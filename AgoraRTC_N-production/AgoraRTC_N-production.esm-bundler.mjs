/**
 * AgoraWebSDK_N-v4.18.2-56-g06e5f5b5-dirty Copyright AgoraInc.
 */

import"webrtc-adapter";import{logger as e,logReportBus as t,BaseRTCEventReport as i,AgoraRTCEvent as n,AgoraRTCEventUploadType as s,isEventCustomReportParams as o}from"@agora-js/report";import{IS_GLOBAL_VERSION as r,MUTABLE_PARAMS as a,MUTABLE_PARAMS_LOCAL_CACHE as c,networkIndicator as d,AgoraAPITag as l,getParameter as h,isEmpty as u,checkValidNumber as p,checkValidBoolean as _,checkValidEnum as E,checkValidString as m,checkValidArray as f,checkValidUID as S,AgoraRTCError as g,AgoraRTCErrorCode as T,checkValidChannelName as R,EventEmitter as C,createDefer as I,PromiseMutex as v,NETWORK_STATE as y,NETWORK_INDICATOR_EVENTS as A,getRetryWaitTime as w,wait as N,emitAsPromise as O,emitAsInvokerNoResponse as b,Rolling as D,ConnectionDisconnectedReason as P,WebSocketQuitReason as L,getRandomString as k,emitAsInvoker as M,SHA256 as U,setBigUint64 as x,getBigUint64 as V,withTimeout as F,nextTick as j,VERSION as B,setParameter as G,getUTF8StringByteLength as W,getMultiUnilbsFormDataByteLength as H,AgoraAPIName as K,retryable as q,getBrowserInfo as Y,DEFAULT_RETRY_CONFIG as J,noop as X,generateSessionID as z,isFirefox as Q,jsonClone as Z,BrowserName as $,BrowserOS as ee,isSafari as te,isIOS as ie,isRTCIceServerList as ne,isChromeKernel as se,isChromeBelow90 as oe,isBelowIOS14_6 as re,emitAsPromiseNoResponse as ae,isSupportedMobile as ce,getUniqueList as de,isClientConfig as le,ClientEvents as he,removeItemFromList as ue,SDKStore as pe,BUILD as _e,isClientRoleOptions as Ee,isHttpsEnv as me,supportIsSecureContext as fe,encryptRSA as Se,isClientRole as ge,isTurnServerConfig as Te,isEncryptionMode as Re,uint8ArrayToBase64 as Ce,base64ToUint8Array as Ie,runOnce as ve,isWebKit as ye,isSupportedWkWebview as Ae,isWechatBrowser as we,isQQBrowser as Ne,isWkWebview as Oe,generateProcessID as be}from"@agora-js/shared";export{AudienceLatencyLevelType,BUILD,ConnectionDisconnectedReason,VERSION,getParameter}from"@agora-js/shared";import{MixingAudioTrack as De,MediaElementNumStatus as Pe,visibilityWatcher as Le,audioElementPlayCenter as ke,LocalAudioTrack as Me,LocalVideoTrack as Ue,TrackHint as xe,getCompatibility as Ve,LocalTrack as Fe,audioTimerLoop as je,MicrophoneAudioTrack as Be,RemoteAudioTrack as Ge,RemoteVideoTrack as We,TrackInternalEvent as He,RemoteTrackEvents as Ke,TrackEvents as qe,StreamType as Ye,frameData2CryptoBuffer as Je,LocalDataChannel as Xe,isLowStreamParameter as ze,RemoteDataChannel as Qe,updateAgoraRTCCompatibility as Ze,autoPlayGestureEventEmitter as $e,deviceManager as et,DeviceManagerEvent as tt,audioContextState as it,__TRACK_LIST__ as nt}from"@agora-js/media";export{RemoteStreamFallbackType,RemoteStreamType,__TRACK_LIST__,audioElementPlayCenter,createBufferSourceAudioTrack,createCameraVideoTrack,createCustomAudioTrack,createCustomVideoTrack,createMicrophoneAndCameraTracks,createMicrophoneAudioTrack,createScreenVideoTrack,getElectronScreenSources}from"@agora-js/media";import st from"axios";import"formdata-polyfill";var ot="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function rt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var at=function(e){try{return!!e()}catch(e){return!0}},ct=!at((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),dt=ct,lt=Function.prototype,ht=lt.call,ut=dt&&lt.bind.bind(ht,ht),pt=dt?ut:function(e){return function(){return ht.apply(e,arguments)}},_t=pt({}.isPrototypeOf),Et=function(e){return e&&e.Math==Math&&e},mt=Et("object"==typeof globalThis&&globalThis)||Et("object"==typeof window&&window)||Et("object"==typeof self&&self)||Et("object"==typeof ot&&ot)||function(){return this}()||ot||Function("return this")(),ft=ct,St=Function.prototype,gt=St.apply,Tt=St.call,Rt="object"==typeof Reflect&&Reflect.apply||(ft?Tt.bind(gt):function(){return Tt.apply(gt,arguments)}),Ct=pt,It=Ct({}.toString),vt=Ct("".slice),yt=function(e){return vt(It(e),8,-1)},At=yt,wt=pt,Nt=function(e){if("Function"===At(e))return wt(e)},Ot="object"==typeof document&&document.all,bt={all:Ot,IS_HTMLDDA:void 0===Ot&&void 0!==Ot},Dt=bt.all,Pt=bt.IS_HTMLDDA?function(e){return"function"==typeof e||e===Dt}:function(e){return"function"==typeof e},Lt={},kt=!at((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),Mt=ct,Ut=Function.prototype.call,xt=Mt?Ut.bind(Ut):function(){return Ut.apply(Ut,arguments)},Vt={},Ft={}.propertyIsEnumerable,jt=Object.getOwnPropertyDescriptor,Bt=jt&&!Ft.call({1:2},1);Vt.f=Bt?function(e){var t=jt(this,e);return!!t&&t.enumerable}:Ft;var Gt,Wt,Ht=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},Kt=at,qt=yt,Yt=Object,Jt=pt("".split),Xt=Kt((function(){return!Yt("z").propertyIsEnumerable(0)}))?function(e){return"String"==qt(e)?Jt(e,""):Yt(e)}:Yt,zt=function(e){return null==e},Qt=zt,Zt=TypeError,$t=function(e){if(Qt(e))throw Zt("Can't call method on "+e);return e},ei=Xt,ti=$t,ii=function(e){return ei(ti(e))},ni=Pt,si=bt.all,oi=bt.IS_HTMLDDA?function(e){return"object"==typeof e?null!==e:ni(e)||e===si}:function(e){return"object"==typeof e?null!==e:ni(e)},ri={},ai=ri,ci=mt,di=Pt,li=function(e){return di(e)?e:void 0},hi=function(e,t){return arguments.length<2?li(ai[e])||li(ci[e]):ai[e]&&ai[e][t]||ci[e]&&ci[e][t]},ui="undefined"!=typeof navigator&&String(navigator.userAgent)||"",pi=mt,_i=ui,Ei=pi.process,mi=pi.Deno,fi=Ei&&Ei.versions||mi&&mi.version,Si=fi&&fi.v8;Si&&(Wt=(Gt=Si.split("."))[0]>0&&Gt[0]<4?1:+(Gt[0]+Gt[1])),!Wt&&_i&&(!(Gt=_i.match(/Edge\/(\d+)/))||Gt[1]>=74)&&(Gt=_i.match(/Chrome\/(\d+)/))&&(Wt=+Gt[1]);var gi=Wt,Ti=gi,Ri=at,Ci=mt.String,Ii=!!Object.getOwnPropertySymbols&&!Ri((function(){var e=Symbol();return!Ci(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Ti&&Ti<41})),vi=Ii&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,yi=hi,Ai=Pt,wi=_t,Ni=Object,Oi=vi?function(e){return"symbol"==typeof e}:function(e){var t=yi("Symbol");return Ai(t)&&wi(t.prototype,Ni(e))},bi=String,Di=function(e){try{return bi(e)}catch(e){return"Object"}},Pi=Pt,Li=Di,ki=TypeError,Mi=function(e){if(Pi(e))return e;throw ki(Li(e)+" is not a function")},Ui=Mi,xi=zt,Vi=function(e,t){var i=e[t];return xi(i)?void 0:Ui(i)},Fi=xt,ji=Pt,Bi=oi,Gi=TypeError,Wi={exports:{}},Hi=mt,Ki=Object.defineProperty,qi=function(e,t){try{Ki(Hi,e,{value:t,configurable:!0,writable:!0})}catch(i){Hi[e]=t}return t},Yi="__core-js_shared__",Ji=mt[Yi]||qi(Yi,{}),Xi=Ji;(Wi.exports=function(e,t){return Xi[e]||(Xi[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"Â© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var zi=Wi.exports,Qi=$t,Zi=Object,$i=function(e){return Zi(Qi(e))},en=$i,tn=pt({}.hasOwnProperty),nn=Object.hasOwn||function(e,t){return tn(en(e),t)},sn=pt,on=0,rn=Math.random(),an=sn(1..toString),cn=function(e){return"Symbol("+(void 0===e?"":e)+")_"+an(++on+rn,36)},dn=zi,ln=nn,hn=cn,un=Ii,pn=vi,_n=mt.Symbol,En=dn("wks"),mn=pn?_n.for||_n:_n&&_n.withoutSetter||hn,fn=function(e){return ln(En,e)||(En[e]=un&&ln(_n,e)?_n[e]:mn("Symbol."+e)),En[e]},Sn=xt,gn=oi,Tn=Oi,Rn=Vi,Cn=function(e,t){var i,n;if("string"===t&&ji(i=e.toString)&&!Bi(n=Fi(i,e)))return n;if(ji(i=e.valueOf)&&!Bi(n=Fi(i,e)))return n;if("string"!==t&&ji(i=e.toString)&&!Bi(n=Fi(i,e)))return n;throw Gi("Can't convert object to primitive value")},In=TypeError,vn=fn("toPrimitive"),yn=function(e,t){if(!gn(e)||Tn(e))return e;var i,n=Rn(e,vn);if(n){if(void 0===t&&(t="default"),i=Sn(n,e,t),!gn(i)||Tn(i))return i;throw In("Can't convert object to primitive value")}return void 0===t&&(t="number"),Cn(e,t)},An=Oi,wn=function(e){var t=yn(e,"string");return An(t)?t:t+""},Nn=oi,On=mt.document,bn=Nn(On)&&Nn(On.createElement),Dn=function(e){return bn?On.createElement(e):{}},Pn=Dn,Ln=!kt&&!at((function(){return 7!=Object.defineProperty(Pn("div"),"a",{get:function(){return 7}}).a})),kn=kt,Mn=xt,Un=Vt,xn=Ht,Vn=ii,Fn=wn,jn=nn,Bn=Ln,Gn=Object.getOwnPropertyDescriptor;Lt.f=kn?Gn:function(e,t){if(e=Vn(e),t=Fn(t),Bn)try{return Gn(e,t)}catch(e){}if(jn(e,t))return xn(!Mn(Un.f,e,t),e[t])};var Wn=at,Hn=Pt,Kn=/#|\.prototype\./,qn=function(e,t){var i=Jn[Yn(e)];return i==zn||i!=Xn&&(Hn(t)?Wn(t):!!t)},Yn=qn.normalize=function(e){return String(e).replace(Kn,".").toLowerCase()},Jn=qn.data={},Xn=qn.NATIVE="N",zn=qn.POLYFILL="P",Qn=qn,Zn=Mi,$n=ct,es=Nt(Nt.bind),ts=function(e,t){return Zn(e),void 0===t?e:$n?es(e,t):function(){return e.apply(t,arguments)}},is={},ns=kt&&at((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),ss=oi,os=String,rs=TypeError,as=function(e){if(ss(e))return e;throw rs(os(e)+" is not an object")},cs=kt,ds=Ln,ls=ns,hs=as,us=wn,ps=TypeError,_s=Object.defineProperty,Es=Object.getOwnPropertyDescriptor,ms="enumerable",fs="configurable",Ss="writable";is.f=cs?ls?function(e,t,i){if(hs(e),t=us(t),hs(i),"function"==typeof e&&"prototype"===t&&"value"in i&&Ss in i&&!i[Ss]){var n=Es(e,t);n&&n[Ss]&&(e[t]=i.value,i={configurable:fs in i?i[fs]:n[fs],enumerable:ms in i?i[ms]:n[ms],writable:!1})}return _s(e,t,i)}:_s:function(e,t,i){if(hs(e),t=us(t),hs(i),ds)try{return _s(e,t,i)}catch(e){}if("get"in i||"set"in i)throw ps("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var gs=is,Ts=Ht,Rs=kt?function(e,t,i){return gs.f(e,t,Ts(1,i))}:function(e,t,i){return e[t]=i,e},Cs=mt,Is=Rt,vs=Nt,ys=Pt,As=Lt.f,ws=Qn,Ns=ri,Os=ts,bs=Rs,Ds=nn,Ps=function(e){var t=function(i,n,s){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,n)}return new e(i,n,s)}return Is(e,this,arguments)};return t.prototype=e.prototype,t},Ls=function(e,t){var i,n,s,o,r,a,c,d,l,h=e.target,u=e.global,p=e.stat,_=e.proto,E=u?Cs:p?Cs[h]:(Cs[h]||{}).prototype,m=u?Ns:Ns[h]||bs(Ns,h,{})[h],f=m.prototype;for(o in t)n=!(i=ws(u?o:h+(p?".":"#")+o,e.forced))&&E&&Ds(E,o),a=m[o],n&&(c=e.dontCallGetSet?(l=As(E,o))&&l.value:E[o]),r=n&&c?c:t[o],n&&typeof a==typeof r||(d=e.bind&&n?Os(r,Cs):e.wrap&&n?Ps(r):_&&ys(r)?vs(r):r,(e.sham||r&&r.sham||a&&a.sham)&&bs(d,"sham",!0),bs(m,o,d),_&&(Ds(Ns,s=h+"Prototype")||bs(Ns,s,{}),bs(Ns[s],o,r),e.real&&f&&(i||!f[o])&&bs(f,o,r)))},ks=Math.ceil,Ms=Math.floor,Us=Math.trunc||function(e){var t=+e;return(t>0?Ms:ks)(t)},xs=function(e){var t=+e;return t!=t||0===t?0:Us(t)},Vs=xs,Fs=Math.max,js=Math.min,Bs=function(e,t){var i=Vs(e);return i<0?Fs(i+t,0):js(i,t)},Gs=xs,Ws=Math.min,Hs=function(e){return e>0?Ws(Gs(e),9007199254740991):0},Ks=function(e){return Hs(e.length)},qs=ii,Ys=Bs,Js=Ks,Xs=function(e){return function(t,i,n){var s,o=qs(t),r=Js(o),a=Ys(n,r);if(e&&i!=i){for(;r>a;)if((s=o[a++])!=s)return!0}else for(;r>a;a++)if((e||a in o)&&o[a]===i)return e||a||0;return!e&&-1}},zs={includes:Xs(!0),indexOf:Xs(!1)},Qs=zs.includes;Ls({target:"Array",proto:!0,forced:at((function(){return!Array(1).includes()}))},{includes:function(e){return Qs(this,e,arguments.length>1?arguments[1]:void 0)}});var Zs=ri,$s=function(e){return Zs[e+"Prototype"]},eo=$s("Array").includes,to=oi,io=yt,no=fn("match"),so=function(e){var t;return to(e)&&(void 0!==(t=e[no])?!!t:"RegExp"==io(e))},oo=TypeError,ro={};ro[fn("toStringTag")]="z";var ao="[object z]"===String(ro),co=ao,lo=Pt,ho=yt,uo=fn("toStringTag"),po=Object,_o="Arguments"==ho(function(){return arguments}()),Eo=co?ho:function(e){var t,i,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=po(e),uo))?i:_o?ho(t):"Object"==(n=ho(t))&&lo(t.callee)?"Arguments":n},mo=Eo,fo=String,So=function(e){if("Symbol"===mo(e))throw TypeError("Cannot convert a Symbol value to a string");return fo(e)},go=fn("match"),To=Ls,Ro=function(e){if(so(e))throw oo("The method doesn't accept regular expressions");return e},Co=$t,Io=So,vo=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[go]=!1,"/./"[e](t)}catch(e){}}return!1},yo=pt("".indexOf);To({target:"String",proto:!0,forced:!vo("includes")},{includes:function(e){return!!~yo(Io(Co(this)),Io(Ro(e)),arguments.length>1?arguments[1]:void 0)}});var Ao=$s("String").includes,wo=_t,No=eo,Oo=Ao,bo=Array.prototype,Do=String.prototype,Po=rt((function(e){var t=e.includes;return e===bo||wo(bo,e)&&t===bo.includes?No:"string"==typeof e||e===Do||wo(Do,e)&&t===Do.includes?Oo:t}));const Lo=["CHINA","GLOBAL"],ko=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),s=[];for(let e=0;e<6;e++)s.push("1");const o=s.join(""),r={};return r[e]=n,r[t]=o,Object.assign(r,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=ko,r||(a.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],a.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],a.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],a.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],a.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],a.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],a.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",a.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",a.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",a.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",a.AREAS=["NORTH_AMERICA","OVERSEA"]);const Mo=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Uo=[];function xo(e,t){return!!t&&Uo.some((i=>i.uid===e&&i.channelName===t))}var Vo={exports:{}},Fo=Ls,jo=kt,Bo=is.f;Fo({target:"Object",stat:!0,forced:Object.defineProperty!==Bo,sham:!jo},{defineProperty:Bo});var Go=ri.Object,Wo=Vo.exports=function(e,t,i){return Go.defineProperty(e,t,i)};Go.defineProperty.sham&&(Wo.sham=!0);var Ho=rt(Vo.exports),Ko=yt,qo=Array.isArray||function(e){return"Array"==Ko(e)},Yo=TypeError,Jo=wn,Xo=is,zo=Ht,Qo=function(e,t,i){var n=Jo(t);n in e?Xo.f(e,n,zo(0,i)):e[n]=i},Zo=Pt,$o=Ji,er=pt(Function.toString);Zo($o.inspectSource)||($o.inspectSource=function(e){return er(e)});var tr=$o.inspectSource,ir=pt,nr=at,sr=Pt,or=Eo,rr=tr,ar=function(){},cr=[],dr=hi("Reflect","construct"),lr=/^\s*(?:class|function)\b/,hr=ir(lr.exec),ur=!lr.exec(ar),pr=function(e){if(!sr(e))return!1;try{return dr(ar,cr,e),!0}catch(e){return!1}},_r=function(e){if(!sr(e))return!1;switch(or(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return ur||!!hr(lr,rr(e))}catch(e){return!0}};_r.sham=!0;var Er=!dr||nr((function(){var e;return pr(pr.call)||!pr(Object)||!pr((function(){e=!0}))||e}))?_r:pr,mr=qo,fr=Er,Sr=oi,gr=fn("species"),Tr=Array,Rr=function(e){var t;return mr(e)&&(t=e.constructor,(fr(t)&&(t===Tr||mr(t.prototype))||Sr(t)&&null===(t=t[gr]))&&(t=void 0)),void 0===t?Tr:t},Cr=function(e,t){return new(Rr(e))(0===t?0:t)},Ir=at,vr=gi,yr=fn("species"),Ar=Ls,wr=at,Nr=qo,Or=oi,br=$i,Dr=Ks,Pr=function(e){if(e>9007199254740991)throw Yo("Maximum allowed index exceeded");return e},Lr=Qo,kr=Cr,Mr=function(e){return vr>=51||!Ir((function(){var t=[];return(t.constructor={})[yr]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},Ur=gi,xr=fn("isConcatSpreadable"),Vr=Ur>=51||!wr((function(){var e=[];return e[xr]=!1,e.concat()[0]!==e})),Fr=function(e){if(!Or(e))return!1;var t=e[xr];return void 0!==t?!!t:Nr(e)};Ar({target:"Array",proto:!0,arity:1,forced:!Vr||!Mr("concat")},{concat:function(e){var t,i,n,s,o,r=br(this),a=kr(r,0),c=0;for(t=-1,n=arguments.length;t<n;t++)if(Fr(o=-1===t?r:arguments[t]))for(s=Dr(o),Pr(c+s),i=0;i<s;i++,c++)i in o&&Lr(a,c,o[i]);else Pr(c+1),Lr(a,c++,o);return a.length=c,a}});var jr={},Br={},Gr=nn,Wr=ii,Hr=zs.indexOf,Kr=Br,qr=pt([].push),Yr=function(e,t){var i,n=Wr(e),s=0,o=[];for(i in n)!Gr(Kr,i)&&Gr(n,i)&&qr(o,i);for(;t.length>s;)Gr(n,i=t[s++])&&(~Hr(o,i)||qr(o,i));return o},Jr=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Xr=Yr,zr=Jr,Qr=Object.keys||function(e){return Xr(e,zr)},Zr=kt,$r=ns,ea=is,ta=as,ia=ii,na=Qr;jr.f=Zr&&!$r?Object.defineProperties:function(e,t){ta(e);for(var i,n=ia(t),s=na(t),o=s.length,r=0;o>r;)ea.f(e,i=s[r++],n[i]);return e};var sa,oa=hi("document","documentElement"),ra=cn,aa=zi("keys"),ca=function(e){return aa[e]||(aa[e]=ra(e))},da=as,la=jr,ha=Jr,ua=Br,pa=oa,_a=Dn,Ea="prototype",ma="script",fa=ca("IE_PROTO"),Sa=function(){},ga=function(e){return"<"+ma+">"+e+"</"+ma+">"},Ta=function(e){e.write(ga("")),e.close();var t=e.parentWindow.Object;return e=null,t},Ra=function(){try{sa=new ActiveXObject("htmlfile")}catch(e){}var e,t,i;Ra="undefined"!=typeof document?document.domain&&sa?Ta(sa):(t=_a("iframe"),i="java"+ma+":",t.style.display="none",pa.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(ga("document.F=Object")),e.close(),e.F):Ta(sa);for(var n=ha.length;n--;)delete Ra[Ea][ha[n]];return Ra()};ua[fa]=!0;var Ca=Object.create||function(e,t){var i;return null!==e?(Sa[Ea]=da(e),i=new Sa,Sa[Ea]=null,i[fa]=e):i=Ra(),void 0===t?i:la.f(i,t)},Ia={},va=Yr,ya=Jr.concat("length","prototype");Ia.f=Object.getOwnPropertyNames||function(e){return va(e,ya)};var Aa={},wa=Bs,Na=Ks,Oa=Qo,ba=Array,Da=Math.max,Pa=function(e,t,i){for(var n=Na(e),s=wa(t,n),o=wa(void 0===i?n:i,n),r=ba(Da(o-s,0)),a=0;s<o;s++,a++)Oa(r,a,e[s]);return r.length=a,r},La=yt,ka=ii,Ma=Ia.f,Ua=Pa,xa="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Aa.f=function(e){return xa&&"Window"==La(e)?function(e){try{return Ma(e)}catch(e){return Ua(xa)}}(e):Ma(ka(e))};var Va={};Va.f=Object.getOwnPropertySymbols;var Fa=Rs,ja=function(e,t,i,n){return n&&n.enumerable?e[t]=i:Fa(e,t,i),e},Ba=is,Ga=function(e,t,i){return Ba.f(e,t,i)},Wa={},Ha=fn;Wa.f=Ha;var Ka,qa,Ya,Ja=ri,Xa=nn,za=Wa,Qa=is.f,Za=function(e){var t=Ja.Symbol||(Ja.Symbol={});Xa(t,e)||Qa(t,e,{value:za.f(e)})},$a=xt,ec=hi,tc=fn,ic=ja,nc=function(){var e=ec("Symbol"),t=e&&e.prototype,i=t&&t.valueOf,n=tc("toPrimitive");t&&!t[n]&&ic(t,n,(function(e){return $a(i,this)}),{arity:1})},sc=Eo,oc=ao?{}.toString:function(){return"[object "+sc(this)+"]"},rc=ao,ac=is.f,cc=Rs,dc=nn,lc=oc,hc=fn("toStringTag"),uc=function(e,t,i,n){if(e){var s=i?e:e.prototype;dc(s,hc)||ac(s,hc,{configurable:!0,value:t}),n&&!rc&&cc(s,"toString",lc)}},pc=Pt,_c=mt.WeakMap,Ec=pc(_c)&&/native code/.test(String(_c)),mc=mt,fc=oi,Sc=Rs,gc=nn,Tc=Ji,Rc=ca,Cc=Br,Ic="Object already initialized",vc=mc.TypeError,yc=mc.WeakMap;if(Ec||Tc.state){var Ac=Tc.state||(Tc.state=new yc);Ac.get=Ac.get,Ac.has=Ac.has,Ac.set=Ac.set,Ka=function(e,t){if(Ac.has(e))throw vc(Ic);return t.facade=e,Ac.set(e,t),t},qa=function(e){return Ac.get(e)||{}},Ya=function(e){return Ac.has(e)}}else{var wc=Rc("state");Cc[wc]=!0,Ka=function(e,t){if(gc(e,wc))throw vc(Ic);return t.facade=e,Sc(e,wc,t),t},qa=function(e){return gc(e,wc)?e[wc]:{}},Ya=function(e){return gc(e,wc)}}var Nc={set:Ka,get:qa,has:Ya,enforce:function(e){return Ya(e)?qa(e):Ka(e,{})},getterFor:function(e){return function(t){var i;if(!fc(t)||(i=qa(t)).type!==e)throw vc("Incompatible receiver, "+e+" required");return i}}},Oc=ts,bc=Xt,Dc=$i,Pc=Ks,Lc=Cr,kc=pt([].push),Mc=function(e){var t=1==e,i=2==e,n=3==e,s=4==e,o=6==e,r=7==e,a=5==e||o;return function(c,d,l,h){for(var u,p,_=Dc(c),E=bc(_),m=Oc(d,l),f=Pc(E),S=0,g=h||Lc,T=t?g(c,f):i||r?g(c,0):void 0;f>S;S++)if((a||S in E)&&(p=m(u=E[S],S,_),e))if(t)T[S]=p;else if(p)switch(e){case 3:return!0;case 5:return u;case 6:return S;case 2:kc(T,u)}else switch(e){case 4:return!1;case 7:kc(T,u)}return o?-1:n||s?s:T}},Uc={forEach:Mc(0),map:Mc(1),filter:Mc(2),some:Mc(3),every:Mc(4),find:Mc(5),findIndex:Mc(6),filterReject:Mc(7)},xc=Ls,Vc=mt,Fc=xt,jc=pt,Bc=kt,Gc=Ii,Wc=at,Hc=nn,Kc=_t,qc=as,Yc=ii,Jc=wn,Xc=So,zc=Ht,Qc=Ca,Zc=Qr,$c=Ia,ed=Aa,td=Va,id=Lt,nd=is,sd=jr,od=Vt,rd=ja,ad=Ga,cd=zi,dd=Br,ld=cn,hd=fn,ud=Wa,pd=Za,_d=nc,Ed=uc,md=Nc,fd=Uc.forEach,Sd=ca("hidden"),gd="Symbol",Td="prototype",Rd=md.set,Cd=md.getterFor(gd),Id=Object[Td],vd=Vc.Symbol,yd=vd&&vd[Td],Ad=Vc.TypeError,wd=Vc.QObject,Nd=id.f,Od=nd.f,bd=ed.f,Dd=od.f,Pd=jc([].push),Ld=cd("symbols"),kd=cd("op-symbols"),Md=cd("wks"),Ud=!wd||!wd[Td]||!wd[Td].findChild,xd=Bc&&Wc((function(){return 7!=Qc(Od({},"a",{get:function(){return Od(this,"a",{value:7}).a}})).a}))?function(e,t,i){var n=Nd(Id,t);n&&delete Id[t],Od(e,t,i),n&&e!==Id&&Od(Id,t,n)}:Od,Vd=function(e,t){var i=Ld[e]=Qc(yd);return Rd(i,{type:gd,tag:e,description:t}),Bc||(i.description=t),i},Fd=function(e,t,i){e===Id&&Fd(kd,t,i),qc(e);var n=Jc(t);return qc(i),Hc(Ld,n)?(i.enumerable?(Hc(e,Sd)&&e[Sd][n]&&(e[Sd][n]=!1),i=Qc(i,{enumerable:zc(0,!1)})):(Hc(e,Sd)||Od(e,Sd,zc(1,{})),e[Sd][n]=!0),xd(e,n,i)):Od(e,n,i)},jd=function(e,t){qc(e);var i=Yc(t),n=Zc(i).concat(Hd(i));return fd(n,(function(t){Bc&&!Fc(Bd,i,t)||Fd(e,t,i[t])})),e},Bd=function(e){var t=Jc(e),i=Fc(Dd,this,t);return!(this===Id&&Hc(Ld,t)&&!Hc(kd,t))&&(!(i||!Hc(this,t)||!Hc(Ld,t)||Hc(this,Sd)&&this[Sd][t])||i)},Gd=function(e,t){var i=Yc(e),n=Jc(t);if(i!==Id||!Hc(Ld,n)||Hc(kd,n)){var s=Nd(i,n);return!s||!Hc(Ld,n)||Hc(i,Sd)&&i[Sd][n]||(s.enumerable=!0),s}},Wd=function(e){var t=bd(Yc(e)),i=[];return fd(t,(function(e){Hc(Ld,e)||Hc(dd,e)||Pd(i,e)})),i},Hd=function(e){var t=e===Id,i=bd(t?kd:Yc(e)),n=[];return fd(i,(function(e){!Hc(Ld,e)||t&&!Hc(Id,e)||Pd(n,Ld[e])})),n};Gc||(rd(yd=(vd=function(){if(Kc(yd,this))throw Ad("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?Xc(arguments[0]):void 0,t=ld(e),i=function(e){this===Id&&Fc(i,kd,e),Hc(this,Sd)&&Hc(this[Sd],t)&&(this[Sd][t]=!1),xd(this,t,zc(1,e))};return Bc&&Ud&&xd(Id,t,{configurable:!0,set:i}),Vd(t,e)})[Td],"toString",(function(){return Cd(this).tag})),rd(vd,"withoutSetter",(function(e){return Vd(ld(e),e)})),od.f=Bd,nd.f=Fd,sd.f=jd,id.f=Gd,$c.f=ed.f=Wd,td.f=Hd,ud.f=function(e){return Vd(hd(e),e)},Bc&&ad(yd,"description",{configurable:!0,get:function(){return Cd(this).description}})),xc({global:!0,constructor:!0,wrap:!0,forced:!Gc,sham:!Gc},{Symbol:vd}),fd(Zc(Md),(function(e){pd(e)})),xc({target:gd,stat:!0,forced:!Gc},{useSetter:function(){Ud=!0},useSimple:function(){Ud=!1}}),xc({target:"Object",stat:!0,forced:!Gc,sham:!Bc},{create:function(e,t){return void 0===t?Qc(e):jd(Qc(e),t)},defineProperty:Fd,defineProperties:jd,getOwnPropertyDescriptor:Gd}),xc({target:"Object",stat:!0,forced:!Gc},{getOwnPropertyNames:Wd}),_d(),Ed(vd,gd),dd[Sd]=!0;var Kd=Ii&&!!Symbol.for&&!!Symbol.keyFor,qd=Ls,Yd=hi,Jd=nn,Xd=So,zd=zi,Qd=Kd,Zd=zd("string-to-symbol-registry"),$d=zd("symbol-to-string-registry");qd({target:"Symbol",stat:!0,forced:!Qd},{for:function(e){var t=Xd(e);if(Jd(Zd,t))return Zd[t];var i=Yd("Symbol")(t);return Zd[t]=i,$d[i]=t,i}});var el=Ls,tl=nn,il=Oi,nl=Di,sl=Kd,ol=zi("symbol-to-string-registry");el({target:"Symbol",stat:!0,forced:!sl},{keyFor:function(e){if(!il(e))throw TypeError(nl(e)+" is not a symbol");if(tl(ol,e))return ol[e]}});var rl=pt([].slice),al=qo,cl=Pt,dl=yt,ll=So,hl=pt([].push),ul=Ls,pl=hi,_l=Rt,El=xt,ml=pt,fl=at,Sl=Pt,gl=Oi,Tl=rl,Rl=function(e){if(cl(e))return e;if(al(e)){for(var t=e.length,i=[],n=0;n<t;n++){var s=e[n];"string"==typeof s?hl(i,s):"number"!=typeof s&&"Number"!=dl(s)&&"String"!=dl(s)||hl(i,ll(s))}var o=i.length,r=!0;return function(e,t){if(r)return r=!1,t;if(al(this))return t;for(var n=0;n<o;n++)if(i[n]===e)return t}}},Cl=Ii,Il=String,vl=pl("JSON","stringify"),yl=ml(/./.exec),Al=ml("".charAt),wl=ml("".charCodeAt),Nl=ml("".replace),Ol=ml(1..toString),bl=/[\uD800-\uDFFF]/g,Dl=/^[\uD800-\uDBFF]$/,Pl=/^[\uDC00-\uDFFF]$/,Ll=!Cl||fl((function(){var e=pl("Symbol")();return"[null]"!=vl([e])||"{}"!=vl({a:e})||"{}"!=vl(Object(e))})),kl=fl((function(){return'"\\udf06\\ud834"'!==vl("\udf06\ud834")||'"\\udead"'!==vl("\udead")})),Ml=function(e,t){var i=Tl(arguments),n=Rl(t);if(Sl(n)||void 0!==e&&!gl(e))return i[1]=function(e,t){if(Sl(n)&&(t=El(n,this,Il(e),t)),!gl(t))return t},_l(vl,null,i)},Ul=function(e,t,i){var n=Al(i,t-1),s=Al(i,t+1);return yl(Dl,e)&&!yl(Pl,s)||yl(Pl,e)&&!yl(Dl,n)?"\\u"+Ol(wl(e,0),16):e};vl&&ul({target:"JSON",stat:!0,arity:3,forced:Ll||kl},{stringify:function(e,t,i){var n=Tl(arguments),s=_l(Ll?Ml:vl,null,n);return kl&&"string"==typeof s?Nl(s,bl,Ul):s}});var xl=Va,Vl=$i;Ls({target:"Object",stat:!0,forced:!Ii||at((function(){xl.f(1)}))},{getOwnPropertySymbols:function(e){var t=xl.f;return t?t(Vl(e)):[]}}),Za("asyncIterator"),Za("hasInstance"),Za("isConcatSpreadable"),Za("iterator"),Za("match"),Za("matchAll"),Za("replace"),Za("search"),Za("species"),Za("split");var Fl=nc;Za("toPrimitive"),Fl();var jl=hi,Bl=uc;Za("toStringTag"),Bl(jl("Symbol"),"Symbol"),Za("unscopables"),uc(mt.JSON,"JSON",!0);var Gl,Wl,Hl,Kl=ri.Symbol,ql={},Yl=kt,Jl=nn,Xl=Function.prototype,zl=Yl&&Object.getOwnPropertyDescriptor,Ql=Jl(Xl,"name"),Zl={EXISTS:Ql,PROPER:Ql&&"something"===function(){}.name,CONFIGURABLE:Ql&&(!Yl||Yl&&zl(Xl,"name").configurable)},$l=!at((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),eh=nn,th=Pt,ih=$i,nh=$l,sh=ca("IE_PROTO"),oh=Object,rh=oh.prototype,ah=nh?oh.getPrototypeOf:function(e){var t=ih(e);if(eh(t,sh))return t[sh];var i=t.constructor;return th(i)&&t instanceof i?i.prototype:t instanceof oh?rh:null},ch=at,dh=Pt,lh=oi,hh=Ca,uh=ah,ph=ja,_h=fn("iterator"),Eh=!1;[].keys&&("next"in(Hl=[].keys())?(Wl=uh(uh(Hl)))!==Object.prototype&&(Gl=Wl):Eh=!0);var mh=!lh(Gl)||ch((function(){var e={};return Gl[_h].call(e)!==e}));dh((Gl=mh?{}:hh(Gl))[_h])||ph(Gl,_h,(function(){return this}));var fh={IteratorPrototype:Gl,BUGGY_SAFARI_ITERATORS:Eh},Sh=fh.IteratorPrototype,gh=Ca,Th=Ht,Rh=uc,Ch=ql,Ih=function(){return this},vh=pt,yh=Mi,Ah=Pt,wh=String,Nh=TypeError,Oh=function(e,t,i){try{return vh(yh(Object.getOwnPropertyDescriptor(e,t)[i]))}catch(e){}},bh=as,Dh=function(e){if("object"==typeof e||Ah(e))return e;throw Nh("Can't set "+wh(e)+" as a prototype")},Ph=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=Oh(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch(e){}return function(i,n){return bh(i),Dh(n),t?e(i,n):i.__proto__=n,i}}():void 0),Lh=Ls,kh=xt,Mh=Zl,Uh=function(e,t,i,n){var s=t+" Iterator";return e.prototype=gh(Sh,{next:Th(+!n,i)}),Rh(e,s,!1,!0),Ch[s]=Ih,e},xh=ah,Vh=uc,Fh=ja,jh=ql,Bh=fh,Gh=Mh.PROPER,Wh=Bh.BUGGY_SAFARI_ITERATORS,Hh=fn("iterator"),Kh="keys",qh="values",Yh="entries",Jh=function(){return this},Xh=function(e,t,i,n,s,o,r){Uh(i,t,n);var a,c,d,l=function(e){if(e===s&&E)return E;if(!Wh&&e in p)return p[e];switch(e){case Kh:case qh:case Yh:return function(){return new i(this,e)}}return function(){return new i(this)}},h=t+" Iterator",u=!1,p=e.prototype,_=p[Hh]||p["@@iterator"]||s&&p[s],E=!Wh&&_||l(s),m="Array"==t&&p.entries||_;if(m&&(a=xh(m.call(new e)))!==Object.prototype&&a.next&&(Vh(a,h,!0,!0),jh[h]=Jh),Gh&&s==qh&&_&&_.name!==qh&&(u=!0,E=function(){return kh(_,this)}),s)if(c={values:l(qh),keys:o?E:l(Kh),entries:l(Yh)},r)for(d in c)(Wh||u||!(d in p))&&Fh(p,d,c[d]);else Lh({target:t,proto:!0,forced:Wh||u},c);return r&&p[Hh]!==E&&Fh(p,Hh,E,{name:s}),jh[t]=E,c},zh=function(e,t){return{value:e,done:t}},Qh=ii,Zh=ql,$h=Nc;is.f;var eu=Xh,tu=zh,iu="Array Iterator",nu=$h.set,su=$h.getterFor(iu);eu(Array,"Array",(function(e,t){nu(this,{type:iu,target:Qh(e),index:0,kind:t})}),(function(){var e=su(this),t=e.target,i=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,tu(void 0,!0)):tu("keys"==i?n:"values"==i?t[n]:[n,t[n]],!1)}),"values"),Zh.Arguments=Zh.Array;var ou={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},ru=mt,au=Eo,cu=Rs,du=ql,lu=fn("toStringTag");for(var hu in ou){var uu=ru[hu],pu=uu&&uu.prototype;pu&&au(pu)!==lu&&cu(pu,lu,hu),du[hu]=du.Array}var _u=Kl,Eu=fn,mu=is.f,fu=Eu("metadata"),Su=Function.prototype;void 0===Su[fu]&&mu(Su,fu,{value:null}),Za("dispose"),Za("metadata");var gu=_u;Za("asyncDispose");var Tu=pt,Ru=hi("Symbol"),Cu=Ru.keyFor,Iu=Tu(Ru.prototype.valueOf),vu=Ru.isRegisteredSymbol||function(e){try{return void 0!==Cu(Iu(e))}catch(e){return!1}};Ls({target:"Symbol",stat:!0},{isRegisteredSymbol:vu});for(var yu=zi,Au=hi,wu=pt,Nu=Oi,Ou=fn,bu=Au("Symbol"),Du=bu.isWellKnownSymbol,Pu=Au("Object","getOwnPropertyNames"),Lu=wu(bu.prototype.valueOf),ku=yu("wks"),Mu=0,Uu=Pu(bu),xu=Uu.length;Mu<xu;Mu++)try{var Vu=Uu[Mu];Nu(bu[Vu])&&Ou(Vu)}catch(e){}var Fu=function(e){if(Du&&Du(e))return!0;try{for(var t=Lu(e),i=0,n=Pu(ku),s=n.length;i<s;i++)if(ku[n[i]]==t)return!0}catch(e){}return!1};Ls({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Fu}),Za("matcher"),Za("observable"),Ls({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:vu}),Ls({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Fu}),Za("metadataKey"),Za("patternMatch"),Za("replaceAll");var ju=rt(gu),Bu=pt,Gu=xs,Wu=So,Hu=$t,Ku=Bu("".charAt),qu=Bu("".charCodeAt),Yu=Bu("".slice),Ju=function(e){return function(t,i){var n,s,o=Wu(Hu(t)),r=Gu(i),a=o.length;return r<0||r>=a?e?"":void 0:(n=qu(o,r))<55296||n>56319||r+1===a||(s=qu(o,r+1))<56320||s>57343?e?Ku(o,r):n:e?Yu(o,r,r+2):s-56320+(n-55296<<10)+65536}},Xu={codeAt:Ju(!1),charAt:Ju(!0)}.charAt,zu=So,Qu=Nc,Zu=Xh,$u=zh,ep="String Iterator",tp=Qu.set,ip=Qu.getterFor(ep);Zu(String,"String",(function(e){tp(this,{type:ep,string:zu(e),index:0})}),(function(){var e,t=ip(this),i=t.string,n=t.index;return n>=i.length?$u(void 0,!0):(e=Xu(i,n),t.index+=e.length,$u(e,!1))}));var np=rt(Wa.f("iterator"));function sp(e){return sp="function"==typeof ju&&"symbol"==typeof np?function(e){return typeof e}:function(e){return e&&"function"==typeof ju&&e.constructor===ju&&e!==ju.prototype?"symbol":typeof e},sp(e)}var op=rt(Wa.f("toPrimitive"));function rp(e){var t=function(e,t){if("object"!==sp(e)||null===e)return e;var i=e[op];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==sp(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===sp(t)?t:String(t)}function ap(e,t,i){return(t=rp(t))in e?Ho(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var cp=Mi,dp=$i,lp=Xt,hp=Ks,up=TypeError,pp=function(e){return function(t,i,n,s){cp(i);var o=dp(t),r=lp(o),a=hp(o),c=e?a-1:0,d=e?-1:1;if(n<2)for(;;){if(c in r){s=r[c],c+=d;break}if(c+=d,e?c<0:a<=c)throw up("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=d)c in r&&(s=i(s,r[c],c,o));return s}},_p={left:pp(!1),right:pp(!0)},Ep=at,mp=function(e,t){var i=[][e];return!!i&&Ep((function(){i.call(null,t||function(){return 1},1)}))},fp="undefined"!=typeof process&&"process"==yt(process),Sp=_p.left;Ls({target:"Array",proto:!0,forced:!fp&&gi>79&&gi<83||!mp("reduce")},{reduce:function(e){var t=arguments.length;return Sp(this,e,t,t>1?arguments[1]:void 0)}});var gp=$s("Array").reduce,Tp=_t,Rp=gp,Cp=Array.prototype,Ip=rt((function(e){var t=e.reduce;return e===Cp||Tp(Cp,e)&&t===Cp.reduce?Rp:t})),vp=hi,yp=Ia,Ap=Va,wp=as,Np=pt([].concat),Op=vp("Reflect","ownKeys")||function(e){var t=yp.f(wp(e)),i=Ap.f;return i?Np(t,i(e)):t},bp=nn,Dp=Op,Pp=Lt,Lp=is,kp=oi,Mp=Rs,Up=Error,xp=pt("".replace),Vp=String(Up("zxcasd").stack),Fp=/\n\s*at [^:]*:[^\n]*/,jp=Fp.test(Vp),Bp=Ht,Gp=!at((function(){var e=Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",Bp(1,7)),7!==e.stack)})),Wp=Rs,Hp=function(e,t){if(jp&&"string"==typeof e&&!Up.prepareStackTrace)for(;t--;)e=xp(e,Fp,"");return e},Kp=Gp,qp=Error.captureStackTrace,Yp=ql,Jp=fn("iterator"),Xp=Array.prototype,zp=Eo,Qp=Vi,Zp=zt,$p=ql,e_=fn("iterator"),t_=function(e){if(!Zp(e))return Qp(e,e_)||Qp(e,"@@iterator")||$p[zp(e)]},i_=xt,n_=Mi,s_=as,o_=Di,r_=t_,a_=TypeError,c_=xt,d_=as,l_=Vi,h_=ts,u_=xt,p_=as,__=Di,E_=function(e){return void 0!==e&&(Yp.Array===e||Xp[Jp]===e)},m_=Ks,f_=_t,S_=function(e,t){var i=arguments.length<2?r_(e):t;if(n_(i))return s_(i_(i,e));throw a_(o_(e)+" is not iterable")},g_=t_,T_=function(e,t,i){var n,s;d_(e);try{if(!(n=l_(e,"return"))){if("throw"===t)throw i;return i}n=c_(n,e)}catch(e){s=!0,n=e}if("throw"===t)throw i;if(s)throw n;return d_(n),i},R_=TypeError,C_=function(e,t){this.stopped=e,this.result=t},I_=C_.prototype,v_=function(e,t,i){var n,s,o,r,a,c,d,l=i&&i.that,h=!(!i||!i.AS_ENTRIES),u=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),_=!(!i||!i.INTERRUPTED),E=h_(t,l),m=function(e){return n&&T_(n,"normal",e),new C_(!0,e)},f=function(e){return h?(p_(e),_?E(e[0],e[1],m):E(e[0],e[1])):_?E(e,m):E(e)};if(u)n=e.iterator;else if(p)n=e;else{if(!(s=g_(e)))throw R_(__(e)+" is not iterable");if(E_(s)){for(o=0,r=m_(e);r>o;o++)if((a=f(e[o]))&&f_(I_,a))return a;return new C_(!1)}n=S_(e,s)}for(c=u?e.next:n.next;!(d=u_(c,n)).done;){try{a=f(d.value)}catch(e){T_(n,"throw",e)}if("object"==typeof a&&a&&f_(I_,a))return a}return new C_(!1)},y_=So,A_=Ls,w_=_t,N_=ah,O_=Ph,b_=function(e,t,i){for(var n=Dp(t),s=Lp.f,o=Pp.f,r=0;r<n.length;r++){var a=n[r];bp(e,a)||i&&bp(i,a)||s(e,a,o(t,a))}},D_=Ca,P_=Rs,L_=Ht,k_=function(e,t){kp(t)&&"cause"in t&&Mp(e,"cause",t.cause)},M_=function(e,t,i,n){Kp&&(qp?qp(e,t):Wp(e,"stack",Hp(i,n)))},U_=v_,x_=function(e,t){return void 0===e?arguments.length<2?"":t:y_(e)},V_=fn("toStringTag"),F_=Error,j_=[].push,B_=function(e,t){var i,n=w_(G_,this);O_?i=O_(F_(),n?N_(this):G_):(i=n?this:D_(G_),P_(i,V_,"Error")),void 0!==t&&P_(i,"message",x_(t)),M_(i,B_,i.stack,1),arguments.length>2&&k_(i,arguments[2]);var s=[];return U_(e,j_,{that:s}),P_(i,"errors",s),i};O_?O_(B_,F_):b_(B_,F_,{name:!0});var G_=B_.prototype=D_(F_.prototype,{constructor:L_(1,B_),message:L_(1,""),name:L_(1,"AggregateError")});A_({global:!0,constructor:!0,arity:2},{AggregateError:B_});var W_,H_,K_,q_,Y_=hi,J_=Ga,X_=kt,z_=fn("species"),Q_=_t,Z_=TypeError,$_=Er,eE=Di,tE=TypeError,iE=as,nE=function(e){if($_(e))return e;throw tE(eE(e)+" is not a constructor")},sE=zt,oE=fn("species"),rE=function(e,t){var i,n=iE(e).constructor;return void 0===n||sE(i=iE(n)[oE])?t:nE(i)},aE=TypeError,cE=/(?:ipad|iphone|ipod).*applewebkit/i.test(ui),dE=mt,lE=Rt,hE=ts,uE=Pt,pE=nn,_E=at,EE=oa,mE=rl,fE=Dn,SE=function(e,t){if(e<t)throw aE("Not enough arguments");return e},gE=cE,TE=fp,RE=dE.setImmediate,CE=dE.clearImmediate,IE=dE.process,vE=dE.Dispatch,yE=dE.Function,AE=dE.MessageChannel,wE=dE.String,NE=0,OE={},bE="onreadystatechange";_E((function(){W_=dE.location}));var DE=function(e){if(pE(OE,e)){var t=OE[e];delete OE[e],t()}},PE=function(e){return function(){DE(e)}},LE=function(e){DE(e.data)},kE=function(e){dE.postMessage(wE(e),W_.protocol+"//"+W_.host)};RE&&CE||(RE=function(e){SE(arguments.length,1);var t=uE(e)?e:yE(e),i=mE(arguments,1);return OE[++NE]=function(){lE(t,void 0,i)},H_(NE),NE},CE=function(e){delete OE[e]},TE?H_=function(e){IE.nextTick(PE(e))}:vE&&vE.now?H_=function(e){vE.now(PE(e))}:AE&&!gE?(q_=(K_=new AE).port2,K_.port1.onmessage=LE,H_=hE(q_.postMessage,q_)):dE.addEventListener&&uE(dE.postMessage)&&!dE.importScripts&&W_&&"file:"!==W_.protocol&&!_E(kE)?(H_=kE,dE.addEventListener("message",LE,!1)):H_=bE in fE("script")?function(e){EE.appendChild(fE("script"))[bE]=function(){EE.removeChild(this),DE(e)}}:function(e){setTimeout(PE(e),0)});var ME={set:RE,clear:CE},UE=function(){this.head=null,this.tail=null};UE.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var xE,VE,FE,jE,BE,GE=UE,WE=/ipad|iphone|ipod/i.test(ui)&&"undefined"!=typeof Pebble,HE=/web0s(?!.*chrome)/i.test(ui),KE=mt,qE=ts,YE=Lt.f,JE=ME.set,XE=GE,zE=cE,QE=WE,ZE=HE,$E=fp,em=KE.MutationObserver||KE.WebKitMutationObserver,tm=KE.document,im=KE.process,nm=KE.Promise,sm=YE(KE,"queueMicrotask"),om=sm&&sm.value;if(!om){var rm=new XE,am=function(){var e,t;for($E&&(e=im.domain)&&e.exit();t=rm.get();)try{t()}catch(e){throw rm.head&&xE(),e}e&&e.enter()};zE||$E||ZE||!em||!tm?!QE&&nm&&nm.resolve?((jE=nm.resolve(void 0)).constructor=nm,BE=qE(jE.then,jE),xE=function(){BE(am)}):$E?xE=function(){im.nextTick(am)}:(JE=qE(JE,KE),xE=function(){JE(am)}):(VE=!0,FE=tm.createTextNode(""),new em(am).observe(FE,{characterData:!0}),xE=function(){FE.data=VE=!VE}),om=function(e){rm.head||xE(),rm.add(e)}}var cm=om,dm=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},lm=mt.Promise,hm="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,um=!hm&&!fp&&"object"==typeof window&&"object"==typeof document,pm=mt,_m=lm,Em=Pt,mm=Qn,fm=tr,Sm=fn,gm=um,Tm=hm,Rm=gi,Cm=_m&&_m.prototype,Im=Sm("species"),vm=!1,ym=Em(pm.PromiseRejectionEvent),Am=mm("Promise",(function(){var e=fm(_m),t=e!==String(_m);if(!t&&66===Rm)return!0;if(!Cm.catch||!Cm.finally)return!0;if(!Rm||Rm<51||!/native code/.test(e)){var i=new _m((function(e){e(1)})),n=function(e){e((function(){}),(function(){}))};if((i.constructor={})[Im]=n,!(vm=i.then((function(){}))instanceof n))return!0}return!t&&(gm||Tm)&&!ym})),wm={CONSTRUCTOR:Am,REJECTION_EVENT:ym,SUBCLASSING:vm},Nm={},Om=Mi,bm=TypeError,Dm=function(e){var t,i;this.promise=new e((function(e,n){if(void 0!==t||void 0!==i)throw bm("Bad Promise constructor");t=e,i=n})),this.resolve=Om(t),this.reject=Om(i)};Nm.f=function(e){return new Dm(e)};var Pm,Lm,km=Ls,Mm=fp,Um=mt,xm=xt,Vm=ja,Fm=uc,jm=function(e){var t=Y_(e);X_&&t&&!t[z_]&&J_(t,z_,{configurable:!0,get:function(){return this}})},Bm=Mi,Gm=Pt,Wm=oi,Hm=function(e,t){if(Q_(t,e))return e;throw Z_("Incorrect invocation")},Km=rE,qm=ME.set,Ym=cm,Jm=function(e,t){try{1==arguments.length?console.error(e):console.error(e,t)}catch(e){}},Xm=dm,zm=GE,Qm=Nc,Zm=lm,$m=wm,ef=Nm,tf="Promise",nf=$m.CONSTRUCTOR,sf=$m.REJECTION_EVENT,of=Qm.getterFor(tf),rf=Qm.set,af=Zm&&Zm.prototype,cf=Zm,df=af,lf=Um.TypeError,hf=Um.document,uf=Um.process,pf=ef.f,_f=pf,Ef=!!(hf&&hf.createEvent&&Um.dispatchEvent),mf="unhandledrejection",ff=function(e){var t;return!(!Wm(e)||!Gm(t=e.then))&&t},Sf=function(e,t){var i,n,s,o=t.value,r=1==t.state,a=r?e.ok:e.fail,c=e.resolve,d=e.reject,l=e.domain;try{a?(r||(2===t.rejection&&If(t),t.rejection=1),!0===a?i=o:(l&&l.enter(),i=a(o),l&&(l.exit(),s=!0)),i===e.promise?d(lf("Promise-chain cycle")):(n=ff(i))?xm(n,i,c,d):c(i)):d(o)}catch(e){l&&!s&&l.exit(),d(e)}},gf=function(e,t){e.notified||(e.notified=!0,Ym((function(){for(var i,n=e.reactions;i=n.get();)Sf(i,e);e.notified=!1,t&&!e.rejection&&Rf(e)})))},Tf=function(e,t,i){var n,s;Ef?((n=hf.createEvent("Event")).promise=t,n.reason=i,n.initEvent(e,!1,!0),Um.dispatchEvent(n)):n={promise:t,reason:i},!sf&&(s=Um["on"+e])?s(n):e===mf&&Jm("Unhandled promise rejection",i)},Rf=function(e){xm(qm,Um,(function(){var t,i=e.facade,n=e.value;if(Cf(e)&&(t=Xm((function(){Mm?uf.emit("unhandledRejection",n,i):Tf(mf,i,n)})),e.rejection=Mm||Cf(e)?2:1,t.error))throw t.value}))},Cf=function(e){return 1!==e.rejection&&!e.parent},If=function(e){xm(qm,Um,(function(){var t=e.facade;Mm?uf.emit("rejectionHandled",t):Tf("rejectionhandled",t,e.value)}))},vf=function(e,t,i){return function(n){e(t,n,i)}},yf=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,gf(e,!0))},Af=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw lf("Promise can't be resolved itself");var n=ff(t);n?Ym((function(){var i={done:!1};try{xm(n,t,vf(Af,i,e),vf(yf,i,e))}catch(t){yf(i,t,e)}})):(e.value=t,e.state=1,gf(e,!1))}catch(t){yf({done:!1},t,e)}}};nf&&(df=(cf=function(e){Hm(this,df),Bm(e),xm(Pm,this);var t=of(this);try{e(vf(Af,t),vf(yf,t))}catch(e){yf(t,e)}}).prototype,(Pm=function(e){rf(this,{type:tf,done:!1,notified:!1,parent:!1,reactions:new zm,rejection:!1,state:0,value:void 0})}).prototype=Vm(df,"then",(function(e,t){var i=of(this),n=pf(Km(this,cf));return i.parent=!0,n.ok=!Gm(e)||e,n.fail=Gm(t)&&t,n.domain=Mm?uf.domain:void 0,0==i.state?i.reactions.add(n):Ym((function(){Sf(n,i)})),n.promise})),Lm=function(){var e=new Pm,t=of(e);this.promise=e,this.resolve=vf(Af,t),this.reject=vf(yf,t)},ef.f=pf=function(e){return e===cf||undefined===e?new Lm(e):_f(e)}),km({global:!0,constructor:!0,wrap:!0,forced:nf},{Promise:cf}),Fm(cf,tf,!1,!0),jm(tf);var wf=fn("iterator"),Nf=!1;try{var Of=0,bf={next:function(){return{done:!!Of++}},return:function(){Nf=!0}};bf[wf]=function(){return this},Array.from(bf,(function(){throw 2}))}catch(e){}var Df=lm,Pf=function(e,t){if(!t&&!Nf)return!1;var i=!1;try{var n={};n[wf]=function(){return{next:function(){return{done:i=!0}}}},e(n)}catch(e){}return i},Lf=wm.CONSTRUCTOR||!Pf((function(e){Df.all(e).then(void 0,(function(){}))})),kf=xt,Mf=Mi,Uf=Nm,xf=dm,Vf=v_;Ls({target:"Promise",stat:!0,forced:Lf},{all:function(e){var t=this,i=Uf.f(t),n=i.resolve,s=i.reject,o=xf((function(){var i=Mf(t.resolve),o=[],r=0,a=1;Vf(e,(function(e){var c=r++,d=!1;a++,kf(i,t,e).then((function(e){d||(d=!0,o[c]=e,--a||n(o))}),s)})),--a||n(o)}));return o.error&&s(o.value),i.promise}});var Ff=Ls,jf=wm.CONSTRUCTOR;lm&&lm.prototype,Ff({target:"Promise",proto:!0,forced:jf,real:!0},{catch:function(e){return this.then(void 0,e)}});var Bf=xt,Gf=Mi,Wf=Nm,Hf=dm,Kf=v_;Ls({target:"Promise",stat:!0,forced:Lf},{race:function(e){var t=this,i=Wf.f(t),n=i.reject,s=Hf((function(){var s=Gf(t.resolve);Kf(e,(function(e){Bf(s,t,e).then(i.resolve,n)}))}));return s.error&&n(s.value),i.promise}});var qf=xt,Yf=Nm;Ls({target:"Promise",stat:!0,forced:wm.CONSTRUCTOR},{reject:function(e){var t=Yf.f(this);return qf(t.reject,void 0,e),t.promise}});var Jf=as,Xf=oi,zf=Nm,Qf=function(e,t){if(Jf(e),Xf(t)&&t.constructor===e)return t;var i=zf.f(e);return(0,i.resolve)(t),i.promise},Zf=Ls,$f=lm,eS=wm.CONSTRUCTOR,tS=Qf,iS=hi("Promise"),nS=!eS;Zf({target:"Promise",stat:!0,forced:true},{resolve:function(e){return tS(nS&&this===iS?$f:this,e)}});var sS=xt,oS=Mi,rS=Nm,aS=dm,cS=v_;Ls({target:"Promise",stat:!0,forced:Lf},{allSettled:function(e){var t=this,i=rS.f(t),n=i.resolve,s=i.reject,o=aS((function(){var i=oS(t.resolve),s=[],o=0,r=1;cS(e,(function(e){var a=o++,c=!1;r++,sS(i,t,e).then((function(e){c||(c=!0,s[a]={status:"fulfilled",value:e},--r||n(s))}),(function(e){c||(c=!0,s[a]={status:"rejected",reason:e},--r||n(s))}))})),--r||n(s)}));return o.error&&s(o.value),i.promise}});var dS=xt,lS=Mi,hS=hi,uS=Nm,pS=dm,_S=v_,ES="No one promise resolved";Ls({target:"Promise",stat:!0,forced:Lf},{any:function(e){var t=this,i=hS("AggregateError"),n=uS.f(t),s=n.resolve,o=n.reject,r=pS((function(){var n=lS(t.resolve),r=[],a=0,c=1,d=!1;_S(e,(function(e){var l=a++,h=!1;c++,dS(n,t,e).then((function(e){h||d||(d=!0,s(e))}),(function(e){h||d||(h=!0,r[l]=e,--c||o(new i(r,ES)))}))})),--c||o(new i(r,ES))}));return r.error&&o(r.value),n.promise}});var mS=Ls,fS=lm,SS=at,gS=hi,TS=Pt,RS=rE,CS=Qf,IS=fS&&fS.prototype;mS({target:"Promise",proto:!0,real:!0,forced:!!fS&&SS((function(){IS.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=RS(this,gS("Promise")),i=TS(e);return this.then(i?function(i){return CS(t,e()).then((function(){return i}))}:e,i?function(i){return CS(t,e()).then((function(){throw i}))}:e)}});var vS=ri.Promise,yS=rt(vS),AS=$s("Array").values,wS=Eo,NS=nn,OS=_t,bS=AS,DS=Array.prototype,PS={DOMTokenList:!0,NodeList:!0},LS=rt((function(e){var t=e.values;return e===DS||OS(DS,e)&&t===DS.values||NS(PS,wS(e))?bS:t}));function kS(e,t,i,n){var s,o=arguments.length,r=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(o<3?s(r):o>3?s(t,i,r):s(t,i))||r);return o>3&&r&&Object.defineProperty(t,i,r),r}function MS(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function US(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(i,n,s){const o=s.value;if("function"==typeof o){const r=t.className||i.__className__||("AgoraRTCClient"===i.constructor.name?"Client":i.constructor.name);s.value=function(){for(var i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];let c=s;if(t.argsMap)try{c=t.argsMap(this,...s)}catch(t){e.warning(t),c=[]}try{JSON.stringify(c)}catch(t){e.warning("arguments for method ".concat(r,".").concat(String(n)," not serializable for apiInvoke.")),c=[]}const d=(t.report||xS).reportApiInvoke(this._sessionId||null,{name:"".concat(r,".").concat(String(n)),options:c,tag:l.TRACER,reportResult:t.reportResult},t.throttleTime);try{const e=o.apply(this,s);return e instanceof yS?e.then((e=>(d.onSuccess(t.reportResult&&e),e))).catch((e=>{throw d.onError(e),e})):(d.onSuccess(t.reportResult&&e),e)}catch(e){throw d.onError(e),e}}}return s}}const xS=new class extends i{constructor(){super(),this.clientList=Uo,this.setSessionIdTimer=void 0,this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),h("EVENT_REPORT_SEND_INTERVAL"))}appendSessionId(){this.clientList.forEach((e=>{if(e._sessionId){const t=this.apiInvokeUploadPendingItems.length;for(let i=0;i<t;i++){const t=this.apiInvokeUploadPendingItems.shift();t&&(t.sid=e._sessionId,this.sendApiInvoke(Object.assign({},t)))}}}))}};var VS,FS,jS,BS,GS,WS,HS,KS,qS,YS,JS,XS,zS;t.on("REPORT_LOG_UPLOAD",(e=>{e.networkState=d.networkState,xS.reportApiInvoke(null,{name:"logUploadError",options:e,tag:l.TRACER})})),function(e){e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY"}(VS||(VS={})),function(e){e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver"}(FS||(FS={})),function(e){e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(jS||(jS={})),function(e){e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(BS||(BS={})),function(e){e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(GS||(GS={})),function(e){e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(WS||(WS={})),function(e){e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(HS||(HS={})),function(e){e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed"}(KS||(KS={})),function(e){e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback"}(qS||(qS={})),function(e){e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag"}(YS||(YS={})),function(e){e.PUBLISH_STATS="publish_stats",e.PUBLISH_RELATED_STATS="publish_related_stats",e.SUBSCRIBE_STATS="subscribe_stats",e.SUBSCRIBE_RELATED_STATS="subscribe_related_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.TRANSPORT_STATS="transport_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats"}(JS||(JS={})),function(e){e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list"}(XS||(XS={})),function(e){e.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",e.NEED_ANSWER="NEED_ANSWER",e.NEED_RENEGOTIATE="NEED_RENEGOTIATE",e.P2P_LOST="P2P_LOST",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NEED_UNPUB="NEED_UNPUB",e.NEED_UNSUB="NEED_UNSUB",e.NEED_UPLOAD="NEED_UPLOAD",e.NEED_CONTROL="NEED_CONTROL",e.START_RECONNECT="START_RECONNECT",e.END_RECONNECT="END_RECONNECT",e.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(zS||(zS={}));const QS={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,currentPacketLossRate:0},ZS={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},$S={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},eg={uplinkNetworkQuality:0,downlinkNetworkQuality:0},tg={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};var ig,ng,sg;!function(e){e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(ig||(ig={})),function(e){e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming"}(ng||(ng={})),function(e){e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(sg||(sg={}));const og={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},rg={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function ag(e,t){m(e.url,"".concat(t,".url"),1,1e3,!1),u(e.x)||p(e.x,"".concat(t,".x"),0,1e4),u(e.y)||p(e.y,"".concat(t,".y"),0,1e4),u(e.width)||p(e.width,"".concat(t,".width"),0,1e4),u(e.height)||p(e.height,"".concat(t,".height"),0,1e4),u(e.zOrder)||p(e.zOrder,"".concat(t,".zOrder"),0,255),u(e.alpha)||p(e.alpha,"".concat(t,".alpha"),0,1,!1)}const cg={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},dg={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var lg,hg,ug,pg,_g,Eg,mg,fg,Sg,gg,Tg,Rg,Cg;!function(e){e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address"}(lg||(lg={})),function(e){e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(hg||(hg={})),function(e){e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(ug||(ug={}));class Ig extends g{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),this.name="AgoraRTCException"}print(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(t,e)}throw(){super.throw(e)}}function vg(e){if(!e.channelName)throw new Ig(T.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof e.uid)throw new Ig(T.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&m(e.token,"info.token",1,2047),S(e.uid),R(e.channelName),!0}!function(e){e.CONNECT_FAILED="connect failed",e.CONNECT_TIMEOUT="connect timeout",e.WS_DISCONNECTED="websocket disconnected",e.REQUEST_TIMEOUT="request timeout",e.REQUEST_FAILED="request failed",e.WAIT_STATUS_TIMEOUT="wait status timeout",e.WAIT_STATUS_ERROR="wait status error",e.BAD_STATE="bad state",e.WS_ABORT="ws abort",e.AP_REQUEST_TIMEOUT="AP request timeout",e.AP_JSON_PARSE_ERROR="AP json parse error",e.AP_REQUEST_ERROR="AP request error",e.AP_REQUEST_ABORT="AP request abort"}(pg||(pg={})),function(e){e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile"}(_g||(_g={})),function(e){e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(Eg||(Eg={})),function(e){e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(mg||(mg={})),function(e){e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(fg||(fg={})),function(e){e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low"}(Sg||(Sg={})),function(e){e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal"}(gg||(gg={})),function(e){e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7"}(Tg||(Tg={})),function(e){e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel"}(Rg||(Rg={})),function(e){e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS"}(Cg||(Cg={}));const yg=[Cg.AFRICA,Cg.ASIA,Cg.CHINA,Cg.EUROPE,Cg.GLOBAL,Cg.INDIA,Cg.JAPAN,Cg.NORTH_AMERICA,Cg.OCEANIA,Cg.OVERSEA,Cg.SOUTH_AMERICA];var Ag;!function(e){e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL"}(Ag||(Ag={}));const wg={CHINA:{},ASIA:{CODE:Ag.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Ag.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Ag.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Ag.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","\tuap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Ag.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Ag.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Ag.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Ag.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Ag.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Ag.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Ag.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Ag.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Ag.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var Ng,Og,bg,Dg,Pg,Lg,kg,Mg,Ug,xg,Vg,Fg,jg,Bg,Gg,Wg,Hg,Kg;r&&(wg.CHINA={CODE:Ag.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(e){e.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(Ng||(Ng={}));class qg extends C{constructor(e,t){super(),this.onICEConnectionStateChange=void 0,this.onConnectionStateChange=void 0,this.onDTLSTransportStateChange=void 0,this.onDTLSTransportError=void 0,this.onICETransportStateChange=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoReceived=void 0,this.onFirstAudioDecoded=void 0,this.onFirstVideoDecoded=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0}}!function(e){e.SEND="sendonly",e.RECV="recvonly",e.SENDRECV="sendrecv",e.INACTIVE="inactive"}(Og||(Og={})),function(e){e.VIDEO="video",e.AUDIO="audio"}(bg||(bg={})),function(e){e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY"}(Dg||(Dg={})),function(e){e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(Pg||(Pg={})),function(e){e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack"}(Lg||(Lg={})),function(e){e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected"}(kg||(kg={})),function(e){e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState"}(Mg||(Mg={})),function(e){e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED"}(Ug||(Ug={})),function(e){e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED"}(xg||(xg={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Vg||(Vg={})),function(e){e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK"}(Fg||(Fg={})),function(e){e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback"}(jg||(jg={})),function(e){e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.SECURITY_POLICY_VIOLATION="security-policy-violation"}(Bg||(Bg={})),function(e){e[e.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",e[e.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",e[e.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",e[e.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",e[e.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",e[e.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",e[e.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",e[e.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",e[e.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",e[e.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",e[e.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",e[e.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",e[e.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",e[e.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",e[e.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",e[e.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",e[e.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",e[e.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",e[e.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",e[e.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(Gg||(Gg={})),function(e){e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED"}(Wg||(Wg={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Hg||(Hg={})),function(e){e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED"}(Kg||(Kg={}));const Yg={[jS.ACCESS_POINT]:{[WS.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[WS.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[WS.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[WS.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[WS.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[WS.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[WS.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[jS.UNILBS]:{[GS.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[GS.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[GS.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[GS.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[GS.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[GS.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[GS.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[GS.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[GS.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[GS.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[GS.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[GS.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[jS.STRING_UID_ALLOCATOR]:{[BS.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[BS.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[BS.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Jg(e){const t=Yg[Math.floor(e/1e4)];if(!t)return{desc:"unkonw error",retry:!1};const i=t[e%1e4];if(!i){if(Math.floor(e/1e4)===jS.ACCESS_POINT){const t=e%1e4;if("1"===t.toString()[0])return{desc:e.toString(),retry:!1};if("2"===t.toString()[0])return{desc:e.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}const Xg={[HS.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[HS.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[HS.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[HS.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[HS.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[HS.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[HS.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[HS.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[HS.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[HS.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[HS.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[HS.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[HS.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[HS.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[HS.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[HS.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[HS.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[HS.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[HS.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[HS.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[HS.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[HS.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[HS.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[HS.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[HS.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[HS.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[HS.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[HS.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[HS.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[HS.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[HS.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[HS.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[HS.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[HS.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[HS.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[HS.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[HS.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[HS.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[HS.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[HS.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[HS.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[HS.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[HS.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[HS.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[HS.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[HS.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[HS.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[HS.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[HS.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[HS.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[HS.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[HS.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[HS.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[HS.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[HS.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[HS.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[HS.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[HS.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[HS.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[HS.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[HS.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[HS.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[HS.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function zg(e){const t=Xg[e];return t||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function Qg(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Zg(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Qg(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Qg(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function $g(e){return e.every((e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING))}function eT(e,t){if("string"==typeof e)return e;const{proxy:i,host:n,port:s}=e;if(t){const e=h("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===e?"wss://".concat(n,"/ws/?p=").concat(Number(s)+150):"wss://".concat(n,":").concat(e,"/ws/?p=").concat(Number(s)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(n,"&p=").concat(s):"wss://".concat(n,":").concat(s)}const tT=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,iT=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,nT=/wss:\/\/(.+):([0-9]+)\/?/,sT=/wss:\/\/(.[^\/]+)\/?/;let oT=0;class rT{constructor(e,t){this.id=0,this.store=void 0,this.recordIndex=void 0,this.websockets=[],this.try443PortDuration=2e3,this.forceCloseWSDuration=5e3,this.try443PortTimeout=null,this.forceCloseTimeout=null,this.isTry443PortFailed=!1,this.isNormalPortFailed=!1,this.useDoubleDomain=!1,this.startTime=Date.now(),this.id=++oT,this.try443PortDuration=h("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const t=Date.now()-this.startTime;for(var i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];console.warn("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(t,"ms:"),...n)}createDoubleDomainWebSocket(e,t,i){this.logger("createDoubleDomainWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:i});const n=h("GATEWAY_DOMAINS"),s=Date.now(),o=[],r=n.find((t=>{var i;return Po(i=e.host).call(i,t)}));r||(this.useDoubleDomain=!1);const a=[];this.useDoubleDomain?n.forEach((i=>{a.push(eT(Zg(Zg({},e),{},{host:e.host.replace(r,i)}),t))})):a.push(eT(e,t));try{a.forEach((e=>{const t=new WebSocket(e);t.binaryType="arraybuffer",o.push(t),this.logger("ws is connecting:",t.url)}))}catch(n){if(this.logger("ws create failed"),o.forEach((e=>e.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createDoubleDomainWebSocket(e,t,i);if(!t&&443!==Number(e.port))return this.createDoubleDomainWebSocket(e,!0,i);throw new Ig(T.WS_ERR,"init websocket failed! Error: ".concat(n.toString()))}const c=I();this.store&&this.store.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},this.recordIndex),o.forEach((e=>{e.onopen=()=>{this.logger("onopen: ws ".concat(e.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((t=>{t!==e&&(t.onopen=null,t.onclose=null,t.onmessage=null,t.close(),this.logger("close backup websocket: ".concat(t.url)))})),this.websockets.length=0,c.resolve(e)},e.onclose=i=>{this.logger("onclose: ws ".concat(e.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(e.readyState)),t?this.isTry443PortFailed=$g(o):this.isNormalPortFailed=$g(o),this.logger("isTry443PortFailed: ".concat(this.isTry443PortFailed," isNormalPortFailed: ").concat(this.isNormalPortFailed)),(t&&this.isTry443PortFailed||!t&&this.isTry443PortFailed&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed"),c.reject(i))},e.onmessage=t=>this.logger("".concat(e.url," onmessage: ").concat(t.data))})),this.websockets.push(...o);return i||(()=>{const i=()=>{this.logger("closeUnOpenWebsocket 5s timeout, isWebsocket create: ",c.isResolved),this.websockets.forEach((e=>e.readyState!==WebSocket.OPEN&&e.close()))};if(t)return this.logger("add 5s timeout at try-443 condition"),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket create: ",c.isResolved),c.isResolved)return i();this.createDoubleDomainWebSocket(e,!0,!0).then((e=>{c.resolve(e)})).catch((e=>{this.isNormalPortFailed&&c.reject(e),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration)}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(t,i,n,s){return this.useDoubleDomain=!!i,"string"==typeof t&&(t=function(t){let i,n,s;return[,i,n,s]=t.match(tT)||[],i||([,n,s]=t.match(iT)||[]),n&&s||([,n,s]=t.match(nT)||[]),n&&s||([,n]=t.match(sT)||[]),n||e.warning("un-destructible url: ",t),{proxy:i,host:n,port:s||"443"}}(t)),this.recordIndex=s,this.createDoubleDomainWebSocket(t,!!n,!1).finally((()=>this.clearTimeout()))}}function aT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class cT extends C{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;Po(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(ig.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(ig.CONNECTED):"closed"===this._state?this.emit(ig.CLOSED):"failed"===this._state&&this.emit(ig.FAILED))}resetReconnectCount(t){e.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=new v("websocket"),this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=o,this.name=e,this.retryConfig=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?aT(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):aT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t),this.useCompress=i,this.tryDoubleDomain=n,this.use443PortOnly=s;const{timeout:r,timeoutFactor:a}=t,c=Math.max(300,Math.floor(3*r/5)),l=Math.max(1.2,Math.floor(8*a)/10);y.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=l),d.on(A.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===y.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=r,this.retryConfig.timeoutFactor=a))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=I(),t=this.urls[this.currentURLIndex];return this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(ig.CLOSED,(()=>{e.reject(new Ig(T.WS_DISCONNECT))})),this.once(ig.CONNECTED,e.resolve),e.promise}finally{i()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,i){if(!this.websocket)return void e.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==t&&(this.reconnectMode=t),e.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:i})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new Ig(T.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new Ig(T.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var i;const n=I();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const s=t=>{var i;null===(i=this.store)||void 0===i||i.signalChannelOpen(),e.debug("[".concat(this.name,"] websocket opened:"),t),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},o=async t=>{if(e.debug("[".concat(this.name,"] websocket close ").concat(this.websocket&&this.websocket.url,", code: ").concat(t.code,", reason: ").concat(t.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new Ig(T.WS_DISCONNECT,"websocket close: ".concat(t.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=t.reason,this.state="reconnecting");const i=b(this,ig.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,s=await this.reconnectWithAction(i);if("closed"===this.state)return void e.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!s)return n.reject(new Ig(T.WS_DISCONNECT,"websocket reconnect failed: ".concat(t.code))),this.close(!0);n.resolve()}},r=e=>{this.emit(ig.ON_MESSAGE,e)},a=t=>{e.warn("[".concat(this.connectionID,"] ws open error ").concat(t))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),h("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=h("GATEWAY_WSS_ADDRESS")),e.debug("[".concat(this.name,"] start connect, url: ").concat(t));const c=null===(i=this.store)||void 0===i?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const e=await this.chooseBestWebsocketConnection(t);this.websocket=e,s&&s(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=r,this.websocket.onerror=a,null===(d=this.store)||void 0===d||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(t){var l;if(e.warning("[choose-best-ws] chooseBestWebsocketConnection error: ".concat(t&&t.toString())),null===(l=this.store)||void 0===l||l.recordJoinChannelService({endTs:Date.now(),status:t instanceof Ig&&t.code===T.WS_ABORT?"aborted":"error",errors:[t]},c),"closed"===this.state)n.reject(new Ig(T.WS_DISCONNECT,"websocket is closed: ".concat(t.toString())));else if(t instanceof Ig&&t.code===T.WS_ERR){const i=new Ig(T.WS_ERR,"init websocket failed! Error: ".concat(t.toString()));e.error("[".concat(this.name,"]").concat(i)),n.reject(i)}else o&&o(t)}return n.promise}async reconnectWithAction(t){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;e.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||d.isOnline||!d.onlineWaiter||(this.onlineReconnectListener=d.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let n=!0;if(this.reconnectInterrupter=()=>n=!1,i){const i=w(this.reconnectCount,this.retryConfig);e.debug("[".concat(this.name,"] wait ").concat(i,"ms to reconnect websocket, mode: ").concat(t)),await yS.race([N(i),this.onlineReconnectListener||new yS((()=>{}))])}if("closed"===this._state||!n)return!1;this.reconnectCount+=1;const s=async(e,t)=>{this.emit(ig.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===t)this.emit(ig.RECONNECT_WAITTING_FINISH,t),await s(this.urls[this.currentURLIndex],t);else if("tryNext"===t){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);e.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(ig.RECONNECT_WAITTING_FINISH,t),await s(this.urls[this.currentURLIndex],t)}else"recover"===t&&(e.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(ig.RECONNECT_WAITTING_FINISH,t),this.urls=await O(this,ig.REQUEST_NEW_URLS),this.currentURLIndex=0,await s(this.urls[this.currentURLIndex],t))}catch(n){var o;e.error("[".concat(this.name,"] reconnect failed ").concat(n&&n.toString()));const s=null==n||null===(o=n.data)||void 0===o?void 0:o.desc;return Array.isArray(s)&&Po(s).call(s,"dynamic key expired")?(this.emit(ig.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(t,i)}return!0}async chooseBestWebsocketConnection(t,i){const n=I(),s=function(e,t){return new rT(e,t)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{e.debug("[choose-best-ws] close establishing websockets"),s.closeAllWebsockets(),n.reject(new Ig(T.WS_ABORT,"choose best websocket aborted"))};const o=h("GATEWAY_DOMAINS");return e.debug("[choose-best-ws] currentDomain: ",t,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),s.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,i).then(n.resolve).catch(n.reject),n.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class dT extends C{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===KS.CONNECTED?this.emit(qS.WS_CONNECTED):e===KS.RECONNECTING?this.emit(qS.WS_RECONNECTING,this._websocketReconnectReason):e===KS.CLOSED&&this.emit(qS.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=KS.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new D(5),this.pingpongTimer=void 0,this.wsInflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(qS.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){if(this.emit(t._type,t._message),t._type===XS.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===XS.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(P.UID_BANNED);break;case 15:this.close(P.IP_BANNED);break;case 16:this.close(P.CHANNEL_BANNED)}if(t._type===XS.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case HS.ERR_LICENSE_MISSING:this.close(P.LICENSE_MISSING);break;case HS.ERR_LICENSE_EXPIRED:this.close(P.LICENSE_EXPIRED);break;case HS.ERR_LICENSE_MINUTES_EXCEEDED:this.close(P.LICENSE_MINUTES_EXCEEDED);break;case HS.ERR_LICENSE_PERIOD_INVALID:this.close(P.LICENSE_PERIOD_INVALID);break;case HS.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(P.LICENSE_MULTIPLE_SDK_SERVICE);break;case HS.ERR_LICENSE_ILLEGAL:this.close(P.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new cT("gateway-".concat(this.clientId),this.spec.retryConfig,!0,h("JOIN_GATEWAY_USE_DUAL_DOMAIN"),h("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===KS.CONNECTED&&this.reconnect("retry",L.OFFLINE)}))}async request(t,i,n,s){const o=k(6,""),r={_id:o,_type:t,_message:i},a=this.websocket.connectionID,c=()=>new yS(((e,i)=>{if(this.connectionState===KS.CONNECTED)return e();const n=()=>{this.off(qS.WS_CLOSED,s),e()},s=()=>{this.off(qS.WS_CONNECTED,n),i(new Ig(T.WS_ABORT))};this.once(qS.WS_CONNECTED,n),this.once(qS.WS_CLOSED,s),t!==YS.PUBLISH&&t!==YS.SUBSCRIBE&&t!==YS.UNSUBSCRIBE&&t!==YS.UNPUBLISH&&t!==YS.CONTROL&&t!==YS.RESTART_ICE||this.once(qS.DISCONNECT_P2P,(()=>{i(new Ig(T.DISCONNECT_P2P))})),t!==YS.PUBLISH&&t!==YS.RESTART_ICE||this.once(qS.ABORT_P2P_EXECUTION,(()=>{i(new Ig(T.DISCONNECT_P2P))}))}));if(this.connectionState!==KS.CONNECTING&&this.connectionState!==KS.RECONNECTING||t===YS.JOIN||t===YS.REJOIN||await c(),this.websocket.sendMessage(r,!0),s)return;const d=new yS(((n,s)=>{let r=!1;const c=(e,s)=>{r=!0,n({isSuccess:"success"===e,message:s||{}}),this.off(qS.WS_CLOSED,d),this.off(qS.WS_RECONNECTING,d),this.emit(qS.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(o),c);const d=()=>{s(new Ig(T.WS_ABORT,"type: ".concat(t))),this.off(qS.WS_CLOSED,d),this.off(qS.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(qS.WS_CLOSED,d),this.once(qS.WS_RECONNECTING,d),N(h("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||r||(e.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(qS.REQUEST_TIMEOUT,t,i))}))}));let l=null;try{l=await d}catch(e){if(this.connectionState===KS.CLOSED||t===YS.LEAVE)throw new Ig(T.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?e.throw():t===YS.JOIN||t===YS.REJOIN?null:(await c(),await this.request(t,i))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=zg(u),_=new Ig(T.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return"success"===p.action?l.message:(e.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===HS.ERR_TOO_MANY_BROADCASTERS?t===YS.JOIN||t===YS.REJOIN?(this.initError=_,this.close(),_.throw()):_.throw():"failed"===p.action?_.throw():"quit"===p.action?(this.initError=_,this.close(),_.throw()):(u===HS.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,e.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",L.MULTI_IP)):this.reconnect(p.action,L.SERVER_ERROR),t===YS.JOIN||t===YS.REJOIN?null:await this.request(t,i)))}waitMessage(e,t){return new yS((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=h("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==KS.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),h("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new yS(((t,i)=>{this.once(qS.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(qS.WS_CLOSED,(()=>i(this.initError||new Ig(T.WS_ABORT)))),this.connectionState=KS.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||P.LEAVE,this.connectionState=KS.CLOSED,e.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===P.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new cT("gateway-".concat(this.clientId),this.spec.retryConfig,!0,h("JOIN_GATEWAY_USE_DUAL_DOMAIN"),h("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(qS.ABORT_P2P_EXECUTION);const e=await O(this,qS.REQUEST_JOIN_INFO),t=await this.request(YS.JOIN,e);if(!t)return this.emit(qS.REPORT_JOIN_GATEWAY,T.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(qS.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=KS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Ig(T.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=M(this,qS.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(YS.REJOIN,e);return!!t&&(this.connectionState=KS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(XS.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(XS.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(XS.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(XS.MUTE_AUDIO,{uid:e.uid}):this.emit(XS.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(XS.MUTE_VIDEO,{uid:e.uid}):this.emit(XS.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(XS.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(XS.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(XS.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(XS.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(XS.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(t){e.debug("[".concat(this.clientId,"] receive notification: "),t);const i=zg(t.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(P.UID_BANNED),void this.close()):void this.reconnect(i.action,L.SERVER_ERROR);e.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=h("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(e.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>h("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",L.TIMEOUT):this.request(YS.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),h("REPORT_STATS")&&this.send(YS.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(JS.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(ig.RECONNECT_WAITTING_FINISH,(e=>{this.emit(qS.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(ig.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(qS.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(ig.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ig.CLOSED,(()=>{this.connectionState=KS.CLOSED})),this.websocket.on(ig.FAILED,(()=>{this._disconnectedReason=P.NETWORK_ERROR,this.connectionState=KS.CLOSED})),this.websocket.on(ig.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===KS.CONNECTED?this.connectionState=KS.RECONNECTING:this.connectionState=KS.CONNECTING})),this.websocket.on(ig.WILL_RECONNECT,((t,i)=>{if(M(this,qS.IS_P2P_DISCONNECTED)&&"retry"===t)return e.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(qS.NEED_RENEW_SESSION),this.emit(qS.DISCONNECT_P2P),i("tryNext");"retry"!==t&&(e.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(qS.NEED_RENEW_SESSION),this.emit(qS.DISCONNECT_P2P)),i(t)})),this.websocket.on(ig.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{e.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",L.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(qS.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof Ig&&t.code===T.UNEXPECTED_RESPONSE&&t.data.code===HS.ERR_NO_AUTHORIZED)return e.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",L.SERVER_ERROR);e.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",L.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(ig.REQUEST_NEW_URLS,((e,t)=>{O(this,qS.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(ig.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(XS.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}var lT="\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff",hT=$t,uT=So,pT=lT,_T=pt("".replace),ET=RegExp("^["+pT+"]+"),mT=RegExp("(^|[^"+pT+"])["+pT+"]+$"),fT=function(e){return function(t){var i=uT(hT(t));return 1&e&&(i=_T(i,ET,"")),2&e&&(i=_T(i,mT,"$1")),i}},ST={start:fT(1),end:fT(2),trim:fT(3)},gT=Zl.PROPER,TT=at,RT=lT,CT=ST.trim;Ls({target:"String",proto:!0,forced:function(e){return TT((function(){return!!RT[e]()||"âÂá "!=="âÂá "[e]()||gT&&RT[e].name!==e}))}("trim")},{trim:function(){return CT(this)}});var IT,vT=$s("String").trim,yT=_t,AT=vT,wT=String.prototype,NT=rt((function(e){var t=e.trim;return"string"==typeof e||e===wT||yT(wT,e)&&t===wT.trim?AT:t}));!function(e){e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"}(IT||(IT={}));class OT extends C{constructor(){super(...arguments),this.resultStorage=new Map}setLocalAudioStats(e,t,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,t))}setLocalVideoStats(e,t,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i))}setRemoteAudioStats(e,t){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(t))}record(e,t,i){if(h("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const n=this.resultStorage.get(e);if(n&&(n.result.push(i),n.result.length>=5)){var s;const i=Po(s=n.result).call(s,!0);n.isPrevNormal&&!i&&this.emit("exception",bT[e],e,t),!n.isPrevNormal&&i&&this.emit("exception",bT[e]+2e3,e+"_RECOVER",t),n.isPrevNormal=i,n.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof De&&!t.isActive||(!!t.muted||0!==e.sendVolumeLevel)}checkFramerateInput(e,t){let i=null;t._encoderConfig&&t._encoderConfig.frameRate&&(i=FT(t._encoderConfig.frameRate));const n=e.captureFrameRate;return!i||!n||!(i>10&&n<5||i<10&&i>=5&&n<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof De&&!t.isActive||(!!t.muted||0!==e.sendBitrate)}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const bT={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003};const DT=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}};function PT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function LT(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?PT(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):PT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class kT{constructor(e){this.store=void 0,this.onStatsException=void 0,this.onUploadPublishDuration=void 0,this.onStatsChanged=void 0,this.localStats=new Map,this.remoteStats=new Map,this.updateStatsInterval=void 0,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0,this.exceptionMonitor=void 0,this.p2pChannel=void 0,this.scalabilityMode=VS.L1T1,this.updateStats=()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))},this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new OT,this.exceptionMonitor.on("exception",((e,t,i)=>{this.onStatsException&&this.onStatsException(e,t,i)}))}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(Lg.LocalAudioTrack)||LT({},QS)}getLocalVideoTrackStats(){return this.localStats.get(Lg.LocalVideoTrack)||LT({},ZS)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.audioStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{audioStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRemoteNetworkQualityStats(e){const t={};if(e){var i;const n=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.networkStats;n&&(t[e]=n)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{networkStats:n}]=e;n&&(t[i]=n)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.videoStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{videoStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRTCStats(){let e=0,t=0,i=0,n=0;const s=this.localStats.get(Lg.LocalAudioTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate);const o=this.localStats.get(Lg.LocalVideoTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate);const r=this.localStats.get(Lg.LocalVideoLowTrack);r&&(e+=r.sendBytes,t+=r.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:s}=e;t&&(i+=t.receiveBytes,n+=t.receiveBitrate),s&&(i+=s.receiveBytes,n+=s.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:t,SendBytes:e,RecvBytes:i,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd));e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const i=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),n=null!=i&&i.videoSSRC?DT.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=null!=i&&i.audioSSRC?DT.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,n>s?n:s),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&e.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(e,t,i){if(!e)return!1;const n=!!i&&t.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||t.framesDecodeCount>i.framesDecodeCount;return n||!s}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&(e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3)}updateLocalStats(t){Array.from(this.localStats.entries()).forEach((i=>{let[n,s]=i;switch(n){case Lg.LocalVideoTrack:case Lg.LocalVideoLowTrack:{const i=s,r=LT({},ZS),a=t.getStats(),c=t.getLocalMedia(n);if(a){const n=a.videoSend.find((e=>e.ssrc===(null==c?void 0:c.ssrcs[0].ssrcId)));if(n){const s=t.getLocalVideoSize(),o=t.getEncoderConfig(Lg.LocalVideoTrack);"H264"!==n.codec&&"H265"!==n.codec&&"VP8"!==n.codec&&"VP9"!==n.codec&&"AV1X"!==n.codec&&"AV1"!==n.codec||(r.codecType=n.codec),r.sendBytes=n.bytes,r.sendBitrate=i?8*Math.max(0,r.sendBytes-i.sendBytes):0,n.inputFrame?(r.captureFrameRate=n.inputFrame.frameRate,r.captureResolutionHeight=n.inputFrame.height,r.captureResolutionWidth=n.inputFrame.width):s&&(r.captureResolutionWidth=s.width,r.captureResolutionHeight=s.height),n.sentFrame?(r.sendFrameRate=n.sentFrame.frameRate,r.sendResolutionHeight=n.sentFrame.height,r.sendResolutionWidth=n.sentFrame.width):s&&(r.sendResolutionWidth=s.width,r.sendResolutionHeight=s.height),n.avgEncodeMs&&(r.encodeDelay=n.avgEncodeMs),o&&o.bitrateMax&&(r.targetSendBitrate=1e3*o.bitrateMax),r.sendPackets=n.packets,r.sendPacketsLost=n.packetsLost,r.totalDuration=i?i.totalDuration+1:1,r.totalFreezeTime=i?i.totalFreezeTime:0,this.isLocalVideoFreeze(n)&&(r.totalFreezeTime+=1),n.scalabilityMode&&this.scalabilityMode!==n.scalabilityMode&&(e.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(n.scalabilityMode)),this.scalabilityMode=n.scalabilityMode)}this.trafficStats&&(r.sendPacketsLost=this.trafficStats.B_pvlr4/100)}var o;if(this.localStats.set(n,r),(null==i?void 0:i.sendResolutionWidth)!==r.sendResolutionWidth||(null==i?void 0:i.sendResolutionHeight)!==r.sendResolutionHeight)null===(o=this.onStatsChanged)||void 0===o||o.call(this,"resolution",{width:r.sendResolutionWidth,height:r.sendResolutionHeight});r&&c&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,c.track,r);break}case Lg.LocalAudioTrack:{const e=s,i=LT({},QS),o=t.getStats(),r=t.getLocalMedia(n);if(o){const n=o.audioSend.find((e=>e.ssrc===(null==r?void 0:r.ssrcs[0].ssrcId)));if(n){if("opus"!==n.codec&&"aac"!==n.codec&&"PCMU"!==n.codec&&"PCMA"!==n.codec&&"G722"!==n.codec||(i.codecType=n.codec),n.inputLevel)i.sendVolumeLevel=Math.round(32767*n.inputLevel);else{const e=t.getLocalAudioVolume();e&&(i.sendVolumeLevel=Math.round(32767*e))}i.sendBytes=n.bytes,i.sendPackets=n.packets,i.sendPacketsLost=n.packetsLost,i.sendBitrate=e?8*Math.max(0,i.sendBytes-e.sendBytes):0}}this.trafficStats&&(i.sendPacketsLost=this.trafficStats.B_pvlr4/100),this.localStats.set(Lg.LocalAudioTrack,i),i&&r&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,r.track,i);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{let[i,{videoStats:n,audioStats:s,videoPcStats:o}]=t;const r=s,a=n,c=o,d=LT({},$S),l=LT({},tg),h=LT({},eg),{audioTrack:u,videoTrack:p,audioSSRC:_,videoSSRC:E}=e.getRemoteMedia(i),m=e.getStats(),f=null==m?void 0:m.audioRecv.find((e=>e.ssrc===_)),S=null==m?void 0:m.videoRecv.find((e=>e.ssrc===E)),g=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===i));if(f&&("opus"!==f.codec&&"aac"!==f.codec&&"PCMU"!==f.codec&&"PCMA"!==f.codec&&"G722"!==f.codec||(d.codecType=f.codec),f.outputLevel?d.receiveLevel=Math.round(32767*f.outputLevel):u&&(d.receiveLevel=Math.round(32767*u.getVolumeLevel())),d.receiveBytes=f.bytes,d.receivePackets=f.packets,d.receivePacketsLost=f.packetsLost,d.packetLossRate=d.receivePacketsLost/(d.receivePackets+d.receivePacketsLost),d.receiveBitrate=r?8*Math.max(0,d.receiveBytes-r.receiveBytes):0,d.totalDuration=r?r.totalDuration+1:1,d.totalFreezeTime=r?r.totalFreezeTime:0,d.freezeRate=d.totalFreezeTime/d.totalDuration,d.receiveDelay=f.jitterBufferMs,d.totalDuration>10&&kT.isRemoteAudioFreeze(u)&&(d.totalFreezeTime+=1)),S){"H264"!==S.codec&&"H265"!==S.codec&&"VP8"!==S.codec&&"VP9"!==S.codec&&"AV1X"!==S.codec&&"AV1"!==S.codec||(l.codecType=S.codec),l.receiveBytes=S.bytes,l.receiveBitrate=a?8*Math.max(0,l.receiveBytes-a.receiveBytes):0,l.decodeFrameRate=S.decodeFrameRate<0?0:S.decodeFrameRate,l.renderFrameRate=S.decodeFrameRate<0?0:S.decodeFrameRate,S.outputFrame&&(l.renderFrameRate=S.outputFrame.frameRate),S.receivedFrame?(l.receiveFrameRate=S.receivedFrame.frameRate,l.receiveResolutionHeight=S.receivedFrame.height,l.receiveResolutionWidth=S.receivedFrame.width):p&&(l.receiveResolutionHeight=p._videoHeight||0,l.receiveResolutionWidth=p._videoWidth||0),void 0!==S.framesRateFirefox&&(l.receiveFrameRate=Math.round(S.framesRateFirefox)),l.receivePackets=S.packets,l.receivePacketsLost=S.packetsLost,l.packetLossRate=l.receivePacketsLost/(l.receivePackets+l.receivePacketsLost),l.totalDuration=a?a.totalDuration+1:1,l.totalFreezeTime=a?a.totalFreezeTime:0,l.receiveDelay=S.jitterBufferMs||0;const t=!!E&&e.getRemoteVideoIsReady(E);p&&t&&kT.isRemoteVideoFreeze(p,S,c)&&(l.totalFreezeTime+=1),l.freezeRate=l.totalFreezeTime/l.totalDuration}g&&(d.end2EndDelay=g.B_ad,l.end2EndDelay=g.B_vd,d.transportDelay=g.B_ed,l.transportDelay=g.B_ed,d.currentPacketLossRate=g.B_ealr4/100,l.currentPacketLossRate=g.B_evlr4/100,h.uplinkNetworkQuality=g.B_punq?g.B_punq:0,h.downlinkNetworkQuality=g.B_pdnq?g.B_pdnq:0),this.remoteStats.set(i,{audioStats:d,videoStats:l,videoPcStats:S,networkStats:h}),u&&this.exceptionMonitor.setRemoteAudioStats(u,d),p&&this.exceptionMonitor.setRemoteVideoStats(p,l)}))}}function MT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function UT(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?MT(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):MT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function xT(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(h("TURN_DOMAIN")):(e.info("Cannot recognized as IP address ".concat(t,". Used As Host instead")),t)}function VT(t,i){var n,s;const o=h("GATEWAY_DOMAINS");let r=o[1]&&-1!==i.indexOf(o[1])?1:0;t.addresses=t.addresses||[];const a=t.addresses.map((t=>t.domain_prefix?{address:"".concat(t.domain_prefix,".").concat(o[r++%o.length],":").concat(t.port)}:t.ip.match(/^[\.\:\d]+$/)?{ip:t.ip,port:t.port,address:"".concat(t.ip.replace(/[^\d]/g,"-"),".").concat(o[r++%o.length],":").concat(t.port)}:(e.info("Cannot recognized as IP address ".concat(t.ip,". Used As Host instead")),{ip:t.ip,port:t.port,address:"".concat(t.ip,":").concat(t.port)})));if(null!==(n=t.detail)&&void 0!==n&&n[18]&&"string"==typeof(null===(s=t.detail)||void 0===s?void 0:s[18])){const e=t.detail[18],i=null==e?void 0:e.split(";");for(let e=0;e<i.length;e++){var c;const t=NT(c=i[e]).call(c);a[e]&&t&&(a[e].ip6=t)}}return{gatewayAddrs:a,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function FT(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function jT(e){const t=e._encoderConfig;if(!t)return{};const i={resolution:t.width&&t.height?"".concat(FT(t.width),"x").concat(FT(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return"number"==typeof t.frameRate?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function BT(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function GT(e,t){let i,n,s;switch(t){case IT.CHOOSE_SERVER:n=4096,s="choose server";break;case IT.CLOUD_PROXY:n=1048576,s="proxy";break;case IT.CLOUD_PROXY_5:n=4194304,s="proxy5";break;case IT.CLOUD_PROXY_FALLBACK:n=4194310,s="proxy fallback";break;default:throw new Ig(T.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((t=>{t.buffer&&t.buffer.flag===n&&(i={code:t.buffer.code,addresses:(t.buffer.edges_services||[]).map((e=>UT(UT({},e),{},{ticket:t.buffer.cert}))),server_ts:e.enter_ts,uid:t.buffer.uid,cid:t.buffer.cid,cname:t.buffer.cname,detail:UT(UT({},t.buffer.detail),e.detail),flag:t.buffer.flag,opid:e.opid,cert:t.buffer.cert})})),!i)throw new Ig(T.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(s," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return i}async function WT(e,t){return await yS.all(e.addresses.map((async e=>({address:xT(e.ip),tcpport:e.port,udpport:e.port,username:t&&h("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():ko.username,password:t&&h("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await U(t.toString()):ko.password}))))}function HT(t,i){const n=i._videoHeight||i.getMediaStreamTrack(!0).getSettings().height;return n?Math.max(n/FT(t.height),1):(e.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function KT(e){let{candidateType:t,relayProtocol:i,type:n,address:s,port:o,protocol:r}=e;return"local-candidate"===n?{candidateType:t,relayProtocol:i,protocol:r}:{candidateType:t,relayProtocol:i,address:s,port:o,protocol:r}}function qT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class YT extends C{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;Po(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(jg.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(jg.CONNECTED):"closed"===this._state?this.emit(jg.CLOSED):"failed"===this._state&&this.emit(jg.FAILED))}constructor(e,t,i,n){super(),this.connectionID=0,this.currentURLIndex=0,this.reconnectReason=void 0,this._reconnectMode="tryNext",this._name=void 0,this._state="closed",this._retryConfig=void 0,this._reconnectCount=0,this._forceCloseTimeout=5e3,this._onlineReconnectListener=void 0,this._closeEstablishingTransmitter=()=>{},this._store=void 0,this._joinChannelServiceRecordIndex=void 0,this._useCompress=void 0,this._inflateLength=0,this._deflateLength=0,this._store=n,this._name=e,this._retryConfig=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?qT(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):qT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t),this._useCompress=i}resetReconnectCount(t){e.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const e=this._transmitter;t?setTimeout((()=>e.close()),500):e.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,i){if(!this._transmitter)return void e.warning("[".concat(this._name,"] can not reconnect, no websocket"));var n;(void 0!==t&&(this.reconnectMode=t),e.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex)&&(null===(n=this._store)||void 0===n||n.recordJoinChannelService({status:"error",errors:[new Error(i)]},this._joinChannelServiceRecordIndex));const s=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),s&&s.bind(this._transmitter)({code:9999,reason:i})}getInflateData(){const e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}var JT;!function(e){e[e.Default=0]="Default",e[e.Ack=1]="Ack"}(JT||(JT={}));class XT{constructor(e,t,i){this.version=1,this.initialRTO=void 0,this.maxBatchAckCount=void 0,this.maxRTO=void 0,this.initialRTT=void 0,this.ID=void 0,this.rtt=void 0,this.packetNumber=1,this.rtoRatioMap=new Map,this.timeoutMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer=void 0,this.sendImpl=void 0,this.receiveImpl=void 0,this.sendImpl=e,this.receiveImpl=t,this.ID=k(7,"transmitter-"),this.initialRTO=void 0!==(null==i?void 0:i.initialRTO)?i.initialRTO:h("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:h("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:h("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==i?void 0:i.maxBatchAckCount)?i.maxBatchAckCount:h("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==i?void 0:i.maxRTO)?i.maxRTO:h("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:JT.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case JT.Default:{let t;if("string"==typeof e.payload){t=(new TextEncoder).encode(e.payload)}else t=e.payload;const i=new ArrayBuffer(t.length+15),n=new DataView(i);n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.packetNumber),x(n,7,BigInt(e.sendTs));return new Uint8Array(n.buffer).set(t,15),i}case JT.Ack:{const t=new ArrayBuffer(16),i=new DataView(t);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),x(i,8,BigInt(e.ackSendTs)),t}}}deserialize(t){const i=new DataView(t),n=i.getUint16(0),s=i.getUint8(2);switch(s){case JT.Default:{const e=i.getUint32(3),o=V(i,7),r=t.slice(15),a=(new TextDecoder).decode(r);return{version:n,type:s,packetNumber:e,sendTs:Number(o),payload:a}}case JT.Ack:{const e=i.getUint32(3),t=i.getUint8(7),o=V(i,8);return{version:n,type:s,maxAckPacketNumber:e,shift:t,ackSendTs:Number(o)}}default:throw e.error("[".concat(this.ID,"] Unrecognized packet type ").concat(s)),new Error("Unrecognized packet type ".concat(s))}}sendMessage(e){const t=this.packetize(e,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const i=this.calculateRTO(t),n=window.setTimeout((()=>{this.resendMessage(t)}),i);this.timeoutMap.set(t.packetNumber,n),this.sendPacket(t)}onData(e){const t=this.deserialize(e);t.type===JT.Default?this.ack(t):t.type===JT.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[t,i]=e;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const t=this.calculateRTO(e),i=window.setTimeout((()=>{this.resendMessage(e)}),t);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){const t=this.rtoRatioMap.get(e.packetNumber);if(void 0===t)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,t){const i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:JT.Ack,version:this.version};this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:JT.Ack,version:this.version};this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:JT.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===JT.Default&&(e.sendTs=Math.round(performance.now()));const t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){const e=this.timeoutMap.get(t);void 0!==e&&window.clearTimeout(e),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class zT extends YT{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),this._initMutex=void 0,this._reconnectInterrupter=void 0,this._url=void 0,this._transmitter=void 0,this._addresses=void 0,this._reliableTransmission=void 0,this._initMutex=new v("datachannel");const{timeout:i,timeoutFactor:n}=t,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*n)/10);y.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),d.on(A.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===y.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=n))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=t;const i=(t,i)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((e=>e.fingerprint||h("FINGERPRINT")));const n=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(n).then(t).catch(i),this.once(jg.CLOSED,(()=>i(new Ig(T.WS_DISCONNECT)))),this.once(jg.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new yS(((e,t)=>{i(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new Ig(T.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(e){throw new Ig(T.WS_ERR,"send datachannel signal message error"+e.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new yS(((i,n)=>{var s;const o=()=>{e.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},r=async t=>{var s;if(null===(s=this._closeEstablishingTransmitter)||void 0===s||s.call(this),e.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(t.code,", reason: ").concat(t.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=t.reason,this.state="reconnecting");const s=b(this,jg.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,o=await this.reconnectWithAction(s);if("closed"===this.state)return void e.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!o)return n(new Ig(T.WS_DISCONNECT,"datachannel reconnect failed: ".concat(t.code))),void this.close(!0);i()}else n(new Ig(T.WS_DISCONNECT,"datachannel close: ".concat(t.code))),this.close()},a=e=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.onData(e.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),e.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const c=null===(s=this._store)||void 0===s?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();O(this,jg.TO_CONNECT_DATACHANNEL,t).then((t=>{var i,n;if(!t)throw new Error("transmissonInfo not exist yet");const{transmitter:s,close:l}=t;this._transmitter=s,null===(i=this._store)||void 0===i||i.signalChannelOpen();const h=Date.now()-d;e.debug("[choose dc] dc open cost ".concat(h,"ms"));this._reliableTransmission=new XT((e=>{var t;this._transmitter&&"open"===this._transmitter.readyState&&(null===(t=this._transmitter)||void 0===t||t.send(e))}),(e=>{"string"==typeof e&&this.emit(jg.ON_MESSAGE,e)})),this._closeEstablishingTransmitter=()=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.close(),this._reliableTransmission=void 0,l()},o&&o(),s.onclose=r,s.onmessage=a,null===(n=this._store)||void 0===n||n.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c})).catch((t=>{var i;if(null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:t instanceof Ig&&t.code===T.WS_ABORT?"aborted":"error",errors:[t]},c),"closed"!==this.state){if(t instanceof Ig&&t.code===T.WS_ERR){const i=new Ig(T.WS_ERR,"init datachannel failed! Error: ".concat(t.toString()));return e.error("[".concat(this._name,"]").concat(i)),void n(i)}r&&r(t)}else n(new Ig(T.WS_DISCONNECT,"datachannel is closed: ".concat(t.toString())))}))}))}async reconnectWithAction(t){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||d.networkState!==y.OFFLINE||(this._onlineReconnectListener=d.onlineWaiter&&d.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let n=!0;if(this._reconnectInterrupter=()=>{n=!1},i){const i=w(this._reconnectCount,this._retryConfig);e.debug("[".concat(this._name,"] wait ").concat(i,"ms to reconnect datachannel, mode: ").concat(t)),await yS.race([N(i),this._onlineReconnectListener||new yS((()=>{}))])}if("closed"===this.state||!n)return!1;this._reconnectCount+=1;const s=async(e,t)=>{this.emit(jg.RECONNECT_CREATE_CONNECTION,t),await this.createTransmitterConnection(e)};try{if("retry"===t){const e=this._addresses[this.currentURLIndex];this.emit(jg.RECONNECT_WAITTING_FINISH,t),await s(e,t)}else if("tryNext"===t){this.currentURLIndex+=1;for(let e=this.currentURLIndex;e<this._addresses.length;e++){if(this._addresses[e].fingerprint||h("FINGERPRINT")){this.currentURLIndex=e;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return e.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);e.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const i=this._addresses[this.currentURLIndex];this.emit(jg.RECONNECT_WAITTING_FINISH,t),await s(i,t)}else"recover"===t&&(e.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(jg.RECONNECT_WAITTING_FINISH,t),this.emit(jg.FAILBACK));return!0}catch(n){var o,r;return e.error("[".concat(this._name,"] reconnect failed"),n.toString()),null!=n&&null!==(o=n.data)&&void 0!==o&&o.desc&&Array.isArray(n.data.desc)&&n.data.desc.length&&Po(r=n.data.desc).call(r,"dynamic key expired")?(this.emit(jg.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,i)}}}class QT extends C{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===KS.CONNECTED?this.emit(qS.WS_CONNECTED):e===KS.RECONNECTING?this.emit(qS.WS_RECONNECTING,this._websocketReconnectReason):e===KS.CLOSED&&this.emit(qS.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=KS.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new D(5),this.pingpongTimer=void 0,this.inflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e instanceof ArrayBuffer)return void this.emit(qS.ON_BINARY_DATA,e);const t=JSON.parse(e);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")&&(this.emit(t._type,t._message),t._type===XS.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===XS.ON_USER_BANNED))switch(t._message.error_code){case 14:this.close(P.UID_BANNED);break;case 15:this.close(P.IP_BANNED);break;case 16:this.close(P.CHANNEL_BANNED)}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new zT("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===KS.CONNECTED&&this.reconnect("retry",Fg.OFFLINE)}))}async request(t,i,n,s){const o=k(6,""),r={_id:o,_type:t,_message:i},a=this.websocket.connectionID,c=()=>new yS(((e,i)=>{if(this.connectionState===KS.CONNECTED)return e();const n=()=>{this.off(qS.WS_CLOSED,s),e()},s=()=>{this.off(qS.WS_CONNECTED,n),i(new Ig(T.WS_ABORT))};this.once(qS.WS_CONNECTED,n),this.once(qS.WS_CLOSED,s),t!==YS.PUBLISH&&t!==YS.SUBSCRIBE&&t!==YS.UNSUBSCRIBE&&t!==YS.UNPUBLISH&&t!==YS.CONTROL&&t!==YS.RESTART_ICE||this.once(qS.DISCONNECT_P2P,(()=>{i(new Ig(T.DISCONNECT_P2P))})),t!==YS.PUBLISH&&t!==YS.RESTART_ICE||this.once(qS.ABORT_P2P_EXECUTION,(()=>{i(new Ig(T.DISCONNECT_P2P))}))}));if(this.connectionState!==KS.CONNECTING&&this.connectionState!==KS.RECONNECTING||t===YS.JOIN||t===YS.REJOIN||await c(),t===YS.LEAVE&&(this.websocket.unbindDcCloseEventListener(),s=!0),this.websocket.sendMessage(r,!0,!1),s)return;const d=new yS(((n,s)=>{let r=!1;const c=(e,s)=>{r=!0,n({isSuccess:"success"===e,message:s||{}}),this.off(qS.WS_CLOSED,d),this.off(qS.WS_RECONNECTING,d),this.emit(qS.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(o),c);const d=()=>{s(new Ig(T.WS_ABORT,"type: ".concat(t))),this.off(qS.WS_CLOSED,d),this.off(qS.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(qS.WS_CLOSED,d),this.once(qS.WS_RECONNECTING,d),N(h("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||r||(e.warning("dc request timeout, type: ".concat(t)),this.emit(qS.REQUEST_TIMEOUT,t,i))}))}));let l=null;try{l=await d}catch(e){if(this.connectionState===KS.CLOSED||t===YS.LEAVE)throw new Ig(T.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?e.throw():t===YS.JOIN||t===YS.REJOIN?null:(await c(),await this.request(t,i))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=zg(u),_=new Ig(T.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return"success"===p.action?l.message:(e.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===HS.ERR_TOO_MANY_BROADCASTERS?t===YS.JOIN||t===YS.REJOIN?(this.initError=_,this.close(),_.throw()):_.throw():"failed"===p.action?_.throw():"quit"===p.action?(this.initError=_,this.close(),_.throw()):(u===HS.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,e.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Fg.MULTI_IP)):this.reconnect(p.action,Fg.SERVER_ERROR),t===YS.JOIN||t===YS.REJOIN?null:await this.request(t,i)))}waitMessage(e,t){return new yS((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=h("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==KS.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),h("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(t,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new yS(((n,s)=>{this.once(qS.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(qS.WS_CLOSED,(()=>s(this.initError||new Ig(T.WS_ABORT)))),this.connectionState=KS.CONNECTING,this.websocket.init(t).catch(s),this.websocket.once(jg.FAILBACK,(()=>{void 0===this.openConnectionTime&&s(new Ig(T.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{i&&void 0===this.openConnectionTime&&(e.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),s(new Ig(T.INIT_DATACHANNEL_TIMEOUT)))}),h("DC_JOIN_WITH_FAILBACK"))}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||P.LEAVE,this.connectionState=KS.CLOSED,e.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===P.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new zT("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(qS.ABORT_P2P_EXECUTION);const e=await O(this,qS.DATACHANNEL_CONNECTING),t=await this.request(YS.JOIN,e);if(!t)return this.emit(qS.REPORT_JOIN_GATEWAY,T.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(qS.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=KS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Ig(T.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=M(this,qS.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(YS.REJOIN,e);return!!t&&(this.connectionState=KS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(XS.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(XS.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(XS.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(XS.MUTE_AUDIO,{uid:e.uid}):this.emit(XS.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(XS.MUTE_VIDEO,{uid:e.uid}):this.emit(XS.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(XS.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(XS.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(XS.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(XS.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(XS.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(t){e.debug("[".concat(this.clientId,"] receive notification: "),t);const i=zg(t.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(P.UID_BANNED),void this.close()):void this.reconnect(i.action,Fg.SERVER_ERROR);e.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=h("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(e.warning("PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>h("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Fg.TIMEOUT):this.request(YS.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),h("REPORT_STATS")&&this.send(YS.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();0!==e&&0!==t&&this.upload(JS.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(jg.RECONNECT_WAITTING_FINISH,(e=>{this.emit(qS.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(jg.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(qS.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(jg.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(jg.CLOSED,(()=>{this.connectionState=KS.CLOSED})),this.websocket.on(jg.FAILED,(()=>{this._disconnectedReason=P.NETWORK_ERROR,this.connectionState=KS.CLOSED})),this.websocket.on(jg.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===KS.CONNECTED?this.connectionState=KS.RECONNECTING:this.connectionState=KS.CONNECTING})),this.websocket.on(jg.WILL_RECONNECT,((t,i)=>{if(M(this,qS.IS_P2P_DISCONNECTED)&&"retry"===t)return e.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(qS.NEED_RENEW_SESSION),this.emit(qS.DISCONNECT_P2P),i("tryNext");"retry"!==t&&(e.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(qS.NEED_RENEW_SESSION),this.emit(qS.DISCONNECT_P2P)),i(t)})),this.websocket.on(jg.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{e.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Fg.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(qS.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof Ig&&t.code===T.UNEXPECTED_RESPONSE&&t.data.code===HS.ERR_NO_AUTHORIZED)return e.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Fg.SERVER_ERROR);e.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Fg.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(jg.REQUEST_NEW_URLS,((e,t)=>{O(this,qS.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(jg.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(XS.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(jg.TO_CONNECT_DATACHANNEL,(async(e,t,i)=>O(this,qS.DATACHANNEL_PRECONNECT,e).then(t).catch(i))),this.websocket.on(jg.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(qS.DATACHANNEL_FAILBACK)}))}}function ZT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function $T(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ZT(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ZT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const eR=new Map;class tR extends C{get state(){return this._state}set state(e){if(e===this._state)return;const t=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(gg.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(gg.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){e.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(e,t){super(),this.store=void 0,this.joinInfo=void 0,this.key=void 0,this.signal=void 0,this.role=void 0,this.inChannelInfo={joinAt:null,duration:0},this.spec=void 0,this._state="DISCONNECTED",this._statsCollector=void 0,this._disconnectedReason=void 0,this.isSignalRecover=!1,this.hasChangeBGPAddress=!1,this.trafficStatsInterval=void 0,this.networkQualityInterval=void 0,this._joinGatewayStartTime=0,this._signalTimeout=!1,this._clientRoleOptions=void 0,this._isProactiveJoin=!1,this.store=e,this.spec=t,this.signal=this.store.useDataChannel?new QT($T($T({},t),{},{retryConfig:t.websocketRetryConfig}),e):new dT($T($T({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(t,i,n){if(this.signal instanceof QT){let i=!1;"disabled"!==t.cloudProxyServer?(e.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),i=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(e.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),i=!0):t.apResponse.addresses.some((e=>e.fingerprint))||h("FINGERPRINT")||(e.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),i=!0),i&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==t.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const s=Date.now();let o=eR.get(t.cname);if(o||(o=new Map,eR.set(t.cname,o)),this._isProactiveJoin=!0,o.has(t.uid)){const e=new Ig(T.UID_CONFLICT);throw xS.joinGateway(t.sid,{lts:s,succ:!1,ec:e.message,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!t.proxyServer,signalChannel:this.signal instanceof QT?"1":"0"}),this._isProactiveJoin=!1,e}o.set(t.uid,!0),this.joinInfo=t,this.key=i;let r=0;this.joinGatewayStartTime=s;const a=t.proxyServer;try{let i;if(e.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof QT?"datachannel":"websocket"," join uid ").concat(r)),this.signal instanceof QT)i=await this.signal.init(t.apResponse.addresses,n);else{const e=t.gatewayAddrs.map((e=>{let{address:i}=e;const[n,s]=i.split(":"),o={host:n,port:s};return t.proxyServer&&(o.proxy=t.proxyServer),o}));i=await this.signal.init(e,n)}r=i.uid,e.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof QT?"datachannel":"websocket"," join uid ").concat(r," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(i){if(i&&i.code===T.INIT_WEBSOCKET_TIMEOUT)throw e.warning("[".concat(this.store.clientId,"] User join failed"),i.toString()),i;if(i&&i.code===T.INIT_DATACHANNEL_TIMEOUT)throw e.warning("[".concat(this.store.clientId,"] User join datachannel failed"),i.toString()),this.resetSignal(),i;throw e.error("[".concat(this.store.clientId,"] User join failed"),i.toString()),xS.joinGateway(t.sid,{lts:s,succ:!1,ec:i.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!a,signalChannel:this.signal instanceof QT?"1":"0"}),this._isProactiveJoin=!1,o.delete(t.uid),this.signal.close(),i}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),e.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((t=>{e.warning("[".concat(this.store.clientId,"] get traffic stats error"),t.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(gg.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(gg.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(gg.NETWORK_QUALITY,{uplinkNetworkQuality:BT(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:BT(this._statsCollector.trafficStats.B_dnq)}):this.emit(gg.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),r}async leave(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){i!==P.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==KS.CONNECTED||await F(this.signal.request(YS.LEAVE,void 0,!0),3e3)}catch(t){e.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),t)}this.signal.close(i),i!==P.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ig(T.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:h("PUB_EXTEND"),twcc:!!h("PUBLISH_TWCC"),rtx:!!h("USE_PUB_RTX")};try{return(await this.signal.request(YS.PUBLISH,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===HS.ERR_PUBLISH_REQUEST_INVALID)return e.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(t,i),this.publish(t,i,!1);throw s}}async publishDataChannel(t,i,n){var s;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ig(T.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:null!==(s=i.maxRetransmits)&&void 0!==s?s:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(YS.PUBLISH_DATASTREAM,o,!0)}catch(s){if(n&&s.data&&s.data.code===HS.ERR_PUBLISH_REQUEST_INVALID)return e.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(t,i),this.publishDataChannel(t,i,!1);throw s}}async unpublish(t,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ig(T.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(YS.UNPUBLISH,{stream_id:i,ortc:t},!0)}catch(t){e.warning("[".concat(this.store.clientId,"] unpublish warning: "),t)}}async unpublishDataChannel(t){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ig(T.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await yS.all(t.map((e=>this.signal.request(YS.UNPUBLISH_DATASTREAM,{channel_id:e},!0))))}catch(t){e.warning("unpublish datachannels warning: ",t)}}async subscribe(t,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ig(T.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const s={stream_id:t,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!h("SUBSCRIBE_TWCC"),rtx:!!h("USE_SUB_RTX"),extend:h("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(h("SVC"))&&0!==h("SVC").length?h("SVC"):void 0};try{return(await this.signal.request(YS.SUBSCRIBE,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===HS.ERR_SUBSCRIBE_REQUEST_INVALID)return e.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(t,i),await this.subscribe(t,i,!1);throw s}}async subscribeDataChannel(t,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ig(T.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const s={uid:t,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(YS.SUBSCRIBE_DATASTREAM,s,!0)}catch(s){if(n&&s.data&&s.data.code===HS.ERR_SUBSCRIBE_REQUEST_INVALID)return e.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(t,i),await this.subscribeDataChannel(t,i,!1);throw s}}async subscribeAll(t,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ig(T.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!h("USE_SUB_RTX")};try{return await this.signal.request(YS.SUBSCRIBE_STREAMS,n,!0)}catch(n){if(i&&n.data&&n.data.code===HS.ERR_SUBSCRIBE_REQUEST_INVALID)return e.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),n.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw n}}async setVideoProfile(t){const i=function(e){if(!(e.bitrateMax&&e.bitrateMin&&e.frameRate&&e.height&&e.width))return;let t=e.frameRate,i=e.width,n=e.height,s=!0;return"number"!=typeof t&&(t=t.exact||t.ideal||t.max||t.min||0,t||(s=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,i||(s=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,t||(s=!1)),s?{stream_type:0,width:i,height:n,fps:t,start_bps:1e3*e.bitrateMax,min_bps:1e3*e.bitrateMin,target_bps:1e3*e.bitrateMax}:void 0}(t);if(i)return this.signal.request(YS.SET_VIDEO_PROFILE,i);e.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,i){try{await this.signal.request(YS.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:i},!0)}catch(t){e.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),t)}}async unsubscribeDataChannel(t,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ig(T.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await yS.all(t.map((e=>this.signal.request(YS.UNSUBSCRIBE_DATASTREAM,{stream_id:e,uid:i},!0))))}catch(t){e.warning("unsubscribeDataChannel warning: ",t)}}async massUnsubscribe(t){try{await this.signal.request(YS.UNSUBSCRIBE_STREAMS,t,!0)}catch(t){e.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),t)}}async reconnectPC(e){const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=e;return{gatewayEstablishParams:await this.signal.request(YS.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(YS.GATEWAY_INFO)}async renewToken(e){await this.signal.request(YS.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),"CONNECTED"!==this.state)return void(this.role=e);let i,n=0;"audience"===e?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,n=1):n=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:n=0,await this.signal.request(YS.SET_CLIENT_ROLE,{role:e,level:n,delay:i,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(YS.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(YS.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(YS.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(YS.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(YS.SET_RTM2_FLAG,{rtm2_flag:e})}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),$T({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(YS.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=eR.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(e){let t;return t=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),t?{username:ko.username,password:ko.password,turnServerURL:t[2],tcpport:parseInt(t[3])+30,udpport:parseInt(t[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push($T($T({},ko),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const e=await this.signal.request(YS.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.peer_delay.forEach((e=>{const t=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((t=>t.peer_uid===e.peer_uid));t&&t.B_st!==e.B_st&&j((()=>{this.emit(gg.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new Ig(T.UNEXPECTED_ERROR,"can not generate join message, no join info");const t=Object.assign({},this.joinInfo.apResponse);let i=h("REPORT_APP_SCENARIO");if("string"!=typeof i)try{i=JSON.stringify(i)}catch(e){i=void 0}i&&i.length>128&&(i=void 0);const n=$T({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:B,browser:navigator.userAgent,process_id:h("PROCESS_ID"),mode:this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:h("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:h("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:h("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof h("SUBSCRIBE_AUDIO_FILTER_TOPN")?h("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof h("ENABLE_PUBLISH_AUDIO_FILTER")?h("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof h("ENABLE_USER_LICENSE_CHECK")?h("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===h("USE_PUB_RTX")||!0===h("USE_SUB_RTX")||void 0,disableFEC:h("DISABLE_FEC"),enableInstantVideo:!!h("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:"boolean"==typeof h("ENABLE_DATASTREAM_2")?h("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:"number"==typeof h("RTM2_FLAG")?h("RTM2_FLAG"):void 0,enableUserAutoRebalanceCheck:!!h("ENABLE_USER_AUTO_REBALANCE_CHECK")}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,h("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),void 0!==this.joinInfo.defaultVideoStream&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new Ig(T.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(qS.WS_RECONNECT_WAITTING_FINISH,(e=>{var t;Po(t=["tryNext","recover"]).call(t,e)&&this.joinInfo&&xS.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(qS.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(qS.WS_RECONNECTING,(e=>{this.joinInfo&&xS.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||L.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",xS.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(qS.WS_CLOSED,(t=>{let i;switch(t){case P.LEAVE:i=L.LEAVE;break;case P.UID_BANNED:case P.IP_BANNED:case P.CHANNEL_BANNED:case P.SERVER_ERROR:i=L.SERVER_ERROR;break;case P.FALLBACK:i=L.FALLBACK;break;case P.LICENSE_MISSING:case P.LICENSE_EXPIRED:case P.LICENSE_MINUTES_EXCEEDED:case P.LICENSE_PERIOD_INVALID:case P.LICENSE_MULTIPLE_SDK_SERVICE:case P.LICENSE_ILLEGAL:case P.TOKEN_EXPIRE:i=t;break;default:i=L.NETWORK_ERROR}e.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(i||"undefined -> "+L.NETWORK_ERROR)),this.joinInfo&&xS.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===P.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:i}),this._disconnectedReason=t,t!==P.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(qS.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(e.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),xS.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof QT?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void e.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));G("EVENT_REPORT_DOMAIN",t[1]),G("EVENT_REPORT_BACKUP_DOMAIN",t[1]),G("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}})),this.signal.on(XS.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on(qS.REQUEST_RECOVER,((e,t,i)=>{if(!this.joinInfo)return i(new Ig(T.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,O(this,gg.REQUEST_NEW_GATEWAY_LIST).then(t).catch(i)})),this.signal.on(qS.REQUEST_JOIN_INFO,(async e=>{var t;this.updateTurnConfigFromSignal();const{iceParameters:i,dtlsParameters:n,rtpCapabilities:s}=await O(this,gg.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(t=this.joinInfo)||void 0===t?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:s,version:"2"}}))})),this.signal.on(qS.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on(qS.REPORT_JOIN_GATEWAY,((e,t)=>{this.joinInfo&&(xS.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof QT?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on(qS.IS_P2P_DISCONNECTED,(e=>{e(M(this,gg.IS_P2P_DISCONNECTED))})),this.signal.on(qS.DISCONNECT_P2P,(()=>{this.emit(gg.DISCONNECT_P2P)})),this.signal.on(qS.NEED_RENEW_SESSION,(()=>{this.emit(gg.NEED_RENEW_SESSION)})),this.signal.on(qS.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(qS.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(qS.JOIN_RESPONSE,(e=>{const t=this.getCurrentGatewayAddress();this.emit(gg.JOIN_RESPONSE,e,t)})),this.signal.on(qS.DATACHANNEL_PRECONNECT,(async(e,t,i)=>{this.updateTurnConfigFromSignal();const n=this.getCurrentGatewayAddress();return O(this,gg.DATACHANNEL_PRECONNECT,e,n).then(t).catch(i)})),this.signal.on(qS.DATACHANNEL_CONNECTING,(async e=>{const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await O(this,gg.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n,version:"2"}}))})),this.signal.on(qS.DATACHANNEL_FAILBACK,(()=>{e.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(gg.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(t,i){try{await this.signal.request(YS.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[i]},!0)}catch(t){throw e.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),t),t}}async tryUnsubDataChannelBeforeResub(t,i){try{await this.signal.request(YS.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(t){throw e.warning("unsubscribe datachannel warning",t),t}}async tryUnpubBeforeRepub(t,i){try{await this.signal.request(YS.UNPUBLISH,{stream_id:t,ortc:i},!0)}catch(t){throw e.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),t),t}}async tryUnpubDataChannelBeforeRepub(t,i){try{await this.signal.request(YS.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(t){throw e.warning("unpublish datastream warning: ",t),t}}async tryMassUnsubBeforeResub(t){const i={users:t.map((e=>({stream_id:e.stream_id,stream_type:e.stream_type})))};try{await this.signal.request(YS.UNSUBSCRIBE_STREAMS,i,!0)}catch(t){throw e.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),t),t}}async muteLocal(t,i){const n={action:t.find((e=>e.stream_type===Sg.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:i};try{await this.signal.request(YS.CONTROL,n,!0,!0)}catch(t){throw e.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),t),t}}async unmuteLocal(t,i){const n={action:t.find((e=>e.stream_type===Sg.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:i};try{await this.signal.request(YS.CONTROL,n,!0,!0)}catch(t){throw e.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),t),t}}uploadStats(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(YS.RESTART_ICE,i,!0)}catch(t){throw e.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),t),t}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,L.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!h("GATEWAY_WSS_ADDRESS"))return null!==(e=this.joinInfo)&&void 0!==e&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(YS.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(P.FALLBACK)),this.store.useDataChannel=!1,this.signal=new dT($T($T({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(gg.RESET_SIGNAL,Rg.websocket)}}var iR=Di,nR=TypeError,sR=Pa,oR=Math.floor,rR=function(e,t){var i=e.length,n=oR(i/2);return i<8?aR(e,t):cR(e,rR(sR(e,0,n),t),rR(sR(e,n),t),t)},aR=function(e,t){for(var i,n,s=e.length,o=1;o<s;){for(n=o,i=e[o];n&&t(e[n-1],i)>0;)e[n]=e[--n];n!==o++&&(e[n]=i)}return e},cR=function(e,t,i,n){for(var s=t.length,o=i.length,r=0,a=0;r<s||a<o;)e[r+a]=r<s&&a<o?n(t[r],i[a])<=0?t[r++]:i[a++]:r<s?t[r++]:i[a++];return e},dR=rR,lR=ui.match(/firefox\/(\d+)/i),hR=!!lR&&+lR[1],uR=/MSIE|Trident/.test(ui),pR=ui.match(/AppleWebKit\/(\d+)\./),_R=!!pR&&+pR[1],ER=Ls,mR=pt,fR=Mi,SR=$i,gR=Ks,TR=function(e,t){if(!delete e[t])throw nR("Cannot delete property "+iR(t)+" of "+iR(e))},RR=So,CR=at,IR=dR,vR=mp,yR=hR,AR=uR,wR=gi,NR=_R,OR=[],bR=mR(OR.sort),DR=mR(OR.push),PR=CR((function(){OR.sort(void 0)})),LR=CR((function(){OR.sort(null)})),kR=vR("sort"),MR=!CR((function(){if(wR)return wR<70;if(!(yR&&yR>3)){if(AR)return!0;if(NR)return NR<603;var e,t,i,n,s="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)OR.push({k:t+n,v:i})}for(OR.sort((function(e,t){return t.v-e.v})),n=0;n<OR.length;n++)t=OR[n].k.charAt(0),s.charAt(s.length-1)!==t&&(s+=t);return"DGBEFHACIJK"!==s}}));ER({target:"Array",proto:!0,forced:PR||!LR||!kR||!MR},{sort:function(e){void 0!==e&&fR(e);var t=SR(this);if(MR)return void 0===e?bR(t):bR(t,e);var i,n,s=[],o=gR(t);for(n=0;n<o;n++)n in t&&DR(s,t[n]);for(IR(s,function(e){return function(t,i){return void 0===i?-1:void 0===t?1:void 0!==e?+e(t,i)||0:RR(t)>RR(i)?1:-1}}(e)),i=gR(s),n=0;n<i;)t[n]=s[n++];for(;n<o;)TR(t,n++);return t}});var UR=$s("Array").sort,xR=_t,VR=UR,FR=Array.prototype,jR=rt((function(e){var t=e.sort;return e===FR||xR(FR,e)&&t===FR.sort?VR:t}));let BR=0,GR=0;function WR(e,t,i,n){return new yS(((s,o)=>{t.timeout=t.timeout||h("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),BR+=W(t.data)):i&&(t.data.size?BR+=t.data.size:t.data instanceof FormData?BR+=H(t.data):BR+=W(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,st.request(t).then((e=>{"string"==typeof e.data?GR+=W(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?GR+=e.data.byteLength:GR+=W(JSON.stringify(e.data)),n&&s({data:e.data,headers:e.headers}),s(e.data)})).catch((e=>{st.isCancel(e)?o(new Ig(T.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?o(new Ig(T.NETWORK_TIMEOUT,e.message)):e.response?o(new Ig(T.NETWORK_RESPONSE_ERROR,e.response.status)):o(new Ig(T.NETWORK_ERROR,e.message))}))}))}const HR=()=>{const e=h("AREAS");0===e.length&&e.push(Cg.GLOBAL);return Ip(e).call(e,((e,t,i)=>{const n=KR(t);return n?0===i?n:"".concat(e,",").concat(n):e}),"")},KR=e=>e===Cg.OVERSEA?"".concat(Ag.ASIA,",").concat(Ag.EUROPE,",").concat(Ag.AFRICA,",").concat(Ag.NORTH_AMERICA,",").concat(Ag.SOUTH_AMERICA,",").concat(Ag.OCEANIA):Ag[e],qR=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((e=>{const i=wg[e],n=Object.keys(i);n&&n.map((e=>{"CODE"!==e&&(t[e]=t[e].concat(i[e]))}))})),t},YR={GLOBAL:{ASIA:[Cg.CHINA,Cg.JAPAN,Cg.INDIA,Cg.KOREA,Cg.HKMC],EUROPE:[],NORTH_AMERICA:[Cg.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},JR=Object.keys(YR[Cg.GLOBAL]),XR=[Cg.CHINA,Cg.NORTH_AMERICA,Cg.EUROPE,Cg.ASIA,Cg.JAPAN,Cg.INDIA,Cg.OCEANIA,Cg.SOUTH_AMERICA,Cg.AFRICA,Cg.KOREA,Cg.HKMC,Cg.US],zR=function(e,t){let i=[];if(Po(e).call(e,Cg.GLOBAL)){const o=[Cg.GLOBAL,Cg.OVERSEA],r=Object.keys(wg);if(t===Cg.GLOBAL)throw new Ig(T.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===Cg.CHINA)i=[Cg.OVERSEA];else if(s=t,Po(JR).call(JR,s)){const e=(n=t,YR[Cg.GLOBAL][n]||[]),s=[...o,t,...e];i=r.filter((e=>!Po(s).call(s,e)))}else if(function(e){let t=!1;return JR.forEach((i=>{var n;Po(n=YR[Cg.GLOBAL][i]).call(n,e)&&(t=!0)})),t}(t)){const e=function(e){let t;return JR.forEach((i=>{var n;Po(n=YR[Cg.GLOBAL][i]).call(n,e)&&(t=i)})),t}(t),n=[...o,e,t];i=r.filter((e=>!Po(n).call(n,e)))}else i=e;i=function(e){const t=[];return XR.forEach((i=>{Po(e).call(e,i)&&t.push(i)})),t.concat(e.filter((e=>!Po(XR).call(XR,e))))}(i)}else i=e;var n,s;return i};function QR(t){var i,n;if(!t&&Po(i=h("AREAS")).call(i,Cg.EXTENSIONS))return e.debug("update area from ap : reset"),void ZR(Lo,!0);if(!Po(n=h("AREAS")).call(n,Cg.GLOBAL)||!t)return;let s=wg.EXTENSIONS;s&&(s={CODE:KR(Cg.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},e.debug("update area from ap success: ".concat(t,",config is "),s),G("AREAS",[Cg.EXTENSIONS],!0),Object.keys(s).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=s[e];G(e,t[0])}else G(e,s[e])})))}function ZR(t){let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=xS.reportApiInvoke(null,{name:K.SET_AREA,options:t,tag:l.TRACER});try{let s=[];if("string"==typeof t&&(s=[t]),Array.isArray(t)&&(t.forEach((e=>{if(!Po(yg).call(yg,e))throw new Ig(T.INVALID_PARAMS,"invalid area code")})),s=t),"[object Object]"===Object.prototype.toString.call(t)){const{areaCode:e,excludedArea:i}=t;if(!e)throw new Ig(T.INVALID_PARAMS,"area code is needed");let n=e;"string"==typeof e&&(n=[e]),s=i?zR(n,i):n}if(!i){if(c.AREAS){const t=new Ig(T.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(t),void e.warning("setArea is prohibited because of config-distribute")}if(Po(s).call(s,Cg.GLOBAL)&&h("AREAS")===Cg.EXTENSIONS){const t=new Ig(T.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(t),void e.warning("setArea is prohibited because of ap extensions")}}G("AREAS",s,i);const o=qR(s);Object.keys(o).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=o[e];G(e,t[0])}else G(e,o[e])})),e.debug("set area success:",s.join(","))}catch(e){throw n.onError(e),e}n.onSuccess()}function $R(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function eC(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?$R(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):$R(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let tC=1;function iC(t,i,n,s,o){tC+=1;const r={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:tC,requestId:tC,version:B,cname:n.cname},a={service_name:i,json_body:JSON.stringify(r)};let c,d,l=t[0];return q((async()=>{c=Date.now();const t=await WR(l,{data:a,cancelToken:s,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(d=Date.now()-c,0!==t.code){const i=new Ig(T.UNEXPECTED_RESPONSE,"live streaming ap error, code"+t.code,{retry:!0,responseTime:d});throw e.error(i.toString()),i}const n=JSON.parse(t.json_body);if(200!==n.code){const t=new Ig(T.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(n.code,", reason: ").concat(n.reason),{code:n.code,responseTime:d});throw e.error(t.toString()),t}if(!n.servers||0===n.servers.length){const t=new Ig(T.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:n.code,responseTime:d});throw e.error(t.toString()),t}const o=function(e,t){return{addressList:e.servers.map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(h("WORKER_DOMAIN"),":").concat(e.wss,"?serviceName=").concat(encodeURIComponent(t)))),workerToken:e.workerToken,vid:e.vid}}(n,i);return h("LIVE_STREAMING_ADDRESS")&&(o.addressList=h("LIVE_STREAMING_ADDRESS")instanceof Array?h("LIVE_STREAMING_ADDRESS"):[h("LIVE_STREAMING_ADDRESS")]),eC(eC({},o),{},{responseTime:d})}),((e,s)=>(xS.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:i,responseDetail:JSON.stringify(e.addressList),firstSuccess:0===s,responseTime:d,serverIp:t[s%t.length]}),!1)),((e,s)=>(xS.apworkerEvent(n.sid,{success:!1,sc:e.data&&e.data.code||200,serviceName:i,responseTime:d,serverIp:t[s%t.length]}),!!(e.code!==T.OPERATION_ABORTED&&e.code!==T.UNEXPECTED_RESPONSE||e.data&&e.data.retry)&&(l=t[(s+1)%t.length],!0))),o)}let nC=1;function sC(t,i,n,s){let{url:o,areaCode:r}=t;const a=Date.now();let c;const[l,h]=dC(i,r,[IT.CHOOSE_SERVER]);let u=d.networkState;return q((async()=>{u&&d.networkState===y.OFFLINE&&d.onlineWaiter&&await yS.race([d.onlineWaiter,N(s&&s.maxRetryTimeout||J.maxRetryTimeout)]),u=d.networkState;const{data:e,headers:t}=await WR(o,{data:l,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c="1"===t.http3?1:-1,xS.reportResourceTiming(o,i.sid),rC(e,o,i,a,[IT.CHOOSE_SERVER],c);const r=GT(e,IT.CHOOSE_SERVER);return aC(r),VT(r,o)}),(e=>(e&&xS.joinChooseServer(i.sid,{lts:a,succ:!0,csAddr:o,opid:h,serverList:e.gatewayAddrs.map((e=>e.address)),ec:null,cid:e.cid.toString(),uid:e.uid.toString(),csIp:e.csIp,unilbsServerIds:[IT.CHOOSE_SERVER].toString(),isHttp3:c}),!1)),(t=>t.code!==T.OPERATION_ABORTED&&(t.code===T.CAN_NOT_GET_GATEWAY_SERVER?t.data.retry:(xS.joinChooseServer(i.sid,{lts:a,succ:!1,csAddr:o,serverList:null,opid:h,ec:t.code,csIp:t.data&&t.data.csIp,unilbsServerIds:[IT.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:u}),isHttp3:c}),e.warning("[".concat(i.clientId,"] Choose server network error, retry"),t),!0))),s)}function oC(t,i,n,s){let o,{url:r,areaCode:a,serviceIds:c}=t;const l=Date.now(),[h,u]=dC(i,a,c);let p;return q((async()=>{p&&d.networkState===y.OFFLINE&&d.onlineWaiter&&await yS.race([d.onlineWaiter,N(s&&s.maxRetryTimeout||J.maxRetryTimeout)]),p=d.networkState;const{data:e,headers:t}=await WR(r,{data:h,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);o="1"===t.http3?1:-1,xS.reportResourceTiming(r,i.sid),rC(e,r,i,l,c,o);const a=GT(e,IT.CHOOSE_SERVER),u=GT(e,"proxy5"===i.cloudProxyServer?IT.CLOUD_PROXY_5:"proxy3"===i.cloudProxyServer||"proxy4"===i.cloudProxyServer?IT.CLOUD_PROXY:IT.CLOUD_PROXY_FALLBACK);return aC(a),{gatewayInfo:VT(a,r),proxyInfo:u,url:r}}),(e=>(e.gatewayInfo&&xS.joinChooseServer(i.sid,{lts:l,succ:!0,csAddr:r,serverList:e.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,opid:u,cid:e.gatewayInfo.cid.toString(),uid:e.gatewayInfo.uid.toString(),csIp:e.gatewayInfo.csIp,unilbsServerIds:c.toString(),isHttp3:o}),e.proxyInfo&&xS.joinWebProxyAP(i.sid,{lts:l,sucess:1,apServerAddr:r,turnServerAddrList:e.proxyInfo.addresses.map((e=>e.ip)).join(","),errorCode:null,eventType:i.cloudProxyServer,unilbsServerIds:c.toString()}),!1)),(t=>t.code!==T.OPERATION_ABORTED&&(t.code===T.CAN_NOT_GET_GATEWAY_SERVER?t.data.retry:(xS.joinWebProxyAP(i.sid,{lts:l,sucess:0,apServerAddr:r,turnServerAddrList:null,errorCode:t.code,eventType:i.cloudProxyServer,unilbsServerIds:c.toString(),extend:JSON.stringify({networkState:p})}),e.warning("[".concat(i.clientId,"] multi unilbs network error, retry"),t),!0))),s)}const rC=(t,i,n,s,o,r)=>{const a=[],c=e=>{4096===e.flag?xS.joinChooseServer(n.sid,{lts:s,succ:!1,csAddr:i,opid:t.opid,serverList:null,ec:e.error.message,csIp:e.error.data&&e.error.data.csIp,unilbsServerIds:o.toString(),isHttp3:r}):1048576!==e.flag&&4194304!==e.flag&&4194310!==e.flag||xS.joinWebProxyAP(n.sid,{lts:s,sucess:0,apServerAddr:i,turnServerAddrList:null,errorCode:e.error.code,eventType:n.cloudProxyServer,unilbsServerIds:o.toString()})};if(t.response_body.forEach((i=>{const n=i.buffer.code;if(23===i.uri&&0===n&&!i.buffer.edges_services)if(4194310===i.buffer.flag)e.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),i.buffer.edges_services=[];else{const e={error:new Ig(T.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:i.buffer.flag};a.push(e),c(e)}if(0!==n){const s=Jg(n),o={error:new Ig(T.CAN_NOT_GET_GATEWAY_SERVER,s.desc,{desc:s.desc,retry:s.retry,csIp:t.detail[502]}),flag:i.buffer.flag};4194310===i.buffer.flag?e.warning(o.error.toString()):a.push(o),c(o)}})),a.length)throw e.warning("[".concat(n.clientId,"] multi unilbs ").concat(i," failed, ").concat(a.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message,", retry: ").concat(e.error.data.retry))).join(" | "))),new Ig(T.CAN_NOT_GET_GATEWAY_SERVER,a.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!a.find((e=>e.error.data.retry)),csIp:t.detail[502],desc:[...new Set(a.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})},aC=t=>{var i,n,s,o;if(t.addresses&&0===t.addresses.length&&0===t.code)throw new Ig(T.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});h("AP_AREA")&&(null!==(s=t.detail)&&void 0!==s&&s[23]&&"string"==typeof(null===(o=t.detail)||void 0===o?void 0:o[23])?QR(t.detail[23].toLowerCase()):QR());if(null!==(i=t.detail)&&void 0!==i&&i[19]&&"string"==typeof(null===(n=t.detail)||void 0===n?void 0:n[19])){const e=t.detail[19],i=null==e?void 0:e.split(";");for(let e=0;e<i.length;e++){var r;const n=NT(r=i[e]).call(r);t.addresses[e]&&i&&(t.addresses[e].fingerprint=n)}}if(h("GATEWAY_ADDRESS")&&h("GATEWAY_ADDRESS").length>0){e.debug("assign gateway address to",h("GATEWAY_ADDRESS"));const i=h("GATEWAY_ADDRESS").map((e=>{var i,n;const s=null!==(i=null===(n=t.addresses.find((t=>t.ip===e.ip&&t.port===e.port)))||void 0===n?void 0:n.fingerprint)&&void 0!==i?i:"";return{ip:e.ip,port:e.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:s}}));t.addresses=i}},cC=(t,i)=>{if(t.response_body&&t.response_body.length){const e=t.response_body[0];if(0!==e.buffer.code){const t=Jg(e.buffer.code);throw new Ig(T.UPDATE_TICKET_FAILED,"[".concat(e.buffer.code,"]: ").concat(t.desc),{retry:t.retry})}return e.buffer.ticket}throw e.debug("update ticket request received ap response without response body:",i),new Ig(T.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},dC=(e,t,i)=>{const n=Math.floor(Math.random()*10**12),s={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:eC({6:e.stringUid,11:t,12:h("USE_NEW_TOKEN")?"1":void 0,22:t},h("AP_RTM")?{26:"RTM2"}:{}),key:e.token,service_ids:i,uid:e.uid||0}}]};s.request_bodies.forEach((t=>{e.multiIP&&e.multiIP.gateway_ip&&(t.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,n]},lC=(e,t)=>{const i=Math.floor(Math.random()*10**12),n={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((e=>({ip:e.ip,port:e.port})))}}]},s=new FormData;return s.append("request",JSON.stringify(n)),[s,i]};let hC=0;function uC(e){return yS.all(e.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e))}const pC=async e=>{let{fragementLength:t,referenceList:i,asyncMapHandler:n,allFailedhandler:s,promisesCollector:o}=e,r=0;const a=t;let c,d=0;const l=async()=>{const e=(()=>{const e=r*a,t=e+a;return i.slice(e,t).map(n)})();o&&o.push(...e);try{c=await uC(e)}catch(e){if(d+=a,r++,!(d>=i.length))return void await l();s(e)}e.forEach((e=>e.cancel()))};return await l(),c};async function _C(t,i,n,s){const o=async function(t,i,n,s){let o=null;const r=[],a=async()=>{const o=h("WEBCS_DOMAIN").slice(0,h("AJAX_REQUEST_CONCURRENT")).map((e=>({url:t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v2/transpond/webrtc?v=2"):"https://".concat(e,"/api/v2/transpond/webrtc?v=2"),areaCode:HR()}))),a=s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:o.map((e=>e.url))}),c=await pC({fragementLength:h("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:s=>(e.debug("[".concat(t.clientId,"] Connect to choose_server:"),s.url),sC(s,t,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:r});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c},c=async()=>{if(await N(1e3),null!==o)return o;const a=h("WEBCS_DOMAIN_BACKUP_LIST").map((e=>({url:t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v2/transpond/webrtc?v=2"):"https://".concat(e,"/api/v2/transpond/webrtc?v=2"),areaCode:HR()}))),c=s.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:a.map((e=>e.url))}),d=await pC({fragementLength:h("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:s=>(e.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),s.url),sC(s,t,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},c),e[0]},promisesCollector:r});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},c),d};try{return o=await uC([a(),c()]),r.length&&r.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),o}catch(e){throw e[0]}}(t,i,n,s);return{gatewayInfo:await o}}async function EC(t,i,n,s,o){const r=t.cloudProxyServer;if("disabled"===r){if(!s)return;if(t.useLocalAccessPoint)return await _C(t,i,n,o);if(h("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:e,proxyInfo:s}=await SC(t,i,n,o);return t.turnServer&&"auto"!==t.turnServer.mode||(t.turnServer={mode:"manual",servers:s.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||ko.tcpport,udpport:e.udpport||ko.udpport,username:e.username||ko.username,password:e.password||ko.password,forceturn:!1,security:!0})))}),{gatewayInfo:e}}return await _C(t,i,n,o)}const{proxyInfo:a,gatewayInfo:c}=await SC(t,i,n,o),d={gatewayInfo:c};return t.turnServer={mode:"manual",servers:a.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===r?void 0:e.tcpport?e.tcpport:ko.tcpport,udpport:"proxy4"===r?void 0:e.udpport?e.udpport:ko.udpport,username:e.username||ko.username,password:e.password||ko.password,forceturn:"proxy4"!==r,security:"proxy5"===r})))},e.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(r)),d}async function mC(t,i,n,s,o){const r=h("ACCOUNT_REGISTER").slice(0,h("AJAX_REQUEST_CONCURRENT"));let a=[];a=i.proxyServer?r.map((e=>"https://".concat(i.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):r.map((e=>"https://".concat(e,"/api/v1")));const c=null==o?void 0:o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:a});try{const r=await async function(t,i,n,s,o){const r=Date.now(),a={sid:n.sid,opid:10,appid:n.appId,string_uid:i};let c=t[0];const d=await q((()=>WR(c+"".concat(-1===c.indexOf("?")?"?":"&","action=stringuid"),{data:a,cancelToken:s,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((n,s)=>{if(0===n.code){if(n.uid<=0||n.uid>=Math.pow(2,32))throw e.error("Invalid Uint Uid ".concat(i," => ").concat(n.uid),n),xS.reqUserAccount(a.sid,{lts:r,success:!1,serverAddr:c,stringUid:a.string_uid,uid:n.uid,errorCode:T.INVALID_UINT_UID_FROM_STRING_UID,extend:a}),new Ig(T.INVALID_UINT_UID_FROM_STRING_UID);return xS.reqUserAccount(a.sid,{lts:r,success:!0,serverAddr:c,stringUid:a.string_uid,uid:n.uid,errorCode:null,extend:a}),!1}const o=Jg(n.code);return o.retry&&(c=t[(s+1)%t.length]),xS.reqUserAccount(a.sid,{lts:r,success:!1,serverAddr:c,stringUid:a.string_uid,uid:n.uid,errorCode:o.desc,extend:a}),o.retry}),((e,i)=>e.code!==T.OPERATION_ABORTED&&(xS.reqUserAccount(a.sid,{lts:r,success:!1,serverAddr:c,stringUid:a.string_uid,uid:null,errorCode:e.code,extend:a}),c=t[(i+1)%t.length],!0)),o);if(0!==d.code){const e=Jg(d.code);throw new Ig(T.UNEXPECTED_RESPONSE,e.desc)}return d}(a,t,i,n,s);return null==o||o.recordJoinChannelService({status:"success",endTs:Date.now()},c),r.uid}catch(e){throw null==o||o.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[e]},c),e}}async function fC(e,t,i){const n=h("CDS_AP").slice(0,h("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"):"https://".concat(t,"/api/v1?action=config"))).map((n=>function(e,t,i,n){const s=Y(),o={flag:64,cipher_method:0,features:{device:s.name,system:s.os,system_general:navigator.userAgent,vendor:t.appId,version:B,cname:t.cname,sid:t.sid,session_id:t.sid,detail:"",proxyServer:t.proxyServer}};return q((()=>WR(e,{data:o,timeout:1e3,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(e=>e.code!==T.OPERATION_ABORTED),n)}(n,e,t,i)));let s=null,o=null,r={};try{s=await uC(n)}catch(e){if(e.code===T.OPERATION_ABORTED)throw e;o=e}n.forEach((e=>e.cancel()));if(xS.reportApiInvoke(e.sid,{name:K.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:s}}).onSuccess(),s&&s.test_tags)try{r=function(e){if(!e.test_tags)return{};const t=e.test_tags,i=Object.keys(t),n={};return i.forEach((e=>{var i;const s=NT(i=e.slice(4)).call(i),o=JSON.parse(t[e])[1];n[s]=o})),n}(s)}catch(e){}return r}async function SC(t,i,n,s){const o=h("PROXY_SERVER_TYPE3"),r=(e,t,i)=>{let n=i||o;return Array.isArray(n)&&(n=t%2==0?o[1]:o[0]),"https://".concat(n,"/ap/?url=").concat(e)};let a=null;const c=[],d=async()=>{const o=h("WEBCS_DOMAIN").slice(0,h("AJAX_REQUEST_CONCURRENT")).map(((e,i)=>{let n;return n="disabled"===t.cloudProxyServer&&t.proxyServer?r("".concat(e,"/api/v2/transpond/webrtc?v=2"),i,t.proxyServer):"disabled"===t.cloudProxyServer||"fallback"===t.cloudProxyServer?"https://".concat(e,"/api/v2/transpond/webrtc?v=2"):r("".concat(e,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:HR(),serviceIds:[IT.CHOOSE_SERVER,"proxy5"===t.cloudProxyServer?IT.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?IT.CLOUD_PROXY:IT.CLOUD_PROXY_FALLBACK]}})),a=s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:o.map((e=>e.url))}),d=await pC({fragementLength:h("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:s=>(e.debug("[".concat(t.clientId,"] Connect to choose_server:"),s.url),oC(s,t,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:c});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},a),d},l=async()=>{if(await N(1e3),null!==a)return a;const o=h("WEBCS_DOMAIN_BACKUP_LIST").map(((e,i)=>{let n;return n="disabled"===t.cloudProxyServer&&t.proxyServer?r("".concat(e,"/api/v2/transpond/webrtc?v=2"),i,t.proxyServer):"disabled"===t.cloudProxyServer||"fallback"===t.cloudProxyServer?"https://".concat(e,"/api/v2/transpond/webrtc?v=2"):r("".concat(e,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:HR(),serviceIds:[IT.CHOOSE_SERVER,"proxy5"===t.cloudProxyServer?IT.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?IT.CLOUD_PROXY:IT.CLOUD_PROXY_FALLBACK]}})),d=s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:o.map((e=>e.url))}),l=await pC({fragementLength:h("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:s=>(e.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),s.url),oC(s,t,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},d),e[0]},promisesCollector:c});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},d),l};let u,p,_;try{({gatewayInfo:u,proxyInfo:p,url:_}=await uC([d(),l()]))}catch(e){throw e[0]}if(c.length&&c.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),!u||!p)throw new Ig(T.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=_,"disabled"!==t.cloudProxyServer&&Array.isArray(o)&&_){const i=/^https?:\/\/(.+?)(\/.*)?$/.exec(_)[1];Po(o).call(o,i)&&(t.proxyServer=i,e.setProxyServer(i),xS.setProxyServer(i))}return a={gatewayInfo:u,proxyInfo:await WT(p,u.uid)},a}async function gC(e,t,i,n){const s=h("UAP_AP").slice(0,h("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap")));return await iC(s,e,t,i,n)}async function TC(t,i,n){const s=h("UAP_AP").slice(0,h("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap"))).map((s=>function(t,i,n,s){const o={command:"convergeAllocateEdge",sid:i.sid,appId:i.appId,token:i.token,ts:Date.now(),version:B,cname:i.cname,uid:i.uid.toString(),requestId:nC,seq:nC};nC+=1;const r={service_name:"tele_channel",json_body:JSON.stringify(o)};return q((async()=>{const i=await WR(t,{data:r,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==i.code){const t=new Ig(T.UNEXPECTED_RESPONSE,"cross channel ap error, code"+i.code,{retry:!0});throw e.error(t.toString()),t}const s=JSON.parse(i.json_body);if(200!==s.code){const t=new Ig(T.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(s.code,", reason: ").concat(s.reason));throw e.error(t.toString()),t}if(!s.servers||0===s.servers.length){const t=new Ig(T.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw e.error(t.toString()),t}return{vid:s.vid,workerToken:s.workerToken,addressList:(h("CHANNEL_MEDIA_RELAY_SERVERS")||s.servers).map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(h("WORKER_DOMAIN"),":").concat(e.wss)))}}),void 0,(e=>!!(e.code!==T.OPERATION_ABORTED&&e.code!==T.UNEXPECTED_RESPONSE||e.data&&e.data.retry)),s)}(s,t,i,n)));try{const e=await uC(s);return s.forEach((e=>e.cancel())),e}catch(e){throw e[0]}}async function RC(t,i,n){let s=null;const o=[],r=async r=>{const a=h(r?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v2/transpond/webrtc?v=2"):"https://".concat(e,"/api/v2/transpond/webrtc?v=2")));return r&&(await N(1e3),null!==s)?s:await pC({fragementLength:h("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:s=>(e.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(r?"backup":""," choose_server:"),s),function(t,i,n,s){const[o]=lC(i,[IT.CHOOSE_SERVER]);let r=d.networkState;return q((async()=>{r&&d.networkState===y.OFFLINE&&d.onlineWaiter&&await yS.race([d.onlineWaiter,N(s&&s.maxRetryTimeout||J.maxRetryTimeout)]),r=d.networkState;const e=await WR(t,{data:o,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0);return cC(e,t)}),(()=>!1),(t=>t.code!==T.OPERATION_ABORTED&&(t.code===T.UPDATE_TICKET_FAILED?t.data.retry:(e.warning("[".concat(i.clientId,"] update ticket network error, retry"),t),!0))),s)}(s,t,i,n)),allFailedhandler:e=>{throw e[0]},promisesCollector:o})};try{return s=await uC([r(!1),r(!0)]),o.length&&o.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),s}catch(e){throw e[0]}}function CC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function IC(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?CC(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):CC(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class vC extends C{constructor(){super(),this.configs=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.retryConfig={timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4},this.interval=void 0,this.mutex=new v("config-distribute"),this.mutableParamsRead=!1}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),h("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),h("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){if(!this.mutex.isLocked)return;(await this.mutex.lock())()}async updateConfigDistribute(){if(!this.mutableParamsRead){this.mutableParamsRead=!0;xS.reportApiInvoke(null,{options:void 0,name:K.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:l.TRACER}).onSuccess(JSON.stringify(c))}if(!this.joinInfo||!this.cancelToken||!this.retryConfig)return void e.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const i=await this.mutex.lock();try{t=await fC(this.joinInfo,this.cancelToken,this.retryConfig),e.debug("[config-distribute] get config distribute",JSON.stringify(t)),t.limit_bitrate&&this.handleBitrateLimit(t.limit_bitrate),this.cacheGlobalParameterConfig(t),this.configs=t}catch(t){const i=new Ig(T.NETWORK_RESPONSE_ERROR,t);e.warning("[config-distribute] ".concat(i.toString()))}finally{i()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&void 0!==t.uplink.max_bitrate&&void 0!==t.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(Ng.UPDATE_BITRATE_LIMIT,e):this.emit(Ng.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&IC({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(t){var i;const n=jR(i=Object.keys(t).filter((e=>/^webrtc_ng_global_parameter/.test(e)))).call(i);for(let e=0;e<n.length;e++)for(let i=n.length-1;i>e;i--){const e=n[i];if("number"==typeof t[e].__priority){const s=t[e].__priority,o=n[i-1];if("number"==typeof t[o].__priority){if(!(s>t[o].__priority))continue;{const t=e;n[i]=n[i-1],n[i-1]=t}}else{const t=e;n[i]=n[i-1],n[i-1]=t}}}const s={};n.forEach((e=>{const i=t[e],n=i.__expires;Object.keys(i).forEach((e=>{"__priority"===e||"__expires"===e||Object.prototype.hasOwnProperty.call(s,e)||(s[e]=IC({value:i[e]},n&&{expires:n}))}))}));try{!function(t){try{const i=Date.now();Object.keys(t).forEach((n=>{switch(n){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(a,n)){const{value:s,expires:o}=t[n];if(o&&o<=i)return;c[n]=s,a[n]=s,e.debug("Update global parameters from config distribute",n,s)}}}))}catch(i){e.error("Error update config immediately: ".concat(t),i.message)}}(s);const t=JSON.stringify(s),i=window.btoa(t);window.localStorage.setItem("websdk_ng_global_parameter",i),e.debug("Caching global parameters ".concat(t))}catch(t){e.error("Error caching global parameters:",t.message)}}}function yC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function AC(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?yC(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):yC(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class wC extends C{constructor(e,t,i,n){super(),this.spec=void 0,this.token=void 0,this.websocket=void 0,this.pingpongTimer=void 0,this.reconnectMode="retry",this.serviceMode=void 0,this.reqId=0,this.commandReqId=0,this.handleWebSocketOpen=()=>{this.reconnectMode="retry",this.startPingPong()},this.handleWebSocketMessage=e=>{if(!e.data)return;const t=JSON.parse(e.data);t.requestId?this.emit("@".concat(t.requestId,"-").concat(t.sid),t):this.serviceMode===ng.INJECT?this.emit(lg.INJECT_STREAM_STATUS,t):(xS.workerEvent(this.spec.sid,{actionType:"status",serverCode:t.code,workerType:this.serviceMode===ng.TRANSCODE?1:2}),this.emit(lg.PUBLISH_STREAM_STATUS,t))},this.spec=t,this.token=e,this.serviceMode=n,this.websocket=new cT("live-streaming",i),this.websocket.on(ig.CONNECTED,this.handleWebSocketOpen),this.websocket.on(ig.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(ig.REQUEST_NEW_URLS,((e,t)=>{O(this,lg.REQUEST_NEW_ADDRESS).then(e).catch(t)})),this.websocket.on(ig.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(e){return this.websocket.init(e)}async request(e,t,i,n){this.reqId+=1,"request"===e&&(this.commandReqId+=1);const s=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new Ig(T.UNEXPECTED_ERROR);const r=AC({command:e,sdkVersion:"4.19.0"===B?"0.0.1":B,seq:o,requestId:o,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if("closed"===this.websocket.state)throw new Ig(T.WS_DISCONNECT);const a=()=>new yS(((e,t)=>{this.websocket.once(ig.CLOSED,(()=>t(new Ig(T.WS_ABORT)))),this.websocket.once(ig.CONNECTED,e)}));"connected"!==this.websocket.state&&await a(),r.clientRequest&&(r.clientRequest.workerToken=this.token);const c=new yS(((e,t)=>{const i=()=>{t(new Ig(T.WS_ABORT))};this.websocket.once(ig.RECONNECTING,i),this.websocket.once(ig.CLOSED,i),this.once("@".concat(o,"-").concat(this.spec.sid),(t=>{e(t)}))}));n&&xS.workerEvent(this.spec.sid,AC(AC({},n),{},{requestId:s,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));const d=Date.now();this.websocket.sendMessage(r);let l=null;try{l=await c}catch(n){if("closed"===this.websocket.state)throw n;return await a(),await this.request(e,t,i)}return n&&xS.workerEvent(this.spec.sid,AC(AC({},n),{},{requestId:s,actionType:"response",payload:JSON.stringify(l.serverResponse),serverCode:l.code,success:200===l.code,responseTime:Date.now()-d})),200!==l.code&&this.handleResponseError(l),l}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e="4.19.0"===B?"0.0.1":B;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case ug.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void e.warning("live stream response already exists stream");case ug.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case ug.LIVE_STREAM_RESPONSE_BAD_STREAM:case ug.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new Ig(T.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case ug.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===t.serverResponse.command||"UninjectStream"===t.serverResponse.command)return;throw new Ig(T.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ug.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new Ig(T.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case ug.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new Ig(T.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(lg.WARNING,e,t.serverResponse.url)}case ug.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const e=new Ig(T.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(lg.WARNING,e,t.serverResponse.url)}case ug.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new Ig(T.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ug.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new Ig(T.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case ug.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const e=new Ig(T.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(lg.WARNING,e,t.serverResponse.url)}case ug.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new Ig(T.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case ug.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new Ig(T.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case ug.LIVE_STREAM_RESPONSE_WORKER_LOST:case ug.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===t.serverResponse.command||"UninjectStream"===t.serverResponse.command)return;throw new Ig(T.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ug.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===t.serverResponse.command||"UninjectStream"===t.serverResponse.command)return;if("UpdateTranscoding"===t.serverResponse.command||"ControlStream"===t.serverResponse.command)return new Ig(T.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new Ig(T.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ug.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ug.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ug.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ug.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new Ig(T.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(X)}),6e3)}}function NC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function OC(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?NC(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):NC(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class bC extends C{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:J,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:J;super(),this.onLiveStreamWarning=void 0,this.onLiveStreamError=void 0,this.onInjectStatusChange=void 0,this.spec=void 0,this.retryTimeout=1e4,this.connection=void 0,this.httpRetryConfig=void 0,this.wsRetryConfig=void 0,this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.taskMutex=new v("live-streaming"),this.cancelToken=st.CancelToken.source(),this.transcodingConfig=void 0,this.injectConfig=OC({},dg),this.injectLoopTimes=0,this.uapResponse=void 0,this.lastTaskId=1,this.statusError=new Map,this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=t}async setTranscodingConfig(t){const i=OC(OC({},cg),t);66!==i.videoCodecProfile&&77!==i.videoCodecProfile&&100!==i.videoCodecProfile&&(e.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map((e=>OC(OC(OC({},og),e),{},{zOrder:e.zOrder?e.zOrder+1:1})))),function(e){u(e.width)||p(e.width,"config.width",0,1e4),u(e.height)||p(e.height,"config.height",0,1e4),u(e.videoBitrate)||p(e.videoBitrate,"config.videoBitrate",1,1e6),u(e.videoFrameRate)||p(e.videoFrameRate,"config.videoFrameRate"),u(e.lowLatency)||_(e.lowLatency,"config.lowLatency"),u(e.audioSampleRate)||E(e.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),u(e.audioBitrate)||p(e.audioBitrate,"config.audioBitrate",1,128),u(e.audioChannels)||E(e.audioChannels,"config.audioChannels",[1,2,3,4,5]),u(e.videoGop)||p(e.videoGop,"config.videoGop"),u(e.videoCodecProfile)||E(e.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),u(e.userCount)||p(e.userCount,"config.userCount",0,17),u(e.backgroundColor)||p(e.backgroundColor,"config.backgroundColor",0,16777215),u(e.userConfigExtraInfo)||m(e.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),e.transcodingUsers&&!u(e.transcodingUsers)&&(f(e.transcodingUsers,"config.transcodingUsers"),e.transcodingUsers.forEach(((e,t)=>{S(e.uid),u(e.x)||p(e.x,"transcodingUser[".concat(t,"].x"),0,1e4),u(e.y)||p(e.y,"transcodingUser[".concat(t,"].y"),0,1e4),u(e.width)||p(e.width,"transcodingUser[".concat(t,"].width"),0,1e4),u(e.height)||p(e.height,"transcodingUser[".concat(t,"].height"),0,1e4),u(e.zOrder)||p(e.zOrder-1,"transcodingUser[".concat(t,"].zOrder"),0,100),u(e.alpha)||p(e.alpha,"transcodingUser[".concat(t,"].alpha"),0,1,!1)}))),u(e.watermark)||ag(e.watermark,"watermark"),u(e.backgroundImage)||ag(e.backgroundImage,"backgroundImage"),e.images&&!u(e.images)&&(f(e.images,"config.images"),e.images.forEach(((e,t)=>{ag(e,"images[".concat(t,"]"))})))}(i);const n=[];i.images&&n.push(...i.images.map((e=>OC(OC(OC({},rg),e),{},{zOrder:255})))),i.backgroundImage&&(n.push(OC(OC(OC({},rg),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(n.push(OC(OC(OC({},rg),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=n,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map((e=>OC({},e))),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);const s=(i.userConfigs||[]).map((e=>"number"==typeof e.uid?yS.resolve(e.uid):mC(e.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await yS.all(s)).forEach(((e,t)=>{i.userConfigs&&i.userConfigs[t]&&(i.userConfigs[t].uid=e)})),this.transcodingConfig=i,this.connection)try{var o;const t=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(LS(o=this.streamingTasks).call(o)).map((e=>e.taskId)).join("#")});e.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(t.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(t){if(!t.data||!t.data.retry)throw t;t.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((i=>{e.warning("[".concat(this.spec.clientId,"] live streaming receive error"),t.toString(),"try to republish",i.url),this.startLiveStreamingTask(i.url,i.mode,t).then((()=>{e.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(i.url," success"))})).catch((t=>{e.error("[".concat(this.spec.clientId,"] live streaming republish failed"),i.url,t.toString()),this.onLiveStreamError&&this.onLiveStreamError(i.url,t)}))}))}}setInjectStreamConfig(e,t){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=t}async startLiveStreamingTask(t,i,n){var s;if(Array.from(LS(s=this.streamingTasks).call(s)).find((e=>e.mode===ng.INJECT))&&i===ng.INJECT)return new Ig(T.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&i===ng.TRANSCODE)throw new Ig(T.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let o={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};e.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(i));const r=await this.taskMutex.lock();if(!this.connection&&n)return void r();if(this.streamingTasks.get(t)&&!n)return r(),new Ig(T.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(e){throw r(),e}switch(i){case ng.TRANSCODE:o.transcodingConfig=OC({},this.transcodingConfig);break;case ng.RAW:break;case ng.INJECT:o={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:t,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(o.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const s=new yS(((e,i)=>{N(this.retryTimeout).then((()=>{if(n)return i(n);const e=this.statusError.get(t);return e?(this.statusError.delete(t),i(e)):void 0}))})),c=await yS.race([this.connection.request("request",{clientRequest:o},!0,{url:t,command:"PublishStream",workerType:i===ng.TRANSCODE?1:2,requestByUser:!n,tid:a.toString()}),s]);this.isStartingStreamingTask=!1,e.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(t,{clientRequest:o,mode:i,url:t,taskId:a}),r()}catch(e){if(r(),this.isStartingStreamingTask=!1,!e.data||!e.data.retry||n)throw e;return e.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,i,e)):await this.startLiveStreamingTask(t,i,e)}}stopLiveStreamingTask(t){return new yS(((i,n)=>{const s=this.streamingTasks.get(t);if(!s||!this.connection)return new Ig(T.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=s.mode;s.abortTask=()=>{e.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),i()},this.connection.request("request",{clientRequest:{command:o===ng.INJECT?"UninjectStream":"UnpublishStream",url:s.url}},!1,{url:t,command:"UnPublishStream",workerType:o===ng.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((n=>{e.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(n.code)),this.streamingTasks.delete(t),0===this.streamingTasks.size&&o!==ng.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),i(),o===ng.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(sg.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,t)})).catch(n)}))}async controlInjectStream(e,t,i,n){const s=this.streamingTasks.get(e);if(!s||!this.connection||s.mode!==ng.INJECT)throw new Ig(T.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:t,audioVolume:i,position:n}})).serverResponse}resetAllTask(){var e;const t=Array.from(LS(e=this.streamingTasks).call(e));this.terminate();for(const e of t)this.startLiveStreamingTask(e.url,e.mode).catch((t=>{this.onLiveStreamError&&this.onLiveStreamError(e.url,t)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=st.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new Ig(T.UNEXPECTED_ERROR,"live streaming connection has already connected");const t=await O(this,hg.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new wC(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(lg.WARNING,((e,t)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e))),this.connection.on(lg.PUBLISH_STREAM_STATUS,(e=>this.handlePublishStreamServer(e))),this.connection.on(lg.INJECT_STREAM_STATUS,(e=>this.handleInjectStreamServerStatus(e))),this.connection.on(lg.REQUEST_NEW_ADDRESS,((t,i)=>{if(!this.connection)return i(new Ig(T.UNEXPECTED_ERROR,"can not get new live streaming address list"));O(this,hg.REQUEST_WORKER_MANAGER_LIST,e).then((e=>{this.uapResponse=e,t(e.addressList)})).catch(i)})),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(t){const i=t.serverStatus&&t.serverStatus.url||"empty_url",n=this.streamingTasks.get(i),s=t.reason;switch(t.code){case ug.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ug.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ug.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ug.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const s=new Ig(T.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(n)return e.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,s);if(!this.isStartingStreamingTask)return;this.statusError.set(i,s)}case ug.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new Ig(T.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,s);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,e)}case ug.LIVE_STREAM_RESPONSE_WORKER_LOST:case ug.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();const i=Array.from(LS(o=this.streamingTasks).call(o));for(const n of i)n.abortTask?n.abortTask():(e.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",n.url),this.startLiveStreamingTask(n.url,n.mode,new Ig(T.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then((()=>{e.debug("[".concat(this.spec.clientId,"] republish live stream success"),n.url)})).catch((t=>{e.error(t.toString()),this.onLiveStreamError&&this.onLiveStreamError(n.url,t)})));return}}}handleInjectStreamServerStatus(t){const i=Number(t.uid),n=t.serverStatus&&t.serverStatus.url;switch(t.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(sg.INJECT_STREAM_STATUS_START_SUCCESS,i,n));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(sg.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,i,n),void this.streamingTasks.delete(n);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(sg.INJECT_STREAM_STATUS_START_UNAUTHORIZED,i,n),void this.streamingTasks.delete(n);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(sg.INJECT_STREAM_STATUS_BROKEN,i,n),void this.streamingTasks.delete(n);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(sg.INJECT_STREAM_STATUS_START_TIMEOUT,i,n),void this.streamingTasks.delete(n);default:return void e.debug("inject stream server status",t)}}hasUrl(e){return this.streamingTasks.has(e)}}class DC{constructor(){this.destChannelMediaInfos=new Map,this.srcChannelMediaInfo=void 0}setSrcChannelInfo(e){vg(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){vg(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){R(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function PC(e){if(!(e instanceof DC)){return new Ig(T.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw()}const t=e.getSrcChannelMediaInfo(),i=e.getDestChannelMediaInfo();if(!t){return new Ig(T.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}if(0===i.size){return new Ig(T.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}}class LC extends C{constructor(e,t,i){super(),this.ws=void 0,this.requestId=1,this.heartBeatTimer=void 0,this.joinInfo=void 0,this.clientId=void 0,this.onOpen=()=>{this.emit("open"),this.startHeartBeatCheck()},this.onClose=e=>{this.emit("close"),this.dispose()},this.onMessage=e=>{const t=JSON.parse(e.data);if(!t||"serverResponse"!==t.command||!t.requestId)return t&&"serverStatus"===t.command&&t.serverStatus&&t.serverStatus.command?(this.emit("status",t.serverStatus),void this.emit(t.serverStatus.command,t.serverStatus)):void 0;this.emit("req_".concat(t.requestId),t)},this.joinInfo=e,this.clientId=t,this.ws=new cT("cross-channel-".concat(this.clientId),i),this.ws.on(ig.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(ig.CONNECTED,this.onOpen),this.ws.on(ig.ON_MESSAGE,this.onMessage),this.ws.on(ig.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new yS(((t,i)=>{const n=window.setTimeout((()=>{i(new Ig(T.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(s=>{window.clearTimeout(n),s.state&&0!==s.state?i(new Ig(T.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)})),this.once("dispose",(()=>{window.clearTimeout(n),i(new Ig(T.WS_ABORT))}))}))}async request(e){if("closed"===this.ws.state)throw new Ig(T.WS_DISCONNECT);const t=()=>new yS(((e,t)=>{this.ws.once(ig.CLOSED,(()=>t(new Ig(T.WS_ABORT)))),this.ws.once(ig.CONNECTED,e)}));"connected"!==this.ws.state&&await t();const i=this.sendMessage(e),n=new yS(((e,t)=>{const n=()=>{t(new Ig(T.WS_ABORT))};this.ws.once(ig.RECONNECTING,n),this.ws.once(ig.CLOSED,n),this.once("req_".concat(i),e),N(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(ig.RECONNECTING,n),this.ws.off(ig.CLOSED,n),t(new Ig(T.TIMEOUT,"cross channel ws request timeout"))}))})),s=await n;if(!s||200!==s.code)throw new Ig(T.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(e){this.ws.removeAllListeners(ig.REQUEST_NEW_URLS),this.ws.on(ig.REQUEST_NEW_URLS,(t=>{t(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class kC extends C{set state(e){e!==this._state&&(e!==mg.RELAY_STATE_FAILURE&&(this.errorCode=fg.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(t,i,n,s,o){super(),this.joinInfo=void 0,this.sid=void 0,this.clientId=void 0,this.cancelToken=st.CancelToken.source(),this.workerToken=void 0,this.requestId=0,this.signal=void 0,this.prevChannelMediaConfig=void 0,this.httpRetryConfig=void 0,this._resolution=void 0,this._state=mg.RELAY_STATE_IDLE,this.errorCode=fg.RELAY_OK,this.onStatus=t=>{e.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(t))),t&&t.command&&("onAudioPacketReceived"===t.command&&this.emit("event",Eg.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===t.command&&this.emit("event",Eg.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===t.command&&(this.errorCode=fg.SRC_TOKEN_EXPIRED,this.state=mg.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===t.command&&(this.errorCode=fg.DEST_TOKEN_EXPIRED,this.state=mg.RELAY_STATE_FAILURE))},this.onReconnect=async()=>{e.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Eg.NETWORK_DISCONNECTED),this.state=mg.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((t=>{this.state!==mg.RELAY_STATE_IDLE&&(e.error("auto restart channel media relay failed",t.toString()),this.errorCode=fg.SERVER_CONNECTION_LOST,this.state=mg.RELAY_STATE_FAILURE)}))},this.joinInfo=t,this.clientId=i,this.sid=z(),this.signal=new LC(this.joinInfo,this.clientId,n),this.httpRetryConfig=s,this._resolution=o}async startChannelMediaRelay(t){if(this.state!==mg.RELAY_STATE_IDLE)throw new Ig(T.INVALID_OPERATION);this.state=mg.RELAY_STATE_CONNECTING,await this.connect(),e.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(e){if(e.data&&e.data.serverResponse&&"SetSourceChannel"===e.data.serverResponse.command)throw new Ig(T.CROSS_CHANNEL_FAILED_JOIN_SRC);if(e.data&&e.data.serverResponse&&"SetDestChannelStatus"===e.serverResponse.command)throw new Ig(T.CROSS_CHANNEL_FAILED_JOIN_DEST);if(e.data&&e.data.serverResponse&&"StartPacketTransfer"===e.serverResponse.command)throw new Ig(T.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw e}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(e){if(this.state!==mg.RELAY_STATE_RUNNING)throw new Ig(T.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(t){if(this._resolution=t,this.state!==mg.RELAY_STATE_RUNNING)throw new Ig(T.INVALID_OPERATION);const i=this.genMessage(_g.SetVideoProfile);await this.signal.request(i),e.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),e.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=mg.RELAY_STATE_IDLE,this.dispose()}dispose(){e.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=st.CancelToken.source(),this.state=mg.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await TC(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",Eg.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const i=this.genMessage(_g.StopPacketTransfer);await this.signal.request(i),await this.signal.waitStatus("Normal Quit"),e.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const n=this.genMessage(_g.SetSdkProfile,t);await this.signal.request(n),e.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const s=this.genMessage(_g.SetSourceChannel,t);await this.signal.request(s),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Eg.PACKET_JOINED_SRC_CHANNEL),e.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const o=this.genMessage(_g.SetSourceUserId,t);await this.signal.request(o),e.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const r=this.genMessage(_g.SetDestChannel,t);await this.signal.request(r),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Eg.PACKET_JOINED_DEST_CHANNEL),e.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(_g.StartPacketTransfer,t);await this.signal.request(a),this.emit("event",Eg.PACKET_SENT_TO_DEST_CHANNEL),this.state=mg.RELAY_STATE_RUNNING,e.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const i=this.genMessage(_g.UpdateDestChannel,t);await this.signal.request(i),this.emit("event",Eg.PACKET_UPDATE_DEST_CHANNEL),e.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(_g.StopPacketTransfer);await this.signal.request(t),e.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){const i=[],n=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:B,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.19.0"===o.sdkVersion&&(o.sdkVersion="0.0.1");let r=null,a=null;switch(e){case _g.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case _g.SetSourceChannel:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new Ig(T.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},o;case _g.SetSourceUserId:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new Ig(T.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:a.uid+""},o;case _g.SetDestChannel:if(r=t&&t.getDestChannelMediaInfo(),!r)throw new Ig(T.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:i,uid:n,token:s},o;case _g.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case _g.Reconnect:return o.clientRequest={command:"Reconnect"},o;case _g.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case _g.UpdateDestChannel:if(r=t&&t.getDestChannelMediaInfo(),!r)throw new Ig(T.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:n,token:s},o;case _g.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}class MC{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio)return this._audioTrack}get videoTrack(){if(this.hasVideo)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){this.uid=void 0,this._uintid=void 0,this._trust_in_room_=!0,this._trust_audio_enabled_state_=!0,this._trust_video_enabled_state_=!0,this._trust_audio_mute_state_=!0,this._trust_video_mute_state_=!0,this._audio_muted_=!1,this._video_muted_=!1,this._audio_enabled_=!0,this._video_enabled_=!0,this._audio_added_=!1,this._video_added_=!1,this._trust_video_stream_added_state_=!0,this._trust_audio_stream_added_state_=!0,this._audioTrack=void 0,this._videoTrack=void 0,this._dataChannels=[],this._audioSSRC=void 0,this._videoSSRC=void 0,this._audioOrtc=void 0,this._videoOrtc=void 0,this._cname=void 0,this._rtxSsrcId=void 0,this.uid=e,this._uintid=t}}var UC=vS,xC=Nm;Ls({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var e=xC.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var VC=Nm,FC=dm;Ls({target:"Promise",stat:!0,forced:!0},{try:function(e){var t=VC.f(this),i=FC(e);return(i.error?t.reject:t.resolve)(i.value),t.promise}});var jC=rt(UC),BC=Wa.f("asyncIterator"),GC=rt(BC);function WC(e,t){this.v=e,this.k=t}function HC(e){var t,i;function n(t,i){try{var o=e[t](i),r=o.value,a=r instanceof WC;jC.resolve(a?r.v:r).then((function(i){if(a){var c="return"===t?"return":"next";if(!r.k||i.done)return n(c,i);i=e[c](i).value}s(o.done?"return":"normal",i)}),(function(e){n("throw",e)}))}catch(e){s("throw",e)}}function s(e,s){switch(e){case"return":t.resolve({value:s,done:!0});break;case"throw":t.reject(s);break;default:t.resolve({value:s,done:!1})}(t=t.next)?n(t.key,t.arg):i=null}this._invoke=function(e,s){return new jC((function(o,r){var a={key:e,arg:s,resolve:o,reject:r,next:null};i?i=i.next=a:(t=i=a,n(e,s))}))},"function"!=typeof e.return&&(this.return=void 0)}function KC(e){return function(){return new HC(e.apply(this,arguments))}}function qC(e){return new WC(e,0)}function YC(e){var t={},i=!1;function n(t,n){return i=!0,{done:!1,value:new WC(n=new jC((function(i){i(e[t](n))})),1)}}return t[void 0!==ju&&np||"@@iterator"]=function(){return this},t.next=function(e){return i?(i=!1,e):n("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(i)throw i=!1,e;return n("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return i?(i=!1,e):n("return",e)}),t}HC.prototype["function"==typeof ju&&GC||"@@asyncIterator"]=function(){return this},HC.prototype.next=function(e){return this._invoke("next",e)},HC.prototype.throw=function(e){return this._invoke("throw",e)},HC.prototype.return=function(e){return this._invoke("return",e)};var JC=rt(BC),XC=$s("Array").keys,zC=Eo,QC=nn,ZC=_t,$C=XC,eI=Array.prototype,tI={DOMTokenList:!0,NodeList:!0},iI=rt((function(e){var t=e.keys;return e===eI||ZC(eI,e)&&t===eI.keys||QC(tI,zC(e))?$C:t})),nI={exports:{}};nI.exports=(()=>{var e={8:(e,t,i)=>{i.r(t),i.d(t,{Parser:()=>C,Printer:()=>w,parse:()=>D,print:()=>P});const n="\n",s="".concat("\r").concat(n),o=" ";let r;function a(e){return e>="0"&&e<="9"}function c(e){return e>="!"&&e<="~"}function d(e){return c(e)||e>="Â"&&e<="Ã¿"}function l(e){return"!"===e||e>="#"&&e<="'"||e>="*"&&e<="+"||e>="-"&&e<="."||e>="0"&&e<="9"||e>="A"&&e<="Z"||e>="^"&&e<="~"}function h(e){return e>="1"&&e<="9"}function u(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"}function p(e){return"d"===e||"h"===e||"m"===e||"s"===e}function _(e){return e>""&&e<"\t"||e>"\v"&&e<"\f"||e>""&&e<"Ã¿"}function E(e){return u(e)||a(e)||"+"===e||"/"===e}function m(e){return a(e)||u(e)||"+"===e||"/"===e||"-"===e||"_"===e}function f(e){return u(e)||a(e)||"+"===e||"/"===e}function S(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function g(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?S(Object(i),!0).forEach((function(t){T(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):S(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function T(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){e.VERSION="v",e.ORIGIN="o",e.SESSION_NAME="s",e.INFORMATION="i",e.URI="u",e.EMAIL="e",e.PHONE="p",e.CONNECTION="c",e.BANDWIDTH="b",e.TIME="t",e.REPEAT="r",e.ZONE_ADJUSTMENTS="z",e.KEY="k",e.ATTRIBUTE="a",e.MEDIA="m"}(r||(r={}));class R{consumeText(e,t){let i=t;for(;i<e.length;){const t=e[i];if("\0"===t||"\r"===t||t===n)break;i+=1}if(i-t==0)throw new Error("Invalid text, at ".concat(e));return i}consumeUnicastAddress(e,t,i){return this.consumeTill(e,t,o)}consumeOneOrMore(e,t,i){let n=t;for(;i(e[n]);)n++;if(n-t==0)throw new Error("Invalid rule at ".concat(t,"."));return n}consumeSpace(e,t){if(e[t]===o)return t+1;throw new Error("Invalid space at ".concat(t,"."))}consumeIP4Address(e,t){let i=t;for(let t=0;t<4;t++)if(i=this.consumeDecimalUChar(e,i),3!==t){if("."!==e[i])throw new Error("Invalid IP4 address.");i++}return i}consumeDecimalUChar(e,t){let i=t;for(let t=0;t<3&&a(e[i]);t++,i++);if(i-t==0)throw new Error("Invalid decimal uchar.");const n=parseInt(e.slice(t,i));if(n>=0&&n<=255)return i;throw new Error("Invalid decimal uchar")}consumeIP6Address(e,t){let i=this.consumeHexpart(e,t);return":"===e[i]?(i+=1,i=this.consumeIP4Address(e,i),i):i}consumeHexpart(e,t){let i=t;if(":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}if(i=this.consumeHexseq(e,i),":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}return i}consumeHexseq(e,t){let i=t;for(;i=this.consumeHex4(e,i),":"===e[i]&&":"!==e[i+1];)i+=1;return i}consumeHex4(e,t){let i=0;for(;i<4;i++)if(!((n=e[t+i])>="0"&&n<="9"||n>="a"&&n<="f"||n>="A"&&n<="F")){if(0===i)throw new Error("Invalid hex 4");break}var n;return t+i}consumeFQDN(e,t){let i=t;for(;a(e[i])||u(e[i])||"-"===e[i]||"."===e[i];)i+=1;if(i-t<4)throw new Error("Invalid FQDN");return i}consumeExtnAddr(e,t){return this.consumeOneOrMore(e,t,d)}consumeMulticastAddress(e,t,i){switch(i){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(e,t);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(e,t);default:try{return this.consumeFQDN(e,t)}catch(i){return this.consumeExtnAddr(e,t)}}}consumeIP6MulticastAddress(e,t){const i=this.consumeHexpart(e,t);return"/"===e[i]?this.consumeInteger(e,i+1):i}consumeIP4MulticastAddress(e,t){let i=t+3;const n=e.slice(t,i),s=parseInt(n);if(s<224||s>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let t=0;t<3;t++){if("."!==e[i])throw new Error("Invalid IP4 multicast address.");i+=1,i=this.consumeDecimalUChar(e,i)}return"/"===e[i]&&(i+=1),i=this.consumeTTL(e,i),"/"===e[i]&&(i=this.consumeInteger(e,i)),i}consumeInteger(e,t){if(!h(e[t]))throw new Error("Invalid integer.");for(t+=1;a(e[t]);)t+=1;return t}consumeTTL(e,t){if("0"===e[t])return t+1;if(!h(e[t]))throw new Error("Invalid TTL.");t+=1;for(let i=0;i<2&&a(e[t]);i++)t+=1;return t}consumeToken(e,t){return this.consumeOneOrMore(e,t,l)}consumeTime(e,t){let i=t;if("0"===e[i])return i+1;for(h(e[i])&&(i+=1);a(e[i]);)i++;if(i-t<10)throw new Error("Invalid time");return i}consumeAddress(e,t){return this.consumeTill(e,t,o)}consumeTypedTime(e,t){let i=t;return i=this.consumeOneOrMore(e,i,a),p(e[i])?i+1:i}consumeRepeatInterval(e,t){if(!h(e[t]))throw new Error("Invalid repeat interval");for(t+=1;a(e[t]);)t+=1;return p(e[t])&&(t+=1),t}consumePort(e,t){return this.consumeOneOrMore(e,t,a)}consume(e,t,i){for(let n=0;n<i.length;n++){if(t+n>=e.length)throw new Error("consume exceeding value length");if(e[t+n]!==i[n])throw new Error("consume ".concat(i," failed at ").concat(n))}return t+i.length}consumeTill(e,t,i){let n=t;for(;n<e.length&&("string"!=typeof i||e[n]!==i)&&("function"!=typeof i||!i(e[n]));)n++;return n}}class C extends R{constructor(){super(),T(this,"records",[]),T(this,"currentLine",0)}parse(e){const t=this.probeEOL(e);this.records=e.split(t).filter((e=>!!e.trim())).map(this.parseLine),this.currentLine=0;const i=this.parseVersion(),n=this.parseOrigin(),s=this.parseSessionName(),o=this.parseInformation(),r=this.parseUri(),a=this.parseEmail(),c=this.parsePhone(),d=this.parseConnection(),l=this.parseBandWidth(),h=this.parseTimeFields(),u=this.parseKey(),p=this.parseSessionAttribute(),_=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:i,origin:n,sessionName:s,information:o,uri:r,emails:a,phones:c,connection:d,bandwidths:l,timeFields:h,key:u,attributes:p,mediaDescriptions:_}}getCurrentRecord(){const e=this.records[this.currentLine];if(!e)throw new Error("Record doesn't exit.");return e}probeEOL(e){for(let t=0;t<e.length;t++)if(e[t]===n)return"\r"===e[t-1]?s:n;throw new Error("Invalid newline character.")}parseLine(e,t){if(e.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const i=e[0];if("="!==e[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:i,value:e.slice(2),line:t,cur:0}}parseSessionAttribute(){const e=new v;for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(t,(e=>l(e)&&":"!==e)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,i.attValue=this.extractOneOrMore(t,_)),e.parse(i),this.currentLine++}return e.digest()}parseMediaAttributes(e){const t=new y(e);for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(e,(e=>l(e)&&":"!==e)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,i.attValue=this.extractOneOrMore(e,_)),t.parse(i),this.currentLine++}return t.digest()}parseKey(){const e=this.getCurrentRecord();if(e.type===r.KEY){if("prompt"===e.value||"clear:"===e.value||"base64:"===e.value||"uri:"===e.value)return e.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const e=this.getCurrentRecord();if(e.type===r.ZONE_ADJUSTMENTS){const t=[];for(;;)try{const i=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);let n=!1;"-"===e.value[e.cur]&&(n=!0,e.cur+=1);const s=this.extract(e,this.consumeTypedTime);t.push({time:i,typedTime:s,back:n})}catch(e){break}if(0===t.length)throw new Error("Invalid zone adjustments");return this.currentLine++,t}return[]}parseRepeat(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==r.REPEAT)break;{const i=this.extract(t,this.consumeRepeatInterval),n=this.parseTypedTime(t);e.push({repeatInterval:i,typedTimes:n}),this.currentLine++}}return e}parseTypedTime(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeTypedTime))}catch(e){break}if(0===t.length)throw new Error("Invalid typed time.");return t}parseTime(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);const i=this.extract(e,this.consumeTime);return this.currentLine++,{startTime:t,stopTime:i}}parseBandWidth(){const e=[];for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==r.BANDWIDTH)break;{const i=this.extractOneOrMore(t,l);if(":"!==t.value[t.cur])throw new Error("Invalid bandwidth field.");t.cur++;const n=this.extractOneOrMore(t,a);e.push({bwtype:i,bandwidth:n}),this.currentLine++}}return e}parseVersion(){const e=this.getCurrentRecord();if(e.type!==r.VERSION)throw new Error("first sdp record must be version");const t=e.value.slice(0,this.consumeOneOrMore(e.value,0,a));if(t.length!==e.value.length)throw new Error('invalid proto version, "v='.concat(e.value,'"'));return this.currentLine++,t}parseOrigin(){const e=this.getCurrentRecord();if(e.type!==r.ORIGIN)throw new Error("second line of sdp must be origin");const t=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const s=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const o=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const c=this.extract(e,this.consumeUnicastAddress);return this.currentLine++,{username:t,sessId:i,sessVersion:n,nettype:s,addrtype:o,unicastAddress:c}}parseSessionName(){const e=this.getCurrentRecord();if(e.type===r.SESSION_NAME){const t=this.extract(e,this.consumeText);return this.currentLine++,t}}parseInformation(){const e=this.getCurrentRecord();if(e.type!==r.INFORMATION)return;const t=this.extract(e,this.consumeText);return this.currentLine++,t}parseUri(){const e=this.getCurrentRecord();if(e.type===r.URI)return this.currentLine++,e.value}parseEmail(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==r.EMAIL)break;e.push(t.value),this.currentLine++}return e}parsePhone(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==r.PHONE)break;e.push(t.value),this.currentLine++}return e}parseConnection(){const e=this.getCurrentRecord();if(e.type===r.CONNECTION){const t=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const n=this.extract(e,this.consumeAddress);return this.currentLine++,{nettype:t,addrtype:i,address:n}}}parseMedia(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeToken);this.consumeSpaceForRecord(e);let i=this.extract(e,this.consumePort);"/"===e.value[e.cur]&&(e.cur+=1,i+=this.extract(e,this.consumeInteger)),this.consumeSpaceForRecord(e);const n=[];for(n.push(this.extract(e,this.consumeToken));"/"===e.value[e.cur];)e.cur+=1,n.push(this.extract(e,this.consumeToken));if(0===n.length)throw new Error("Invalid proto");const s=this.parseFmt(e);return this.currentLine++,{mediaType:t,port:i,protos:n,fmts:s}}parseTimeFields(){const e=[];for(;this.getCurrentRecord().type===r.TIME;){const t=this.parseTime(),i=this.parseRepeat(),n=this.parseZone();e.push({time:t,repeats:i,zones:n})}return e}parseMediaDescription(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.MEDIA;){const t=this.parseMedia(),i=this.parseInformation(),n=this.parseConnections(),s=this.parseBandWidth(),o=this.parseKey(),r=this.parseMediaAttributes(t);e.push({media:t,information:i,connections:n,bandwidths:s,key:o,attributes:r})}return e}parseConnections(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.CONNECTION;)e.push(this.parseConnection());return e}parseFmt(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeToken))}catch(e){break}if(0===t.length)throw new Error("Invalid fmts");return t}extract(e,t,...i){const n=t.call(this,e.value,e.cur,...i),s=e.value.slice(e.cur,n);return e.cur=n,s}extractOneOrMore(e,t){const i=this.consumeOneOrMore(e.value,e.cur,t),n=e.value.slice(e.cur,i);return e.cur=i,n}consumeSpaceForRecord(e){if(e.value[e.cur]!==o)throw new Error("Invalid space at ".concat(e.cur,"."));e.cur+=1}}class I extends R{constructor(...e){super(...e),T(this,"attributes",void 0),T(this,"digested",!1)}extractOneOrMore(e,t,i){const n=this.consumeOneOrMore(e.attValue,e._cur,t),s=e.attValue.slice(e._cur,n),[o,r]=i||[];if("number"==typeof o&&s.length<o)throw new Error("error in length, should be more or equal than ".concat(o," characters."));if("number"==typeof r&&s.length>r)throw new Error("error in length, should be less or equal than ".concat(r," characters."));return e._cur=n,s}consumeAttributeSpace(e){if(e.attValue[e._cur]!==o)throw new Error("Invalid space at ".concat(e._cur,"."));e._cur+=1}extract(e,t,...i){if(!e.attValue)throw new Error("Nothing to extract from attValue.");const n=t.call(this,e.attValue,e._cur,...i),s=e.attValue.slice(e._cur,n);return e._cur=n,s}atEnd(e){if(!e.attValue)throw new Error;return e._cur>=e.attValue.length}peekChar(e){if(!e.attValue)throw new Error;return e.attValue[e._cur]}peek(e,t){if(!e.attValue)throw new Error;for(let i=0;i<t.length;i++)if(t[i]!==e.attValue[e._cur+i])return!1;return!0}parseIceUfrag(e){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(e,E,[4,256])}parseIcePwd(e){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(e,E,[22,256])}parseIceOptions(e){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const t=[];for(;!this.atEnd(e);){t.push(this.extractOneOrMore(e,E));try{this.consumeAttributeSpace(e)}catch(t){if(this.atEnd(e))break;throw t}}this.attributes.iceOptions=t}parseFingerprint(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill);this.attributes.fingerprints.push({hashFunction:t,fingerprint:i})}parseExtmap(e){const t=this.extractOneOrMore(e,a);let i;"/"===this.peekChar(e)&&(this.extract(e,this.consume,"/"),i=this.extract(e,this.consumeToken)),this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,o),s=g(g({entry:parseInt(t,10)},i&&{direction:i}),{},{extensionName:n});this.peekChar(e)===o&&(this.consumeAttributeSpace(e),s.extensionAttributes=this.extract(e,this.consumeTill)),this.attributes.extmaps.push(s)}parseSetup(e){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const t=this.extract(e,this.consumeTill);if("active"!==t&&"passive"!==t&&"actpass"!==t&&"holdconn"!==t)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=t}}class v extends I{constructor(...e){super(...e),T(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"group":this.parseGroup(e);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"fingerprint":this.parseFingerprint(e);break;case"setup":this.parseSetup(e);break;case"tls-id":this.parseTlsId(e);break;case"identity":this.parseIdentity(e);break;case"extmap":this.parseExtmap(e);break;case"msid-semantic":this.parseMsidSemantic(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing session attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;)this.consumeAttributeSpace(e),i.push(this.extract(e,this.consumeToken));this.attributes.groups.push({semantic:t,identificationTag:i})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(e){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(e,m)}parseIdentity(e){const t=this.extractOneOrMore(e,f),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.extract(e,this.consume,"=");const n=this.extractOneOrMore(e,(e=>e!==o&&_(e)));i.push({name:t,value:n})}this.attributes.identities.push({assertionValue:t,extensions:i})}parseMsidSemantic(e){this.peekChar(e)===o&&this.consumeAttributeSpace(e);const t={semantic:this.extract(e,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(e)}catch(e){break}if("*"===this.peekChar(e)){this.extract(e,this.consume,"*"),t.applyForAll=!0;break}{const i=this.extract(e,this.consumeTill,o);t.identifierList.push(i)}}this.attributes.msidSemantic=t}}class y extends I{constructor(e){super(),T(this,"attributes",void 0),-1!==e.protos.indexOf("RTP")||e.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"extmap":this.parseExtmap(e);break;case"setup":this.parseSetup(e);break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"candidate":this.parseCandidate(e);break;case"remote-candidate":this.parseRemoteCandidate(e);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(e);break;case"rtpmap":this.parseRtpmap(e);break;case"ptime":this.parsePtime(e);break;case"maxptime":this.parseMaxPtime(e);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(e);break;case"ssrc":this.parseSSRC(e);break;case"fmtp":this.parseFmtp(e);break;case"rtcp-fb":this.parseRtcpFb(e);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(e);break;case"mid":this.parseMid(e);break;case"msid":this.parseMsid(e);break;case"imageattr":this.parseImageAttr(e);break;case"rid":this.parseRid(e);break;case"simulcast":this.parseSimulcast(e);break;case"sctp-port":this.parseSctpPort(e);break;case"max-message-size":this.parseMaxMessageSize(e);break;case"ssrc-group":this.parseSSRCGroup(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing media attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}parseCandidate(e){const t=this.extractOneOrMore(e,E,[1,32]);this.consumeAttributeSpace(e);const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const s=this.extractOneOrMore(e,a,[1,10]);this.consumeAttributeSpace(e);const r=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const d=this.extract(e,this.consumePort);this.consumeAttributeSpace(e),this.extract(e,this.consume,"typ"),this.consumeAttributeSpace(e);const l={foundation:t,componentId:i,transport:n,priority:s,connectionAddress:r,port:d,type:this.extract(e,this.consumeToken),extension:{}};for(this.peek(e," raddr")&&(this.extract(e,this.consume," raddr"),this.consumeAttributeSpace(e),l.relAddr=this.extract(e,this.consumeAddress)),this.peek(e," rport")&&(this.extract(e,this.consume," rport"),this.consumeAttributeSpace(e),l.relPort=this.extract(e,this.consumePort));this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e),l.extension[t]=this.extractOneOrMore(e,c)}this.attributes.candidates.push(l)}parseRemoteCandidate(e){const t=[];for(;;){const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const s=this.extract(e,this.consumePort);t.push({componentId:i,connectionAddress:n,port:s});try{this.consumeAttributeSpace(e)}catch(e){break}}this.attributes.remoteCandidatesList.push(t)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,"/");this.extract(e,this.consume,"/");const n={encodingName:i,clockRate:this.extractOneOrMore(e,a)};this.atEnd(e)||"/"!==this.peekChar(e)||(this.extract(e,this.consume,"/"),n.encodingParameters=parseInt(this.extract(e,this.consumeTill),10));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.rtpMap=n:this.attributes.payloads.push({payloadType:parseInt(t,10),rtpMap:n,rtcpFeedbacks:[]})}parsePtime(e){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(e,this.consumeTill)}parseMaxPtime(e){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(e,this.consumeTill)}parseDirection(e){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=e.attField}parseSSRC(e){const t=this.extractOneOrMore(e,a);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,":");let n;":"===this.peekChar(e)&&(this.extract(e,this.consume,":"),n=this.extract(e,this.consumeTill));const s=this.attributes.ssrcs.find((e=>e.ssrcId===parseInt(t,10)));s?s.attributes[i]=n:this.attributes.ssrcs.push({ssrcId:parseInt(t,10),attributes:{[i]:n}})}parseFmtp(e){const t=this.extract(e,this.consumeTill,o);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill),n={};i.split(";").forEach((e=>{let[t,i]=e.split("=");t=t.trim();const s="string"==typeof i?i.trim():null;"string"==typeof t&&t.length>0&&(n[t]=s)}));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.fmtp={parameters:n}:this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[],fmtp:{parameters:n}})}parseFmtParameters(e){const t={},i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");for(t[i]=n;";"===e.attValue[e._cur];){const i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");t[i]=n}return t}parseRtcpFb(e){let t="";t="*"===this.peekChar(e)?this.extract(e,this.consume,"*"):this.extract(e,this.consumeTill,o),this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,o);let n;if("trr-int"===i)n={type:i,interval:this.extract(e,this.consumeTill)};else{const t={type:i};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.parameter=this.extract(e,this.consumeToken),this.peekChar(e)===o&&(t.additional=this.extract(e,this.consumeTill))),n=t}if("*"===t)this.attributes.rtcpFeedbackWildcards.push(n);else{const e=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));e?e.rtcpFeedbacks.push(n):this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[n]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(e){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const t={port:this.extract(e,this.consumePort)};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.netType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.addressType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.address=this.extract(e,this.consumeAddress)),this.attributes.rtcp=t}parseMsid(e){const t={id:this.extractOneOrMore(e,l,[1,64])};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.appdata=this.extractOneOrMore(e,l,[1,64])),this.attributes.msids.push(t)}parseImageAttr(e){this.attributes.imageattr.push(e.attValue)}parseRid(e){const t=this.extractOneOrMore(e,(e=>u(e)||a(e)||"_"===e||"-"===e));this.consumeAttributeSpace(e);const i={id:t,direction:this.extract(e,this.consumeToken),params:[]};if(this.peekChar(e)===o){if(this.consumeAttributeSpace(e),this.peek(e,"pt=")){this.extract(e,this.consume,"pt=");const t=[];for(;;){const i=this.extract(e,this.consumeToken);t.push(i);try{this.extract(e,this.consume,",")}catch(e){break}}i.payloads=t,this.peekChar(e)===o&&this.extract(e,this.consume,o)}for(;;){const t=this.extract(e,this.consumeToken);switch(t){case"depend":{const n={type:t,rids:this.extract(e,this.consume,"=").split(",")};i.params.push(n);break}default:{const n={type:t};"="===this.peekChar(e)&&(this.extract(e,this.consume,"="),n.val=this.extract(e,this.consumeTill,";")),i.params.push(n)}}try{this.extract(e,this.consume,";")}catch(e){break}}}this.attributes.rids.push(i)}parseSimulcast(e){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=e.attValue,this.extract(e,this.consumeTill)}parseSctpPort(e){this.attributes.sctpPort=this.extractOneOrMore(e,a,[1,5])}parseMaxMessageSize(e){this.attributes.maxMessageSize=this.extractOneOrMore(e,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(e){this.attributes.mid=this.extract(e,this.consumeToken)}parseSSRCGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;;)try{this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeInteger);i.push(parseInt(t,10))}catch(e){break}this.attributes.ssrcGroups.push({semantic:t,ssrcIds:i})}}function A(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class w{constructor(){A(this,"eol",s)}print(e,t){let i="";return t&&(this.eol=t),i+=this.printVersion(e.version),i+=this.printOrigin(e.origin),i+=this.printSessionName(e.sessionName),i+=this.printInformation(e.information),i+=this.printUri(e.uri),i+=this.printEmail(e.emails),i+=this.printPhone(e.phones),i+=this.printConnection(e.connection),i+=this.printBandwidth(e.bandwidths),i+=this.printTimeFields(e.timeFields),i+=this.printKey(e.key),i+=this.printSessionAttributes(e.attributes),i+=this.printMediaDescription(e.mediaDescriptions),i}printVersion(e){return"v=".concat(e).concat(this.eol)}printOrigin(e){return"o=".concat(e.username," ").concat(e.sessId," ").concat(e.sessVersion," ").concat(e.nettype," ").concat(e.addrtype," ").concat(e.unicastAddress).concat(this.eol)}printSessionName(e){return e?"s=".concat(e).concat(this.eol):""}printInformation(e){return e?"i=".concat(e).concat(this.eol):""}printUri(e){return e?"u=".concat(e).concat(this.eol):""}printEmail(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printPhone(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printConnection(e){return e?"c=".concat(e.nettype," ").concat(e.addrtype," ").concat(e.address).concat(this.eol):""}printBandwidth(e){let t="";for(const i of e)t+="b=".concat(i.bwtype,":").concat(i.bandwidth).concat(this.eol);return t}printTimeFields(e){let t="";for(const i of e){t+="t=".concat(i.time.startTime," ").concat(i.time.startTime).concat(this.eol);for(const e of i.repeats)t+="r=".concat(e.repeatInterval," ").concat(e.typedTimes.join(" ")).concat(this.eol);i.zoneAdjustments&&(t+="z=",t+="z=".concat(i.zoneAdjustments.map((e=>"".concat(e.time," ").concat(e.back?"-":""," ").concat(e.typedTime))).join(" ")).concat(this.eol),t+=this.eol)}return t}printKey(e){return e?"k=".concat(e).concat(this.eol):""}printAttributes(e){let t="";for(const i of e)t+="a=".concat(i.attField).concat(i.attValue?":".concat(i.attValue):"").concat(this.eol);return t}printMediaDescription(e){let t="";for(const i of e)t+=this.printMedia(i.media),t+=this.printInformation(i.information),t+=this.printConnections(i.connections),t+=this.printBandwidth(i.bandwidths),t+=this.printKey(i.key),t+=this.printMediaAttributes(i);return t}printConnections(e){let t="";for(const i of e)t+=this.printConnection(i);return t}printMedia(e){return"m=".concat(e.mediaType," ").concat(e.port," ").concat(e.protos.join("/")," ").concat(e.fmts.join(" ")).concat(this.eol)}printSessionAttributes(e){return new O(this.eol).print(e)}printMediaAttributes(e){return new b(this.eol).print(e)}}class N{constructor(e){A(this,"eol",void 0),this.eol=e}printIceUfrag(e){return void 0===e?"":"a=ice-ufrag:".concat(e).concat(this.eol)}printIcePwd(e){return void 0===e?"":"a=ice-pwd:".concat(e).concat(this.eol)}printIceOptions(e){return void 0===e?"":"a=ice-options:".concat(e.join(o)).concat(this.eol)}printFingerprints(e){return e.length>0?e.map((e=>"a=fingerprint:".concat(e.hashFunction).concat(o).concat(e.fingerprint))).join(this.eol)+this.eol:""}printExtmap(e){return e.map((e=>"a=extmap:".concat(e.entry).concat(e.direction?"/".concat(e.direction):"").concat(o).concat(e.extensionName).concat(e.extensionAttributes?"".concat(o).concat(e.extensionAttributes):"").concat(this.eol))).join("")}printSetup(e){return void 0===e?"":"a=setup:".concat(e).concat(this.eol)}printUnrecognized(e){return e.map((e=>"a=".concat(e.attField).concat(e.attValue?":".concat(e.attValue):"").concat(this.eol))).join("")}}class O extends N{print(e){let t="";return t+=this.printGroups(e.groups),t+=this.printMsidSemantic(e.msidSemantic),t+=this.printIceLite(e.iceLite),t+=this.printIceUfrag(e.iceUfrag),t+=this.printIcePwd(e.icePwd),t+=this.printIceOptions(e.iceOptions),t+=this.printFingerprints(e.fingerprints),t+=this.printSetup(e.setup),t+=this.printTlsId(e.tlsId),t+=this.printIdentity(e.identities),t+=this.printExtmap(e.extmaps),t+=this.printUnrecognized(e.unrecognized),t}printGroups(e){let t="";return e.length>0&&(t+=e.map((e=>"a=group:".concat(e.semantic).concat(e.identificationTag.map((e=>"".concat(o).concat(e))).join("")).concat(this.eol))).join("")),t}printIceLite(e){return void 0===e?"":"a=ice-lite"+this.eol}printTlsId(e){return e?"a=tls-id:".concat(e).concat(this.eol):""}printIdentity(e){return 0===e.length?"":e.map((e=>"a=identity:".concat(e.assertionValue).concat(e.extensions.map((e=>"".concat(o).concat(e.name).concat(e.value?"=".concat(e.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(e){if(!e)return"";let t="a=msid-semantic:".concat(e.semantic);return e.applyForAll?t+="".concat(o,"*"):e.identifierList.length>0&&(t+=e.identifierList.map((e=>"".concat(o).concat(e)))),t+this.eol}}class b extends N{print(e){const t=e.attributes;let i="";return i+=this.printRTCP(t.rtcp),i+=this.printIceUfrag(t.iceUfrag),i+=this.printIcePwd(t.icePwd),i+=this.printIceOptions(t.iceOptions),i+=this.printCandidates(t.candidates),i+=this.printRemoteCandidatesList(t.remoteCandidatesList),i+=this.printEndOfCandidates(t.endOfCandidates),i+=this.printFingerprints(t.fingerprints),i+=this.printSetup(t.setup),i+=this.printMid(t.mid),i+=this.printExtmap(t.extmaps),i+=this.printRTPRelated(t),i+=this.printPtime(t.ptime),i+=this.printMaxPtime(t.maxPtime),i+=this.printDirection(t.direction),i+=this.printSSRCGroups(t.ssrcGroups),i+=this.printSSRC(t.ssrcs),i+=this.printRTCPMux(t.rtcpMux),i+=this.printRTCPMuxOnly(t.rtcpMuxOnly),i+=this.printRTCPRsize(t.rtcpRsize),i+=this.printMSId(t.msids),i+=this.printImageattr(t.imageattr),i+=this.printRid(t.rids),i+=this.printSimulcast(t.simulcast),i+=this.printSCTPPort(t.sctpPort),i+=this.printMaxMessageSize(t.maxMessageSize),i+=this.printUnrecognized(t.unrecognized),i}printCandidates(e){return e.map((e=>"a=candidate:".concat(e.foundation).concat(o).concat(e.componentId).concat(o).concat(e.transport).concat(o).concat(e.priority).concat(o).concat(e.connectionAddress).concat(o).concat(e.port).concat(o,"typ").concat(o).concat(e.type).concat(e.relAddr?"".concat(o,"raddr").concat(o).concat(e.relAddr):"").concat(e.relPort?"".concat(o,"rport").concat(o).concat(e.relPort):"").concat(Object.keys(e.extension).map((t=>"".concat(o).concat(t).concat(o).concat(e.extension[t]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(e){return e.map((e=>"a=remote-candidates:".concat(e.join(o)).concat(this.eol))).join("")}printEndOfCandidates(e){return void 0===e?"":"a=end-of-candidates"+this.eol}printRTPRelated(e){if(!e.payloads)return"";const t=e.payloads;let i="";i+=e.rtcpFeedbackWildcards.map((e=>this.printRTCPFeedback("*",e))).join("");for(const e of t)i+=this.printRtpMap(e.payloadType,e.rtpMap),i+=this.printFmtp(e.payloadType,e.fmtp),i+=e.rtcpFeedbacks.map((t=>this.printRTCPFeedback(e.payloadType,t))).join("");return i}printFmtp(e,t){if(!t)return"";const i=Object.keys(t.parameters);return 1===i.length&&null===t.parameters[i[0]]?"a=fmtp:".concat(e).concat(o).concat(i[0]).concat(this.eol):"a=fmtp:".concat(e).concat(o).concat(Object.keys(t.parameters).map((e=>"".concat(e,"=").concat(t.parameters[e]))).join(";")).concat(this.eol)}printRtpMap(e,t){return t?"a=rtpmap:".concat(e).concat(o).concat(t.encodingName,"/").concat(t.clockRate).concat(t.encodingParameters?"/".concat(t.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(e,t){let i="a=rtcp-fb:".concat(e).concat(o),n=t;return"trr-int"===n.type?i+="ttr-int".concat(o).concat(n.interval):(i+="".concat(n.type),n.parameter&&(i+="".concat(o).concat(n.parameter),n.additional&&(i+="".concat(o).concat(n.additional)))),i+this.eol}printPtime(e){return void 0===e?"":"a=ptime:".concat(e).concat(this.eol)}printMaxPtime(e){return void 0===e?"":"a=maxptime:".concat(e).concat(this.eol)}printDirection(e){return void 0===e?"":"a=".concat(e).concat(this.eol)}printSSRC(e){return e.map((e=>Object.keys(e.attributes).map((t=>"a=ssrc:".concat(e.ssrcId.toString(10)).concat(o).concat(t).concat(e.attributes[t]?":".concat(e.attributes[t]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(e){return void 0===e?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(e){return void 0===e?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(e){return void 0===e?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(e){if(void 0===e)return"";let t="a=rtcp:".concat(e.port);return e.netType&&(t+="".concat(o).concat(e.netType)),e.addressType&&(t+="".concat(o).concat(e.addressType)),e.address&&(t+="".concat(o).concat(e.address)),t+this.eol}printMSId(e){return e.map((e=>"a=msid:".concat(e.id).concat(e.appdata?"".concat(o).concat(e.appdata):"").concat(this.eol))).join("")}printImageattr(e){return e.map((e=>"a=imageattr:".concat(e).concat(this.eol))).join("")}printRid(e){return e.map((e=>{let t="a=rid:".concat(e.id).concat(o).concat(e.direction);return e.payloads&&(t+="".concat(o,"pt=").concat(e.payloads.join(","))),e.params.length>0&&(t+="".concat(o).concat(e.params.map((e=>"depend"===e.type?"depend=".concat(e.rids.join(",")):"".concat(e.type,"=").concat(e.val))).join(";"))),t+this.eol})).join("")}printSimulcast(e){return void 0===e?"":"a=simulcast:".concat(e).concat(this.eol)}printSCTPPort(e){return void 0===e?"":"a=sctp-port:".concat(e).concat(this.eol)}printMaxMessageSize(e){return void 0===e?"":"a=max-message-size:".concat(e).concat(this.eol)}printMid(e){return void 0===e?"":"a=mid:".concat(e).concat(this.eol)}printSSRCGroups(e){return e.map((e=>"a=ssrc-group:".concat(e.semantic).concat(e.ssrcIds.map((e=>"".concat(o).concat(e.toString(10)))).join("")).concat(this.eol))).join("")}}function D(e){return(new C).parse(e)}function P(e,t){return(new w).print(e,t)}}},t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}return i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(8)})();var sI=nI.exports;function oI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function rI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?oI(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):oI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function aI(e,t,i,n,s,o,r){let a=[],c=[],d=[],l=[],h=!1,u=!1;if(sI.parse(e).mediaDescriptions.forEach((e=>{r&&r!==e.attributes.direction||("video"!==e.media.mediaType||h||(c=e.attributes.payloads,l=e.attributes.extmaps,h=!0),"audio"!==e.media.mediaType||u||(a=e.attributes.payloads,d=e.attributes.extmaps,u=!0))})),!l||0===c.length)throw new Error("Cannot get video capabilities from SDP.");if(!d||0===a.length)throw new Error("Cannot get audio capabilities from SDP.");return c.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate))})),a.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate))})),t&&(a=a.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),c=c.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),i&&(c=c.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),n&&(a=a.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),s&&(null==s?void 0:s.length)>0&&(a=a.filter((e=>{var t;return Po(s).call(s,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),o&&(null==o?void 0:o.length)>0&&(c=c.filter((e=>{var t;return Po(o).call(o,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),{audioCodecs:a,videoCodecs:c,audioExtensions:d,videoExtensions:l}}function cI(e){const t=sI.parse(e);let i,n;for(const e of t.mediaDescriptions){if(!i){const t=e.attributes.iceUfrag,n=e.attributes.icePwd;if(!t||!n)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:t,icePwd:n}}if(!n){const t=e.attributes.fingerprints;t.length>0&&(n={fingerprints:t})}}if(!n&&t.attributes.fingerprints.length>0&&(n={fingerprints:t.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function dI(e,t){const i=[],n=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),s=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),o=e.attributes.ssrcs;if(s)s.ssrcIds.forEach((e=>{var s;const o=null===(s=n.find((t=>t.ssrcIds[0]===e)))||void 0===s?void 0:s.ssrcIds[1];i.push({ssrcId:e,rtx:t?o:void 0})}));else if(n.length>0){const e=n[0].ssrcIds[0],s=n[0].ssrcIds[1];i.push({ssrcId:e,rtx:t?s:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function lI(t,i){const{cname:n}=t;let s;i&&i.ip&&"number"==typeof i.port?(s=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip,port:i.port.toString(),type:"host",extension:{}}],e.debug("Using remote candidate from AP ".concat(i.ip,":").concat(i.port)),i.ip6&&(s.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip6,port:i.port.toString(),type:"host",extension:{}}),e.debug("Using IPV6 remote candidate from AP ".concat(i.ip6,":").concat(i.port)))):s=t.iceParameters.candidates.map((e=>({foundation:e.foundation,componentId:"1",transport:e.protocol,priority:e.priority.toString(),connectionAddress:e.ip,port:e.port.toString(),type:e.type,extension:{}})));const o={fingerprints:t.dtlsParameters.fingerprints.map((e=>({hashFunction:e.algorithm,fingerprint:e.fingerprint})))},r={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let a;switch(t.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}return{dtlsParameters:o,iceParameters:r,candidates:s,rtpCapabilities:TI(t.rtpCapabilities),setup:a,cname:n}}function hI(e,t,i){const n=[],s=[];return e.forEach((e=>{let{ssrcId:o,rtx:r}=e;const a=k(8,"track-"),c={ssrcId:o,attributes:rI({label:a,mslabel:i=i||k(10,""),msid:"".concat(i," ").concat(a)},t&&{cname:t})};if(n.push(c),void 0!==r){const e={ssrcId:r,attributes:rI({label:a,mslabel:i,msid:"".concat(i," ").concat(a)},t&&{cname:t})};n.push(e),s.push({semantic:"FID",ssrcIds:[o,r]})}})),e.length>1&&s.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:n,ssrcGroups:s}}function uI(e,t){t instanceof Me&&e.attributes.payloads.forEach((e=>{var i;const n=null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase();if(!n||-1===["opus","pcmu","pcma","g722"].indexOf(n))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&"pcmu"!==n&&"pcma"!==n&&"g722"!==n&&(s.bitrate&&!Q()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function pI(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function _I(e,t){var i;if(!(t instanceof Ue&&t._encoderConfig&&-1===t._hints.indexOf(xe.SCREEN_TRACK)))return;const n=t._encoderConfig;Ve().supportMinBitrate&&n.bitrateMin&&e.attributes.payloads.forEach((e=>{var t,i;Po(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))})),Ve().supportMinBitrate&&!Po(i=t._hints).call(i,xe.LOW_STREAM)&&n.bitrateMax&&e.attributes.payloads.forEach((e=>{var t,i;Po(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(h("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))}))}function EI(e){if("video"!==e.media.mediaType)return;const t=Y();if(t.name!==$.SAFARI&&t.os!==ee.IOS)return;const i=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==i&&e.attributes.extmaps.splice(i,1)}function mI(e,t,i){if(!t)return;let n,s;if("video"===e.media.mediaType?(n=i.videoExtensions,s=i.videoCodecs):(n=i.audioExtensions,s=i.audioCodecs),!0===t.twcc){const t=n.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=n.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function fI(e,t,i){if(Q())return;if("video"!==e.media.mediaType)return;if(!(t instanceof Ue))return;if("vp9"!==i&&"vp8"!==i)return;if("vp8"===i&&!h("SIMULCAST"))return;if(void 0===t._scalabilityMode||t._scalabilityMode.numSpatialLayers<=1)return;const n="vp8"===i?2:t._scalabilityMode.numSpatialLayers,s=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===s.ssrcId)),r={semantic:"SIM",ssrcIds:[s.ssrcId]};for(let t=1;t<n;t++)e.attributes.ssrcs.push({ssrcId:s.ssrcId+t,attributes:Z(s.attributes)}),r.ssrcIds.push(s.ssrcId+t),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+t,attributes:Z(s.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[s.ssrcId+t,o.ssrcIds[1]+t]}));e.attributes.ssrcGroups.unshift(r)}async function SI(t,i,n,s,o){const r=new RTCPeerConnection;r.addTransceiver("video",{direction:"sendonly"}),r.addTransceiver("audio",{direction:"sendonly"}),r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"});const a=(await r.createOffer()).sdp,c=aI(a,t,i,n,s,o,"sendonly"),d=aI(a,t,i,n,s,o,"recvonly"),l={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},u={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(gI(c,d,"videoExtensions",l,u,p),gI(c,d,"videoCodecs",l,u,p),gI(c,d,"audioExtensions",l,u,p),gI(c,d,"audioCodecs",l,u,p),h("RAISE_H264_BASELINE_PRIORITY")){const t=p.videoCodecs.findIndex((e=>{var t,i;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"===(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])}));if(-1!==t){const i=p.videoCodecs.findIndex((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())}));if(i<t){e.debug("raising H264 baseline profile priority");const n=p.videoCodecs[t];p.videoCodecs.splice(t,1),p.videoCodecs.splice(i,0,n)}-1!==i&&(u.videoCodecs=u.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))}))),-1!==i&&h("FILTER_SEND_H264_BASELINE")&&(l.videoCodecs=l.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))})))}}try{r.close()}catch(e){}return{send:l,recv:u,sendrecv:p}}function gI(e,t,i,n,s,o){if("videoExtensions"===i||"audioExtensions"===i){const r=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return r.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===r.indexOf(t)&&s[i].push(e)}))}if("videoCodecs"===i||"audioCodecs"===i){const r=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return r.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===r.indexOf(t)&&s[i].push(e)}))}}function TI(e){const{send:t,recv:i,sendrecv:n}=e;if(!n){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let s,o;return t?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...t.audioCodecs,...n.audioCodecs],s.videoCodecs=[...t.videoCodecs,...n.videoCodecs],s.audioExtensions=[...t.audioExtensions,...n.audioExtensions],s.videoExtensions=[...t.videoExtensions,...n.videoExtensions]):s=n,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...n.audioCodecs],o.videoCodecs=[...i.videoCodecs,...n.videoCodecs],o.audioExtensions=[...i.audioExtensions,...n.audioExtensions],o.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):o=n,{send:s,recv:o}}function RI(e){if("audio"!==e.media.mediaType)return;e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function CI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function II(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?CI(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):CI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function vI(e){if(Array.isArray(e))return e.map((e=>e));if(!yI(e))return e;const t={};for(const i in e){const n=e[i];yI(n)||Array.isArray(n)?t[i]=vI(n):t[i]=n}return t}function yI(e){return!("object"!=typeof e||Array.isArray(e)||!e)}class AI{constructor(e){this.input=[],this.size=void 0,this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const wI={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},NI={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:wI,remoteCandidate:wI}},OI={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},bI={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,qpSumPerFrame:0},DI={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0},PI={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function LI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function kI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?LI(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):LI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class MI{constructor(e,t){this.onFirstVideoReceived=void 0,this.onFirstVideoDecoded=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onFirstAudioDecoded=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.videoIsReady=!1,this.videoIsReady2={},this.pc=void 0,this.options=void 0,this.intervalTimer=void 0,this.stats=vI(NI),this.isFirstVideoReceived={},this.isFirstVideoDecoded={},this.isFirstAudioReceived={},this.isFirstAudioDecoded={},this.isFirstVideoDecodedTimeout={},this.lossRateWindowStats=[],this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new yS((e=>{e({local:kI({},wI),remote:kI({},wI)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,s=0,o=0,r=0;for(const a of i)e[a].forEach(((e,i)=>{if(!this.lossRateWindowStats[t-1][a][i]||!this.lossRateWindowStats[0][a][i])return;const c=this.lossRateWindowStats[t-1][a][i].packets-this.lossRateWindowStats[0][a][i].packets,d=this.lossRateWindowStats[t-1][a][i].packetsLost-this.lossRateWindowStats[0][a][i].packetsLost;"videoSend"===a||"audioSend"===a?(n+=c,o+=d):(s+=c,r+=d),Number.isNaN(c)||Number.isNaN(c)?e.packetLostRate=0:e.packetLostRate=c<=0||d<=0?0:d/(c+d)}));e.sendPacketLossRate=n<=0||o<=0?0:o/(n+o),e.recvPacketLossRate=s<=0||r<=0?0:r/(s+r)}}function UI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function xI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?UI(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):UI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class VI extends MI{constructor(){super(...arguments),this._stats=NI,this.lastDecodeVideoReceiverStats=new Map}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=vI(NI);const i=t.filter((e=>"ssrc"===e.type));this.processSSRCStats(i);const n=t.find((e=>"VideoBwe"===e.type));n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((e=>{var t;const i=Po(t=e.id).call(t,"send");switch("".concat(e.mediaType,"_").concat(i?"send":"recv")){case"video_send":{const t=vI(bI);t.codec=e.googCodecName,t.adaptionChangeReason="none",e.googCpuLimitedResolution&&(t.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(t.adaptionChangeReason="bandwidth"),t.avgEncodeMs=Number(e.googAvgEncodeMs),t.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.firsCount=Number(e.googFirReceived),t.nacksCount=Number(e.googNacksReceived),t.plisCount=Number(e.googPlisReceived),t.frameCount=Number(e.framesEncoded),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(t),this._stats.rtt=t.rttMs;break}case"video_recv":{const t=vI(OI),i=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(t.codec=e.googCodecName,t.targetDelayMs=Number(e.googTargetDelayMs),t.renderDelayMs=Number(e.googRenderDelayMs),t.currentDelayMs=Number(e.googCurrentDelayMs),t.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),t.decodeMs=Number(e.googDecodeMs),t.maxDecodeMs=Number(e.googMaxDecodeMs),t.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},t.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},t.decodeFrameRate=Number(e.googFrameRateDecoded),t.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},t.jitterBufferMs=Number(e.googJitterBufferMs),t.firsCount=Number(e.googFirsSent),t.nacksCount=Number(e.googNacksSent),t.plisCount=Number(e.googPlisSent),t.framesDecodeCount=Number(e.framesDecoded),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,t.decodedFrame.width,t.decodedFrame.height),this.isFirstVideoDecoded[t.ssrc]=!0),i){const n=i.stats,s=Date.now()-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=s,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<i.stats.framesDecodeCount&&(t.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:xI({},t),lts:Date.now()}),this._stats.videoRecv.push(t);break}case"audio_recv":{const t=vI(PI);t.codec=e.googCodecName,t.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,t.decodingCNG=Number(e.googDecodingCNG),t.decodingCTN=Number(e.googDecodingCTN),t.decodingCTSG=Number(e.googDecodingCTSG),t.decodingNormal=Number(e.googDecodingNormal),t.decodingPLC=Number(e.googDecodingPLC),t.decodingPLCCNG=Number(e.googDecodingPLCCNG),t.expandRate=Number(e.googExpandRate),t.accelerateRate=Number(e.googAccelerateRate),t.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),t.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),t.speechExpandRate=Number(e.googSpeechExpandRate),t.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),t.jitterBufferMs=Number(e.googJitterBufferMs),t.jitterMs=Number(e.googJitterReceived),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),t.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.decodingNormal>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),this._stats.audioRecv.push(t);break}case"audio_send":{const t=vI(DI);t.codec=e.googCodecName,t.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,t.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),t.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),t.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),t.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.rtt=t.rttMs,this._stats.audioSend.push(t);break}}}))}_getStats(){return new yS(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp.valueOf().toString(),type:e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t.push(i)})),t}}function FI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function jI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?FI(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):FI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class BI extends MI{constructor(){super(...arguments),this._stats=NI,this.report=void 0,this.lastDecodeVideoReceiverStats=new Map,this.lastVideoFramesRecv=new Map,this.lastVideoFramesSent=new Map,this.lastVideoFramesDecode=new Map,this.lastVideoJBDelay=new Map,this.lastAudioJBDelay=new Map,this.mediaBytesSent=new Map,this.mediaBytesRetransmit=new Map,this.mediaBytesTargetEncode=new Map,this.lastEncoderMs=new Map}async updateStats(){this.report=await this.pc.getStats(),this._stats=vI(NI),this.report.forEach((e=>{switch(e.type){case FS.OUTBOUND:"audio"===e.mediaType?this.processAudioOutboundStats(e):"video"===e.mediaType&&this.processVideoOutboundStats(e);break;case FS.INBOUND:"audio"===e.mediaType?this.processAudioInboundStats(e):"video"===e.mediaType&&this.processVideoInboundStats(e);break;case FS.TRANSPORT:{const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case FS.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:jI({},wI),remote:jI({},wI)};return e.forEach((i=>{let n;if(i.type===FS.TRANSPORT&&(n=e.get(i.selectedCandidatePairId)),i.type===FS.CANDIDATE_PAIR&&i.selected&&(n=i),n){const i=(e,t)=>{e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol)};if(n.localCandidateId){const s=e.get(n.localCandidateId);s&&i(t.local,s)}if(n.remoteCandidateId){const s=e.get(n.remoteCandidateId);s&&i(t.remote,s)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===FS.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===FS.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===FS.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(jI({},t),jI({},this.stats.selectedCandidatePair.localCandidate)),e.type===FS.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(jI({},t),jI({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((t=>t.ssrc===e.ssrc));t||(t=vI(PI),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),"number"==typeof e.concealedSamples&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find((t=>t.ssrc===e.ssrc));t||(t=vI(OI),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;const i=this.lastDecodeVideoReceiverStats.get(t.ssrc),n=this.lastVideoFramesDecode.get(t.ssrc),s=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const e=t.decodedFrame?t.decodedFrame.width:0,i=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,e,i),this.isFirstVideoDecoded[t.ssrc]=!0}if(i){const n=i.stats,o=s-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&o>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=o,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<n.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount))}n&&s-n.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-n.count)/((s-n.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:t.decodeFrameRate})):n?t.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:0}),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:jI({},t),lts:i?i.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((t=>t.ssrc===e.ssrc));t||(t=vI(bI),this._stats.videoSend.push(t));const i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else{const t=new AI(10);t.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,t)}if(void 0!==e.retransmittedBytesSent){const t=this.mediaBytesRetransmit.get(e.ssrc);if(t)t.add(e.retransmittedBytesSent);else{const t=new AI(10);t.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,t)}}if(e.totalEncodedBytesTarget){const t=this.mediaBytesTargetEncode.get(e.ssrc);if(t)t.add(e.totalEncodedBytesTarget);else{const t=new AI(10);t.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,t)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);if(!i||i.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const n=e.framesEncoded-i.lastFrameCount,s=e.totalEncodeTime-i.lastEncoderTime;t.avgEncodeMs=1e3*s/n}}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);!i||i.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,FS.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((t=>t.ssrc===e.ssrc));if(t||(t=vI(DI),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,FS.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}findRemoteStatsId(e,t){var i;const n=Array.from(LS(i=this.report).call(i)).find((i=>i.type===t&&i.ssrc===e));return n?n.id:null}processVideoMediaSource(e,t){const i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(t.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(e,t){const i=this.report.get(e);i&&(t.inputLevel=i.audioLevel)}processVideoTrackSenderStats(e,t,i){var n,s,o;const r=t?this.report.get(t):void 0,a=null!==(n=null==r?void 0:r.framesSent)&&void 0!==n?n:e.framesSent;let c=null!==(s=null==r?void 0:r.frameWidth)&&void 0!==s?s:e.frameWidth,d=null!==(o=null==r?void 0:r.frameHeight)&&void 0!==o?o:e.frameHeight;if("number"!=typeof a)return;"number"==typeof c&&"number"==typeof d||(c=0,d=0);let l=0;const h=Date.now(),u=this.lastVideoFramesSent.get(i.ssrc);u&&h-u.lts>=800?(l=Math.round((a-u.count)/((h-u.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:a,lts:h,rate:l})):u?l=u.rate:this.lastVideoFramesSent.set(i.ssrc,{count:a,lts:h,rate:0}),i.sentFrame={width:c,height:d,frameRate:Math.max(0,l)}}processVideoTrackReceiverStats(e,t,i){var n,s,o,r,a;const c=t?this.report.get(t):void 0,d=null!==(n=null==c?void 0:c.framesReceived)&&void 0!==n?n:e.framesReceived,l=null!==(s=null==c?void 0:c.frameWidth)&&void 0!==s?s:e.frameWidth,h=null!==(o=null==c?void 0:c.frameHeight)&&void 0!==o?o:e.frameHeight,u=null!==(r=null==c?void 0:c.jitterBufferDelay)&&void 0!==r?r:e.jitterBufferDelay,p=null!==(a=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount;if("number"==typeof d){const e=this.lastVideoFramesRecv.get(i.ssrc),t=Date.now();i.framesReceivedCount=d;let n=0;e&&t-e.lts>=800?(n=Math.round((d-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:n})):e?n=e.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:0}),i.receivedFrame={width:l||0,height:h||0,frameRate:n||0},i.decodedFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0}}if(u&&p){let e=this.lastVideoJBDelay.get(i.ssrc);this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:u,jitterBufferEmittedCount:p}),e||(e={jitterBufferDelay:0,jitterBufferEmittedCount:0});const t=1e3*(u-e.jitterBufferDelay)/(p-e.jitterBufferEmittedCount);i.jitterBufferMs=t,i.currentDelayMs=Math.round(t)}}processAudioTrackSenderStats(e,t,i){var n,s,o,r;const a=t?this.report.get(t):void 0,c=null!==(n=null!==(s=null==a?void 0:a.echoReturnLoss)&&void 0!==s?s:e.echoReturnLoss)&&void 0!==n?n:0,d=null!==(o=null!==(r=null==a?void 0:a.echoReturnLossEnhancement)&&void 0!==r?r:e.echoReturnLossEnhancement)&&void 0!==o?o:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,i){var n,s,o,r,a,c,d;const l=t?this.report.get(t):void 0,h=null!==(n=null==l?void 0:l.removedSamplesForAcceleration)&&void 0!==n?n:e.removedSamplesForAcceleration,u=null!==(s=null==l?void 0:l.totalSamplesReceived)&&void 0!==s?s:e.totalSamplesReceived,p=null!==(o=null==l?void 0:l.jitterBufferDelay)&&void 0!==o?o:e.jitterBufferDelay,_=null!==(r=null==l?void 0:l.jitterBufferEmittedCount)&&void 0!==r?r:e.jitterBufferEmittedCount,E=null!==(a=null==l?void 0:l.audioLevel)&&void 0!==a?a:null==e?void 0:e.audioLevel,m=null!==(c=null==l?void 0:l.totalSamplesDuration)&&void 0!==c?c:null==e?void 0:e.totalSamplesDuration,f=null!==(d=null==l?void 0:l.concealedSamples)&&void 0!==d?d:e.concealedSamples;if(h&&u&&(i.accelerateRate=h/u),p&&_){let e=this.lastAudioJBDelay.get(i.ssrc);this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:_}),e||(e={jitterBufferDelay:0,jitterBufferEmittedCount:0});const t=1e3*(p-e.jitterBufferDelay)/(_-e.jitterBufferEmittedCount);i.jitterBufferMs=Math.round(t)}i.outputLevel=E;let S=1920;m&&u&&(S=u/m/50,i.receivedFrames=Math.round(u/S)),f&&(i.droppedFrames=Math.round(f/S))}processRemoteInboundStats(e,t){const i=this.report.get(e);i&&(t.packetsLost=i.packetsLost,i.roundTripTime&&(t.rttMs=1e3*i.roundTripTime))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const i=t.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,t=null,i=null;this.mediaBytesSent.forEach((t=>{e+=t.diffMean()})),this.mediaBytesRetransmit.forEach((e=>{t=null===t?e.diffMean():t+e.diffMean()})),this.mediaBytesTargetEncode.forEach((e=>{i=null===i?e.diffMean():i+e.diffMean()}));const n=null!==t?e-t:e;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==t&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),null!==i&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class GI extends MI{updateStats(){return yS.resolve()}}function WI(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=function(){const e=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return e&&e[0]?Number(e[0].split("/")[1]):null}();return o?o<76?new VI(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new BI(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):function(e){return!!window.RTCStatsReport&&e.getStats()instanceof yS}(e)?new BI(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new GI(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s})}function HI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function KI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?HI(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):HI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class qI extends qg{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}constructor(e,t){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.statsFilter=void 0,this.useRTX=!1,this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.establishPromise=void 0,this.mutex=new v("P2PConnection-mutex"),this.store=t,this.peerConnection=new RTCPeerConnection(qI.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=WI(this.peerConnection,h("STATS_UPDATE_INTERVAL"),void 0,Q()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=cI(e.sdp),i=aI(e.sdp,!this.useRTX,h("FILTER_VIDEO_FEC"),h("FILTER_AUDIO_FEC"),["opus"]);return this.localCapabilities=i,this.initialOffer=e,KI(KI({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new g(T.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(e){this.sessionDesc=void 0,this.localCapabilities=void 0,this.rtpCapabilities=void 0,this.candidates=void 0,this.iceParameters=void 0,this.dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,e=Z(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,sdkCodec:a,cname:c}=e,d=sI.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=s,this.candidates=n,this.iceParameters=t,this.dtlsParameters=i,this.setup=o,this.localCapabilities=r,this.cname=c;for(let e=0;e<d.mediaDescriptions.length;e++){const r=d.mediaDescriptions[e];r.attributes.iceUfrag=t.iceUfrag,r.attributes.icePwd=t.icePwd,r.attributes.fingerprints=i.fingerprints,r.attributes.candidates=n,r.attributes.setup=o,"video"===r.media.mediaType&&(r.media.fmts=s.videoCodecs.map((e=>e.payloadType.toString(10))),r.attributes.payloads=s.videoCodecs,r.attributes.extmaps=s.videoExtensions),"audio"===r.media.mediaType&&(r.media.fmts=s.audioCodecs.map((e=>e.payloadType.toString(10))),r.attributes.payloads=s.audioCodecs,r.attributes.extmaps=s.audioExtensions),d.mediaDescriptions[e]=this.mungMediaDesc(r)}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return sI.print(this.sessionDesc)}send(e,t,i){const{ssrcs:n,ssrcGroups:s}=hI(t,this.cname),o=this.sessionDesc.mediaDescriptions.find((t=>e===bg.VIDEO?"video"===t.media.mediaType:"audio"===t.media.mediaType)),r=n[0].attributes.label,a=n[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(n),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:r,mslabel:a}}batchSend(e){return e.map((e=>{let{kind:t,ssrcMsg:i}=e;return this.send(t,i,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((t=>{const i=[],n=[],s=[];t.attributes.ssrcs.forEach((t=>{Po(e).call(e,t.attributes.label||"")?s.push(t):i.push(t)})),t.attributes.ssrcGroups.forEach((e=>{var t;Po(t=s.map((e=>e.ssrcId))).call(t,e.ssrcIds[0])||n.push(e)})),t.attributes.ssrcs=i,t.attributes.ssrcGroups=n}))}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,i){e.forEach(((e,t)=>{const i=e._mediaStreamTrack,n=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===i.kind)),s=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=s}))}stopReceiving(e){}updateCandidates(e){e===Dg.TCP?this.candidates.forEach((e=>{-1===this.candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this.candidates.push(II(II({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this.candidates=this.candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=Z(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}mungRecvMediaDsec(e,t){const i=Z(e);return uI(i,t),_I(i,t),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,i){const n=this.sessionDesc.mediaDescriptions.find((t=>e===bg.VIDEO?"video"===t.attributes.mid:"audio"===t.attributes.mid));if(n){const e=n.attributes.ssrcs.find((e=>e.attributes.label===t));var s;e&&(e.attributes.label=i,null===(s=e.attributes.msid)||void 0===s||s.replace(t,i))}}mungMediaDesc(e){const t=Z(e);return pI(t),function(e){const t=e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&e.attributes.extmaps.splice(e.attributes.extmaps.indexOf(t),1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}(t),t}getSSRC(e){for(const t of this.sessionDesc.mediaDescriptions)for(const i of t.attributes.ssrcs)if(i.attributes.label===e)return[i]}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n.send,remoteSetup:s,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const r=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t){var i=this;return KC((function*(){const n=yield qC(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const n=e.map((e=>i.peerConnection.addTrack(e._mediaStreamTrack))),s=yield qC(i.peerConnection.createOffer()),o=sI.parse(s.sdp),r=e.map((e=>{const t=e._mediaStreamTrack,n=o.mediaDescriptions.find((e=>e.attributes.mid===t.kind));if(!n)throw new Error("Cannot extract ssrc from mediaDescription.");return function(e,t,i){const n=e.attributes.ssrcs.filter((e=>e.attributes.label===t)),s=e.attributes.ssrcGroups;if(0===n.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(s&&n.length>1){const e=s.find((e=>-1!==e.ssrcIds.indexOf(n[0].ssrcId)));return e?[{ssrcId:e.ssrcIds[0],rtx:i?e.ssrcIds[1]:void 0}]:[{ssrcId:n[0].ssrcId}]}return[{ssrcId:n[0].ssrcId}]}(n,t.id,i.useRTX)}));let a;try{a=yield r}catch(e){throw n.forEach((e=>{te()&&e.replaceTrack(null),i.peerConnection.removeTrack(e)})),e}const c=i.mungSendOfferSDP(s.sdp,e);i.remoteSDP.receive(e,t,a);const d=i.remoteSDP.toString();return yield qC(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield qC(i.applySendEncodings(n,e)),yield qC(i.peerConnection.setRemoteDescription({type:"answer",sdp:d})),e.map(((e,t)=>{const i=e._mediaStreamTrack.id;return{localSSRC:r[t],id:i}}))}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{n()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{te()&&e.replaceTrack(null),this.peerConnection.removeTrack(e)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:i,mslabel:s}=this.remoteSDP.send(e,t,n),o=new yS(((t,n)=>{const o=setTimeout((()=>{n(new Error("Cannot receive track, id: ".concat(i)))}),1e4),r=n=>{const a=Y();if(("Safari"===a.name&&11===Number(a.version)||ie())&&n.track.id!==i&&n.streams[0].id===s){var c;const s=n.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(e,i,n.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(o),void t(s)}if(n.track.id===i)return this.peerConnection.removeEventListener("track",r),clearTimeout(o),void t(n.track)};this.peerConnection.addEventListener("track",r)})),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a);return{track:await o,id:i}}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map((e=>{if(te()&&e.track)e.track.enabled=!1;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!1)),e.setParameters(t)}}))}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map((async e=>{if(te()&&e.track)e.track.enabled=!0;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!0)),await e.setParameters(t)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var i=this;return KC((function*(){const n=yield qC(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ve().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=t===Dg.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(e.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(t===Dg.RELAY)return;t!==Dg.RELAY&&i.remoteSDP.updateCandidates(t);const n=yield qC(i.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=cI(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;i.remoteSDP.restartICE(o);const r=i.remoteSDP.toString();yield qC(i.peerConnection.setLocalDescription(n)),yield qC(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(t){e.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),t)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const e=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(e.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getSenders().filter((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e}));1===i.length&&await this.applySendEncodings(i,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getSenders().find((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t}));i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new g(T.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new g(T.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),h("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(ne(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...qI.turnServerConfigToIceServers(e.turnServer.servers)),h("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...qI.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async updateRtpSenderEncodings(t,i){var n;if(!i){i=this.peerConnection.getSenders().find((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t._mediaStreamTrack.id}))}if(!i)return e.debug("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!Ve().supportSetRtpSenderParameters)return console.warn("Browser not support set rtp-sender parameters");const s={},o={};if(t instanceof Ue)switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(h("DSCP_TYPE")&&se()){var r;const e=h("DSCP_TYPE");Po(r=["very-low","low","medium","high"]).call(r,e)&&(o.networkPriority=e)}const a=i.getParameters(),c=null===(n=a.encodings)||void 0===n?void 0:n[0];c&&Object.assign(c,o),Object.assign(a,s),e.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a))),await i.setParameters(a)}async applySendEncodings(t,i){try{if(!Ve().supportSetRtpSenderParameters)return;if(t.length!==i.length)return;for(let e=0;e<t.length;e++){const n=t[e],s=i[e];n&&s&&await this.updateRtpSenderEncodings(s,n)}}catch(t){e.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){const i=sI.parse(e);return t.forEach(((e,t)=>{const n=e._mediaStreamTrack,s=i.mediaDescriptions.find((e=>e.attributes.mid===n.kind));s&&uI(s,e)})),sI.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const t=this.remoteSDP.batchSend(e).map(((t,i)=>{let{id:n,mslabel:s}=t;const{kind:o}=e[i];return new yS(((e,t)=>{const i=setTimeout((()=>{t(new Error("Cannot receive track, id: ".concat(n)))}),1e4),r=t=>{const a=Y();if("Safari"===a.name&&11===Number(a.version)&&t.track.id!==n&&t.streams[0].id===s){var c;const s=t.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(o,n,t.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(i),void e({track:s,id:n})}if(t.track.id===n)return this.peerConnection.removeEventListener("track",r),clearTimeout(i),void e({track:t.track,id:n})};this.peerConnection.addEventListener("track",r)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await yS.all(t)}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(Ve().supportPCSetConfiguration){const t=qI.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function YI(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("Locking from P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function JI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function XI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?JI(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):JI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}kS([YI,MS("design:type",Function),MS("design:paramtypes",[Object,Object,Array,Object,String,String]),MS("design:returntype",yS)],qI.prototype,"connect",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],qI.prototype,"stopSending",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[String,Array,String,Object]),MS("design:returntype",yS)],qI.prototype,"receive",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],qI.prototype,"stopReceiving",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],qI.prototype,"muteRemote",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],qI.prototype,"unmuteRemote",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],qI.prototype,"muteLocal",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],qI.prototype,"unmuteLocal",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",void 0)],qI.prototype,"close",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[String,Fe]),MS("design:returntype",yS)],qI.prototype,"updateEncoderConfig",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[String,Fe]),MS("design:returntype",yS)],qI.prototype,"updateSendParameters",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[Fe,String]),MS("design:returntype",yS)],qI.prototype,"replaceTrack",null),kS([YI,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],qI.prototype,"getRemoteSSRC",null);const zI="9",QI=4e4;function ZI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function $I(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ZI(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ZI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class ev extends qg{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}constructor(e,t){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.mutex=new v("P2PConnection-mutex"),this.store=t,this.peerConnection=new RTCPeerConnection(ev.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=WI(this.peerConnection,h("STATS_UPDATE_INTERVAL"),void 0,Q()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=cI(e.sdp),i=await SI(!h("USE_PUB_RTX")&&!h("USE_SUB_RTX"),h("FILTER_VIDEO_FEC"),h("FILTER_AUDIO_FEC"));return this.localCapabilities=TI(i),this.initialOffer=e,$I($I({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new g(T.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(t,i,n,s,o,r){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return Z(this._localCapabilities)}get rtpCapabilities(){return Z(this._rtpCapabilities)}get candidates(){return Z(this._candidates)}get iceParameters(){return Z(this._iceParameters)}get dtlsParameters(){return Z(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=Z(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=e,c=sI.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=o,"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,h("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=hI([{ssrcId:QI,rtx:h("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,RI(e),h("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=hI([{ssrcId:2e4}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const e=h("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+2e4,r=2*o+QI,{ssrcs:a,ssrcGroups:c}=hI([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=hI([{ssrcId:r,rtx:h("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:zI,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:zI,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return sI.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:o}=hI(t,this.cname,h("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(Q()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||1===t&&(te()||oe())||0===t&&h("USE_SUB_RTX")||re()?(i=this.createOrRecycleSendMedia(e,s,o,"sendonly",n),this.updateBundleMids()):(i=Z(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),Q()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||Q()||re()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Po(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Po(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){e===Dg.TCP?this._candidates.forEach((e=>{-1===this._candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this._candidates.push(XI(XI({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=Z(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(Q()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleDataChannel(){for(const e of this.sessionDesc.mediaDescriptions)if("application"===e.media.mediaType)return{mediaDesc:e,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:zI,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(t,i,n,s,o,r){const a=t._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=this.localCapabilities.send;let l=[];if(a===bg.VIDEO){var u,p;if(h("H264_PROFILE_LEVEL_ID")&&"h264"===s&&(l=c.videoCodecs.filter((e=>{var t,i,n;return Po(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,s)&&(null==e||null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"])===h("H264_PROFILE_LEVEL_ID")}))),!l||0===(null===(u=l)||void 0===u?void 0:u.length)){const e=d.videoCodecs.filter((e=>{var t,i;return Po(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,s)}));0!==e.length&&(l=c.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(h("USE_PUB_RTX")){const e=l.map((e=>e.payloadType.toString())),t=c.videoCodecs.filter((t=>{var i,n;return"rtx"===(null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName)&&Po(e).call(e,(null===(n=t.fmtp)||void 0===n?void 0:n.parameters.apt)||"")}));l=[...l,...t]}0===l.length&&(e.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(null===(p=c.videoCodecs[0].rtpMap)||void 0===p?void 0:p.encodingName)),l=c.videoCodecs)}else l=c.audioCodecs.filter((e=>{var t,i;return Po(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,o)})),0===l.length&&(e.warning("codec ".concat(o," not included in rtpCapabilities, fallback to opus")),l=c.audioCodecs.filter((e=>{var t,i;return Po(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,"opus")})));const _=a===bg.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const E="".concat(this.currentMidIndex);let m={media:{mediaType:a,port:zI,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:_,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(E)}};m=this.mungRecvMediaDsec(m,t,r);const f=this.findFirstClosedMedia(a);if(f){const e=this.sessionDesc.mediaDescriptions.indexOf(f);this.sessionDesc.mediaDescriptions[e]=m}else this.sessionDesc.mediaDescriptions.push(m);return m}createOrRecycleSendMedia(e,t,i,n,s){const o=this.rtpCapabilities.send,r=e===bg.VIDEO?o.videoCodecs:o.audioCodecs,a=e===bg.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:zI,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=Z(e);return pI(n),uI(n,t),_I(n,t),EI(n),mI(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=Z(e);return mI(i,t,this.localCapabilities.recv),RI(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>Q()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}({remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:this.localCapabilities,cname:r});const a=this.remoteSDP.toString(),c=sI.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find((e=>"audio"===e.media.mediaType));d&&RI(d);const l=sI.print(c),u=this.logSDPExchange(l||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),null==u||u(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});const p=this.peerConnection.getTransceivers()[0];if(null!=p&&p.receiver&&this.tryBindTransportEvents(p.receiver),h("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return KC((function*(){const s=yield qC(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[];e.forEach((e=>{console.warn("[P2PConnection] send",e,e._mediaStreamTrack);const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});s.push(t),e._updateRtpTransceiver(t)})),Q()&&!0===h("SIMULCAST")&&(yield qC(n.applySimulcastForFirefox(s,e)));const o=yield qC(n.peerConnection.createOffer()),r=n.remoteSDP.predictReceivingMids(e.length),a=n.mungSendOfferSDP(o.sdp,e,r),c=sI.parse(a),d=r.map((e=>{const t=c.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return dI(t,h("USE_PUB_RTX"))}));let l;try{l=yield d}catch(s){l=[],n.remoteSDP.receive(e,t,i,l);const o=n.remoteSDP.toString();throw yield qC(n.peerConnection.setLocalDescription({type:"offer",sdp:a})),yield qC(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield qC(n.stopSending(r,!0)),s}n.remoteSDP.receive(e,t,i,l);const u=n.remoteSDP.toString(),p=n.logSDPExchange(a,"offer","local","send");return yield qC(n.peerConnection.setLocalDescription({type:"offer",sdp:a})),yield qC(n.applySimulcastEncodings(s,e)),yield qC(n.applySendEncodings(s,e)),null==p||p(u),yield qC(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),s.map(((e,t)=>{const i=r[t];return{localSSRC:d[t],id:i,transceiver:e}}))}catch(e){throw e instanceof g?e:new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async createDataChannels(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(t);n&&"open"===n.readyState?e.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:h("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,n)),i.forEach((e=>{e._updateOriginDataChannel(n)}));const{needExchangeSDP:s}=this.remoteSDP.sendDataChannel();if(s){const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i),e.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else e.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof g?e:new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof g?e:new g(T.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(t,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:r}=this.remoteSDP.send(t,i,n,s);if(r){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(s.sdp,o,t);null==n||n(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),e.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else e.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(t);if(n){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n),e.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else e.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return i.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var i=this;return KC((function*(){const n=yield qC(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ve().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=t===Dg.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(e.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(t===Dg.RELAY)return;t!==Dg.RELAY&&i.remoteSDP.updateCandidates(t);const n=yield qC(i.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=cI(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;i.remoteSDP.restartICE(o);const r=i.remoteSDP.toString(),a=i.logSDPExchange(n.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield qC(i.peerConnection.setLocalDescription(n)),null==a||a(r),yield qC(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(t){e.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),t)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new g(T.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?Q()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:$I($I({},wI),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:$I($I({},wI),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),h("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(ne(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...ev.turnServerConfigToIceServers(e.turnServer.servers)),h("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...ev.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),h("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),h("ENABLE_ENCODED_TRANSFORM")&&Ve().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(xT(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!h("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}tryBindTransportEvents(t){const i=t.transport;if(i){this.transportEventReceiver=t,i.onstatechange=()=>{var e;null!=i&&i.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,i.state))},i.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const n=i.iceTransport;n&&(n.onstatechange=()=>{const e=null==i?void 0:i.iceTransport.state;var t;e&&(null===(t=this.onICETransportStateChange)||void 0===t||t.call(this,e))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:t,remote:i}=n.getSelectedCandidatePair();e.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:t.type,protocol:t.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,i){var n;if(!i){i=this.peerConnection.getSenders().find((e=>e.track===t._mediaStreamTrack))}if(!i)return e.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return console.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ve().supportSetRtpSenderParameters)return console.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(t._encoderConfig){var r;const{bitrateMax:e,frameRate:i,scaleResolutionDownBy:n}=t._encoderConfig;e&&(o.maxBitrate=1e3*e),Po(r=t._hints).call(r,xe.LOW_STREAM)&&(i&&(o.maxFramerate=FT(i)),n&&n>=1&&(o.scaleResolutionDownBy=n))}if(h("DSCP_TYPE")&&se()){var a;const e=h("DSCP_TYPE");Po(a=["very-low","low","medium","high"]).call(a,e)&&(o.networkPriority=e)}const c=i.getParameters(),d=null===(n=c.encodings)||void 0===n?void 0:n[0];Q()&&!d&&(s.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,s),e.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c))),await i.setParameters(c)}async applySendEncodings(t,i){try{if(!Ve().supportSetRtpSenderParameters)return;if(t.length!==i.length)return;for(let e=0;e<t.length;e++){const n=t[e],s=i[e];s instanceof Ue&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(t){e.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=sI.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(uI(o,e),fI(o,e,this.store.codec))})),sI.print(n)}mungReceiveAnswerSDP(e,t,i){const n=sI.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&i===bg.AUDIO&&"audio"===s.media.mediaType&&RI(s),sI.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o,r;const c=e[a],d=t[a];if(d instanceof Ue&&!Po(i=d._hints).call(i,xe.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!Q()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof Ue&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(e){var t,i,n,s,o;return!!(e instanceof Ue&&h("SIMULCAST")&&"vp8"===this.store.codec&&!Po(t=e._hints).call(t,xe.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=e._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,i,n,s){if(h("SDP_LOGGING"))return e.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),t),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(Ve().supportPCSetConfiguration){const t=ev.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function tv(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function iv(t,i){let n=document.createElement("video"),s=document.createElement("canvas");n.setAttribute("style","display:none"),s.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),s.width=FT(i.width),s.height=FT(i.height);const o=FT(i.framerate||15);document.body.append(n),document.body.append(s);let r=t._mediaStreamTrack;n.srcObject=new MediaStream([r]),n.play();const a=s.getContext("2d");if(!a)throw new Ig(T.UNEXPECTED_ERROR,"can not get canvas context");const c=Ve(),d=s.captureStream(c.supportRequestFrame?0:o).getVideoTracks()[0];s.startCapture=()=>{if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const t=n.videoWidth,i=n.videoHeight/t,o=s.width*i;Math.abs(o-s.height)>=2&&(e.debug("adjust low stream resolution","".concat(s.width,"x").concat(s.height," -> ").concat(s.width,"x").concat(o)),s.height=o)}a.drawImage(n,0,0,s.width,s.height),d.requestFrame&&d.requestFrame(),r!==t._mediaStreamTrack&&(r=t._mediaStreamTrack,n.srcObject=new MediaStream([r]))},s.stopCapture=je((()=>s.startCapture&&s.startCapture()),o);const l=d.stop;return d.stop=()=>{l.call(d),s.stopCapture&&s.stopCapture(),n&&(n.remove(),n=null),s&&(s.width=0,s.remove(),s=null),e.debug("clean low stream renderer")},d}function nv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function sv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?nv(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):nv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}kS([tv,MS("design:type",Function),MS("design:paramtypes",[Object,Object,Array,Object,String,String]),MS("design:returntype",yS)],ev.prototype,"connect",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[Object,Array]),MS("design:returntype",yS)],ev.prototype,"createDataChannels",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[String,Array,String,Object]),MS("design:returntype",yS)],ev.prototype,"receive",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],ev.prototype,"batchReceive",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],ev.prototype,"stopReceiving",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],ev.prototype,"muteRemote",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],ev.prototype,"unmuteRemote",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],ev.prototype,"muteLocal",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],ev.prototype,"unmuteLocal",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",void 0)],ev.prototype,"close",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[String,Fe]),MS("design:returntype",yS)],ev.prototype,"updateEncoderConfig",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[String,Fe]),MS("design:returntype",yS)],ev.prototype,"updateSendParameters",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[Fe,String]),MS("design:returntype",yS)],ev.prototype,"replaceTrack",null),kS([tv,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],ev.prototype,"getRemoteSSRC",null);const ov="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",rv="9",av=2e4,cv=4e4;class dv{get localCapabilities(){return Z(this._localCapabilities)}get rtpCapabilities(){return Z(this._rtpCapabilities)}get candidates(){return Z(this._candidates)}get iceParameters(){return Z(this._iceParameters)}get dtlsParameters(){return Z(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=Z(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=e,c=sI.parse(ov);this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=o,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,h("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=hI([{ssrcId:cv,rtx:h("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,RI(e),h("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=hI([{ssrcId:av}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const t=sI.parse(ov);this._rtpCapabilities=e;const i=this.rtpCapabilities.send;for(const e of t.mediaDescriptions){if(e.attributes.iceUfrag=this._iceParameters.iceUfrag,e.attributes.icePwd=this._iceParameters.icePwd,e.attributes.fingerprints=this._dtlsParameters.fingerprints,e.attributes.candidates=this._candidates,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=i.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.videoCodecs,e.attributes.extmaps=i.videoExtensions,h("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=hI([{ssrcId:cv,rtx:h("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=i.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.audioCodecs,e.attributes.extmaps=i.audioExtensions,h("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=hI([{ssrcId:av}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+av,r=2*o+cv,{ssrcs:a,ssrcGroups:c}=hI([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=hI([{ssrcId:r,rtx:h("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:rv,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:rv,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return sI.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:o}=hI(t,this.cname,h("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(Q()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||te()||ie()||oe()||0===t&&h("USE_SUB_RTX")?(i=this.createOrRecycleSendMedia(e,s,o,"sendonly",n),this.updateBundleMids()):(i=Z(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),Q()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||Q()||te()||ie()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Po(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Po(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){e===Dg.TCP?this._candidates.forEach((e=>{-1===this._candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this._candidates.push(sv(sv({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=Z(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(Q()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(t,i,n,s,o,r){const a=t._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=this.localCapabilities.send;let l=[];if(a===bg.VIDEO){var u,p;if(h("H264_PROFILE_LEVEL_ID")&&"h264"===s&&(l=c.videoCodecs.filter((e=>{var t,i,n;return Po(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,s)&&(null==e||null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"])===h("H264_PROFILE_LEVEL_ID")}))),!l||0===(null===(u=l)||void 0===u?void 0:u.length)){const e=d.videoCodecs.filter((e=>{var t,i;return Po(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,s)}));0!==e.length&&(l=c.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(h("USE_PUB_RTX")){const e=l.map((e=>e.payloadType.toString())),t=c.videoCodecs.filter((t=>{var i,n;return"rtx"===(null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName)&&Po(e).call(e,(null===(n=t.fmtp)||void 0===n?void 0:n.parameters.apt)||"")}));l=[...l,...t]}if(0===l.length)e.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(null===(p=c.videoCodecs[0].rtpMap)||void 0===p?void 0:p.encodingName)),l=c.videoCodecs}else l=c.audioCodecs.filter((e=>{var t,i;return Po(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,o)})),0===l.length&&(e.warning("codec ".concat(o," not included in rtpCapabilities, fallback to opus")),l=c.audioCodecs.filter((e=>{var t,i;return Po(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,"opus")})));const _=a===bg.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const E="".concat(this.currentMidIndex);let m={media:{mediaType:a,port:rv,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:_,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(E)}};m=this.mungRecvMediaDsec(m,t,r);const f=this.findFirstClosedMedia(a);if(f){const e=this.sessionDesc.mediaDescriptions.indexOf(f);this.sessionDesc.mediaDescriptions[e]=m}else this.sessionDesc.mediaDescriptions.push(m);return m}createOrRecycleSendMedia(e,t,i,n,s){const o=this.rtpCapabilities.send,r=e===bg.VIDEO?o.videoCodecs:o.audioCodecs,a=e===bg.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:rv,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=Z(e);return pI(n),uI(n,t),_I(n,t),EI(n),mI(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=Z(e);return mI(i,t,this.localCapabilities.recv),RI(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>Q()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}function lv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function hv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?lv(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):lv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class uv extends qg{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,t,i){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.mutex=new v("NVExtentionsConnection-mutex"),this.rtcMedia=void 0,this.store=t,this.peerConnection=i,this.statsFilter=WI(this.peerConnection,h("STATS_UPDATE_INTERVAL"),void 0,Q()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=cI(e.sdp),i=await SI(!h("USE_PUB_RTX")&&!h("USE_SUB_RTX"),h("FILTER_VIDEO_FEC"),h("FILTER_AUDIO_FEC"));return this.localCapabilities=i,this.initialOffer=e,hv(hv({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new Ig(T.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new dv({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:TI(this.localCapabilities),cname:o});const r=this.remoteSDP.toString(),a=sI.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&RI(c);const d=sI.print(a),l=this.logSDPExchange(d||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(e.toString()))}}async updateRemoteConnect(t){var i,n,s;null===(i=this.remoteSDP)||void 0===i||i.updateRemoteRTPCapabilities(t),null===(n=this.remoteSDP)||void 0===n||n.preloadRemoteMedia(2);const o=null===(s=this.remoteSDP)||void 0===s?void 0:s.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r),e.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,t,i){var n=this;return KC((function*(){const s=yield qC(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const s=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});s.push(t)})),Q()&&!0===h("SIMULCAST")&&(yield qC(n.applySimulcastForFirefox(s,e)));const o=yield qC(n.peerConnection.createOffer()),r=n.remoteSDP.predictReceivingMids(e.length),a=n.mungSendOfferSDP(o.sdp,e,r),c=sI.parse(a),d=r.map((e=>{const t=c.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return dI(t,h("USE_PUB_RTX"))}));let l;try{l=yield d}catch(s){l=[],n.remoteSDP.receive(e,t,i,l);const o=n.remoteSDP.toString();throw yield qC(n.peerConnection.setLocalDescription({type:"offer",sdp:a})),yield qC(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield qC(n.stopSending(r,!0)),s}n.remoteSDP.receive(e,t,i,l);const u=n.remoteSDP.toString(),p=n.logSDPExchange(a,"offer","local","send");return yield qC(n.peerConnection.setLocalDescription({type:"offer",sdp:a})),yield qC(n.applySimulcastEncodings(s,e)),yield qC(n.applySendEncodings(s,e)),null==p||p(u),yield qC(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),s.map(((e,t)=>{const i=r[t];return{localSSRC:d[t],id:i,transceiver:e}}))}catch(e){throw e instanceof Ig?e:new Ig(T.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async createDataChannels(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(t);return n&&"open"===n.readyState?e.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:h("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,n)),void i.forEach((e=>{e._updateOriginDataChannel(n)}))}catch(e){throw e instanceof Ig?e:new Ig(T.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof Ig?e:new Ig(T.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(e.toString()))}}async receive(t,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:r}=this.remoteSDP.send(t,i,n,s);if(r){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(s.sdp,o,t);null==n||n(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),e.debug("[NVExtentionsConnection] receive ".concat(t," by exchanging SDP."))}else e.debug("[NVExtentionsConnection] receive ".concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o}}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(t);if(n){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n),e.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else e.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return i.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e}}))}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var i=this;return KC((function*(){const n=yield qC(i.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ve().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=t===Dg.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(e.debug("restartICE change iceTransportPolicy from [".concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(t===Dg.RELAY)return;t!==Dg.RELAY&&i.remoteSDP.updateCandidates(t);const n=yield qC(i.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=cI(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;i.remoteSDP.restartICE(o);const r=i.remoteSDP.toString(),a=i.logSDPExchange(n.sdp||"","offer","local","restartICE");yield qC(i.peerConnection.setLocalDescription(n)),null==a||a(r),yield qC(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(t){e.warning("restart ICE failed, abort operation",t)}finally{n()}}))()}close(){var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new Ig(T.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?Q()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if(null===(e=this.peerConnection.currentLocalDescription)||void 0===e||!e.sdp||!this.localCapabilities)throw new Error;return hv(hv({},cI(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,e.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,e.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),h("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(ne(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...uv.turnServerConfigToIceServers(e.turnServer.servers)),h("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...uv.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),h("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(xT(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!h("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async applySendEncodings(t,i){try{if(!Ve().supportSetRtpSenderParameters)return;if(t.length!==i.length)return;for(let e=0;e<t.length;e++){const u=t[e],p=i[e];if(p&&p instanceof Ue){var n,s,o;if(this.isVP8Simulcast(p))continue;const e={},t={};switch(p._optimizationMode){case"motion":e.degradationPreference="maintain-framerate";break;case"detail":e.degradationPreference="maintain-resolution";break;default:e.degradationPreference="balanced"}var r,a,c,d;if(null!==(n=p._encoderConfig)&&void 0!==n&&n.bitrateMax)t.maxBitrate=1e3*(null===(r=p._encoderConfig)||void 0===r?void 0:r.bitrateMax);if(Po(s=p._hints).call(s,xe.LOW_STREAM))null!==(a=p._encoderConfig)&&void 0!==a&&a.frameRate&&(t.maxFramerate=FT(p._encoderConfig.frameRate)),null!==(c=p._encoderConfig)&&void 0!==c&&c.scaleResolutionDownBy&&(null===(d=p._encoderConfig)||void 0===d?void 0:d.scaleResolutionDownBy)>1&&(t.scaleResolutionDownBy=p._encoderConfig.scaleResolutionDownBy);if(h("DSCP_TYPE")&&se()){var l;const e=h("DSCP_TYPE");Po(l=["very-low","low","medium","high"]).call(l,e)&&(t.networkPriority=e)}const i=u.sender.getParameters(),_=null===(o=i.encodings)||void 0===o?void 0:o[0];Q()&&!_&&(e.encodings=[t]),_&&Object.assign(_,t),Object.assign(i,e),await u.sender.setParameters(i)}}}catch(t){e.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,i){const n=sI.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(uI(o,e),fI(o,e,this.store.codec))})),sI.print(n)}mungReceiveAnswerSDP(e,t,i){const n=sI.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&i===bg.AUDIO&&"audio"===s.media.mediaType&&RI(s),sI.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o,r;const c=e[a],d=t[a];if(d instanceof Ue&&!Po(i=d._hints).call(i,xe.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!Q()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof Ue&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(e){var t,i,n,s,o;return!!(e instanceof Ue&&h("SIMULCAST")&&"vp8"===this.store.codec&&!Po(t=e._hints).call(t,xe.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=e._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,i,n,s){if(h("SDP_LOGGING"))return e.upload("exchanging ".concat(n," ").concat(i," SDP during NVExtentionsConnection.").concat(s,"\n"),t),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(Ve().supportPCSetConfiguration){const t=uv.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function pv(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From NVExtentionsConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function _v(e){var t,i,n,s=2;for("undefined"!=typeof Symbol&&(i=JC,n=Symbol.iterator);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new Ev(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Ev(e){function t(e){if(Object(e)!==e)return yS.reject(new TypeError(e+" is not an object."));var t=e.done;return yS.resolve(e.value).then((function(e){return{value:e,done:t}}))}return Ev=function(e){this.s=e,this.n=e.next},Ev.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?yS.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?yS.reject(e):t(i.apply(this.s,arguments))}},new Ev(e)}kS([pv,MS("design:type",Function),MS("design:paramtypes",[Object,Object,Array,Object,String,String]),MS("design:returntype",yS)],uv.prototype,"connect",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[Object]),MS("design:returntype",yS)],uv.prototype,"updateRemoteConnect",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[Object,Array]),MS("design:returntype",yS)],uv.prototype,"createDataChannels",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[String,Array,String,Object]),MS("design:returntype",yS)],uv.prototype,"receive",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],uv.prototype,"batchReceive",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],uv.prototype,"stopReceiving",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],uv.prototype,"muteRemote",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],uv.prototype,"unmuteRemote",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],uv.prototype,"muteLocal",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],uv.prototype,"unmuteLocal",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",void 0)],uv.prototype,"close",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[String,Fe]),MS("design:returntype",yS)],uv.prototype,"updateEncoderConfig",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[String,Fe]),MS("design:returntype",yS)],uv.prototype,"updateSendParameters",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[Fe,String]),MS("design:returntype",yS)],uv.prototype,"replaceTrack",null),kS([pv,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],uv.prototype,"getRemoteSSRC",null);class mv extends qg{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,t){super(e,t),this.store=void 0,this.peerConnection=void 0,this.cname=void 0,this.mutex=new v("DataChannelConnection-mutex"),this.dataChannel=void 0,this._p2pConnection=void 0,this.establishPromise=void 0,this._nvMedia=void 0,this.store=t,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(mv.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new uv(e,t,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const t=null===(e=this._nvMedia)||void 0===e?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(t)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,t,i,n,s,o){return this.cname=o,await this._p2pConnection.connect(e,t,i,n,s,o),await new yS(((e,t)=>{const n=setTimeout((()=>{this.closeSignal(),t(new Ig(T.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(n),void e()},this.dataChannel.onerror=e=>{this.closeSignal(),t(e)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}send(e,t,i){var n=this;return KC((function*(){const s=yield qC(n.mutex.lock("From DataChannelConnection.send"));try{return yield*YC(_v(n._p2pConnection.send(e,t,i)))}finally{s()}}))()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(t,i,n,s){return this._nvMedia?(e.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,i,this.cname)):(e.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,i,n,s))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return KC((function*(){return yield*YC(_v(t._p2pConnection.restartICE(e)))}))()}close(){var e;null===(e=this._nvMedia)||void 0===e||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;null===(t=this._nvMedia)||void 0===t||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(t,i,n,s){if(h("SDP_LOGGING"))return e.upload("exchanging ".concat(n," ").concat(i," SDP during DataChannelConnection.").concat(s,"\n"),t),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(ne(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...mv.turnServerConfigToIceServers(e.turnServer.servers)),h("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...mv.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),h("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(xT(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!h("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return null===(t=this.onICEConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return null===(t=this.onConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return null===(t=this.onDTLSTransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return null===(t=this.onDTLSTransportError)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return null===(t=this.onICETransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return null===(t=this.onFirstAudioReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return null===(t=this.onFirstVideoReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return null===(t=this.onFirstAudioDecoded)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,i)=>{var n;return null===(n=this.onFirstVideoDecoded)||void 0===n?void 0:n.call(this,e,t,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return null===(t=this.onFirstVideoDecodedTimeout)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedLocalCandidateChanged)||void 0===i?void 0:i.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i?void 0:i.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}}function fv(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From DataChannelConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function Sv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function gv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Sv(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Sv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}kS([fv,MS("design:type",Function),MS("design:paramtypes",[Object,Object,Array,Object,String,String]),MS("design:returntype",yS)],mv.prototype,"connect",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[Object,Array]),MS("design:returntype",yS)],mv.prototype,"createDataChannels",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[String,Array,String,Object]),MS("design:returntype",yS)],mv.prototype,"receive",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],mv.prototype,"stopReceiving",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],mv.prototype,"muteRemote",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],mv.prototype,"unmuteRemote",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],mv.prototype,"muteLocal",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],mv.prototype,"unmuteLocal",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",void 0)],mv.prototype,"close",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[String,Fe]),MS("design:returntype",yS)],mv.prototype,"updateEncoderConfig",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[String,Fe]),MS("design:returntype",yS)],mv.prototype,"updateSendParameters",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[Fe,String]),MS("design:returntype",yS)],mv.prototype,"replaceTrack",null),kS([fv,MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],mv.prototype,"getRemoteSSRC",null);class Tv extends C{constructor(){super(),this.uplinkStatsUploadInterval=void 0,this.uplinkRelatedStatsUploadInterval=void 0,this.uplinkDenoiserStatsUploadInterval=void 0,this.transportStatsUploadInterval=void 0,this.uplinkExtensionStatsUploadInterval=void 0,this.downlinkExtensionStatsUploadInterval=void 0,this.extensionUsageStatsUploadInterval=void 0,this.downlinkStatsUploadInterval=void 0,this.downlinkRelatedStatsUploadInterval=void 0,this.lastStats=void 0,this.uploadUnplinkStarted=!1,this.uploadDownlinkStarted=!1,this.uploadTransportStarted=!1,this.uploadExtensionUsageStarted=!1,this.requestStats=void 0,this.requestLocalMedia=void 0,this.requestRemoteMedia=void 0,this.requestAllTracks=void 0,this.requestVideoIsReady=void 0,this.requestUpload=void 0}startUploadTransportStats(){this.uploadTransportStarted||(this.uploadTransportStarted=!0,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&this.uploadTransportStats(t)}),1e3))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval);const e=new Map;this.extensionUsageStatsUploadInterval=window.setInterval((async()=>{var t,i,n;const s=Date.now(),o={connectionInterval:h("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:s};let r=[];const a=(null===(t=this.requestAllTracks)||void 0===t?void 0:t.call(this))||[];for(const e of a)!e.muted&&e.enabled&&(r=r.concat(await e.getProcessorUsage()));const c=(null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[];for(const[e,t]of c)t.has(bg.VIDEO)&&e.videoTrack&&(r=r.concat(await e.videoTrack.getProcessorUsage())),t.has(bg.AUDIO)&&e.audioTrack&&(r=r.concat(await e.audioTrack.getProcessorUsage()));if(0===r.length)return;o.details=function(e,t){const i={};for(const{id:r,value:a,level:c,direction:d}of e){var n;const e=null!==(n=t.get(r))&&void 0!==n?n:0,l=2===a?e+h("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var s,o;t.set(r,l),i[r]?(2===a&&(i[r].value=a),c>i[r].level&&(i[r].level=c),"remote"===d&&(i[r].remoteUidCount+=1),i[r].totalTs=null!==(s=t.get(r))&&void 0!==s?s:0):i[r]={value:a,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(o=t.get(r))&&void 0!==o?o:0}}return Object.keys(i).map((e=>{const{level:t,value:n,totalTs:s}=i[e];return{id:e,level:t,value:n,totalTs:s}}))}(r,e);const d=Date.now(),l=d>s?d:s+1;null===(n=this.requestUpload)||void 0===n||n.call(this,JS.EXTENSION_USAGE_STATS,{usageStats:o,sendTs:l})}),h("EXTENSION_USAGE_UPLOAD_INTERVAL"))}startUploadUplinkStats(){this.uploadUnplinkStarted||(this.uploadUnplinkStarted=!0,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&(this.uploadUplinkStats(t),this.lastStats=t)}),3e3),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkRelatedStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&this.uploadRelatedUplinkStats(t,this.lastStats),this.lastStats=t}),1e3),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestAllTracks)||void 0===e?void 0:e.call(this);t&&this.uploadDenoiserStats(t)}),2e3),this.uplinkExtensionStatsUploadInterval&&window.clearInterval(this.uplinkExtensionStatsUploadInterval),this.uplinkExtensionStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestAllTracks)||void 0===e?void 0:e.call(this);t&&this.uploadExtensionStats(t)}),2e3))}uploadTransportStats(e){j((()=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,JS.TRANSPORT_STATS,function(e){const t={connectionType:100,googRtt:e.rtt};if("relay"===e.selectedCandidatePair.localCandidate.candidateType){const i=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(t.connectionType=101),"tcp"===i&&(t.connectionType=103),"tls"===i&&(t.connectionType=104)}return t}(e))}))}uploadUplinkStats(e){var t;((null===(t=this.requestLocalMedia)||void 0===t?void 0:t.call(this))||[]).forEach((t=>{let[i,{track:n,ssrcs:s}]=t;switch(i){case Lg.LocalVideoLowTrack:case Lg.LocalVideoTrack:{const t=function(e,t,i){var n;const s=t.videoSend.find((t=>t.ssrc===e));if(!s)return null;const o={id:k(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:s.ssrc.toString()};switch(o.A_vstd=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?"1":"0",s.sentFrame&&(o.A_fhs=s.sentFrame.height.toString(),o.A_frs=s.sentFrame.frameRate.toString(),o.A_fws=s.sentFrame.width.toString()),s.adaptionChangeReason){case"none":o.A_ac="0";break;case"cpu":o.A_ac="1";break;case"bandwidth":o.A_ac="2";break;case"other":o.A_ac="3"}return o.A_lvps=Pe[i._player?i._player.videoElementStatus:"uninit"].toString(),o.A_nr=null===(n=s.nacksCount)||void 0===n?void 0:n.toString(),s.avgEncodeMs&&(o.A_aem=s.avgEncodeMs.toFixed(0).toString()),o}(s[0].ssrcId,e,n),o=i===Lg.LocalVideoTrack?function(e,t,i){var n,s,o,r,a,c,d,l;const h=t.videoSend.find((t=>t.ssrc===e));if(!h)return null;const u={id:k(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:h.ssrc.toString()},p=null!==(n=null!==(s=null===(o=h.inputFrame)||void 0===o?void 0:o.height)&&void 0!==s?s:null==i?void 0:i._videoHeight)&&void 0!==n?n:0,_=null!==(r=null!==(a=null===(c=h.inputFrame)||void 0===c?void 0:c.width)&&void 0!==a?a:null==i?void 0:i._videoWidth)&&void 0!==r?r:0,E=null!==(d=null===(l=h.inputFrame)||void 0===l?void 0:l.frameRate)&&void 0!==d?d:0;return p&&(u.A_fhi=p+""),_&&(u.A_fwi=_+""),E&&(u.A_fri=E+""),u}(s[0].ssrcId,e,n):null;t&&j((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,JS.PUBLISH_STATS,{stream_type:i===Lg.LocalVideoLowTrack?"low":"high",stats:gv(gv({},t),o)})}));const r=function(e){const t={id:"bweforvideo",timestamp:new Date(e.timestamp).toISOString(),type:"VideoBwe"};return e.bitrate.retransmit&&(t.A_rb=e.bitrate.retransmit.toString()),e.bitrate.targetEncoded&&(t.A_teb=e.bitrate.targetEncoded.toString()),t.A_aeb=e.bitrate.actualEncoded.toString(),t.A_tb=e.bitrate.transmit.toString(),void 0!==e.sendBandwidth&&(t.A_asb=e.sendBandwidth.toString()),t}(e);r&&setTimeout((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,JS.PUBLISH_STATS,{stream_type:i===Lg.LocalVideoLowTrack?"low":"high",stats:r})}),1e3);break}case Lg.LocalAudioTrack:{const t=function(e,t,i){const n=t.audioSend.find((t=>t.ssrc===e));if(!n)return null;const s={id:k(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:n.ssrc.toString()};return s.A_astd=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?"1":"0",n.inputLevel?s.A_ail=Math.round(100*n.inputLevel).toString():s.A_ail=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),s.A_apil=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),n.aecReturnLoss&&(s.A_ecrl=Math.round(n.aecReturnLoss).toString()),n.aecReturnLossEnhancement&&(s.A_ecrle=Math.round(n.aecReturnLossEnhancement).toString()),s}(s[0].ssrcId,e,n);t&&j((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,JS.PUBLISH_STATS,{stream_type:"high",stats:t})}));break}}}))}uploadRelatedUplinkStats(e,t){var i;((null===(i=this.requestLocalMedia)||void 0===i?void 0:i.call(this))||[]).filter((e=>{let[t]=e;return t===Lg.LocalVideoLowTrack||t===Lg.LocalVideoTrack})).forEach((t=>{let[i,{ssrcs:n}]=t;const s=function(e,t){const i=t.videoSend.find((t=>t.ssrc===e));return i?{mediaType:"video",isVideoMute:!1,frameRateInput:i.inputFrame&&i.inputFrame.frameRate.toString(),frameRateSent:i.sentFrame&&i.sentFrame.frameRate.toString(),googRtt:i.rttMs.toString(),qpSumPerFrame:Math.floor(i.qpSumPerFrame).toString()}:null}(n[0].ssrcId,e);s&&j((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,JS.PUBLISH_RELATED_STATS,{stream_type:i===Lg.LocalVideoLowTrack?"low":"high",stats:s})}))}))}uploadDenoiserStats(e){for(let s=0;s<e.length;s++){const o=e[s];if(o instanceof Be){var t,i,n;const e=null===(t=(i=o._external).getDenoiserStats)||void 0===t?void 0:t.call(i);return void(e&&(null===(n=this.requestUpload)||void 0===n||n.call(this,JS.DENOISER_STATS,e)))}}}uploadExtensionStats(e){for(let t=0;t<e.length;t++){e[t].getProcessorStats().forEach((e=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,e.type,e.stats)}))}}stopUploadUplinkStats(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkStatsUploadInterval=void 0,this.uplinkRelatedStatsUploadInterval=void 0,this.uplinkDenoiserStatsUploadInterval=void 0)}startUploadDownlinkStats(){if(this.uploadDownlinkStarted)return;let e;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let t=!1;this.downlinkStatsUploadInterval=window.setInterval((()=>{var i;const n=null===(i=this.requestStats)||void 0===i?void 0:i.call(this);n&&(this.uploadDownlinkStats(n,t,e),e=n),t=!t}),3e3),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkRelatedStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&(this.uploadRelatedDownlinkStats(t,this.lastStats),this.lastStats=t)}),1e3),this.downlinkExtensionStatsUploadInterval&&window.clearInterval(this.downlinkExtensionStatsUploadInterval),this.downlinkExtensionStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestRemoteMedia)||void 0===e?void 0:e.call(this);t&&this.uploadDownlinkExtensionStats(t)}),2e3)}uploadDownlinkStats(e,t,i){var n;((null===(n=this.requestRemoteMedia)||void 0===n?void 0:n.call(this))||[]).forEach((n=>{let[s,o]=n;if(o.has(bg.VIDEO)&&s.videoTrack){const n=s.videoTrack?function(e,t,i,n,s){const o=t.videoRecv.find((t=>t.ssrc===e));if(!o)return null;const r={id:k(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:o.ssrc.toString()};var a,c;if(r.bytesReceived=o.bytes.toString(),r.packetsLost=o.packetsLost.toString(),r.packetsReceived=o.packets.toString(),o.framesRateFirefox&&(r.A_frr=o.framesRateFirefox.toString()),o.receivedFrame?(r.A_frr=o.receivedFrame.frameRate.toString(),r.A_fhr=o.receivedFrame.height.toString(),r.A_fwr=o.receivedFrame.width.toString()):(r.A_fhr=null===(a=n._videoHeight)||void 0===a?void 0:a.toString(),r.A_fwr=null===(c=n._videoWidth)||void 0===c?void 0:c.toString()),r.A_frd=o.decodeFrameRate.toString(),o.outputFrame&&(r.A_fro=o.outputFrame.frameRate.toString()),void 0!==o.jitterBufferMs&&(r.A_jbm=Math.floor(o.jitterBufferMs).toString()),void 0!==o.currentDelayMs&&(r.A_cdm=Math.floor(o.currentDelayMs).toString()),r.A_fs=o.firsCount.toString(),r.A_ns=o.nacksCount.toString(),r.A_ps=o.plisCount.toString(),n&&(r.A_vrtd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),n._player&&n._player.freezeTimeCounterList.length>0&&(r.A_vrft=Math.round(n._player.freezeTimeCounterList.splice(0,1)[0]).toString()),s&&n._player&&"visible"===Le.visibility){const e=Math.min(6e3,n._player.renderFreezeAccTime);r.A_vrrft=Math.round(e).toString(),n._player.renderFreezeAccTime=Math.max(0,n._player.renderFreezeAccTime-e)}if(r.A_rvps=Pe[n._player?n._player.videoElementStatus:"uninit"].toString(),i){const t=i.videoRecv.find((t=>t.ssrc===e));if(t&&void 0!==o.totalInterFrameDelay&&void 0!==o.totalSquaredInterFrameDelay&&void 0!==t.totalInterFrameDelay&&void 0!==t.totalSquaredInterFrameDelay){const e=o.totalInterFrameDelay-t.totalInterFrameDelay,i=o.totalSquaredInterFrameDelay-t.totalSquaredInterFrameDelay,n=o.framesDecodeCount-t.framesDecodeCount,s=e/n*1e3,a=Math.round(1e3*Math.sqrt((i-Math.pow(e,2)/n)/n));!isNaN(a)&&s+a>Math.max(3*s,s+150)&&(r.A_ifdsd=a.toString())}}return r}(s._videoSSRC,e,i,s.videoTrack,t):void 0;n&&j((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,JS.SUBSCRIBE_STATS,{stream_id:s.uid,stats:n})}))}if(o.has(bg.AUDIO)&&s.audioTrack){const t=s.audioTrack?function(e,t,i,n){const s=t.audioRecv.find((t=>t.ssrc===e));if(!s)return null;const o={id:k(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:s.ssrc.toString()};if(o.bytesReceived=s.bytes.toString(),o.packetsLost=s.packetsLost.toString(),o.packetsReceived=s.packets.toString(),s.outputLevel?o.A_aol=Math.round(100*s.outputLevel).toString():o.A_aol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),o.A_apol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),n&&(o.A_artd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),o.A_jr=s.jitterMs.toString(),o.A_jbm=Math.floor(s.jitterBufferMs).toString(),o.A_cdm=Math.floor(s.jitterBufferMs).toString(),o.A_raps=Pe[ke.getPlayerState(n.getTrackId())].toString(),i){const t=i.audioRecv.find((t=>t.ssrc===e));if(t){const e=s.concealedSamples-t.concealedSamples;e>0&&(o.A_cs=Math.round(e).toString())}}return o}(s._audioSSRC,e,i,s.audioTrack):void 0;t&&j((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,JS.SUBSCRIBE_STATS,{stream_id:s.uid,stats:t})}))}}))}uploadRelatedDownlinkStats(e,t){var i;((null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[]).forEach((i=>{let[n,s]=i;if(s.has(bg.VIDEO)&&n.videoTrack){var o;const i=!0===(n._videoSSRC&&(null===(o=this.requestVideoIsReady)||void 0===o?void 0:o.call(this,n._videoSSRC))||!1),s=function(e,t,i,n,s,o){const r=i.videoRecv.find((t=>t.ssrc===e)),a=s?s.videoRecv.find((t=>t.ssrc===e)):void 0;if(!r)return null;const c=kT.isRemoteVideoFreeze(o,r,a)&&t,d={mediaType:"video",isVideoMute:!1,peerId:n,frameRateReceived:r.receivedFrame&&r.receivedFrame.frameRate.toString(),frameRateDecoded:r.decodedFrame&&r.decodedFrame.frameRate.toString(),isFreeze:c,bytesReceived:r.bytes.toString(),packetsReceived:r.packets.toString(),packetsLost:r.packetsLost.toString(),qpSumPerFrame:Math.floor(r.qpSumPerFrame).toString()};return r.framesRateFirefox&&(d.frameRateDecoded=r.framesRateFirefox.toString(),d.frameRateReceived=r.framesRateFirefox.toString()),d}(n._videoSSRC,i,e,n.uid,t,n.videoTrack);s&&j((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,JS.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:s})}))}if(s.has(bg.AUDIO)&&n.audioTrack){const t=function(e,t,i,n){const s=t.audioRecv.find((t=>t.ssrc===e));if(!s)return null;const o=kT.isRemoteAudioFreeze(n);return{mediaType:"audio",isAudioMute:!1,peerId:i,googJitterReceived:s.jitterMs.toString(),isFreeze:o,bytesReceived:s.bytes.toString(),packetsReceived:s.packets.toString(),packetsLost:s.packetsLost.toString(),frameReceived:s.receivedFrames.toString(),frameDropped:s.droppedFrames.toString()}}(n._audioSSRC,e,n.uid,n.audioTrack);t&&j((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,JS.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:t})}))}}))}stopUploadDownlinkStats(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkStatsUploadInterval=void 0,this.downlinkRelatedStatsUploadInterval=void 0)}stopUploadTransportStats(){this.uploadTransportStarted&&(this.uploadTransportStarted=!1,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=void 0)}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval),this.extensionUsageStatsUploadInterval=void 0)}uploadDownlinkExtensionStats(e){e.forEach((e=>{let[t,i]=e;if(i.has(bg.VIDEO)&&t.videoTrack){t.videoTrack.getProcessorStats().forEach((e=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,e.type,e.stats)}))}if(i.has(bg.AUDIO)&&t.audioTrack){t.audioTrack.getProcessorStats().forEach((e=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,e.type,e.stats)}))}}))}}function Rv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Cv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Rv(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Rv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Iv(e){var t,i,n,s=2;for("undefined"!=typeof Symbol&&(i=JC,n=Symbol.iterator);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new vv(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function vv(e){function t(e){if(Object(e)!==e)return yS.reject(new TypeError(e+" is not an object."));var t=e.done;return yS.resolve(e.value).then((function(e){return{value:e,done:t}}))}return vv=function(e){this.s=e,this.n=e.next},vv.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?yS.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?yS.reject(e):t(i.apply(this.s,arguments))}},new vv(e)}class yv extends C{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Mg.StateChange,t,this._state)}constructor(t,i){super(),this.store=void 0,this.statsUploader=void 0,this.connection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.remoteDataChannelMap=new Map,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.statsCollector=void 0,this.isPlanB=!1,this.shouldForwardP2PCreation=void 0,this.iceFailedCount=0,this.dtlsFailedCount=0,this.mutex=new v("P2PChannel-mutex"),this._state=kg.Disconnected,this._pcStatsUploadType=h("NEW_ICE_RESTART")?Pg.FIRST_CONNECTION:Pg.OLD_FIRST_CONNECTION,this._isInRestartIce=!1,this._isStartRestartIce=!1,this._restartStates=["disconnected","failed"],this._restartTimer=void 0,this._isFirstConnected=!0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==kg.Connected)return void i(new g(T.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const n=this.filterTobeMutedTracks(e);if(0===n.length)return void t();const s=n.find((e=>"videoLowTrack"===e[0]));if(s){s[1].track._originMediaStreamTrack.stop()}await this.connection.muteLocal(n.map((e=>{let[,{id:t}]=e;return t})));const o=this.createMuteMessage(n);await ae(this,Mg.RequestMuteLocal,o),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==kg.Connected)return void i(new g(T.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const n=this.filterTobeUnmutedTracks(e);if(0===n.length)return void t();const s=n.find((e=>"videoLowTrack"===e[0]));if(s){const t=s[1];if(t.track._originMediaStreamTrack.stop(),Ve().supportDualStreamEncoding){const i=e._mediaStreamTrack.clone();t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}else{const i=iv(e,M(this,Mg.RequestLowStreamParameter));t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}await new yS(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}await this.connection.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnmuteMessage(n);await ae(this,Mg.RequestUnmuteLocal,o),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const i=this.localTrackMap.get(Lg.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==kg.Connected)return void t();const{id:n,track:s}=i;await this.connection.updateSendParameters(n,s),await this.connection.updateEncoderConfig(n,s),this.emit(Mg.UpdateVideoEncoder,s),t()}catch(e){i(e)}finally{n()}},this.handleSetOptimizationMode=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const i=this.localTrackMap.get(Lg.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==kg.Connected)return;const{id:n,track:s}=i;await this.connection.updateSendParameters(n,s),t()}catch(e){i(e)}finally{n()}},this.handleReplaceTrack=async(t,i,n,s)=>{let o;e.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(t.getTrackId(),"]")),"boolean"==typeof s&&s||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var r;const e=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(!this.connection||!e||this.state!==kg.Connected)return void i();if(await(null===(r=this.connection)||void 0===r?void 0:r.replaceTrack(t,e[1].id)),this.isPlanB){const i=e[1];i.id=t._mediaStreamTrack.id,this.localTrackMap.set(e[0],i)}if(e[0]===Lg.LocalVideoTrack&&Ve().supportDualStreamEncoding){const e=this.localTrackMap.get(Lg.LocalVideoLowTrack);if(e){const i=t._mediaStreamTrack.clone();e.track._originMediaStreamTrack.stop(),e.track._mediaStreamTrack=i,e.track._originMediaStreamTrack=i,await new yS(((t,i)=>{this.handleReplaceTrack(e.track,t,i,!0)}))}}i()}catch(e){n(e)}finally{var a;null===(a=o)||void 0===a||a()}},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=t,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new Tv,this.bindStatsUploaderEvents(),this.isPlanB=!Ve().supportUnifiedPlan||h("CHROME_FORCE_PLAN_B")&&se(),this.shouldForwardP2PCreation=h("FORWARD_P2P_CREATION")&&Ve().supportPCSetConfiguration&&ce(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new mv({},this.store):this.isPlanB?new qI({},this.store):new ev({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,i){var n;this.state=kg.New;const s=this.shouldForwardP2PCreation&&"closed"===(null===(n=this.connection)||void 0===n?void 0:n.peerConnectionState);if(this.shouldForwardP2PCreation&&!s||(s&&this.connection&&(e.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new mv(t,this.store):this.isPlanB?new qI(t,this.store):new ev(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new g(T.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=h("NEW_ICE_RESTART")?Pg.FIRST_CONNECTION:Pg.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(e,t,i,n,s,o){if(!this.connection)throw new g(T.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof mv?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(e,t,i,n,s,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kg.Connected)}async preConnect(e,t,i,n,s,o){if(!this.connection)throw new g(T.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const r=await this.connection.connect(e,t,i,n,s,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kg.Connected,r}getEstablishParams(){if(this.connection instanceof mv)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection){if(this.state===kg.Disconnected)throw new g(T.UNEXPECTED_ERROR,"PeerConnection already disconnected.");const t=e.filter((e=>-1!==this.pendingLocalDataChannels.findIndex((t=>t.id===e.id))));return void(this.pendingLocalDataChannels=this.pendingLocalDataChannels.concat(t))}const t=this.filterTobePublishedDataChannels(e);0!==t.length&&(t.forEach((e=>{const t=Date.now();this.store.publish(e.id.toString(),"datachannel",t)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((e=>{this.localDataChannels.push(e);const t=Date.now();this.store.publish(e.id+"","datachannel",void 0,t)})))}publish(e,t,i){var n=this;return KC((function*(){const s=yield qC(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==kg.Connected){if(n.state===kg.Disconnected)throw new g(T.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,DT.markPublishStart(n.store.clientId,n.store.pubId);const s=n.filterTobePublishedTracks(e,t,i);if(0===s.length)return void(yield qC(n.tryToUnmuteAudio(e)));yield*YC(Iv(n.doPublish(n.connection,s)))}finally{s()}}))()}doPublish(e,t){var i=this;return KC((function*(){t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===Lg.LocalAudioTrack?"audio":"video",s)})),i.bindLocalTrackEvents(t);const n=yield qC(e.send(t.map((e=>{let{track:t}=e;return t})),i.store.codec,i.store.audioCodec)),s=(yield qC(n.next())).value,o=i.createGatewayPublishMessage(t,s);let r;try{r=yield o}catch(e){throw n.throw(e),(null==e?void 0:e.code)===T.WS_ABORT&&t.forEach((e=>{let{track:t}=e;-1===i.pendingLocalTracks.indexOf(t)&&i.pendingLocalTracks.push(t)})),i.unbindLocalTrackEvents(t),e}const a=i.mapPubResToRemoteConfig(o,r),c=(yield qC(n.next(a))).value;t.forEach((e=>{let{type:t}=e;i.statsCollector.addLocalStats(t)})),i.assignLocalTracks(t,c),i.statsUploader.startUploadUplinkStats(),t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===Lg.LocalAudioTrack?"audio":"video",void 0,s)}))}))()}async updateVideoStreamParameter(t,i){const n=this.localTrackMap.get(i);if(!n)return;if(!(n.track instanceof Ue))return console.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof ev||this.connection instanceof qI))return console.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:s}=n,o=function(e,t){const i={};return e.height&&e.width&&(i.scaleResolutionDownBy=HT(e,t)),i.maxFramerate=e.framerate?FT(e.framerate):void 0,i.maxBitrate=e.bitrate?1e3*e.bitrate:void 0,i}(t,s);if(e.debug("[".concat(s.getTrackId(),"] updateLowStreamParameter: , ").concat(JSON.stringify(o))),s._encoderConfig||(s._encoderConfig={}),i!==Lg.LocalVideoLowTrack||Ve().supportDualStreamEncoding)null!=o.scaleResolutionDownBy&&(s._encoderConfig.scaleResolutionDownBy=o.scaleResolutionDownBy);else{const i=s._originMediaStreamTrack;if(!(i instanceof CanvasCaptureMediaStreamTrack))return e.warn("[".concat(s.getTrackId(),"] track is not CanvasCaptureMediaStreamTrack"));!function(t,i){e.debug("updateCanvasCapturePrams: ",t,i);const n=t.canvas;i.width&&(n.width=FT(i.width)),i.height&&(n.height=FT(i.height)),i.framerate&&(n.stopCapture&&n.stopCapture(),n.stopCapture=je((()=>{n.startCapture&&n.startCapture()}),FT(i.framerate)))}(i,t)}null!=o.maxBitrate&&(s._encoderConfig.bitrateMax=o.maxBitrate/1e3),null!=o.maxFramerate&&(s._encoderConfig.frameRate&&"object"==typeof s._encoderConfig.frameRate?s._encoderConfig.frameRate.max=o.maxFramerate:s._encoderConfig.frameRate={max:o.maxFramerate}),await this.connection.updateRtpSenderEncodings(s)}publishLowStream(e){var t=this;return KC((function*(){if(!t.connection||t.state!==kg.Connected)return;const i=yield qC(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const i=t.localTrackMap.get(Lg.LocalVideoTrack);if(!i)throw new g(T.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(Lg.LocalVideoLowTrack))throw new g(T.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const s=[{track:t.getLowVideoTrack(i.track,e),type:Lg.LocalVideoLowTrack}];if(yield*YC(Iv(t.doPublish(t.connection,s))),i.track.muted||!i.track.enabled){var n;const e=null===(n=t.localTrackMap.get(Lg.LocalVideoLowTrack))||void 0===n?void 0:n.id;void 0!==e&&(yield qC(t.connection.muteLocal([e])))}}finally{i()}}))()}async republish(){this.pendingLocalTracks.length>0&&(e.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await O(this,Mg.RequestRePublish,this.pendingLocalTracks),this.emit(Mg.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(e.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await O(this,Mg.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:t,kind:i}=this.pendingRemoteTracks[e];(i!==bg.AUDIO||t._audio_added_&&t._audioSSRC)&&(i!==bg.VIDEO||t._video_added_&&t._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(e)await O(this,Mg.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:t}of this.pendingRemoteTracks)await this.subscribe(e,t,t===bg.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:t}=e;this.emit(Mg.MediaReconnectEnd,t.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==kg.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));if(i){i[1].track.close()}return this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==kg.Connected)return void e.forEach((e=>{const t=this.pendingLocalDataChannels.indexOf(e);-1!==t&&this.pendingLocalDataChannels.splice(t,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return 0!==t.length?(t.forEach((e=>{const t=this.localDataChannels.indexOf(e);-1!==t&&this.localDataChannels.splice(t,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),t.map((e=>e.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==kg.Connected)return;const e=this.localTrackMap.get(Lg.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[Lg.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const i=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadUplinkStats(),i}async subscribeDataChannel(e,t){if(!this.connection||this.state!==kg.Connected)throw new g(T.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=t.filter((t=>{var i;return!(null!==(i=this.remoteDataChannelMap.get(e))&&void 0!==i&&i.get(t.id))}));if(0!==i.length)return await this.connection.createDataChannels(e.uid,i),i.forEach((t=>{var i;this.remoteDataChannelMap.has(e)?null===(i=this.remoteDataChannelMap.get(e))||void 0===i||i.set(t.id,t):this.remoteDataChannelMap.set(e,new Map([[t.id,t]]));const n=this.pendingRemoteDataChannels.findIndex((i=>{let{user:n,id:s}=i;return n.uid===e.uid&&s===t.id}));-1!==n&&this.pendingRemoteDataChannels.splice(n,1)})),i.map((e=>e.id))}async subscribe(t,i,n,s,o){var r;if(!this.connection||this.state!==kg.Connected)throw new g(T.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(r=this.remoteUserMap.get(t))&&void 0!==r&&r.has(i))return;let a,c,d;if(o){const e=o.find((e=>{let{stream_type:t}=e;return t===i}));if(!e)throw new g(T.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(i," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(i,"."));const n=await this.connection.receive(i,e.ssrcs,String(t._uintid),e.attributes);this.connection instanceof ev&&(d=n.transceiver),a=n.track,c=n.id}else{const e=await this.connection.receive(i,[{ssrcId:n,rtx:s}],String(t._uintid),void 0);this.connection instanceof ev&&(d=e.transceiver),a=e.track,c=e.id}i===bg.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(a):(t._audioTrack=new Ge(a,t.uid,t._uintid,this.store),e.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),d&&t._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(a):(t._videoTrack=new We(a,t.uid,t._uintid,this.store),e.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),d&&t._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(t,t._videoTrack));const l=this.remoteUserMap.get(t);l?l.set(i,c):this.remoteUserMap.set(t,new Map([[i,c]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadDownlinkStats();const h=this.pendingRemoteTracks.findIndex((e=>{let{user:n,kind:s}=e;return n.uid===t.uid&&i===s}));-1!==h&&(this.pendingRemoteTracks.splice(h,1),this.emit(Mg.MediaReconnectEnd,t.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(t){if(!this.connection||this.state!==kg.Connected)throw new g(T.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter((e=>{var t;let{user:i,mediaType:n}=e;return!(null!==(t=this.remoteUserMap.get(i))&&void 0!==t&&t.has(n))}));const i=await this.connection.batchReceive(t.map((e=>{let{user:t,mediaType:i,ssrcId:n,rtxSsrcId:s}=e;return{kind:i,ssrcMsg:[{ssrcId:n,rtx:s}],mslabel:String(t._uintid)}})));t.forEach(((t,n)=>{let{user:s,mediaType:o}=t;const{track:r,id:a,transceiver:c}=i[n];o===bg.AUDIO?(s._audioTrack?s._audioTrack._updateOriginMediaStreamTrack(r):(s._audioTrack=new Ge(r,s.uid,s._uintid,this.store),e.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(s._audioTrack.getTrackId()))),c&&s._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(s,s._audioTrack)):(s._videoTrack?s._videoTrack._updateOriginMediaStreamTrack(r):(s._videoTrack=new We(r,s.uid,s._uintid,this.store),e.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(s._videoTrack.getTrackId()))),c&&s._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(s,s._videoTrack));const d=this.remoteUserMap.get(s);d?d.set(o,a):this.remoteUserMap.set(s,new Map([[o,a]])),this.statsCollector.addRemoteStats(s.uid),this.statsUploader.startUploadDownlinkStats();const l=this.pendingRemoteTracks.findIndex((e=>{let{user:t,kind:i}=e;return t.uid===s.uid&&o===i}));-1!==l&&(this.pendingRemoteTracks.splice(l,1),this.emit(Mg.MediaReconnectEnd,s.uid))}))}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.connection&&this.state===kg.Connected||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===bg.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===bg.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==kg.Connected)return;const s=this.filterTobeUnSubscribedTracks(e,t);if(0===s.length)return;await this.connection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnsubscribeMessage(s);return this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),s.forEach((e=>{let[t,{kind:n}]=e;var s,o;n===bg.VIDEO&&t._videoSSRC&&(null===(s=this.connection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(n===bg.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(n===bg.AUDIO){var r;if(this.unbindRemoteTrackEvents(t._audioTrack),!i)null===(r=t._audioTrack)||void 0===r||r._destroy(),t._audioTrack=void 0}})),o}async unsubscribeDataChannel(e,t){if(t.forEach((e=>{const t=this.pendingRemoteDataChannels.findIndex((t=>t.id===e.id));-1!==t&&this.pendingRemoteDataChannels.splice(t,1)})),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(e,t);if(0===i.length)return;t.forEach((e=>{e._close()}));const n=this.remoteDataChannelMap.get(e);return i.forEach((e=>{n&&n.delete(e.id)})),n&&0===n.size&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),i.map((e=>e.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:i,mediaType:n}of e){const e=this.pendingRemoteTracks.filter((e=>{let{user:t,kind:s}=e;return void 0!==n?t.uid===i.uid&&n===s:t.uid===i.uid}));e.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),t=t.concat(e)}if(!this.connection||this.state!==kg.Connected)return void t.forEach((e=>{let{user:t,kind:i}=e;var n;if(i===bg.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===bg.VIDEO){var s;null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0}}));const i=Ip(e).call(e,((e,t)=>{let{user:i,mediaType:n}=t;const s=this.filterTobeUnSubscribedTracks(i,n);return e.concat(s)}),[]);if(0===i.length)return;await this.connection.stopReceiving(i.map((e=>{let[,{id:t}]=e;return t})));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),i.forEach((e=>{let[t,{kind:i}]=e;var n,s;i===bg.VIDEO&&t._videoSSRC&&(null===(n=this.connection)||void 0===n||n.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(i===bg.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0;else if(i===bg.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0}})),n}async muteRemote(t,i){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void e.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(i))return void e.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(i,"."));const s=i===bg.VIDEO?t._videoSSRC:t._audioSSRC;void 0!==s&&this.connection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(t,i){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void e.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(i)||e.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(i,"."))}getAllTracks(e){const t=this.localTrackMap.get(Lg.LocalAudioTrack);if((null==t?void 0:t.track)instanceof De){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==Lg.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===Lg.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===Lg.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,i,n,s){if(e){const i=this.localTrackMap.get(Lg.LocalAudioTrack),o=n?this.localTrackMap.get(Lg.LocalVideoLowTrack):this.localTrackMap.get(Lg.LocalVideoTrack);xS.publish(this.store.sessionId,{eventElapse:DT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==i?void 0:i.track.getTrackLabel(),videoName:null==o?void 0:o.track.getTrackLabel(),screenshare:-1!==(null==o?void 0:o.track._hints.indexOf(xe.SCREEN_TRACK)),audio:!!i,video:!!o,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}else{var o;i||(i=[]);const r=i.find((e=>e instanceof Me)),a=n?null===(o=this.localTrackMap.get(Lg.LocalVideoTrack))||void 0===o?void 0:o.track:i.find((e=>e instanceof Ue));xS.publish(this.store.sessionId,{eventElapse:DT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==r?void 0:r.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(xe.SCREEN_TRACK)),audio:!!r,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}}reportSubscribeEvent(e,t,i,n){const s=n===bg.VIDEO?i._videoSSRC:i._audioSSRC;s&&xS.subscribe(this.store.sessionId,{succ:e,ec:t,video:n===bg.VIDEO,audio:n===bg.AUDIO,peerid:i.uid,subscribeRequestid:n===bg.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:DT.measureFromSubscribeStart(this.store.clientId,s)})}reset(){e.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new v("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new mv({},this.store):this.isPlanB?new qI({},this.store):new ev({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(Lg.LocalAudioTrack);if((null==t?void 0:t.track)instanceof De){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach((t=>{e.removeAudioTrack(t)}))}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=kg.Disconnected}getStats(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.connection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(Lg.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(Lg.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof Ue||t&&t.track instanceof Me?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;const i=Array.from(iI(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(Lg.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=jR(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.connection&&(e.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=kg.Reconnecting,h("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new mv({},this.store):this.isPlanB?new qI({},this.store):new ev({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[i,{track:n}]=e;switch(i){case Lg.LocalVideoTrack:Po(t=n._hints).call(t,xe.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case Lg.LocalAudioTrack:n instanceof De?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case Lg.LocalVideoLowTrack:}})),this.emit(Mg.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(iI(i).call(i)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(Mg.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,i]=e;Array.from(iI(i).call(i)).forEach((e=>{this.setPendingRemoteDataChannel(t,e)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),e.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const i of this.pendingRemoteDataChannels){const{user:n,id:s}=i;if((e instanceof MC?e.uid:e)===n.uid&&s===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof MC?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return KC((function*(){if(!t.connection||t.state!==kg.Connected||t.connection instanceof mv)return;const i=yield qC(t.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield qC(t.connection.restartICE(e));const i=yield qC(n.next());if(i.done)return;const s=i.value,o=yield s;switch(t.reportPCDisconnectedOrFailed(e),e){case Dg.TCP:t._pcStatsUploadType=Pg.TCP_RESTART;break;case Dg.RELAY:t._pcStatsUploadType=Pg.RELAY_RESTART;break;default:t._pcStatsUploadType=Pg.OLD_RESTART}t._isInRestartIce=!0,n.next(o)}catch(e){var s;null===(s=n)||void 0===s||s.throw(e)}finally{i()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(Lg.LocalVideoTrack),i=this.localTrackMap.get(Lg.LocalAudioTrack),n=e.videoSend.find((e=>e.ssrc===(null==t?void 0:t.ssrcs[0].ssrcId))),s=e.audioSend.find((e=>e.ssrc===(null==i?void 0:i.ssrcs[0].ssrcId)));if(!n||!s)return 1;const o=b(this,Mg.NeedSignalRTT),r=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=r&&a?(r+a)/2:r||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(xe.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return Mo[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,r=e.audioRecv.find((e=>e.ssrc===s)),a=e.videoRecv.find((e=>e.ssrc===o));if(!r&&!a)return void(t+=1);const c=b(this,Mg.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=r?r.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new yS(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(e,t,i){const n=[],s=Ve(),o=this.getAllTracks();e=e.filter((e=>-1===o.indexOf(e))),e=de(e);let r=!1,a=!1;for(const o of e){if(o instanceof Ue&&(this.localTrackMap.has(Lg.LocalVideoTrack)||r?new g(T.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:Lg.LocalVideoTrack}),r=!0),t)){const e=this.getLowVideoTrack(o,i);n.push({track:e,type:Lg.LocalVideoLowTrack})}if(o instanceof Me){const e=this.localTrackMap.get(Lg.LocalAudioTrack);if(e){if(!(e.track instanceof De))throw new g(T.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new g(T.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(a){const e=n.find((e=>{let{type:t}=e;return t===Lg.LocalAudioTrack}));if(!(e.track instanceof De))throw new g(T.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new g(T.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof De||o._bypassWebAudio)n.push({track:o,type:Lg.LocalAudioTrack});else{const e=new De;e.addAudioTrack(o),n.push({track:e,type:Lg.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=e.filter((e=>-1!==i.indexOf(e))),e=de(e);for(const i of e){if(i instanceof Me){const e=this.localTrackMap.get(Lg.LocalAudioTrack);if(!e)continue;e.track instanceof De?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([Lg.LocalAudioTrack,e]),e.track.close())):t.push([Lg.LocalAudioTrack,e])}if(i instanceof Ue){const e=this.localTrackMap.get(Lg.LocalVideoTrack);if(!e)continue;t.push([Lg.LocalVideoTrack,e]);const i=this.localTrackMap.get(Lg.LocalVideoLowTrack);i&&t.push([Lg.LocalVideoLowTrack,i])}}return t}filterTobePublishedDataChannels(e){return e=(e=de(e)).filter((e=>-1===this.localDataChannels.findIndex((t=>t.id===e.id))))}filterTobeUnpublishedDataChannels(e){return e=(e=(e=de(e)).filter((e=>-1!==this.localDataChannels.indexOf(e)))).filter((e=>e._originDataChannel))}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Lg.LocalVideoTrack:t.addListener(He.GET_STATS,this.handleGetLocalVideoStats),t.addListener(He.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(He.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(He.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(He.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(He.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(He.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(He.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Lg.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case Lg.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof De?e.trackList.forEach((e=>{e.addListener(He.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(He.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(He.GET_STATS,this.handleGetLocalAudioStats),e.addListener(He.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(He.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(He.GET_STATS,this.handleGetLocalAudioStats),e.addListener(He.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(He.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(He.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(He.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(He.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Lg.LocalVideoTrack:t.off(He.GET_STATS,this.handleGetLocalVideoStats),t.off(He.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(He.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(He.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(He.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(He.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(He.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(He.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Lg.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case Lg.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof De?e.trackList.forEach((e=>{e.off(He.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(He.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(He.GET_STATS,this.handleGetLocalAudioStats),e.off(He.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(He.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(He.GET_STATS,this.handleGetLocalAudioStats),e.off(He.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(He.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(He.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(He.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(He.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof We&&t.addListener(He.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof Ge&&t.addListener(He.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(He.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(bg.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(bg.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{var n;let s,o,{track:r,type:a}=e;switch(a){case Lg.LocalAudioTrack:s=Sg.Audio,o={dtx:r instanceof Be&&r._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Lg.LocalVideoTrack:s=Po(n=r._hints).call(n,xe.SCREEN_TRACK)?Sg.Screen:Sg.High,o=Cv(Cv({},jT(r)),{},{codec:this.store.codec});break;case Lg.LocalVideoLowTrack:s=Sg.Low,o=Cv(Cv({},jT(r)),{},{codec:this.store.codec})}return{stream_type:s,attributes:o,ssrcs:t[i]}}))}createGatewayUnpublishMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case Lg.LocalVideoTrack:i=Po(t=s._hints).call(t,xe.SCREEN_TRACK)?Sg.Screen:Sg.High;break;case Lg.LocalAudioTrack:i=Sg.Audio;break;case Lg.LocalVideoLowTrack:i=Sg.Low}return{stream_type:i,ssrcs:o,mid:r}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(t){t.onConnectionStateChange=async i=>{if(e.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(i,")")),this.emit(Mg.PeerConnectionStateChange,i),"connected"!==i||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===i&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),h("NEW_ICE_RESTART")){var n;if(Po(n=this._restartStates).call(n,i)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const i=i=>{if("disconnected"===t.iceConnectionState||"checking"===t.iceConnectionState||"failed"===t.iceConnectionState){e.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(i));"CONNECTED"===b(this,Mg.QueryClientConnectionState)&&this.emit(Mg.RequestRestartICE,i)}},n=()=>{"disconnected"!==t.iceConnectionState&&"checking"!==t.iceConnectionState&&"failed"!==t.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),e.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(Mg.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},s=h("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(h("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Ve().supportPCSetConfiguration)i(Dg.RELAY),this._restartTimer=window.setTimeout(n,s);else if(Q())i(Dg.UDP),this._restartTimer=window.setTimeout(n,4e3);else{if(i(Dg.TCP),Ve().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{i(Dg.RELAY),this._restartTimer=window.setTimeout(n,s)}),s));this._restartTimer=window.setTimeout(n,s)}}),800))}}else{if("disconnected"===i&&"disconnected"===t.iceConnectionState)return setTimeout((()=>{if("disconnected"===t.iceConnectionState&&h("ICE_RESTART")){"CONNECTED"===b(this,Mg.QueryClientConnectionState)&&this.emit(Mg.RequestRestartICE)}}),800),void setTimeout((()=>{"disconnected"===t.peerConnectionState&&(e.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(Mg.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===i&&(e.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(Mg.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=t=>{"connected"!==t||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),e.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),xS.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:l.TRACER}).onSuccess(),this.emit(Mg.IceConnectionStateChange,t)},t.onICETransportStateChange=t=>{e.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},t.onDTLSTransportStateChange=t=>{e.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},t.onDTLSTransportError=t=>{e.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},t.onFirstAudioDecoded=e=>{var t;const i=Array.from(iI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var o;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),null===(o=i.audioTrack)||void 0===o||o.emit(Ke.FIRST_FRAME_DECODED),xS.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_DECODE,s.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:DT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var t;const i=Array.from(iI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));i&&xS.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_RECEIVED,s.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:DT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},t.onFirstVideoReceived=e=>{var t;const i=Array.from(iI(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));i&&xS.firstRemoteFrame(this.store.sessionId,n.FIRST_VIDEO_RECEIVED,s.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:DT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(t,i)=>{const n="relay"===t.candidateType,s="relay"===i.candidateType;"unknown"!==i.candidateType&&n===s||this.emit(Mg.ConnectionTypeChange,n),e.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(KT(i))," -> ").concat(JSON.stringify(KT(t)),")"))},t.onSelectedRemoteCandidateChanged=(t,i)=>{e.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(KT(i))," -> ").concat(JSON.stringify(KT(t)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(Lg.LocalAudioTrack);if(e instanceof Me&&(null==i?void 0:i.track)instanceof De)return i.track.isActive||t.push([Lg.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===Lg.LocalVideoTrack)){const e=this.localTrackMap.get(Lg.LocalVideoLowTrack);e&&t.push([Lg.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(Lg.LocalAudioTrack);if(e instanceof Me&&(null==i?void 0:i.track)instanceof De)return i.track.isActive&&t.push([Lg.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===Lg.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(Lg.LocalVideoLowTrack);e&&t.push([Lg.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case Lg.LocalAudioTrack:i=Sg.Audio;break;case Lg.LocalVideoTrack:i=Po(t=s._hints).call(t,xe.SCREEN_TRACK)?Sg.Screen:Sg.High;break;case Lg.LocalVideoLowTrack:i=Sg.Low}return{stream_type:i,ssrcs:o,mid:r}}))}createUnmuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case Lg.LocalAudioTrack:i=Sg.Audio;break;case Lg.LocalVideoTrack:i=Po(t=s._hints).call(t,xe.SCREEN_TRACK)?Sg.Screen:Sg.High;break;case Lg.LocalVideoLowTrack:i=Sg.Low}return{stream_type:i,ssrcs:o,mid:r}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}filterTobeUnSubscribedDataChannels(e,t){const i=[];return t.forEach((t=>{var n;null!==(n=this.remoteDataChannelMap.get(e))&&void 0!==n&&n.has(t.id)&&i.push(t)})),i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case bg.VIDEO:return void(i._videoSSRC&&t.push({stream_type:bg.VIDEO,ssrcId:i._videoSSRC}));case bg.AUDIO:return void(i._audioSSRC&&t.push({stream_type:bg.AUDIO,ssrcId:i._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((e=>{let[i,{kind:n}]=e;if(t.has(i)){let e=t.get(i);n===bg.VIDEO?e|=Tg.Video:e|=Tg.Audio,t.set(i,e)}else n===bg.VIDEO?t.set(i,Tg.Video):t.set(i,Tg.Audio)})),{users:Array.from(t.entries()).map((e=>{let[t,i]=e;return{stream_id:t.uid,stream_type:i}}))}}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(Lg.LocalVideoTrack),i=this.localTrackMap.get(Lg.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.connection){return"connected"!==this.connection.peerConnectionState}return!0}mapPubResToRemoteConfig(e,t){return e.map(((e,i)=>{var n;let{stream_type:s}=e;return null===(n=t.find((e=>{let{stream_type:t}=e;return s===t})))||void 0===n?void 0:n.attributes}))}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof Me){var t;const n=this.filterTobeUnmutedTracks(e[i]);if(0===n.length)continue;await(null===(t=this.connection)||void 0===t?void 0:t.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t}))));const s=this.createUnmuteMessage(n);return void await ae(this,Mg.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.connection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Mg.RequestUploadStats,e,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await N(w(this.dtlsFailedCount,J)),this.emit(Mg.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await O(this,Mg.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(Mg.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(Lg.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof Ue))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof Ue)).length>1)throw new g(T.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof Me)).length>1&&(e.some((e=>e instanceof Me&&e._bypassWebAudio))||!Ve().webAudioMediaStreamDest))throw new g(T.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof Ue&&this.pendingLocalTracks.some((e=>e instanceof Ue)))throw new g(T.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Me&&this.pendingLocalTracks.some((e=>e instanceof Me))&&(!Ve().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof Me&&e._bypassWebAudio))))throw new g(T.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=Ve().supportDualStreamEncoding,n=Cv(Cv({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():iv(e,n);const o=k(8,"track-low-"),r=new Ue(s,Cv(Cv({},i&&{scaleResolutionDownBy:HT(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return r.on(qe.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,Ye.LOW_STREAM)})),r._hints.push(xe.LOW_STREAM),e.addListener(He.NEED_CLOSE,(()=>{r.close()})),r}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof ev){var s,o,r,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:h}=this.connection,{local:u,remote:p}=await this.connection.getSelectedCandidatePair();xS.pcStats(this.store.sessionId,{startTime:c,eventElapse:e-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:h,intSucc:t?1:2,error:n,selectedLocalCandidateProtocol:null!==(s=null==u?void 0:u.protocol)&&void 0!==s?s:"",selectedLocalCandidateType:null!==(o=u.candidateType)&&void 0!==o?o:"",selectedLocalCandidateAddress:"".concat(u.address,":").concat(u.port),selectedRemoteCandidateProtocol:null!==(r=p.protocol)&&void 0!==r?r:"",selectedRemoteCandidateType:null!==(a=p.candidateType)&&void 0!==a?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:i})}}reportVideoFirstFrameDecoded(e,t,i,o){var r;const a=Array.from(iI(r=this.remoteUserMap).call(r)).find((t=>t._videoSSRC===e));if(a){o||this.store.subscribe(a.uid,"video",void 0,void 0,void 0,void 0,Date.now());const r=this.store.keyMetrics,c=r.subscribe.find((e=>e.userId===a.uid&&"video"===e.type));xS.firstRemoteVideoDecode(this.store.sessionId,n.FIRST_VIDEO_DECODE,s.FIRST_VIDEO_DECODE,{peer:a._uintid,videowidth:t,videoheight:i,subscribeElapse:DT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:r.requestAPEnd||0,apStart:r.requestAPStart||0,joinGwEnd:r.joinGatewayEnd||0,joinGwStart:r.joinGatewayStart||0,pcEnd:r.peerConnectionEnd||0,pcStart:r.peerConnectionStart||0,subscriberEnd:(null==c?void 0:c.subscribeEnd)||0,subscriberStart:(null==c?void 0:c.subscribeStart)||0,videoAddNotify:(null==c?void 0:c.streamAdded)||0,state:o?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const o=await this.connection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(t){e.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(t)),this.state===kg.Connected?(e.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=t===Rg.datachannel?new mv({},this.store):this.isPlanB?new qI({},this.store):new ev({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===Lg.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,Ye.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof ev&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===Pg.TCP_RESTART&&e===Dg.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,Pg.DISCONNECTED_OR_FAILED)))}}function Av(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PChannel.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function wv(e){let t=Vv();return function(e,t){let i=e.appId;void 0!==i&&(Zv(t,10),Kv(t,i));let n=e.cid;void 0!==n&&(Zv(t,16),Zv(t,n));let s=e.cname;void 0!==s&&(Zv(t,26),Kv(t,s));let o=e.deviceId;void 0!==o&&(Zv(t,34),Kv(t,o));let r=e.elapse;void 0!==r&&(Zv(t,40),$v(t,r));let a=e.fileSize;void 0!==a&&(Zv(t,48),$v(t,Uv(a)));let c=e.height;void 0!==c&&(Zv(t,56),$v(t,Uv(c)));let d=e.jpg;void 0!==d&&(Zv(t,66),Zv(t,d.length),function(e,t){let i=Gv(e,t.length);e.bytes.set(t,i)}(t,d));let l=e.networkType;void 0!==l&&(Zv(t,72),$v(t,Uv(l)));let h=e.osType;void 0!==h&&(Zv(t,80),$v(t,Uv(h)));let u=e.requestId;void 0!==u&&(Zv(t,90),Kv(t,u));let p=e.sdkVersion;void 0!==p&&(Zv(t,98),Kv(t,p));let _=e.sequence;void 0!==_&&(Zv(t,104),$v(t,Uv(_)));let E=e.sid;void 0!==E&&(Zv(t,114),Kv(t,E));let m=e.timestamp;void 0!==m&&(Zv(t,120),$v(t,m));let f=e.uid;void 0!==f&&(Zv(t,128),Zv(t,f));let S=e.vid;void 0!==S&&(Zv(t,136),Zv(t,S));let g=e.width;void 0!==g&&(Zv(t,144),$v(t,Uv(g)));let T=e.service;void 0!==T&&(Zv(t,152),Zv(t,T));let R=e.callbackData;void 0!==R&&(Zv(t,162),Kv(t,R));let C=e.jpgEncryption;void 0!==C&&(Zv(t,168),Zv(t,C));let I=e.requestType;void 0!==I&&(Zv(t,176),Zv(t,I));let v=e.scorePorn;void 0!==v&&(Zv(t,185),zv(t,v));let y=e.scoreSexy;void 0!==y&&(Zv(t,193),zv(t,y));let A=e.scoreNeutral;void 0!==A&&(Zv(t,201),zv(t,A));let w=e.scene;void 0!==w&&(Zv(t,208),Zv(t,w));let N=e.ossFilePrefix;void 0!==N&&(Zv(t,218),Kv(t,N));let O=e.serviceVendor;if(void 0!==O)for(let e of O){Zv(t,226);let i=Vv();bv(e,i),Zv(t,i.limit),qv(t,i),Fv(i)}}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}function Nv(e){return function(e){let t={};e:for(;!Bv(e);){let i=Qv(e);switch(i>>>3){case 0:break e;case 1:t.code=Qv(e);break;case 2:t.msg=Hv(e,Qv(e));break;case 3:{let i=Dv(e);t.data=Ov(e),e.limit=i;break}default:Pv(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function Ov(e){let t={};e:for(;!Bv(e);){let i=Qv(e);switch(i>>>3){case 0:break e;case 1:t.requestId=Hv(e,Qv(e));break;case 2:t.requestType=Qv(e)>>>0;break;case 3:t.scorePorn=Xv(e);break;case 4:t.scoreSexy=Xv(e);break;case 5:t.scoreNeutral=Xv(e);break;case 6:t.requestScene=Qv(e)>>>0;break;case 7:t.scene=Qv(e)>>>0;break;default:Pv(e,7&i)}}return t}function bv(e,t){let i=e.service;void 0!==i&&(Zv(t,8),Zv(t,i));let n=e.vendor;void 0!==n&&(Zv(t,16),Zv(t,n));let s=e.token;void 0!==s&&(Zv(t,26),Kv(t,s));let o=e.callbackUrl;void 0!==o&&(Zv(t,34),Kv(t,o))}function Dv(e){let t=Qv(e),i=e.limit;return e.limit=e.offset+t,i}function Pv(e,t){switch(t){case 0:for(;128&Yv(e););break;case 2:jv(e,Qv(e));break;case 5:jv(e,4);break;case 1:jv(e,8);break;default:throw new Error("Unimplemented type: "+t)}}kS([Av,MS("design:type",Function),MS("design:paramtypes",[Object,Boolean]),MS("design:returntype",yS)],yv.prototype,"startP2PConnection",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[Object,Object,Array,Object,String,String]),MS("design:returntype",yS)],yv.prototype,"connect",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[Object,Object,Array,Object,String,String]),MS("design:returntype",yS)],yv.prototype,"preConnect",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],yv.prototype,"publishDataChannel",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],yv.prototype,"unpublish",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],yv.prototype,"unpublishDataChannel",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",yS)],yv.prototype,"unpublishLowStream",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[MC,Array]),MS("design:returntype",yS)],yv.prototype,"subscribeDataChannel",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[MC,String,Number,Number,Array]),MS("design:returntype",yS)],yv.prototype,"subscribe",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],yv.prototype,"massSubscribe",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[MC,String,Boolean]),MS("design:returntype",yS)],yv.prototype,"unsubscribe",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[MC,Array]),MS("design:returntype",yS)],yv.prototype,"unsubscribeDataChannel",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],yv.prototype,"massUnsubscribe",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[MC,String]),MS("design:returntype",yS)],yv.prototype,"muteRemote",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[MC,String]),MS("design:returntype",yS)],yv.prototype,"unmuteRemote",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[MC,String]),MS("design:returntype",yS)],yv.prototype,"hasRemoteMediaWithLock",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",yS)],yv.prototype,"disconnectForReconnect",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[Object]),MS("design:returntype",yS)],yv.prototype,"updateBitrateLimit",null),kS([Av,MS("design:type",Function),MS("design:paramtypes",[MC,String,Number]),MS("design:returntype",yS)],yv.prototype,"remoteMediaSsrcChanged",null);let Lv=new Float32Array(1);new Uint8Array(Lv.buffer);let kv=new Float64Array(1),Mv=new Uint8Array(kv.buffer);function Uv(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let xv=[];function Vv(){const e=xv.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function Fv(e){xv.push(e)}function jv(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function Bv(e){return e.offset>=e.limit}function Gv(e,t){let i=e.bytes,n=e.offset,s=e.limit,o=n+t;if(o>i.length){let t=new Uint8Array(2*o);t.set(i),e.bytes=t}return e.offset=o,o>s&&(e.limit=o),n}function Wv(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function Hv(e,t){let i=Wv(e,t),n=String.fromCharCode,s=e.bytes,o="ï¿½",r="";for(let e=0;e<t;e++){let a,c,d,l,h=s[e+i];0==(128&h)?r+=n(h):192==(224&h)?e+1>=t?r+=o:(a=s[e+i+1],128!=(192&a)?r+=o:(l=(31&h)<<6|63&a,l<128?r+=o:(r+=n(l),e++))):224==(240&h)?e+2>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],32896!=(49344&(a|c<<8))?r+=o:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?r+=o:(r+=n(l),e+=2))):240==(248&h)?e+3>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(a|c<<8|d<<16))?r+=o:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?r+=o:(l-=65536,r+=n(55296+(l>>10),56320+(1023&l)),e+=3))):r+=o}return r}function Kv(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}Zv(e,n);let s=Gv(e,n),o=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function qv(e,t){let i=Gv(e,t.limit),n=e.bytes,s=t.bytes;for(let e=0,o=t.limit;e<o;e++)n[e+i]=s[e]}function Yv(e){return e.bytes[Wv(e,1)]}function Jv(e,t){let i=Gv(e,1);e.bytes[i]=t}function Xv(e){let t=Wv(e,8),i=e.bytes;return Mv[0]=i[t++],Mv[1]=i[t++],Mv[2]=i[t++],Mv[3]=i[t++],Mv[4]=i[t++],Mv[5]=i[t++],Mv[6]=i[t++],Mv[7]=i[t++],kv[0]}function zv(e,t){let i=Gv(e,8),n=e.bytes;kv[0]=t,n[i++]=Mv[0],n[i++]=Mv[1],n[i++]=Mv[2],n[i++]=Mv[3],n[i++]=Mv[4],n[i++]=Mv[5],n[i++]=Mv[6],n[i++]=Mv[7]}function Qv(e){let t,i=0,n=0;do{t=Yv(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function Zv(e,t){for(t>>>=0;t>=128;)Jv(e,127&t|128),t>>>=7;Jv(e,t)}function $v(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=Gv(e,o),a=e.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}function ey(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}const ty=new Map([["moderation",1],["supervise",2]]);class iy extends C{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(Vg.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){var t;this._inspectMode=Ip(t=e.map((e=>ty.get(e)||0))).call(t,((e,t)=>e+t)),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(t){super(),this.name="AgoraRTCVideoContentInspect",this._connectionState=Ug.CONNECTING,this._innerConnectionState=void 0,this.sequence=0,this.inspectStartTime=void 0,this.workerManagerConnection=void 0,this.workerConnection=void 0,this.workerMessageLengthLimit=void 0,this.inspectIntervalMinimum=void 0,this.qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=st.CancelToken.source(),this._retryConfig=void 0,this.wmSequence=0,this.inspectInterval=void 0,this.inspectTimer=null,this.ossFilePrefix=void 0,this.extraInfo=void 0,this._inspectType=void 0,this._inspectMode=void 0,this._quality=1,this.qualityTimer=null,this._inspectId=void 0,this._needWorkUrlOnly=!1,this.inspectImage=()=>{if(this.connectionState!==Ug.CONNECTED)throw new Ig(T.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===Ug.CONNECTED?this.requestToInspectImage():e.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()},this._inspectId=k(5,"inspect-"),this.workerMessageLengthLimit=h("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=h("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=h("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new cT("worker-manager-"+this._inspectId,J),this.on(Vg.STATE_CHANGE,((t,i)=>{this._innerConnectionState=t,e.debug("[".concat(this._inspectId,"] Inspect operation :").concat(xg[t]," ").concat(i||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new cT("worker-"+this._inspectId,J),this.handleWorkerEvents()}async init(e,t){this.emit(Vg.STATE_CHANGE,xg.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new yS(((n,s)=>{this.on(Vg.CONNECTION_STATE_CHANGE,((e,t)=>{t===Ug.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorkerManager(e)})).catch((e=>{s(e)}))}))}async requestAP(t,i,n){const s=h("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),o=await function(t,i,n,s){let{appId:o,areaCode:r,cname:a,sid:c,token:d,uid:l}=i;hC++;const u="image_moderation_api",p={service_name:u,json_body:JSON.stringify({appId:o,areaCode:r,cname:a,command:"allocateEdge",requestId:hC,seq:hC,sid:c,token:d,ts:Date.now(),uid:l+""})};let _,E,m=t[0];return q((async()=>{_=Date.now();const t=await WR(m,{data:p,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(E=Date.now()-_,0!==t.code){const i=new Ig(T.UNEXPECTED_RESPONSE,"image inspect ap error, code"+t.code,{retry:!0,responseTime:E});throw e.error(i.toString()),i}const i=JSON.parse(t.json_body);if(200!==i.code){const t=new Ig(T.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:E});throw e.error(t.toString()),t}if(!i.servers||!Array.isArray(i.servers)||0===i.servers.length){const t=new Ig(T.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:i.code,responseTime:E});throw e.error(t.toString()),t}const s=h("VIDEO_INSPECT_WORKER_MANAGER_HOST"),o=h("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:i.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(s,":").concat(o||i)})).filter((e=>!!e)),workerToken:i.workerToken,vid:i.vid,responseTime:E}}),((e,i)=>(xS.apworkerEvent(c,{success:!0,sc:200,serviceName:u,responseDetail:JSON.stringify(e.addressList),firstSuccess:0===i,responseTime:E,serverIp:t[i%t.length]}),!1)),((e,i)=>(xS.apworkerEvent(c,{success:!1,sc:e.data&&e.data.code||200,serviceName:u,responseTime:E,serverIp:t[i%t.length]}),!!(e.code!==T.OPERATION_ABORTED&&e.code!==T.UNEXPECTED_RESPONSE||e.data&&e.data.retry)&&(m=t[(i+1)%t.length],!0))),s)}(s,t,i,n);this.emit(Vg.STATE_CHANGE,xg.AP_CONNECTED);const{addressList:r}=o;return this.wmSequence++,r}async connectWorkerManager(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=t,this.emit(Vg.STATE_CHANGE,xg.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(ig.CONNECTED,(async()=>{this.emit(Vg.STATE_CHANGE,xg.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.19.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(ig.CLOSED,(()=>{this._innerConnectionState<xg.GET_WORKER_MANAGER_RESPONSE&&e.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(ig.FAILED,(()=>{this._innerConnectionState<xg.GET_WORKER_MANAGER_RESPONSE&&e.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(ig.RECONNECTING,(()=>{this._innerConnectionState<xg.GET_WORKER_MANAGER_RESPONSE&&e.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(ig.ON_MESSAGE,(async t=>{this.emit(Vg.STATE_CHANGE,xg.GET_WORKER_MANAGER_RESPONSE);const i=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(t.data);if(200!==n.code)throw e.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new Ig(T.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&i))throw e.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new Ig(T.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const e=h("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,t=i.replace(/:\d+\/?$/,":".concat(e));this.emit(Vg.STATE_CHANGE,xg.CONNECT_WORKER,t),this._needWorkUrlOnly?this.emit(Vg.REQUEST_NEW_WORKER_URL,t):await this.connectWorker(t)}})),this.workerManagerConnection.on(ig.WILL_RECONNECT,((e,t)=>{t(e)})),this.workerManagerConnection.on(ig.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}handleWorkerEvents(){this.workerConnection.on(ig.CONNECTED,(async()=>{this.emit(Vg.STATE_CHANGE,xg.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=Ug.CONNECTED})),this.workerConnection.on(ig.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const n=Nv(new Uint8Array(t.data));if(h("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&e.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),200===n.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(Vg.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var i;const e={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},t=Ip(i=Object.keys(e)).call(i,((t,i)=>e[t]>e[i]?t:i),"porn"),s=Object.keys(e).find((e=>e===t));this.emit(Vg.INSPECT_RESULT,s)}else this.emit(Vg.INSPECT_RESULT,void 0,new Ig(T.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(Vg.INSPECT_RESULT,void 0,new Ig(T.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else e.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Vg.INSPECT_RESULT,void 0,new Ig(T.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(ig.CLOSED,(()=>{this.connectionState=Ug.CLOSED})),this.workerConnection.on(ig.FAILED,(()=>{this.connectionState=Ug.CLOSED})),this.workerConnection.on(ig.RECONNECTING,(()=>{this.connectionState=this.connectionState===Ug.CONNECTED?Ug.RECONNECTING:Ug.CONNECTING})),this.workerConnection.on(ig.WILL_RECONNECT,((e,t)=>{"recover"===e&&t(e),t("tryNext")})),this.workerConnection.on(ig.REQUEST_NEW_URLS,((e,t)=>{this.workerManagerConnection.close(),this.once(Vg.REQUEST_NEW_WORKER_URL,(t=>{e([t])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((e=>{this.connectWorkerManager(e,!0)})).catch((e=>{t(e)}))}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=b(this,Vg.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(Vg.INSPECT_RESULT,void 0,new Ig(T.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(e,t);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(Vg.INSPECT_RESULT,void 0,new Ig(T.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,i){let{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c}=i;const d=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),u=await Je(l,n,s),p=this.sequence+"-"+o+"-"+c+"-"+d+"-"+k(12,""),_={appId:n,cid:o,cname:s,deviceId:"",elapse:iy.intToLong(Number(d-this.inspectStartTime)),fileSize:u.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:p,sdkVersion:"4.19.0",sequence:this.sequence,sid:a,timestamp:iy.intToLong(d),uid:c,vid:r,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete _.callbackData,void 0===this.ossFilePrefix&&delete _.ossFilePrefix;const E=wv(_);if(E.byteLength<this.workerMessageLengthLimit){if(h("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const t=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ey(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ey(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},_);delete t.jpg,e.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(t))}return E}{const e=this.quality*this.qualityRatio;return this.quality=e,await this.generateRequestData(t,{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=st.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=Ug.CLOSED,this.emit(Vg.STATE_CHANGE,xg.CLOSED)}}function ny(e){let t=function(){const e=ay.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,t){let i=e.appId;void 0!==i&&(Sy(t,10),_y(t,i));let n=e.cid;void 0!==n&&(Sy(t,16),Sy(t,n));let s=e.cname;void 0!==s&&(Sy(t,26),_y(t,s));let o=e.deviceId;void 0!==o&&(Sy(t,34),_y(t,o));let r=e.elapse;void 0!==r&&(Sy(t,40),Ty(t,r));let a=e.fileSize;void 0!==a&&(Sy(t,48),Ty(t,ry(a)));let c=e.height;void 0!==c&&(Sy(t,56),Ty(t,ry(c)));let d=e.jpg;void 0!==d&&(Sy(t,66),Sy(t,d.length),uy(t,d));let l=e.networkType;void 0!==l&&(Sy(t,72),Ty(t,ry(l)));let h=e.osType;void 0!==h&&(Sy(t,80),Ty(t,ry(h)));let u=e.requestId;void 0!==u&&(Sy(t,90),_y(t,u));let p=e.sdkVersion;void 0!==p&&(Sy(t,98),_y(t,p));let _=e.sequence;void 0!==_&&(Sy(t,104),Ty(t,ry(_)));let E=e.sid;void 0!==E&&(Sy(t,114),_y(t,E));let m=e.timestamp;void 0!==m&&(Sy(t,120),Ty(t,m));let f=e.uid;void 0!==f&&(Sy(t,128),Sy(t,f));let S=e.vid;void 0!==S&&(Sy(t,136),Sy(t,S));let g=e.width;void 0!==g&&(Sy(t,144),Ty(t,ry(g)));let T=e.service;void 0!==T&&(Sy(t,152),Sy(t,T));let R=e.callbackData;void 0!==R&&(Sy(t,162),Sy(t,R.length),uy(t,R));let C=e.ticket;void 0!==C&&(Sy(t,170),_y(t,C))}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}function sy(e){return function(e){let t={};e:for(;!dy(e);){let i=fy(e);switch(i>>>3){case 0:break e;case 1:t.code=fy(e);break;case 2:t.msg=py(e,fy(e));break;case 3:t.requestId=py(e,fy(e));break;case 4:t.timestamp=gy(e,!1);break;default:oy(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function oy(e,t){switch(t){case 0:for(;128&Ey(e););break;case 2:cy(e,fy(e));break;case 5:cy(e,4);break;case 1:cy(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function ry(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let ay=[];function cy(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function dy(e){return e.offset>=e.limit}function ly(e,t){let i=e.bytes,n=e.offset,s=e.limit,o=n+t;if(o>i.length){let t=new Uint8Array(2*o);t.set(i),e.bytes=t}return e.offset=o,o>s&&(e.limit=o),n}function hy(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function uy(e,t){let i=ly(e,t.length);e.bytes.set(t,i)}function py(e,t){let i=hy(e,t),n=String.fromCharCode,s=e.bytes,o="ï¿½",r="";for(let e=0;e<t;e++){let a,c,d,l,h=s[e+i];0==(128&h)?r+=n(h):192==(224&h)?e+1>=t?r+=o:(a=s[e+i+1],128!=(192&a)?r+=o:(l=(31&h)<<6|63&a,l<128?r+=o:(r+=n(l),e++))):224==(240&h)?e+2>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],32896!=(49344&(a|c<<8))?r+=o:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?r+=o:(r+=n(l),e+=2))):240==(248&h)?e+3>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(a|c<<8|d<<16))?r+=o:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?r+=o:(l-=65536,r+=n(55296+(l>>10),56320+(1023&l)),e+=3))):r+=o}return r}function _y(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}Sy(e,n);let s=ly(e,n),o=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function Ey(e){return e.bytes[hy(e,1)]}function my(e,t){let i=ly(e,1);e.bytes[i]=t}function fy(e){let t,i=0,n=0;do{t=Ey(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function Sy(e,t){for(t>>>=0;t>=128;)my(e,127&t|128),t>>>=7;my(e,t)}function gy(e,t){let i,n=0,s=0,o=0;return i=Ey(e),n=127&i,128&i&&(i=Ey(e),n|=(127&i)<<7,128&i&&(i=Ey(e),n|=(127&i)<<14,128&i&&(i=Ey(e),n|=(127&i)<<21,128&i&&(i=Ey(e),s=127&i,128&i&&(i=Ey(e),s|=(127&i)<<7,128&i&&(i=Ey(e),s|=(127&i)<<14,128&i&&(i=Ey(e),s|=(127&i)<<21,128&i&&(i=Ey(e),o=127&i,128&i&&(i=Ey(e),o|=(127&i)<<7))))))))),{low:n|s<<28,high:s>>>4|o<<24,unsigned:t}}function Ty(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=ly(e,o),a=e.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}const Ry={},Cy={},Iy=4294967296,vy=0x10000000000000000,yy=vy/2,Ay=Dy(0,!0),wy=Dy(0),Ny=Py(0,-2147483648,!1),Oy=Py(-1,2147483647,!1),by=Py(-1,-1,!0);function Dy(e,t){let i,n,s;return t?(s=0<=(e>>>=0)&&e<256)&&(n=Cy[e],n)?n:(i=Py(e,0,!0),s&&(Cy[e]=i),i):(s=-128<=(e|=0)&&e<128)&&(n=Ry[e],n)?n:(i=Py(e,e<0?-1:0,!1),s&&(Ry[e]=i),i)}function Py(e,t,i){return{low:0|e,high:0|t,unsigned:!!i}}function Ly(e,t){if(isNaN(e))return t?Ay:wy;if(t){if(e<0)return Ay;if(e>=vy)return by}else{if(e<=-yy)return Ny;if(e+1>=yy)return Oy}return e<0?t?Ay:wy:Py(e%Iy|0,e/Iy|0,t)}function ky(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class My extends C{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(Hg.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(t){var i;super(),this.name="AgoraRTCImageModeration",this._connectionState=Wg.CONNECTING,this._sequence=0,this._moderationStartTime=void 0,this._workerConnection=void 0,this._workerMessageLengthLimit=void 0,this._qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=st.CancelToken.source(),this._retryConfig=void 0,this._moderationInterval=void 0,this._moderationTimer=null,this._moderationMode=1,this._quality=1,this._qualityTimer=null,this._ticket=void 0,this._moderationIntervalMinimum=void 0,this._uploadFailedNum=0,this._uploadNum=0,this._uploadTimer=null,this._moderationId=void 0,this.inspectImage=()=>{if(this.connectionState!==Wg.CONNECTED)throw new Ig(T.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===Wg.CONNECTED?this.requestToInspectImage():e.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()},this._moderationId=k(5,"image-moderation-"),this._workerMessageLengthLimit=h("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=h("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(i=t.interval)&&void 0!==i?i:1e3,this._qualityRatio=h("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new cT("worker-"+this._moderationId,J),this.on(Hg.STATE_CHANGE,((t,i)=>{e.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Kg[t]," ").concat(i||""))})),this.handleWorkerEvents()}async init(e,t){this.emit(Hg.STATE_CHANGE,Kg.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new yS(((n,s)=>{this.on(Hg.CONNECTION_STATE_CHANGE,((e,t)=>{e===Wg.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorker(e)})).catch((e=>{s(e)}))}))}updateConfig(t){var i;this._moderationInterval=null!==(i=t.interval)&&void 0!==i?i:1e3,e.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===Wg.CONNECTED&&this.inspectImage()}async requestAP(t,i,n){const s=h("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),o=await function(t,i,n,s){let{appId:o,areaCode:r,cname:a,sid:c,token:d,uid:l}=i;hC++;const u="moderation_plugin",p={service_name:u,json_body:JSON.stringify({appId:o,areaCode:r,cname:a,command:"allocateEdge",requestId:hC,seq:hC,sid:c,appToken:d,ts:Date.now(),uid:l+""})};let _,E,m=t[0];return q((async()=>{_=Date.now();const t=await WR(m,{data:p,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(E=Date.now()-_,0!==t.code){const i=new Ig(T.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+t.code,{retry:!0,responseTime:E});throw e.error(i.toString()),i}const i=JSON.parse(t.json_body);if(200!==i.code){const t=new Ig(T.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:E});throw e.error(t.toString()),t}if(!i.servers||!Array.isArray(i.servers)||0===i.servers.length){const t=new Ig(T.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:i.code,responseTime:E});throw e.error(t.toString()),t}if(!i.servers.some((e=>!!e.wss))){const t=new Ig(T.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:i.code,responseTime:E});throw e.error(t.toString()),t}const s=h("IMAGE_MODERATION_WORKER_HOST");return{addressList:i.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(s,":").concat(i,"/moderation")})).filter((e=>!!e)),workerToken:i.workerToken,vid:i.vid,ticket:i.appTicket,responseTime:E}}),((e,i)=>(xS.apworkerEvent(c,{success:!0,sc:200,serviceName:u,responseDetail:JSON.stringify(e.addressList),firstSuccess:0===i,responseTime:E,serverIp:t[i%t.length]}),!1)),((e,i)=>(xS.apworkerEvent(c,{success:!1,sc:e.data&&e.data.code||200,serviceName:u,responseTime:E,serverIp:t[i%t.length]}),!!(e.code!==T.OPERATION_ABORTED&&e.code!==T.UNEXPECTED_RESPONSE||e.data&&e.data.retry)&&(m=t[(i+1)%t.length],!0))),s)}(s,t,i,n);this.emit(Hg.STATE_CHANGE,Kg.AP_CONNECTED);const{addressList:r,ticket:a}=o;return this._ticket=a,r}async connectWorker(e){this.emit(Hg.STATE_CHANGE,Kg.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(ig.CONNECTED,(async()=>{this.emit(Hg.STATE_CHANGE,Kg.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=Wg.CONNECTED})),this._workerConnection.on(ig.CLOSED,(()=>{this.connectionState=Wg.CLOSED})),this._workerConnection.on(ig.FAILED,(()=>{this.connectionState=Wg.CLOSED})),this._workerConnection.on(ig.RECONNECTING,(()=>{this.connectionState=this.connectionState===Wg.CONNECTED?Wg.RECONNECTING:Wg.CONNECTING})),this._workerConnection.on(ig.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const i=sy(new Uint8Array(t.data));h("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&e.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(i)),this._uploadNum++,void 0===i.code||0===i.code||(this._uploadFailedNum++,e.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(i.code,", msg is ").concat(i.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{xS.reportApiInvoke(this._connectInfo.sid||null,{name:K.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,i.code],tag:l.TRACER}).onError(new Ig(T.IMAGE_MODERATION_UPLOAD_FAILED,i.msg)),this._uploadTimer=null}),h("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else e.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(ig.WILL_RECONNECT,((e,t)=>{"recover"===e&&t(e),t("tryNext")})),this._workerConnection.on(ig.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const t=b(this,Hg.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(h("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&e.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(t,i);this._workerConnection.sendMessage(n,!0,!0)}else h("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&e.debug("Only the track being published can be inspected")}async generateRequestData(t,i){let{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c}=i;const d=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),u=await Je(l,n,s),p=this._sequence+"-"+o+"-"+c+"-"+d+"-"+k(12,""),_={appId:n,cid:o,cname:s,deviceId:"",elapse:My.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:p,sdkVersion:"4.19.0",sequence:this._sequence,sid:a,timestamp:Ly(d),uid:c,vid:r,service:this._moderationMode,ticket:this._ticket},E=ny(_);if(E.byteLength<this._workerMessageLengthLimit){if(h("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const t=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ky(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ky(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},_);delete t.jpg,e.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(t))}return E}{const e=this.quality*this._qualityRatio;return this.quality=e,await this.generateRequestData(t,{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=st.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=Wg.CLOSED,this.emit(Hg.STATE_CHANGE,Kg.CLOSED)}}function Uy(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function xy(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Uy(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Uy(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Vy extends C{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return(null===(e=this._config)||void 0===e?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t){let i;if(super(),this.store=void 0,this._uid=void 0,this._channelName=void 0,this._uintUid=void 0,this._users=[],this._config=void 0,this._clientId=void 0,this._appId=void 0,this._sessionId=null,this._key=void 0,this._joinInfo=void 0,this._gateway=void 0,this._statsCollector=void 0,this._configDistribute=void 0,this._leaveMutex=new v("client-leave"),this._publishMutex=new v("client-publish"),this._renewTokenMutex=new v("client-renewtoken"),this._subscribeMutex=new v("client-subscribe"),this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._proxyServer=void 0,this._turnServer={servers:[],mode:"auto"},this._cloudProxyServerMode="disabled",this._isDualStreamEnabled=!1,this._defaultStreamFallbackType=void 0,this._lowStreamParameter=void 0,this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._axiosCancelSource=st.CancelToken.source(),this._audioVolumeIndicationInterval=void 0,this._networkQualityInterval=void 0,this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0,this._injectStreamingClient=void 0,this._liveTranscodeStreamingClient=void 0,this._liveRawStreamingClient=void 0,this._channelMediaRelayClient=void 0,this._networkQualitySensitivity="normal",this._p2pChannel=void 0,this._useLocalAccessPoint=!1,this._setLocalAPVersion=void 0,this._joinAndNotLeaveYet=!1,this._numberOfJoinCount=0,this._remoteDefaultVideoStreamType=void 0,this._inspect=void 0,this._moderation=void 0,this._license=void 0,this._pendingPublishedUsers=[],this._handleLocalTrackEnable=(e,t,i)=>{this.publish(e,!1).then(t).catch(i)},this._handleLocalTrackDisable=(e,t,i)=>{this.unpublish(e).then(t).catch(i)},this._handleUserOnline=t=>{if(h("BLOCK_LOCAL_CLIENT")&&xo(t.uid,this.channelName))return void e.debug("[".concat(t.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof t.uid&&e.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const i=this._users.find((e=>e.uid===t.uid));if(i)i._trust_in_room_=!0;else{const i=new MC(t.uid,t.uint_id||t.uid);this._users.push(i),e.debug("[".concat(this._clientId,"] user online"),t.uid),this.safeEmit(he.USER_JOINED,i)}},this._handleUserOffline=t=>{if(h("BLOCK_LOCAL_CLIENT")&&xo(t.uid,this.channelName))return;const i=this._users.find((e=>e.uid===t.uid));i&&(this._handleRemoveStream(t),this._handleRemoveDataChannels(t),ue(this._users,i),this._remoteStreamTypeCacheMap.delete(i.uid),this._streamFallbackTypeCacheMap.delete(i.uid),e.debug("[".concat(this._clientId,"] user offline"),t.uid,"reason:",t.reason),this.safeEmit(he.USER_LEAVED,i,t.reason))},this._handleAddAudioOrVideoStream=(t,i,o,r,a,c,d)=>{if(h("BLOCK_LOCAL_CLIENT")&&xo(i,this.channelName))return;const l=this._users.find((e=>e.uid===i));if(!l)return void e.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));e.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(t)),this.store.subscribe(l.uid,t,void 0,void 0,void 0,Date.now());const u="audio"===t?l.hasAudio:l.hasVideo;l._uintid||(l._uintid=a||i),"audio"===t?l._trust_audio_stream_added_state_=!0:l._trust_video_stream_added_state_=!0,"audio"===t?(l._audio_added_=!0,void 0!==o&&(l._audioSSRC=o),void 0!==r&&(l._cname=r),c&&(l._audioOrtc=c)):(l._video_added_=!0,void 0!==o&&(l._videoSSRC=o),void 0!==r&&(l._cname=r),void 0!==d&&(l._rtxSsrcId=d),c&&(l._videoOrtc=c)),("audio"===t?l.hasAudio:l.hasVideo)&&!u&&(e.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published ").concat(t)),this.safeEmit(he.USER_PUBLISHED,l,t)),"video"===t?xS.onGatewayStream(this._sessionId,n.ON_ADD_VIDEO_STREAM,s.ON_ADD_VIDEO_STREAM,{peer:a||i}):xS.onGatewayStream(this._sessionId,n.ON_ADD_AUDIO_STREAM,s.ON_ADD_AUDIO_STREAM,{peer:a||i}),this._p2pChannel.remoteMediaSsrcChanged(l,t,o).then((i=>{if(i)return e.debug("[".concat(this._clientId,"] resubscribe ").concat(t," for user ").concat(l.uid," after rejoin because SSRC id changed.")),this._p2pChannel.unsubscribe(l,t,!0).then((()=>this._subscribe(l,t,!0).catch((t=>{e.error("[".concat(this._clientId,"] resubscribe error"),t.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(l,t)&&(e.debug("[".concat(this._clientId,"] resubscribe ").concat(t," for user ").concat(l.uid," after reconnect.")),this._subscribe(l,t,!0).catch((t=>{e.error("[".concat(this._clientId,"] resubscribe error"),t.toString())})))},this._handleRemoveStream=t=>{if(h("BLOCK_LOCAL_CLIENT")&&xo(t.uid,this.channelName))return;const i=this._users.find((e=>e.uid===t.uid));if(!i)return void e.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));e.debug("[".concat(this._clientId,"] stream removed with uid ").concat(t.uid));let o=()=>{};i.hasAudio&&i.hasVideo?o=()=>{e.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(he.USER_UNPUBLISHED,i,"audio"),e.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(he.USER_UNPUBLISHED,i,"video")}:i.hasVideo?o=()=>{e.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(he.USER_UNPUBLISHED,i,"video")}:i.hasAudio&&(o=()=>{e.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(he.USER_UNPUBLISHED,i,"audio")}),i._trust_audio_stream_added_state_=!0,i._trust_video_stream_added_state_=!0,i._audio_added_=!1,i._video_added_=!1,this._p2pChannel.unsubscribe(i).then((e=>{if(e)return this._gateway.unsubscribe(e,i.uid)})),i._audioSSRC=void 0,i._videoSSRC=void 0,i._audioOrtc=void 0,i._videoOrtc=void 0,i._rtxSsrcId=void 0,xS.onGatewayStream(this._sessionId,n.ON_REMOVE_STREAM,s.ON_REMOVE_STREAM,{peer:t.uint_id||t.uid}),o()},this._handleSetStreamLocalEnable=(t,i,n)=>{if(h("BLOCK_LOCAL_CLIENT")&&xo(i,this.channelName))return;const s=this._users.find((e=>e.uid===i));if(!s)return void e.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));e.debug("[".concat(this._clientId,"] local ").concat(t," ").concat(n?"enabled":"disabled"," with uid ").concat(i));const o="audio"===t?s.hasAudio:s.hasVideo;if("audio"===t){s._trust_audio_enabled_state_=!0;const t=s._audio_enabled_;if(s._audio_enabled_=n,s._audio_enabled_===t)return;{const t=s._audio_enabled_?"enable-local-audio":"disable-local-audio";e.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(i,", msg: ").concat(t)),this.safeEmit(he.USER_INFO_UPDATED,i,t)}}else{s._trust_video_enabled_state_=!0;const t=s._video_enabled_;if(s._video_enabled_=n,s._video_enabled_===t)return;{const t=s._video_enabled_?"enable-local-video":"disable-local-video";e.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(t)),this.safeEmit(he.USER_INFO_UPDATED,i,t)}}const r="audio"===t?s.hasAudio:s.hasVideo;return o!==r?!o&&r?(e.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(t)),void this.safeEmit(he.USER_PUBLISHED,s,t)):("video"===t&&s._videoTrack&&s._videoTrack._destroy(),"audio"===t&&s._audioTrack,this._p2pChannel.muteRemote(s,t),e.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(t)),void this.safeEmit(he.USER_UNPUBLISHED,s,t)):void 0},this._handleMuteStream=(t,i,n)=>{if(h("BLOCK_LOCAL_CLIENT")&&xo(t,this.channelName))return;e.debug("[".concat(this._clientId,"] receive mute message"),t,i,n);const s=this._users.find((e=>e.uid===t));if(!s)return void e.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(t));const o="audio"===i?s.hasAudio:s.hasVideo;if("audio"===i){s._trust_audio_mute_state_=!0;const i=s._audio_muted_;if(s._audio_muted_=n,s._audio_muted_===i)return;{const i=s._audio_muted_?"mute-audio":"unmute-audio";e.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(i)),this.safeEmit(he.USER_INFO_UPDATED,t,i)}}else{s._trust_video_mute_state_=!0;const i=s._video_muted_;if(s._video_muted_=n,s._video_muted_===i)return;{const i=s._video_muted_?"mute-video":"unmute-video";e.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(i)),this.safeEmit(he.USER_INFO_UPDATED,t,i)}}const r="audio"===i?s.hasAudio:s.hasVideo;if(o!==r){if(!o&&r){return("audio"===i?s._audioSSRC:s._videoSSRC)?(e.info("[".concat(this._clientId,"] remote user ").concat(t," published ").concat(i)),void this.safeEmit(he.USER_PUBLISHED,s,i)):void e.warning("[".concat(this._clientId,"] remote user ").concat(t," receive ").concat(i," unmute message  before add stream message, ").concat(i," SSRC doesn't exist yet."))}"video"===i&&s._videoTrack&&s._videoTrack._destroy(),"audio"===i&&s._audioTrack,this._p2pChannel.muteRemote(s,i),e.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished ").concat(i)),this.safeEmit(he.USER_UNPUBLISHED,s,i)}},this._handleP2PLost=async t=>{e.debug("[".concat(this._clientId,"] receive p2p lost"),t),parseInt(t.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():e.warning("[".concat(this._clientId,"] P2PLost stream not found"),t)},this._handleTokenWillExpire=()=>{e.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(he.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)},this._handleBeforeUnload=t=>{"beforeunload"===t.type&&void 0!==t.returnValue&&""!==t.returnValue||(this.leave(),e.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))},this._handleUpdateNetworkQuality=()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(he.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const e={downlinkNetworkQuality:0,uplinkNetworkQuality:0};e.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),e.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(he.NETWORK_QUALITY,e)},this._config=t,this._clientId=k(5,"client-"),this.store=new pe(t.codec,t.audioCodec,t.mode,this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),e.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(B," build: ").concat(_e,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{Ee(t.clientRoleOptions),i=Object.assign({},t.clientRoleOptions)}catch(t){e.warning("[".concat(this._clientId,"] ").concat(t.toString()))}this._statsCollector=new kT(this.store),this._statsCollector.onStatsException=(t,i,n)=>{e.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(t,", msg: ").concat(i,", uid: ").concat(n)),this.safeEmit(he.EXCEPTION,{code:t,msg:i,uid:n})},this._statsCollector.onUploadPublishDuration=(e,t,i,n)=>{const s=this._users.find((t=>t.uid===e));s&&xS.peerPublishStatus(this._sessionId,{subscribeElapse:n,audioPublishDuration:t,videoPublishDuration:i,peer:s._uintid})},this.store.useDataChannel=Ve().supportDataChannel&&h("SIGNAL_CHANNEL"),this._gateway=new tR(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||J,httpRetryConfig:t.httpRetryConfig||J,forceWaitGatewayResponse:void 0===t.forceWaitGatewayResponse||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:i}),this._configDistribute=new vC,this._p2pChannel=new yv(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async join(t,i,n,s,o){const r=++this._numberOfJoinCount;this.store.joinStart(),s&&(this.store.uid=s);const a=me(),c=fe()?window.isSecureContext:"Browser Not Support";if(!fe()&&!a||!window.isSecureContext){const t="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";e.warning(t)}const d=z();"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),e.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const u=xS.reportApiInvoke(d,{name:K.JOIN,options:[t,i,n,s],states:{isHttps:a,isSecureContext:c},tag:l.TRACER});xS.setAppId(t);try{if(!n&&null!==n)throw new Ig(T.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&m(n,"token",1,2047),m(t,"appid",1,2047),R(i),s&&S(s),o&&m(o,"optionalInfo",1,2047)}catch(e){throw u.onError(e),e}if(e.info("[".concat(this._clientId,"] start join channel ").concat(i,", join number: ").concat(r)),this._leaveMutex.isLocked){e.debug("[".concat(this._clientId,"] join: waiting leave operation"));(await this._leaveMutex.lock())(),e.debug("[".concat(this._clientId,"] join: continue"))}if(this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const e=new Ig(T.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw u.onError(e),e}this._sessionId||(this._sessionId=d,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const p=xy({clientId:this._clientId,appId:t,sid:this._sessionId,cname:i,uid:"string"!=typeof s?s:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:o,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(p.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof s&&(p.stringUid=s,this._uintUid?(p.uid=this._uintUid,this._uintUid=void 0):p.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(p.aesmode=this._encryptionMode,p.aespassword=await Se(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new Ig(T.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(p.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:i,appId:t});const _=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&_===this._sessionId&&xS.joinChannelTimeout(this._sessionId,5)}),5e3);try{var E;let s;const o=p.cloudProxyServer;if(Po(E=["proxy3","proxy4","proxy5"]).call(E,o)){const e=h("PROXY_SERVER_TYPE3");Array.isArray(e)?p.proxyServer=e[0]:p.proxyServer=e}if(xS.setProxyServer(p.proxyServer),e.setProxyServer(p.proxyServer),this.store.requestAPStart(),p.stringUid&&!p.uid){const t=await mC(p.stringUid,p,this._axiosCancelSource.token,this._config.httpRetryConfig||J,this.store);e.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(p.stringUid," => ").concat(t)),p.uid=t,s=await EC(p,this._axiosCancelSource.token,this._config.httpRetryConfig||J,!0,this.store)}else s=await EC(p,this._axiosCancelSource.token,this._config.httpRetryConfig||J,!0,this.store);if(!this._joinAndNotLeaveYet)throw new Ig(T.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(p,this._axiosCancelSource.token),this._configDistribute.on(Ng.UPDATE_BITRATE_LIMIT,(e=>{this._p2pChannel.updateBitrateLimit(e)}))}),0),this._key=n||t;const r=s.gatewayInfo;this._joinInfo=xy(xy({},p),{},{cid:r.cid,uid:p.uid?p.uid:r.uid,vid:r.vid,apResponse:r.res,uni_lbs_ip:r.uni_lbs_ip,gatewayAddrs:r.gatewayAddrs});const a=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new Ig(T.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));u.onSuccess(a),this._appId=t,this._channelName=p.cname,this._uid=a,this.store.uid=a,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(te()?"beforeunload":"pagehide",this._handleBeforeUnload)}),0);const c=p.stringUid?"string uid: ".concat(p.stringUid,",uid: ").concat(p.uid):"uid: ".concat(this._uid);return e.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(i,",").concat(c)),setTimeout((()=>{e.startUpload()}),5e3),this.store.joinEnd(),f=this,Po(Uo).call(Uo,f)||Uo.push(f),a}catch(t){const i=Array.isArray(t)?t[0]:t;throw i&&i.code===T.OPERATION_ABORTED?e.warning("[".concat(this._clientId,"] join number: ").concat(r,", Joining channel failed, rollback"),i):e.error("[".concat(this._clientId,"] join number: ").concat(r,", Joining channel failed, rollback"),i),i.code!==T.OPERATION_ABORTED&&this._numberOfJoinCount===r&&(this._gateway.state="DISCONNECTED",this._reset()),u.onError(i),i}var f}_joinGateway(){if(!this._joinInfo||!this._key)throw new Ig(T.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!h("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((e=>e)).catch((e=>{if(e.code===T.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,P.FALLBACK),e;if(e.code===T.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,P.FALLBACK),e;throw e})).then((t=>{if(t instanceof Ig){if(t.code===T.INIT_WEBSOCKET_TIMEOUT){if(e.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new Ig(T.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const t=h("PROXY_SERVER_TYPE3");if(Array.isArray(t))if(this._joinInfo.apUrl){const e=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),i=e.slice(e.length-2).join(".");t.forEach((e=>{this._joinInfo&&Po(e).call(e,i)&&(this._joinInfo.proxyServer=e)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=t[0])}else this._joinInfo.proxyServer=t[0];else this._joinInfo.proxyServer=t;const i=h("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);i&&i[1]&&"443"!==i[1]&&e.setProxyServer(this._joinInfo.proxyServer),"443"!==h("STATS_COLLECTOR_PORT").toString()&&xS.setProxyServer(this._joinInfo.proxyServer);return xS.reportApiInvoke(this._sessionId,{name:K.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:l.TRACER}).onSuccess(),this.safeEmit(he.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),h("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((e=>{"forceturn"in e&&(e.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if(e.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new Ig(T.INVALID_OPERATION);return xS.reportApiInvoke(this._sessionId,{name:K.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:l.TRACER}).onSuccess(),this._joinGateway()}return t})).then((e=>e))}async leave(){e.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(te()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const t=Uo.indexOf(e);-1!==t&&Uo.splice(t,1)}(this);const t=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return e.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave("CONNECTED"!==this.connectionState),e.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(t)){if(!(t instanceof Fe))return this._publishDataChannel(t);t=[t]}if(0===t.length)throw new Ig(T.INVALID_PARAMS,"param list is empty");const n=t;if("audience"===this._gateway.role)throw new Ig(T.INVALID_OPERATION,"audience can not publish stream");for(const e of n){if(!(e instanceof Fe))throw new Ig(T.INVALID_PARAMS,"parameter is not local track");if(!e._enabled&&i)throw new Ig(T.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(e.getTrackId()))}e.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))));const s=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),i&&n.forEach((e=>{const t=this._configDistribute.getBitrateLimit();e instanceof Ue&&t&&e.setBitrateLimit(t.uplink)}));try{await this._publishHighStream(n),e.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))))}catch(t){throw e.error("[".concat(this._clientId,"] publish error"),t.toString()),t}finally{s()}}async _publishDataChannel(t){p(t.id,"id",0,65535,!0),_(t.ordered,"ordered"),m(t.metadata,"metadata",0,512),e.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));const i=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((e=>e.id===t.id)))throw new Ig(T.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new Ig(T.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&h("FORCE_TURN")&&!h("TURN_ENABLE_TCP")&&!h("TURN_ENABLE_UDP"))throw new Ig(T.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const i=new Xe(t);await this._p2pChannel.publishDataChannel([i]);try{const e={streamId:t.id,ordered:t.ordered,maxRetransmits:h("DATASTREAM_MAX_RETRANSMITS"),metadata:t.metadata,channelId:i._originDataChannelId};await this._gateway.publishDataChannel(this._uid,e,!0)}catch(e){if(e.code!==T.DISCONNECT_P2P)throw e}return await i._waitTillOpen(),e.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(i.id)),i}catch(t){throw e.error("[".concat(this._clientId,"] publish datachannels error"),t.toString()),t}finally{i()}}async unpublish(t){if(!this._joinInfo||void 0===this._uid)throw new Ig(T.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let i=[];if(t)if(Array.isArray(t))i=t;else{if(!(t instanceof Fe))return this._unpublishDataChannel([t]);i=[t]}else await this._unpublishDataChannel(),i=this._p2pChannel.getAllTracks(!0);e.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(i.map((e=>"".concat(e.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{const t=await this._p2pChannel.unpublish(i);t&&await this._gateway.unpublish(t,this._uid),e.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(i.map((e=>"".concat(e.getTrackId())))))}catch(t){throw e.error("[".concat(this._clientId,"] unpublish error"),t.toString()),t}finally{n&&n()}}async _unpublishDataChannel(t){void 0!==t&&0!==t.length||(t=this._p2pChannel.getAllDataChannels()),e.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map((e=>"".concat(e.id," ")))," "));const i=await this._publishMutex.lock();try{const i=await this._p2pChannel.unpublishDataChannel(t);i&&await this._gateway.unpublishDataChannel(i),e.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map((e=>"".concat(e.id)))))}catch(t){throw e.error("[".concat(this._clientId,"] unpublish dataChannel error"),t.toString()),t}finally{i&&i()}}async subscribe(e,t,i){return"datachannel"===t?this._subscribeDataChannel(e,i):this._subscribe(e,t)}async _subscribeDataChannel(t,i){var n;if(p(i,"channelId",0,65535,!0),!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((e=>e===t)))throw e.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new Ig(T.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&0===t._dataChannels.length)throw e.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new Ig(T.INVALID_REMOTE_USER,"user is not published");const s=null===(n=t._dataChannels)||void 0===n?void 0:n.find((e=>e.id===i));if(!s)throw e.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new Ig(T.REMOTE_USER_IS_NOT_PUBLISHED);const o=await this._subscribeMutex.lock();e.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const i=await this._p2pChannel.subscribeDataChannel(t,[s]);if(i&&Po(i).call(i,s.id))try{var r;if(!s._originDataChannelId)throw e.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new Ig(T.REMOTE_USER_IS_NOT_PUBLISHED);const i={id:s.id,datachannelId:s._originDataChannelId,ordered:s.ordered,maxRetransmits:s.maxRetransmits,metadata:null!==(r=s.metadata)&&void 0!==r?r:""};await this._gateway.subscribeDataChannel(t.uid,i,!0)}catch(e){if((null==e?void 0:e.code)!==T.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[s]),e;await this._p2pChannel.unsubscribeDataChannel(t,[s]),this._p2pChannel.setPendingRemoteDataChannel(t,s.id)}return await s._waitTillOpen(),e.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),s}finally{o()}}async _subscribe(t,i,n){if(E(i,"mediaType",["audio","video"]),!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((e=>e===t))){const i=new Ig(T.INVALID_REMOTE_USER,"user is not in the channel");throw e.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),i}if(!t.hasAudio&&!t.hasVideo){const i=new Ig(T.INVALID_REMOTE_USER,"user is not published");throw e.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),i}if(!(n||("audio"!==i||t.hasAudio&&void 0!==t._audioSSRC)&&("video"!==i||t.hasVideo&&void 0!==t._videoSSRC))){const n=new Ig(T.REMOTE_USER_IS_NOT_PUBLISHED);throw e.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(i,", remote track is not published")),n}const s="audio"===i?t._audioSSRC:t._videoSSRC,o="audio"===i?t._audioOrtc:t._videoOrtc,r="video"===i?t._rtxSsrcId:void 0,a={stream_type:"audio"===i?bg.AUDIO:bg.VIDEO,ssrcId:s},c=await this._subscribeMutex.lock();e.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,i))await this._p2pChannel.unmuteRemote(t,i);else try{DT.markSubscribeStart(this.store.clientId,s),this.store.subscribe(t.uid,i,Date.now()),await this._p2pChannel.subscribe(t,i,s,r,o);try{await this._gateway.subscribe(t.uid,a,!0)}catch(e){if((null==e?void 0:e.code)!==T.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,i),e;await this._p2pChannel.unsubscribe(t,i,!0),this._p2pChannel.setPendingRemoteMedia(t,i)}this.store.subscribe(t.uid,i,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,i)}catch(e){throw this._p2pChannel.reportSubscribeEvent(!1,null==e?void 0:e.code,t,i),e}e.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch((t=>{e.warning("[".concat(this._clientId,"] auto set fallback failed"),t)}));const n="audio"===i?t._audioTrack:t._videoTrack;if(!n)throw new Ig(T.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(i){throw e.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),i),i}finally{c()}}async massSubscribe(t){if(f(t,"subscribeList"),!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const i=Date.now(),n=new Map,s=await this._subscribeMutex.lock();e.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; ")));const o=(t=[...t]).map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i}})),r=await this._p2pChannel.globalLock();try{var a;for(let i=t.length-1;i>=0;i--){const s=t[i],{user:r,mediaType:a}=s;if(E(a,"mediaType",["audio","video"]),!r){const t=new Ig(T.INVALID_PARAMS,"user property does not exist in subscribeList item");throw e.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),t}if(!this._users.find((e=>e===r))){const n=new Ig(T.INVALID_REMOTE_USER,"user is not in the channel");e.error("[".concat(this._clientId,"] can not massSubscribe ").concat(r.uid,", this user is not in the channel")),o[i].error=n,t.splice(i,1);continue}if("audio"===a&&(!r.hasAudio||void 0===r._audioSSRC)||"video"===a&&(!r.hasVideo||void 0===r._videoSSRC)){const n=new Ig(T.REMOTE_USER_IS_NOT_PUBLISHED);e.error("[".concat(this._clientId,"] can not subscribe ").concat(r.uid," with mediaType ").concat(a,", remote user is not published")),o[i].error=n,t.splice(i,1);continue}const c=Tg.Video|Tg.LwoVideo,d=n.get(r);if(d){if("video"===a?d&c:d&Tg.Audio){t.splice(i,1),e.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(r.uid,", mediaType:").concat(a," twice"));continue}n.set(r,d|("video"===a?c:Tg.Audio))}else n.set(r,"video"===a?c:Tg.Audio)}for(let e=t.length-1;e>=0;e--){const i=t[e],{user:s,mediaType:o}=i,r=Tg.Video|Tg.LwoVideo;if(this._p2pChannel.hasRemoteMedia(s,o)){await this._p2pChannel.unmuteRemoteNoLock(s,o);const i=n.get(s);n.set(s,"video"===o?i^r:i^Tg.Audio),t.splice(e,1)}}this.store.massSubscribe(t.map((e=>({userId:e.user.uid,type:e.mediaType}))),i);const s=Ip(a=Array.from(n.entries())).call(a,((e,t)=>{let[i,n]=t;if(0===n)return e;const s={stream_id:i.uid,stream_type:n};return n&Tg.Audio&&(s.audio_ssrc=i._audioSSRC),n&Tg.Video&&(s.video_ssrc=i._videoSSRC),e.push(s),e}),[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i,ssrcId:i===bg.VIDEO?t._videoSSRC:t._audioSSRC,rtxSsrcId:i===bg.VIDEO?t._rtxSsrcId:void 0}})));const n=new Map;if(s.length>0){const e=await this._gateway.subscribeAll(s,!0);((null==e?void 0:e.users)||[]).forEach((e=>{let{stream_id:t,video_error_code:i,audio_error_code:s,error_code:o}=e;(i||s||o)&&n.set(t,{video_error_code:i,audio_error_code:s,error_code:o})}))}if(Array.from(n.entries()).length>0){const e=Array.from(n.entries()).map((e=>{let t,[i,n]=e;n.error_code||n.video_error_code&&n.audio_error_code?t=void 0:n.video_error_code?t=bg.VIDEO:n.audio_error_code&&(t=bg.AUDIO);return{user:this.remoteUsers.find((e=>e.uid===i)),mediaType:t}}));await this._p2pChannel.massUnsubscribeNoLock(e)}for(const t of o){const i=n.get(t.user.uid);if(i){const n=i.error_code||"audio"===t.mediaType&&i.audio_error_code||"video"===t.mediaType&&i.video_error_code;if(n){const i=zg(n);e.error("user:".concat(t.user.uid," mediaType:").concat(t.mediaType," has massSubscribe error ").concat(i.desc)),t.error=new Ig(T.SUBSCRIBE_FAILED,"code ".concat(n,": ").concat(i.desc))}}t.error||("video"===t.mediaType?t.track=t.user.videoTrack:t.track=t.user.audioTrack)}return this.store.massSubscribe(o.filter((e=>!e.error)).map((e=>({userId:e.user.uid,type:e.mediaType}))),void 0,Date.now()),o.forEach((e=>{var t;xS.subscribe(this.store.sessionId,{succ:!!e.error,ec:(null===(t=e.error)||void 0===t?void 0:t.code)||null,video:e.mediaType===bg.VIDEO,audio:e.mediaType===bg.AUDIO,peerid:e.user.uid,subscribeRequestid:e.mediaType===bg.VIDEO?e.user._videoSSRC:e.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-i)},!0)})),e.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; "))),o}catch(e){throw await this._p2pChannel.massUnsubscribeNoLock(t),e}}finally{r(),s()}}async unsubscribe(t,i,n){if(i){if("datachannel"===i)return this._unsubscribeDataChannel(t,n)}else await this._unsubscribeDataChannel(t,n);if(i&&E(i,"mediaType",["audio","video"]),!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((e=>e===t))){const i=new Ig(T.INVALID_REMOTE_USER,"user is not in the channel");throw e.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),i}e.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(i));const s=await this._subscribeMutex.lock();try{const n=await this._p2pChannel.unsubscribe(t,i);n&&await this._gateway.unsubscribe(n,t.uid),e.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(i))}catch(i){if(i.code===T.DISCONNECT_P2P)return void e.warning("disconnecting p2p, abort unsubscribe request.");throw e.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),i.toString()),i}finally{s()}}async _unsubscribeDataChannel(t,i){if(i&&p(i,"id",0,65535,!0),!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((e=>e===t))){const i=new Ig(T.INVALID_REMOTE_USER,"user is not in the channel");throw e.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),i}let n;if(i){const e=t._dataChannels.find((e=>e.id===i));e&&(n=[e])}else n=t._dataChannels;if(void 0===n){const n=new Ig(T.REMOTE_USER_IS_NOT_PUBLISHED);throw e.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(i,", remote datachannel is not published")),n}e.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(n.map((e=>e.id))));try{const i=await this._p2pChannel.unsubscribeDataChannel(t,n);i&&await this._gateway.unsubscribeDataChannel(i,t.uid),e.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(i))}catch(i){if(i.code===T.DISCONNECT_P2P)return void e.warning("disconnecting p2p, abort unsubscribe request.");throw e.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),i.toString()),i}}async massUnsubscribe(t){if(f(t,"unsubscribeList"),!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");e.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join())),t=[...t];const i=new Map;for(let n=t.length-1;n>=0;n--){const{user:s,mediaType:o}=t[n];if(!s){const t=new Ig(T.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw e.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),t}E(o,"mediaType",["video","audio",void 0]);if(!this._users.find((e=>e===s))){e.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(s.uid,", user is not in the channel")),t.splice(n,1);continue}const r=Tg.Video|Tg.LwoVideo;if(i.has(s)){const a=i.get(s);let c;switch(o){case"video":c=a&r;break;case"audio":c=a&Tg.Audio;break;default:c=a&(Tg.Audio|r)}if(c){e.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(s.uid,",mediaType:").concat(o," twice.")),t.splice(n,1);continue}o?"audio"===o?i.set(s,a|Tg.Audio):"video"===o&&i.set(s,a|r):i.set(s,a|Tg.Audio|r)}else o?"audio"===o?i.set(s,Tg.Audio):"video"===o&&i.set(s,r):i.set(s,Tg.Audio|r)}try{const i=await this._p2pChannel.massUnsubscribe(t);i&&await this._gateway.massUnsubscribe(i),e.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join()))}catch(t){if(t.code===T.DISCONNECT_P2P)return void e.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw e.error("[".concat(this._clientId,"] massUnsubscribe error"),t.toString()),t}}async setLowStreamParameter(t){ze(t),(!t.width&&t.height||t.width&&!t.height)&&e.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),e.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const i=this._configDistribute.getLowStreamConfigDistribute();if(i&&i.bitrate&&t.bitrate&&i.bitrate<t.bitrate&&(t.bitrate=i.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,Lg.LocalVideoLowTrack)}async enableDualStream(){if(!Ve().supportDualStream)throw xS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new Ig(T.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new Ig(T.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw xS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,xS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),e.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(Lg.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw xS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,xS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),e.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,i){if(ge(t),i&&Ee(i),"rtc"===this.mode)throw e.warning("[".concat(this._clientId,"]rtc mode can not use setClientRole")),new Ig(T.INVALID_OPERATION,"rtc mode can not use setClientRole");if(i&&i.level&&"host"===t)throw new Ig(T.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===t&&this._p2pChannel.hasLocalMedia())throw new Ig(T.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,i),this._config.role=t,e.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(i&&i.level))}setProxyServer(t,i){if(m(t,"proxyServer"),!i){if("DISCONNECTED"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Ig(T.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,xS.setProxyServer(this._proxyServer),e.setProxyServer(this._proxyServer),e.info("[".concat(this._clientId,"] Set proxy server ").concat(i?"by initialize call":""," success."))}setTurnServer(t,i){if(Array.isArray(t)||(t=[t]),!i){if("DISCONNECTED"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Ig(T.INVALID_OPERATION,"You have already set the proxy")}if(ne(t))return this._turnServer={servers:t,mode:"original-manual"},void e.info("[".concat(this._clientId,"] Set original turnserver ").concat(i?"by initialize call":""," success: ").concat(t.map((e=>e.urls)).join(","),"."));t.forEach((e=>Te(e))),this._turnServer={servers:t,mode:"manual"},e.info("[".concat(this._clientId,"] Set turnserver ").concat(i?"by initialize call":""," success."))}setLicense(t){if("DISCONNECTED"!==this.connectionState){throw new Ig(T.INVALID_OPERATION,"you should set license before join channel")}if(m(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new Ig(T.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,e.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if("DISCONNECTED"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new Ig(T.INVALID_OPERATION,"You have already set the proxy");const i=[3,4,5];let n;switch(void 0===t&&(t=3),t){case 1:case 2:throw new Ig(T.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new Ig(T.INVALID_PARAMS,"proxy server mode must be ".concat(i.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,e.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"Stop proxy server after leave channel");xS.setProxyServer(),e.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",e.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new Ig(T.INVALID_PARAMS,"accessPoints is required.");f(t.accessPoints.serverList,"accessPoints.serverList"),m(t.accessPoints.domain,"accessPoints.domain");const i=(e,t)=>{p(e,t,0,65535,!0)};let n=443;if(t.accessPoints.port&&(i(t.accessPoints.port,"accessPoints.port"),n=t.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Ig(T.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");h("CLOSE_AFB_FOR_LOCAL_AP")&&(G("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),G("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const s=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,o=t.accessPoints.domain,r=t.accessPoints.serverList.map((e=>s.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(o):e)),a=r.map((e=>"".concat(e,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,G("WEBCS_DOMAIN",a),G("WEBCS_DOMAIN_BACKUP_LIST",a),G("GATEWAY_DOMAINS",[o]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(f(t.report.hostname,"report.hostname"),G("EVENT_REPORT_DOMAIN",t.report.hostname[0]),G("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(G("EVENT_REPORT_DOMAIN",r[0]),G("EVENT_REPORT_BACKUP_DOMAIN",r[1]||r[0]));let c=6443;t.report&&t.report.port&&(i(t.report.port,"report.port"),c=t.report.port),G("STATS_COLLECTOR_PORT",c),t.report?G("ENABLE_EVENT_REPORT",!0):G("ENABLE_EVENT_REPORT",!1);let d="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(f(t.log.hostname,"log.hostname"),d=t.log.hostname[0]):d=r[0];let l=6444;t.log&&t.log.port&&(i(t.log.port,"log.port"),l=t.log.port),G("LOG_UPLOAD_SERVER","".concat(d,":").concat(l));let u=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(f(t.cds.hostname,"cds.hostname"),u=t.cds.hostname):u=r;let _=443;t.cds&&t.cds.port&&(i(t.cds.port,"cds.port"),_=t.cds.port),G("CDS_AP",u.map((e=>"".concat(e,":").concat(_)))),t.cds?G("ENABLE_CONFIG_DISTRIBUTE",!0):G("ENABLE_CONFIG_DISTRIBUTE",!1),e.info("set local access point v2 success")}setLocalAccessPoints(t,i){if(f(t,"serverList"),m(i,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Ig(T.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map((e=>n.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(i):e)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,G("WEBCS_DOMAIN",t),G("WEBCS_DOMAIN_BACKUP_LIST",t),G("GATEWAY_DOMAINS",[i]),G("EVENT_REPORT_DOMAIN",t[0]),G("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),G("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),e.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(E(t,"streamType",[0,1]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw e.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else e.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,i){E(i,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(t,i),setTimeout((()=>{const e=this._users.find((e=>e.uid===t));e&&e.videoTrack&&e.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(t){throw e.error("[".concat(this._clientId,"] set remote video stream type error"),t.toString()),t}e.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(i)),this._remoteStreamTypeCacheMap.set(t,i)}async setStreamFallbackOption(t,i){E(i,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(t,i)}catch(t){throw e.error("[".concat(this._clientId,"] set stream fallback option"),t.toString()),t}e.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(i)),this._streamFallbackTypeCacheMap.set(t,i)}setEncryptionConfig(t,i,n){Re(t),m(i,"secret");const s=["aes-128-gcm2","aes-256-gcm2"];if(Po(s).call(s,t)){if(!n||!(n instanceof Uint8Array&&32===n.length))throw new Ig(T.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new Ig(T.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(i)||e.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=t,this._encryptionSecret=i,n&&(this._encryptionSalt=Ce(n))}async renewToken(t){if(m(t,"token",1,2047),!this._key||!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"renewToken should not be called before user join");const i=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const n=await this._renewTokenMutex.lock();try{if(h("USE_NEW_TOKEN")){e.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await RC(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||J);e.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:i})}else e.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});e.debug("[".concat(this._clientId,"] renewToken success"))}catch(t){throw this._key=i,this._joinInfo.token=i,e.error("[".concat(this._clientId,"] renewToken failed"),t.toString()),t}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?e.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(he.VOLUME_INDICATOR,e)}),h("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if("h264"!==this.codec)throw new Ig(T.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new Ig(T.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new Ig(T.LIVE_STREAMING_TASK_CONFLICT);const i=t?ng.TRANSCODE:ng.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(e,i)}setLiveTranscoding(e){return this._createLiveStreamingClient(ng.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((t=>t&&t.hasUrl(e)));if(!t.length)throw new Ig(T.INVALID_PARAMS,"can not find live streaming url to stop");await yS.all(t.map((t=>t&&t.stopLiveStreamingTask(e))))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(ng.INJECT);i.setInjectStreamConfig(t,0),await i.startLiveStreamingTask(e,ng.INJECT)}async removeInjectStreamUrl(){var e;const t=this._createLiveStreamingClient(ng.INJECT),i=Array.from(LS(e=t.streamingTasks).call(e)).find((e=>e.mode===ng.INJECT));if(!this._joinInfo||!i)throw new Ig(T.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await t.stopLiveStreamingTask(i.url)}async startChannelMediaRelay(e){PC(e);const t=this._createChannelMediaRelayClient();await t.startChannelMediaRelay(e)}async updateChannelMediaRelay(e){PC(e);const t=this._createChannelMediaRelayClient();await t.updateChannelMediaRelay(e)}async stopChannelMediaRelay(){const e=this._createChannelMediaRelayClient();await e.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"can not send data stream, not joined");if("string"==typeof e){e=(new TextEncoder).encode(e)}if(new Blob([e]).size>1024)throw new Ig(T.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(YS.DATA_STREAM,{payload:Ce(e)},!t)}sendMetadata(e){if(!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new Ig(T.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(YS.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Ce(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(o),!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"can not send custom report, not joined");await xS.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,i){E(i.spatialLayer,"spatialLayer",[0,1,2,3]),E(i.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,i)}catch(t){throw e.error("[".concat(this._clientId,"] pick SVC layer failed"),t.toString()),t}}setRTM2Flag(e){if(E(e,"flag",[0,1]),!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"Can't setRtm2Flag, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"Can't setRtm2Flag in ".concat(this.connectionState," state"));return this._gateway.setRTM2Flag(e)}_reset(){if(e.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=st.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((e=>e._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new v("client-publish"),this._subscribeMutex=new v("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(e){}if(this._moderation)try{this.setImageModeration(!1)}catch(e){}}_startSession(t,i){const n=t||z();t?e.debug("[".concat(this._clientId,"] new Session ").concat(n)):e.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(n)),this._sessionId=n,this.store.sessionId=n,i?xS.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:i.channel,appid:i.appId,mode:this.mode}):this._joinInfo?xS.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._joinInfo.cname,appid:this._joinInfo.appId,mode:this.mode}):this._gateway.joinInfo&&xS.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId,mode:this.mode}),this._joinInfo&&(this._joinInfo.sid=n),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=n)}async _publishHighStream(t){if(!this._joinInfo||void 0===this._uid)throw new Ig(T.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&h("FORCE_TURN")&&!h("TURN_ENABLE_TCP")&&!h("TURN_ENABLE_UDP"))throw new Ig(T.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");e.debug("[".concat(this._clientId,"] publish high stream"));try{const e=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter),n=(await e.next()).value;if(n){var i;let t;try{t=await this._gateway.publish(this._uid,n,!0)}catch(t){if(t.code!==T.DISCONNECT_P2P)throw e.throw(t),t}await e.next((null===(i=t)||void 0===i?void 0:i.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const e of t)e instanceof Ue&&e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig),!e.muted&&e.enabled||await this._p2pChannel.muteLocalTrack(e)}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,t),(null==e?void 0:e.code)===T.WS_ABORT)return;throw e}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new Ig(T.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ig(T.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));e.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const e=await this._p2pChannel.publishLowStream(this._lowStreamParameter),t=(await e.next()).value;if(t){var i;let n;try{n=await this._gateway.publish(this._uid,t,!0)}catch(t){if(t.code!==T.DISCONNECT_P2P)throw e.throw(t),t}e.next((null===(i=n)||void 0===i?void 0:i.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,void 0,!0),(null==e?void 0:e.code)===T.WS_ABORT)return;throw e}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId){return new Ig(T.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw()}const t=()=>new bC(this._joinInfo,this._config.websocketRetryConfig||J,this._config.httpRetryConfig||J),i=e=>{e.onLiveStreamError=(e,t)=>{xS.reportApiInvoke(this._sessionId,{name:K.ON_LIVE_STREAM_ERROR,options:[e,t],tag:l.TRACER}).onSuccess(),this.safeEmit(he.LIVE_STREAMING_ERROR,e,t)},e.onLiveStreamWarning=(e,t)=>{xS.reportApiInvoke(this._sessionId,{name:K.ON_LIVE_STREAM_WARNING,options:[e,t],tag:l.TRACER}).onSuccess(),this.safeEmit(he.LIVE_STREAMING_WARNING,e,t)},e.on(hg.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new Ig(T.INVALID_OPERATION,"can not find join info to get worker manager"));gC(e,this._joinInfo,this._axiosCancelSource.token,J).then(t).catch(i)}))};switch(e){case ng.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),i(this._liveRawStreamingClient)),this._liveRawStreamingClient;case ng.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),i(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case ng.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(hg.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new Ig(T.INVALID_OPERATION,"can not find join info to get worker manager"));gC(e,this._joinInfo,this._axiosCancelSource.token,J).then(t).catch(i)})),this._injectStreamingClient.onInjectStatusChange=(e,t,i)=>{this.emit(he.INJECT_STREAM_STATUS,e,t,i)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo){return new Ig(T.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw()}if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),i={width:e,height:t};this._channelMediaRelayClient=new kC(this._joinInfo,this._clientId,this._config.websocketRetryConfig||J,this._config.httpRetryConfig||J,i),this._channelMediaRelayClient.on("state",(e=>{e===mg.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(he.CHANNEL_MEDIA_RELAY_STATE,e)})),this._channelMediaRelayClient.on("event",(e=>{this.safeEmit(he.CHANNEL_MEDIA_RELAY_EVENT,e)})),this._statsCollector.onStatsChanged=(e,t)=>{var i;"resolution"===e&&(null===(i=this._channelMediaRelayClient)||void 0===i||i.setVideoProfile(t))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(t,i){const{added:n,deleted:s}=t,o=[];Array.isArray(n)&&n.length>0&&n.forEach((t=>{const{uid:n,stream_id:s,ordered:r,max_retrans_times:a,metadata:c}=t,d=this._users.find((e=>e._uintid===n));if(!d)return void e.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));e.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(n)),Po(o).call(o,d)||o.push(d),d._uintid||(d._uintid=n);if(!(-1!==d._dataChannels.findIndex((e=>e.id===t.stream_id)))){const t={id:s,ordered:!!r,maxRetransmits:a,metadata:c},n=new Qe(t);d._dataChannels.push(n),e.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published datachannel")),i||this.emit(he.USER_PUBLISHED,d,"datachannel",t)}this._p2pChannel.hasPendingRemoteDataChannel(d,t.stream_id)&&(e.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(d.uid," after reconnect.")),this._subscribeDataChannel(d,t.stream_id).catch((t=>{e.error("[".concat(this._clientId,"] resubscribe datachannel error"),t.toString())})))})),i&&(this.emit(he.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(s)&&s.length>0&&s.forEach((t=>{const{uid:i,stream_id:n}=t,s=this._users.find((e=>e._uintid===i));if(!s)return void e.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const o=s._dataChannels.find((e=>e.id===t.stream_id));o&&(e.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(i)),this._p2pChannel.unsubscribeDataChannel(s,[o]).then((e=>{if(e)return s._dataChannels=s._dataChannels.filter((e=>e!==o)),this._gateway.unsubscribeDataChannel(e,s.uid)})),e.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished datachannel ,id:").concat(o.id)),this.emit(he.USER_UNPUBLISHED,s,"datachannel",o._config))}))}_handleRemoveDataChannels(t){const i=this._users.find((e=>e.uid===t.uid));if(i){if(void 0!==i._dataChannels&&i._dataChannels.length>0){e.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const n=()=>{e.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished datachannel")),i._dataChannels.forEach((e=>{this.emit(he.USER_UNPUBLISHED,i,"datachannel",e._config)}))};this._p2pChannel.unsubscribeDataChannel(i,i._dataChannels).then((e=>{if(e)return this._gateway.unsubscribeDataChannel(e,i.uid)})),n()}}else e.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(gg.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(gg.CONNECTION_STATE_CHANGE,((t,i,n)=>{var s;if(n===P.FALLBACK)return;const o=()=>{this.safeEmit(he.CONNECTION_STATE_CHANGE,t,i,n)};if(xS.reportApiInvoke(this._sessionId||(null===(s=this._gateway.joinInfo)||void 0===s?void 0:s.sid)||null,{name:K.CONNECTION_STATE_CHANGE,options:[t,i,n],tag:l.TRACER}).onSuccess(JSON.stringify({cur:t,prev:i,reason:n})),e.info("[".concat(this._clientId,"] connection state change: ").concat(i," -> ").concat(t)),"DISCONNECTED"===t)return this._reset(),void o();if("RECONNECTING"===t)this._users.forEach((e=>{e._trust_in_room_=!1,e._trust_audio_enabled_state_=!1,e._trust_video_enabled_state_=!1,e._trust_audio_mute_state_=!1,e._trust_video_mute_state_=!1,e._trust_audio_stream_added_state_=!1,e._trust_video_stream_added_state_=!1,e._audioSSRC=void 0,e._videoSSRC=void 0,e._videoOrtc=void 0,e._audioOrtc=void 0,e._cname=void 0,e._rtxSsrcId=void 0})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===t){var r;this._streamFallbackTypeCacheMap.forEach(((t,i)=>{this._gateway.setStreamFallbackOption(i,t).catch((t=>{e.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),t)}))})),this._remoteStreamTypeCacheMap.forEach(((t,i)=>{this._gateway.setRemoteVideoStreamType(i,t).catch((t=>{e.warning("[".concat(this._clientId,"] auto set remote stream type failed"),t)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(r=this._joinInfo)||void 0===r?void 0:r.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{e.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((t=>{e.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(t))})),this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{if("CONNECTED"!==this.connectionState)return;this._userOfflineTimeout=void 0;this._users.filter((e=>!e._trust_in_room_)).forEach((t=>{e.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(t.uid)),this._handleUserOffline({uid:t.uid})}))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((t=>{t._trust_audio_mute_state_||(e.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(t.uid)),this._handleMuteStream(t.uid,"audio",!1)),t._trust_video_mute_state_||(e.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(t.uid)),this._handleMuteStream(t.uid,"video",!1)),t._trust_audio_enabled_state_||(e.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(t.uid)),this._handleSetStreamLocalEnable("audio",t.uid,!0)),t._trust_video_enabled_state_||(e.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(t.uid)),this._handleSetStreamLocalEnable("video",t.uid,!0)),t._trust_video_stream_added_state_||(e.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(t.uid)),this._handleResetAddStream(t,"video")),t._trust_audio_stream_added_state_||(e.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(t.uid)),this._handleResetAddStream(t,"audio")),t._video_added_||t._audio_added_||(e.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(t.uid)),this._handleRemoveStream({uid:t.uid,uint_id:t._uintid}))})))}),1e3)}o()})),this._gateway.on(gg.REQUEST_NEW_GATEWAY_LIST,((e,t)=>{if(!this._joinInfo)return t(new Ig(T.UNEXPECTED_ERROR,"can not recover, no join info"));_C(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||J,this.store).then((t=>{this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip);const i=[];t.gatewayInfo.gatewayAddrs.forEach((e=>{var t;let{address:n}=e;const[s,o]=n.split(":");if(null!==(t=this._joinInfo)&&void 0!==t&&t.proxyServer){const e=h("PROXY_SERVER_TYPE3");Array.isArray(e)?e.forEach((e=>i.push({proxy:e,host:s,port:o}))):i.push({proxy:e,host:s,port:o})}else i.push({host:s,port:o})})),e(i)})).catch(t)})),this._gateway.on(gg.NETWORK_QUALITY,(e=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(he.NETWORK_QUALITY,e)})),this._gateway.on(gg.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(he.STREAM_TYPE_CHANGED,e,t);xS.reportApiInvoke(this._sessionId,{name:K.STREAM_TYPE_CHANGE,options:[e,t],tag:l.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.on(gg.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(gg.NEED_RENEW_SESSION,(()=>{this._startSession()})),this._gateway.on(gg.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,i)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(e){i(e)}})),this._gateway.on(gg.JOIN_RESPONSE,((e,t)=>{const{dtlsParameters:i,iceParameters:n,candidates:s,rtpCapabilities:o,setup:r,cname:a}=lI(e.ortc,t);this._p2pChannel.connect(n,i,s,o,r,a)})),this._gateway.on(gg.REQUEST_DC_CONNECTION_PARAMS,(e=>{e(this._p2pChannel.getEstablishParams())})),this._gateway.on(gg.RESET_SIGNAL,(e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()})),this._gateway.on(gg.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(gg.DATACHANNEL_PRECONNECT,(async(t,i,n,s)=>{var o,r,a,c,d,l;await this._p2pChannel.startP2PConnection({turnServer:null===(o=this._joinInfo)||void 0===o?void 0:o.turnServer},!0);const u=function(t,i){let n;return i&&i.ip&&"number"==typeof i.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip,port:i.port.toString(),type:"host",extension:{}}],e.debug("Using remote candidate from AP ".concat(i.ip,":").concat(i.port)),i.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip6,port:i.port.toString(),type:"host",extension:{}}),e.debug("Using IPV6 remote candidate from AP ".concat(i.ip6,":").concat(i.port)))):n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],n}(t,i);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(r=this._joinInfo)||void 0===r?void 0:r.apResponse.cid,"_").concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cert),icePwd:"".concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cid,"_").concat(null===(d=this._joinInfo)||void 0===d?void 0:d.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(l=h("FINGERPRINT"))&&void 0!==l?l:t.fingerprint}]},u,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(s)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(XS.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(XS.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(XS.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc))),this._gateway.signal.on(XS.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(XS.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(XS.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)})),this._gateway.signal.on(XS.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(XS.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(XS.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,"audio",!0))),this._gateway.signal.on(XS.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,"audio",!1))),this._gateway.signal.on(XS.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,"video",!0))),this._gateway.signal.on(XS.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,"video",!1))),this._gateway.signal.on(XS.RECEIVE_METADATA,(e=>{const t=Ie(e.metadata);this.safeEmit(he.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(XS.ON_DATA_STREAM,(e=>{e.seq&&delete e.seq,e.payload=Ie(e.payload),this.safeEmit(he.STREAM_MESSAGE,e.uid,e.payload),this.onStreamMessage&&this.onStreamMessage(e)})),this._gateway.signal.on(XS.ON_CRYPT_ERROR,(()=>{ve((()=>{e.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(he.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(XS.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(XS.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{e.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,P.TOKEN_EXPIRE),this.safeEmit(he.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(XS.ON_STREAM_FALLBACK_UPDATE,(t=>{e.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(he.STREAM_FALLBACK,t.stream_id,1===t.stream_type?"fallback":"recover")})),this._gateway.signal.on(XS.ON_PUBLISH_STREAM,(t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),e.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))})),this._gateway.signal.on(XS.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(XS.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(qS.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case YS.PUBLISH:{if(!t)return;const e=t.ortc;if(e){var i,n;const s=e.some((e=>{let{stream_type:t}=e;return t===Sg.Audio})),o=e.some((e=>{let{stream_type:t}=e;return t!==Sg.Audio})),r=e.some((e=>{let{stream_type:t}=e;return t===Sg.Screen||t===Sg.ScreenLow}));"offer"===t.state&&xS.publish(this._joinInfo.sid,{eventElapse:DT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:T.TIMEOUT,audio:s,video:o,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:r,audioName:s?null===(i=e.find((e=>{let{stream_type:t}=e;return t===Sg.Audio})))||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId.toString():void 0,videoName:o?null===(n=e.find((e=>{let{stream_type:t}=e;return t!==Sg.Audio})))||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0})}break}case YS.SUBSCRIBE:t&&xS.subscribe(this._joinInfo.sid,{succ:!1,ec:T.TIMEOUT,audio:t.stream_type===bg.AUDIO,video:t.stream_type===bg.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:DT.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}})),this._gateway.signal.on(XS.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(XS.ON_PUBLISHED_USER_LIST,(t=>{if(null==t||!t.users)return;h("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter((e=>!xo(e.audio_ssrc,this.channelName))));const i=[],n=[];for(const s of t.users){let t=this._users.find((e=>e._uintid===s.stream_id));t?t._trust_in_room_=!0:(t=new MC(s.string_id||s.stream_id,s.stream_id),this._users.push(t),0===this.getListeners(he.PUBLISHED_USER_LIST).length&&(e.debug("[".concat(this._clientId,"] user online"),s.stream_id),this.safeEmit(he.USER_JOINED,t)));const o=Tg.Audio&s.stream_type,r=(Tg.Video|Tg.LwoVideo)&s.stream_type,a=0!=(65280&s.stream_type),c=o&&t.hasAudio,d=r&&t.hasVideo;r&&(t._trust_video_stream_added_state_=!0,t._video_added_=!0,t._videoSSRC=s.video_ssrc,t._rtxSsrcId=s.video_rtx),o&&(t._trust_audio_stream_added_state_=!0,t._audio_added_=!0,t._audioSSRC=s.audio_ssrc),o&&!c&&0===this.getListeners(he.PUBLISHED_USER_LIST).length&&(e.info("[".concat(this._clientId,"] remote user ").concat(t.uid," published audio")),this.safeEmit(he.USER_PUBLISHED,t,"audio")),r&&!d&&0===this.getListeners(he.PUBLISHED_USER_LIST).length&&(e.info("[".concat(this._clientId,"] remote user ").concat(t.uid," published video")),this.safeEmit(he.USER_PUBLISHED,t,"video")),(o&&!c||r&&!d||a)&&i.push(t),r&&this._p2pChannel.hasPendingRemoteMedia(t,"video")&&n.push({user:t,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(t,"audio")&&n.push({user:t,mediaType:"audio"})}n.length>0&&(e.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((e=>"user: ".concat(e.user.uid,", mediaType: ").concat(e.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((t=>{e.error("[".concat(this._clientId,"] mass resubscribe error"),t.toString())}))),this.getListeners(he.PUBLISHED_USER_LIST).length>0?h("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=i:(e.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(i.map((e=>e.uid)).join(", "))),this.safeEmit(he.PUBLISHED_USER_LIST,i)):e.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(i.map((e=>e.uid)).join(", ")))}))}_handleP2PChannelEvents(){this._p2pChannel.on(Mg.RequestMuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===T.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Mg.RequestUnmuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===T.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Mg.RequestRePublish,((e,t,i)=>{this.publish(e,!1).then(t).catch(i)})),this._p2pChannel.on(Mg.RequestRePublishDataChannel,((e,t,i)=>{yS.all(e.map((async e=>{await this._p2pChannel.publishDataChannel([e]);const t={streamId:e.id,ordered:e.ordered,maxRetransmits:e.maxRetransmits,metadata:e.metadata,channelId:e._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,t,!0)}catch(e){if(e.code!==T.DISCONNECT_P2P)throw e}}))).then(t).catch(i)})),this._p2pChannel.on(Mg.RequestReSubscribe,(async(e,t,i)=>{try{for(const{user:t,kind:i}of e)i===bg.VIDEO?await this.subscribe(t,"video"):await this.subscribe(t,"audio");t()}catch(e){i(e)}})),this._p2pChannel.on(Mg.RequestUploadStats,((e,t)=>{this._gateway.uploadStats(e,t)})),this._p2pChannel.on(Mg.MediaReconnectStart,(e=>{this.safeEmit(he.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(Mg.MediaReconnectEnd,(e=>{this.safeEmit(he.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(Mg.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(Mg.RequestRestartICE,(async e=>{const t=await this._p2pChannel.restartICE(e),i=await t.next();if(i.done)return;const n=i.value;let s;try{s=await this._gateway.restartICE({iceParameters:n})}catch(e){return void t.throw(e)}const{iceParameters:o}=function(e){const t=e.iceParameters;return{iceParameters:{iceUfrag:t.iceUfrag,icePwd:t.icePwd}}}(s);await t.next({remoteIceParameters:o})})),this._p2pChannel.on(Mg.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(Mg.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:null===(e=this._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:s,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:i,rtpCapabilities:n}),{dtlsParameters:r,iceParameters:a,candidates:c,rtpCapabilities:d,setup:l,cname:h}=lI(s,o);await this._p2pChannel.connect(a,r,c,d,l,h),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(Mg.RequestUnpublishForReconnectPC,(async(e,t,i)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(e,this._uid),t()):i()})),this._p2pChannel.on(Mg.P2PLost,(()=>{this.safeEmit(he.P2P_LOST,this.store.uid)})),this._p2pChannel.on(Mg.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(Mg.ConnectionTypeChange,(e=>{this.safeEmit(he.IS_USING_CLOUD_PROXY,e)})),this._p2pChannel.on(Mg.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(Mg.QueryClientConnectionState,(e=>{e(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new Ig(T.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new Ig(T.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new Ig(T.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const t=[...new Set(e.inspectType)];t.forEach((e=>{var t;if(!Po(t=["supervise","moderation"]).call(t,e))throw new Ig(T.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(e," is not a valid inspect type."))})),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new Ig(T.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const t=new iy(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},J)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new Ig(T.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(_(e,"enabled"),e){if(!t)throw new Ig(T.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(p(t.interval,"interval",1e3,1/0),"CONNECTED"!==this.connectionState||!this._joinInfo)throw new Ig(T.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);const e=new My(t);this._moderation=e,this.handleImageModerationEvents(this._moderation),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},J)}catch(e){throw Array.isArray(e)?e[0]:e}}else{if(!this._moderation)throw new Ig(T.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}}handleImageModerationEvents(e){e.on(Hg.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.emit(he.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,i),t===Wg.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new Ig(T.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(Hg.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}handleVideoInspectEvents(t){t.on(Vg.CONNECTION_STATE_CHANGE,((e,i)=>{if(this.emit(he.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,i),i===Ug.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.emit(he.CONTENT_INSPECT_ERROR,new Ig(T.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}})),t.on(Vg.INSPECT_RESULT,((t,i)=>{var n;if((null==i?void 0:i.code)===T.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return e.debug("Stop inspect content because that has left channel"),null==this||null===(n=this._inspect)||void 0===n||n.close(),void(this._inspect=void 0);this.emit(he.CONTENT_INSPECT_RESULT,t,i)})),t.on(Vg.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return e.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){_(e,"enabled"),G("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}function Fy(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const t=xS.reportApiInvoke(null,{name:K.CREATE_CLIENT,options:[e],tag:l.TRACER});try{le(e)}catch(e){throw t.onError(e),e}return void 0===e.audioCodec&&(e.audioCodec="opus"),t.onSuccess(),new Vy(xy(xy({forceWaitGatewayResponse:!0},e),{},{role:"rtc"===e.mode?"host":e.role||"audience"}))}async function jy(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});const i=(await t.createOffer()).sdp;if(!i)return e;t.close(),t=null,e=function(e){const t={video:[],audio:[]};return e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ VP9/i)&&t.video.push("VP9"),e.match(/ AV1/i)&&t.video.push("AV1"),e.match(/ H264/i)&&t.video.push("H264"),e.match(/ H265/i)&&t.video.push("H265"),e.match(/ opus/i)&&t.audio.push("OPUS"),e.match(/ PCMU/i)&&t.audio.push("PCMU"),e.match(/ PCMA/i)&&t.audio.push("PCMA"),e.match(/ G722/i)&&t.audio.push("G722"),t}(i)}catch(e){throw new Ig(T.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return e}function By(){const t=xS.reportApiInvoke(null,{name:K.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:l.TRACER});let i=!1;try{const e=window.RTCPeerConnection,t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,n=window.WebSocket;i=!!(e&&t&&n)}catch(t){return e.error("check system requirement failed: ",t),!1}let n=!1;const s=Y();s.name===$.CHROME&&Number(s.version)>=58&&(!ye()||Ae())&&(n=!0),s.name===$.FIREFOX&&Number(s.version)>=56&&(n=!0),s.name===$.OPERA&&Number(s.version)>=45&&(n=!0),s.name===$.SAFARI&&Number(s.version)>=11&&(n=!0),(we()||Ne())&&(n=!0),e.debug("checkSystemRequirements, api:",i,"browser",n);const o=i&&n;return t.onSuccess(o),o}kS([US(),MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",yS)],Vy.prototype,"leave",null),kS([US({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof Fe))return[t];t=[t]}return t.map((e=>e?Object(e).toString():"null"))}}),MS("design:type",Function),MS("design:paramtypes",[Object,Boolean]),MS("design:returntype",yS)],Vy.prototype,"publish",null),kS([US({argsMap:(e,t)=>(t||(t=[]),t instanceof Xe?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map((e=>e.getTrackId()))))}),MS("design:type",Function),MS("design:paramtypes",[Object]),MS("design:returntype",yS)],Vy.prototype,"unpublish",null),kS([US({argsMap:(e,t,i,n)=>[t.uid,i,n]}),MS("design:type",Function),MS("design:paramtypes",[MC,String,Number]),MS("design:returntype",yS)],Vy.prototype,"subscribe",null),kS([US({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return[null==t?void 0:t.uid,i]}))}),MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],Vy.prototype,"massSubscribe",null),kS([US({argsMap:(e,t,i,n)=>[t.uid,i,n]}),MS("design:type",Function),MS("design:paramtypes",[MC,String,Number]),MS("design:returntype",yS)],Vy.prototype,"unsubscribe",null),kS([US({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return{uid:null==t?void 0:t.uid,mediaType:i}}))}),MS("design:type",Function),MS("design:paramtypes",[Array]),MS("design:returntype",yS)],Vy.prototype,"massUnsubscribe",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Object]),MS("design:returntype",yS)],Vy.prototype,"setLowStreamParameter",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",yS)],Vy.prototype,"enableDualStream",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",yS)],Vy.prototype,"disableDualStream",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[String,Object]),MS("design:returntype",yS)],Vy.prototype,"setClientRole",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[String,Boolean]),MS("design:returntype",void 0)],Vy.prototype,"setProxyServer",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Object,Boolean]),MS("design:returntype",void 0)],Vy.prototype,"setTurnServer",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",void 0)],Vy.prototype,"setLicense",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Number]),MS("design:returntype",void 0)],Vy.prototype,"startProxyServer",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",void 0)],Vy.prototype,"stopProxyServer",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Object]),MS("design:returntype",void 0)],Vy.prototype,"setLocalAccessPointsV2",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Array,String]),MS("design:returntype",void 0)],Vy.prototype,"setLocalAccessPoints",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Number]),MS("design:returntype",yS)],Vy.prototype,"setRemoteDefaultVideoStreamType",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Object,Number]),MS("design:returntype",yS)],Vy.prototype,"setRemoteVideoStreamType",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Object,Number]),MS("design:returntype",yS)],Vy.prototype,"setStreamFallbackOption",null),kS([US({argsMap:(e,t)=>[t]}),MS("design:type",Function),MS("design:paramtypes",[String,String,Uint8Array]),MS("design:returntype",void 0)],Vy.prototype,"setEncryptionConfig",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],Vy.prototype,"renewToken",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",void 0)],Vy.prototype,"enableAudioVolumeIndicator",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[String,Boolean]),MS("design:returntype",yS)],Vy.prototype,"startLiveStreaming",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Object]),MS("design:returntype",yS)],Vy.prototype,"setLiveTranscoding",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[String]),MS("design:returntype",yS)],Vy.prototype,"stopLiveStreaming",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[String,Object]),MS("design:returntype",yS)],Vy.prototype,"addInjectStreamUrl",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",yS)],Vy.prototype,"removeInjectStreamUrl",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[DC]),MS("design:returntype",yS)],Vy.prototype,"startChannelMediaRelay",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[DC]),MS("design:returntype",yS)],Vy.prototype,"updateChannelMediaRelay",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",yS)],Vy.prototype,"stopChannelMediaRelay",null),kS([US({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),MS("design:type",Function),MS("design:paramtypes",[Object]),MS("design:returntype",yS)],Vy.prototype,"sendCustomReportMessage",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Object,Object]),MS("design:returntype",yS)],Vy.prototype,"pickSVCLayer",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Number]),MS("design:returntype",yS)],Vy.prototype,"setRTM2Flag",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Object]),MS("design:returntype",yS)],Vy.prototype,"enableContentInspect",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",yS)],Vy.prototype,"disableContentInspect",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Boolean,Object]),MS("design:returntype",yS)],Vy.prototype,"setImageModeration",null),kS([US({reportResult:!0}),MS("design:type",Function),MS("design:paramtypes",[]),MS("design:returntype",Array)],Vy.prototype,"getJoinChannelServiceRecords",null),kS([US(),MS("design:type",Function),MS("design:paramtypes",[Boolean]),MS("design:returntype",yS)],Vy.prototype,"setPublishAudioFilterEnabled",null);const Gy=Y().name;async function Wy(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const n=xS.reportApiInvoke(null,{tag:l.TRACER,name:K.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[i]});if(!(t instanceof Ue||t instanceof We)){const e=new Ig(T.INVALID_TRACK,"the parameter is not a video track");return n.onError(e),e.throw()}i&&i<1e3&&(i=1e3);const s=t instanceof Ue?t.getTrackLabel():"remote_track",o=t.getMediaStreamTrack(!0),r=document.createElement("video");r.style.width="1px",r.style.height="1px",r.setAttribute("muted",""),r.muted=!0,r.setAttribute("playsinline",""),r.controls=!1,(te()||Oe())&&(r.style.opacity="0.01",r.style.position="fixed",r.style.left="0",r.style.top="0",document.body.appendChild(r)),r.srcObject=new MediaStream([o]),r.play();const a=document.createElement("canvas");a.width=160,a.height=120;let c=0,d=0;try{const t=Date.now();c=await function(t,i,n,s){let o,r=0,a=null;return new yS(((c,d)=>{function l(){r>s&&o&&(o(),c(r));const i=n.getContext("2d");if(!i){const t=new Ig(T.UNEXPECTED_ERROR,"can not get canvas 2d context.");return e.error(t.toString()),void d(t)}i.drawImage(t,0,0,160,120);const l=i.getImageData(0,0,n.width,n.height),h=Math.floor(l.data.length/3);if(a){for(let e=0;e<h;e+=3)if(l.data[e]!==a[e])return r+=1,void(a=l.data);a=l.data}else a=l.data}setTimeout((()=>{o&&(o(),c(r))}),i),o=je((()=>{l()}),30)}))}(r,i,a,4),d=Date.now()-t}catch(e){throw n.onError(e),e}Gy===$.SAFARI&&(r.pause(),r.remove()),r.srcObject=null;const h=c>4,u={duration:d,changedPicNum:c,deviceLabel:s,result:h};return e.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(u))),n.onSuccess(u),h}async function Hy(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const n=xS.reportApiInvoke(null,{tag:l.TRACER,name:K.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[i]});if(!(t instanceof Me||t instanceof Ge)){const e=new Ig(T.INVALID_TRACK,"the parameter is not a audio track");return n.onError(e),e.throw()}i&&i<1e3&&(i=1e3);const s=t instanceof Me?t.getTrackLabel():"remote_track",o=t.getVolumeLevel();let r=o,a=o;const c=Date.now();return new yS((o=>{const d=setInterval((()=>{const l=t.getVolumeLevel();r=l>r?l:r,a=l<a?l:a;const h=r-a>1e-4,u=Date.now()-c;if(h||u>i){clearInterval(d);const i=h,a={duration:u,deviceLabel:s,maxVolumeLevel:r,result:i};e.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(a))),n.onSuccess(a),o(i)}}),200)}))}class Ky{constructor(e,t){this.id=0,this.element=void 0,this.peerPair=void 0,this.context=void 0,this.audioPlayerElement=void 0,this.audioTrack=void 0,Ky.count+=1,this.id=Ky.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;const e=async(e,t)=>{const i="offer"===t?await e.createOffer():await e.createAnswer();return await e.setLocalDescription(i),"complete"===e.iceGatheringState?e.localDescription:new yS((t=>{e.onicegatheringstatechange=()=>{"complete"===e.iceGatheringState&&t(e.localDescription)}}))},t=async(e,t)=>await e.setRemoteDescription(t);try{const i=await e(this.peerPair[0],"offer");await t(this.peerPair[1],i);const n=await e(this.peerPair[1],"answer");await t(this.peerPair[0],n)}catch(e){throw new Ig(T.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination();this.context.createMediaElementSource(e).connect(t)}catch(e){throw new Ig(T.LOCAL_AEC_ERROR,e.toString()).print()}if(!t){throw new Ig(T.LOCAL_AEC_ERROR,"no dest node when local aec").print()}const i=t.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){e.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}Ky.count=0;const qy=window.AudioContext||window.webkitAudioContext;class Yy{constructor(){this.units=[],this.context=void 0}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return e.debug("the system does not need to process local aec"),-1;this.context||(this.context=new qy);let i=this.units.find((e=>e&&e.getElement()===t));return i||(i=new Ky(t,this.context),this.units.push(i)),i.startEchoCancellation(),e.debug("start processing local audio echo cancellation, id is",i.id),i.id}_doesEnvironmentNeedAEC(){return Y().name!==$.SAFARI}}kS([US({report:xS}),MS("design:type",Function),MS("design:paramtypes",[HTMLAudioElement]),MS("design:returntype",Number)],Yy.prototype,"processExternalMediaAEC",null);const Jy=new Yy;function Xy(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function zy(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Xy(Object(i),!0).forEach((function(t){ap(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Xy(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Qy=window||document;function Zy(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!Qy)return;const i=lA._cspEventHandlerPointer;if(i&&t)return void console.error(i,t);const n=e=>{if(!(e&&e.blockedURI&&(lA.onSecurityPolicyViolation||lA.getListeners(Bg.SECURITY_POLICY_VIOLATION).length>0)))return;const t=e.blockedURI;h("CSP_DETECTED_HOSTNAME_LIST").some((e=>Po(t).call(t,e)))&&(lA.onSecurityPolicyViolation&&"function"==typeof lA.onSecurityPolicyViolation&&lA.onSecurityPolicyViolation(e),lA.getListeners(Bg.SECURITY_POLICY_VIOLATION).length>0&&lA.safeEmit(Bg.SECURITY_POLICY_VIOLATION,e))};i&&Qy.removeEventListener("securitypolicyviolation",i),(t||e&&"function"==typeof e||lA.getListeners(Bg.SECURITY_POLICY_VIOLATION).length>0)&&Qy.addEventListener("securitypolicyviolation",n),lA._cspEventHandlerPointer=n}function $y(e){return et.enumerateDevices(!0,!0,e)}function eA(e){return et.getRecordingDevices(e)}function tA(e){return et.getCamerasDevices(e)}function iA(e){return et.getSpeakers(e)}function nA(){return new DC}function sA(t){if(e.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw e.debug("Invalid appType"),new Ig(T.INVALID_PARAMS,"invalid app type",t);G("APP_TYPE",Math.floor(t))}function oA(t){e.setLogLevel(t)}function rA(){h("USE_NEW_LOG")?G("UPLOAD_LOG",!0):e.enableLogUpload()}function aA(){h("USE_NEW_LOG")?G("UPLOAD_LOG",!1):e.disableLogUpload()}function cA(e){Jy.processExternalMediaAEC(e)}function dA(t){t.forEach((t=>{const i=t;i.__registered__=!0,i.logger.hookLog=e.extLog,i.reporter.hookApiInvoke=xS.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach((e=>{i.parameters[e]=h(e)}))}))}G("PROCESS_ID",be()),Ze(),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void e.error("Error loading sdk config",t.message)}if(t)try{const i=JSON.parse(window.atob(t)),n=Date.now();e.debug("Loading global parameters from cache",i),Object.keys(i).forEach((e=>{if(Object.prototype.hasOwnProperty.call(a,e)){const{value:t,expires:s}=i[e];if(s&&s<=n)return;c[e]=t,a[e]=t}}))}catch(i){e.error("Error loading mutableParamsCache: ".concat(t),i.message)}}(),Array.isArray(c.AREAS)&&c.AREAS.length>0&&ZR(c.AREAS,!0);const lA=function(e){const t=new C,i=e,n={getListeners:t.getListeners.bind(t),on:(e,i)=>(function(e,t){e===Bg.SECURITY_POLICY_VIOLATION&&Zy(t,!0)}(e,i),t.on.bind(t)(e,i)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return zy(zy({},i),n)}({__CLIENT_LIST__:Uo,__TRACK_LIST__:nt,VERSION:B,BUILD:_e,ESM_BUNDLER:!0,ESM:!1,UMD:!1,DEV:!1});function hA(e){$e.onAudioAutoplayFailed=e}function uA(e){$e.onAutoplayFailed=e}function pA(e){lA.onSecurityPolicyViolation=e}function _A(e){lA.onCameraChanged=e}function EA(e){lA.onMicrophoneChanged=e}Object.defineProperties(lA,{onAudioAutoplayFailed:{get:()=>$e.onAudioAutoplayFailed,set:hA},onAutoplayFailed:{get:()=>$e.onAutoplayFailed,set:uA},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>lA._onSecurityPolicyViolation,set(e){lA._onSecurityPolicyViolation=e,Zy(e)}}}),et.on(tt.CAMERA_DEVICE_CHANGED,(t=>{var i;e.info("camera device changed",JSON.stringify(t)),null===(i=lA.onCameraChanged)||void 0===i||i.call(lA,t),lA.safeEmit(Bg.CAMERA_CHANGED,t)})),et.on(tt.RECORDING_DEVICE_CHANGED,(t=>{var i;e.info("microphone device changed",JSON.stringify(t)),null===(i=lA.onMicrophoneChanged)||void 0===i||i.call(lA,t),lA.safeEmit(Bg.MICROPHONE_CHANGED,t)})),et.on(tt.PLAYOUT_DEVICE_CHANGED,(t=>{var i;e.debug("playout device changed",JSON.stringify(t)),null===(i=lA.onPlaybackDeviceChanged)||void 0===i||i.call(lA,t),lA.safeEmit(Bg.PLAYBACK_DEVICE_CHANGED,t)})),ke.onAutoplayFailed=()=>{var t;e.info("detect audio element autoplay failed"),null===(t=$e.onAudioAutoplayFailed)||void 0===t||t.call($e)},it.on("autoplay-failed",(()=>{var t;e.info("detect webaudio autoplay failed"),null===(t=$e.onAudioAutoplayFailed)||void 0===t||t.call($e),lA.safeEmit(Bg.AUTOPLAY_FAILED)})),window&&(window.__ARTC__=lA);const mA=(t,i,n)=>{e.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(i))),G(t,i,n)};export{Cg as AREAS,lA as AgoraRTC,fg as ChannelMediaRelayError,Eg as ChannelMediaRelayEvent,mg as ChannelMediaRelayState,Uo as __CLIENT_LIST__,Hy as checkAudioTrackIsActive,By as checkSystemRequirements,Wy as checkVideoTrackIsActive,nA as createChannelMediaRelayConfiguration,Fy as createClient,aA as disableLogUpload,rA as enableLogUpload,tA as getCameras,$y as getDevices,eA as getMicrophones,iA as getPlaybackDevices,jy as getSupportedCodec,hA as onAudioAutoplayFailed,uA as onAutoplayFailed,_A as onCameraChanged,EA as onMicrophoneChanged,pA as onSecurityPolicyViolation,cA as processExternalMediaAEC,dA as registerExtensions,sA as setAppType,ZR as setArea,oA as setLogLevel,mA as setParameter};
